<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Dashboard Guru Pembimbing - SIMAK NESBU</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @media print {

            .sidebar,
            .mobile-header,
            .no-print,
            header,
            .btn-close,
            .toast-container,
            .section {
                display: none !important;
            }

            @page {
                margin-top: 0;
            }

            .main-content {
                margin: 0 !important;
                padding: 0 !important;
            }
        }
    </style>
    <script>
        /* Mobile Helper functions */
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('active');
                document.body.classList.toggle('sidebar-open', sidebar.classList.contains('active'));
            }
        }

        function toggleProfileDropdown(e) {
            if (e) e.stopPropagation();
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }

        window.onclick = function (event) {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown && dropdown.classList.contains('active')) {
                if (!event.target.closest('.profile-dropdown-container')) {
                    dropdown.classList.remove('active');
                }
            }
        }

        function updateClock() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            const timeStr = now.toLocaleDateString('id-ID', options);
            const el = document.getElementById('currentTime');
            if (el) el.textContent = timeStr.replace('pukul', 'â€¢');
        }

        function updateUserUI() {
            const user = AUTH.getUser();
            if (!user) return;

            const welcomeName = document.getElementById('welcomeName');
            if (welcomeName) welcomeName.textContent = user.nama || 'Guru';

            const sidebarName = document.getElementById('userName');
            if (sidebarName) sidebarName.textContent = user.nama || 'Guru';

            const fallbackUrl = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.nama || 'Guru') + '&background=random';
            const avatarSrc = user.photo ? getDriveThumbnail(user.photo) : fallbackUrl;

            const avatars = ['userAvatar', 'headerAvatar', 'profViewAvatar', 'profModalAvatar'];
            avatars.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.onerror = function () {
                        this.onerror = null;
                        this.src = fallbackUrl;
                        if (id === 'headerAvatar') {
                            const ph = document.getElementById('headerAvatarPlaceholder');
                            if (ph) ph.classList.remove('hidden');
                            this.style.display = 'none';
                        }
                    };
                    el.src = avatarSrc;

                    // Special handling for headerAvatar
                    if (id === 'headerAvatar') {
                        const ph = document.getElementById('headerAvatarPlaceholder');
                        if (user.photo) {
                            el.style.display = 'block';
                            if (ph) ph.classList.add('hidden');
                        } else {
                            el.style.display = 'none';
                            if (ph) ph.classList.remove('hidden');
                        }
                    }
                }
            });

            // Update stats
            updateSmallStats();
        }

        async function updateSmallStats() {
            try {
                // Approximate student count from cached students
                if (window.cachedAssignedStudents) {
                    const el = document.getElementById('statStudentCountSmall');
                    if (el) el.textContent = window.cachedAssignedStudents.length + ' Siswa Bimbingan';
                }
            } catch (e) { console.error(e); }
        }

        /* Override showSection for Animations */
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            const navLinks = document.querySelectorAll('.sidebar-menu a');
            const bottomLinks = document.querySelectorAll('.bottom-nav-link');

            sections.forEach(s => {
                s.classList.add('hidden');
                s.classList.remove('fade-in');
            });

            navLinks.forEach(l => l.classList.remove('active'));
            bottomLinks.forEach(l => l.classList.remove('active'));

            const target = document.getElementById('section-' + sectionId);
            if (target) {
                target.classList.remove('hidden');
                target.classList.add('fade-in');

                const activeNav = document.getElementById('nav-' + sectionId);
                if (activeNav) activeNav.classList.add('active');

                const activeBNav = document.getElementById('bnav-' + sectionId);
                if (activeBNav) activeBNav.classList.add('active');

                const titles = {
                    home: 'Beranda',
                    monitoring: 'Monitoring Siswa Bimbingan',
                    attendance: 'Monitoring Absensi Siswa',
                    titles: 'Monitoring Judul Laporan',
                    bimbingan: 'Bimbingan & Monitoring PKL'
                };
                document.getElementById('sectionTitle').textContent = titles[sectionId] || 'Panel Guru';
            }

            // Close sidebar on mobile
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth <= 1024 && sidebar) {
                sidebar.classList.remove('active');
                document.body.classList.remove('sidebar-open');
            }

            if (sectionId === 'monitoring') loadMonitoringData();
            if (sectionId === 'attendance') loadAttendanceData();
            if (sectionId === 'titles') loadReportTitlesData();
            if (sectionId === 'bimbingan') loadBimbinganData();
        }

    </script>
</head>

<body class="dashboard">
    <header class="mobile-header">
        <div style="display: flex; align-items: center; gap: 0.85rem;">
            <div class="logo-circle">
                <img src="https://blogger.googleusercontent.com/img/a/AVvXsEj0gidDMAxs79SkpgBW6-nRy7SLq7ytNTzeXSLp8-sX5SKhlCY7JHDHr7BNvJ9nTF8YgHbB_kubuvfYzX4t4ONGFDfoL2-AMa8mgK29o6XGebiHkSMgiO2BoXpv0fATKQ9XMf-RPWGbqrr_KQ1iVX3JeWYh9JGXR43QSWxyIa2o-qeJR9S0_8dxANpck08"
                    alt="Logo"
                    style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 5px rgba(var(--primary-rgb), 0.3));">
            </div>
            <div style="display: flex; flex-direction: column;">
                <span class="text-gradient"
                    style="font-weight: 800; font-size: 1.1rem; line-height: 1; font-family: 'Outfit', sans-serif;">SIMAK</span>
                <span
                    style="font-size: 0.7rem; color: var(--text-muted); font-weight: 700; letter-spacing: 0.1em; opacity: 0.8;">NESBU</span>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="profile-dropdown-container">
                <div class="header-profile" onclick="toggleProfileDropdown(event)"
                    style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <img src="" alt="" id="headerAvatar"
                        style="width: 36px; height: 36px; border-radius: 12px; border: 1.5px solid var(--glass-border); object-fit: cover; display: none;">
                    <div id="headerAvatarPlaceholder"
                        style="width: 36px; height: 36px; border-radius: 12px; background: var(--glass-bg); display: flex; align-items: center; justify-content: center; border: 1.5px solid var(--glass-border);">
                        <i class="fas fa-user" style="color: var(--primary-light); font-size: 1.1rem;"></i>
                    </div>
                </div>

                <div id="profileDropdown" class="profile-dropdown">
                    <div class="dropdown-item" onclick="openProfileModal()">
                        <i class="fas fa-user-edit"></i> Edit Profil
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item danger" onclick="AUTH.logout()">
                        <i class="fas fa-sign-out-alt"></i> Keluar
                    </div>
                </div>
            </div>
            <button class="menu-toggle" onclick="toggleMobileSidebar()"
                style="background: transparent; border: none; color: var(--text-main); font-size: 1.25rem;">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <aside class="sidebar glass" id="sidebar">
        <div class="user-profile" onclick="openProfileModal()">
            <img src="" alt="Avatar" class="avatar" id="userAvatar" referrerpolicy="no-referrer">
            <div>
                <h4 id="userName">Guru Name</h4>
                <p style="font-size: 0.75rem; color: var(--text-muted);">Guru Pembimbing</p>
            </div>
        </div>
        <div class="sidebar-content">
            <ul class="sidebar-menu">
                <li><a href="#" id="nav-home" onclick="showSection('home')" class="active"><i
                            class="fas fa-th-large"></i> Beranda</a></li>
                <li><a href="#" id="nav-monitoring" onclick="showSection('monitoring')"><i class="fas fa-eye"></i>
                        Monitoring Siswa</a></li>
                <li><a href="#" id="nav-attendance" onclick="showSection('attendance')"><i
                            class="fas fa-clipboard-list"></i> Absensi Siswa</a></li>
                <li><a href="#" id="nav-titles" onclick="showSection('titles')"><i class="fas fa-file-alt"></i> Judul
                        Laporan</a></li>
                <li><a href="#" id="nav-bimbingan" onclick="showSection('bimbingan')"><i
                            class="fas fa-hand-holding-heart"></i>
                        Bimbingan & Monitoring</a></li>
                <li><a href="#" onclick="AUTH.logout()" style="color: var(--danger);"><i
                            class="fas fa-sign-out-alt"></i>
                        Keluar</a></li>
            </ul>
        </div>
        <div class="sidebar-footer">
            <div style="display: flex; align-items: center; gap: 0.5rem; opacity: 0.6;">
                <i class="fas fa-shield-virus"></i>
                <span>Malware Developed</span>
            </div>
            <div style="font-size: 0.65rem; margin-top: 0.25rem;">&copy; 2026 SIMAK NESBU</div>
        </div>
    </aside>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()" aria-hidden="true"></div>

    <nav class="bottom-nav">
        <ul class="bottom-nav-list">
            <li><a href="#" class="bottom-nav-link active" id="bnav-home" onclick="showSection('home')"><i
                        class="fas fa-th-large"></i><span>Home</span></a></li>
            <li><a href="#" class="bottom-nav-link" id="bnav-monitoring" onclick="showSection('monitoring')"><i
                        class="fas fa-users"></i><span>Siswa</span></a></li>
            <li><a href="#" class="bottom-nav-link" id="bnav-attendance" onclick="showSection('attendance')"><i
                        class="fas fa-clipboard-list"></i><span>Absen</span></a></li>
            <li><a href="#" class="bottom-nav-link" id="bnav-bimbingan" onclick="showSection('bimbingan')"><i
                        class="fas fa-hand-holding-heart"></i><span>Bimbingan</span></a></li>
            <li><a href="#" class="bottom-nav-link" id="bnav-profile" onclick="openProfileModal()"><i
                        class="fas fa-user-circle"></i><span>Profil</span></a></li>
        </ul>
    </nav>
    <main class="main-content">
        <header>
            <div>
                <h2 id="sectionTitle" class="text-gradient"
                    style="font-family: 'Outfit', sans-serif; font-size: 2rem; font-weight: 800;">Beranda</h2>
                <div id="currentTime"
                    style="font-weight: 600; color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem;"></div>
            </div>
        </header>

        <!-- Section: Home (Launcher) -->
        <div id="section-home" class="section">
            <div class="welcome-section fade-in" style="margin-bottom: 2.5rem;">
                <p id="greetingText"
                    style="font-size: 1.1rem; color: var(--primary-light); font-weight: 700; margin-bottom: 0.25rem;">
                    Halo, Bapak/Ibu Guru! ðŸ‘‹</p>
                <h1 id="welcomeName"
                    style="font-family: 'Outfit', sans-serif; font-size: 2.5rem; font-weight: 800; line-height: 1.1;">-
                </h1>
                <p style="color: var(--text-muted); margin-top: 0.5rem; font-weight: 500;">Pantau bimbingan PKL siswa
                    Anda
                    dengan efisien.</p>
            </div>

            <!-- Quick Stats Summary -->
            <div
                style="display: flex; gap: 0.75rem; margin-bottom: 2rem; overflow-x: auto; padding-bottom: 0.5rem; scrollbar-width: none;">
                <div class="glass"
                    style="padding: 0.75rem 1.25rem; border-radius: 1rem; display: flex; align-items: center; gap: 0.75rem; white-space: nowrap;">
                    <i class="fas fa-users" style="color: var(--primary-light);"></i>
                    <span id="statStudentCountSmall" style="font-weight: 700;">0 Siswa Bimbingan</span>
                </div>
                <div class="glass"
                    style="padding: 0.75rem 1.25rem; border-radius: 1rem; display: flex; align-items: center; gap: 0.75rem; white-space: nowrap;">
                    <i class="fas fa-clipboard-check" style="color: var(--success);"></i>
                    <span id="statAttendanceCountSmall" style="font-weight: 700;">Kehadiran Aktif</span>
                </div>
            </div>

            <!-- Launcher Grid (Mobile Main Menu) -->
            <div class="launcher-grid fade-in">
                <div class="launcher-item" onclick="showSection('monitoring')">
                    <i class="fas fa-eye"></i>
                    <span>Monitoring</span>
                </div>
                <div class="launcher-item" onclick="showSection('attendance')">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Absensi</span>
                </div>
                <div class="launcher-item" onclick="showSection('titles')">
                    <i class="fas fa-file-alt"></i>
                    <span>Judul Laporan</span>
                </div>
                <div class="launcher-item" onclick="showSection('bimbingan')">
                    <i class="fas fa-hand-holding-heart"></i>
                    <span>Bimbingan</span>
                </div>
                <div class="launcher-item" onclick="openProfileModal()">
                    <i class="fas fa-user-circle"></i>
                    <span>Profil Saya</span>
                </div>
                <div class="launcher-item" onclick="AUTH.logout()">
                    <i class="fas fa-sign-out-alt" style="color: var(--danger);"></i>
                    <span>Keluar</span>
                </div>
            </div>
        </div>

        <!-- Section: Monitoring -->
        <div id="section-monitoring" class="section hidden">
            <div class="glass" style="padding: 2rem; border-radius: var(--radius);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3>Daftar Siswa Bimbingan</h3>
                    <button class="btn btn-primary" onclick="loadMonitoringData()"
                        style="width: auto; padding: 0.5rem 1rem;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #e2e8f0; text-align: left; color: var(--text-muted);">
                                <th style="padding: 1rem;">Siswa (Nama & NIS)</th>
                                <th style="padding: 1rem;">Kelas</th>
                                <th style="padding: 1rem; text-align: right;">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="monitoringTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                    Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- Section: Attendance -->
        <div id="section-attendance" class="section hidden">
            <div class="glass" style="padding: 2rem; border-radius: var(--radius);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3>Monitoring Absensi Siswa</h3>
                    <button class="btn btn-primary" onclick="loadAttendanceData()"
                        style="width: auto; padding: 0.5rem 1rem;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #e2e8f0; text-align: left; color: var(--text-muted);">
                                <th style="padding: 1rem;">Tanggal</th>
                                <th style="padding: 1rem;">Siswa</th>
                                <th style="padding: 1rem;">Waktu</th>
                                <th style="padding: 1rem;">Status</th>
                                <th style="padding: 1rem;">Lokasi</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                    Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Section: Titles (Judul Laporan) -->
        <div id="section-titles" class="section hidden">
            <div class="glass" style="padding: 2rem; border-radius: var(--radius);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--primary);"><i class="fas fa-file-alt"></i> Pengajuan Judul Laporan</h3>
                    <button class="btn btn-primary" onclick="loadReportTitlesData()"
                        style="width: auto; padding: 0.5rem 1rem;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align: left; border-bottom: 2px solid #f1f5f9;">
                                <th style="padding: 1rem;">Siswa</th>
                                <th style="padding: 1rem;">Judul yang Diajukan</th>
                                <th style="padding: 1rem;">Status</th>
                                <th style="padding: 1rem;">Feedback</th>
                                <th style="padding: 1rem;">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="titlesTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                    Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Section: Bimbingan & Monitoring -->
        <div id="section-bimbingan" class="section hidden">
            <div class="glass" style="padding: 2rem; border-radius: var(--radius);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3>Data Bimbingan & Monitoring</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="openBimbinganModal()"
                            style="width: auto; padding: 0.5rem 1rem;">
                            <i class="fas fa-plus"></i> Input Kegiatan
                        </button>
                        <button class="btn btn-primary" onclick="loadBimbinganData()"
                            style="width: auto; padding: 0.5rem 1rem; background: #94a3b8;">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div id="bimbinganDataContainer">
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        Memuat data...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Lihat Data Siswa -->
    <div id="viewStudentModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 95%; max-width: 800px; padding: 2rem; border-radius: var(--radius); position: relative; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-user-circle"></i> Detail Profil Siswa
            </h3>
            <div id="viewStudentContent">
                <!-- Content will be injected -->
            </div>
            <div style="margin-top: 2rem; text-align: right; border-top: 1px solid #eee; padding-top: 1rem;">
                <button class="btn btn-primary" onclick="toggleViewStudentModal(false)">Tutup Detail</button>
            </div>
        </div>
    </div>

    <!-- Modal Validasi Jurnal -->
    <div id="journalModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass" style="width: 90%; max-width: 500px; padding: 2rem; border-radius: var(--radius);">
            <h3 style="margin-bottom: 1.5rem;">Validasi Jurnal</h3>
            <form id="journalForm">
                <input type="hidden" id="valJournalId">
                <div class="form-group">
                    <label>Status</label>
                    <select id="valJournalStatus" required>
                        <option value="Pending">Pending</option>
                        <option value="Disetujui">Disetujui</option>
                        <option value="Revisi">Revisi</option>
                        <option value="Ditolak">Ditolak</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Feedback</label>
                    <textarea id="valJournalFeedback" style="width:100%; min-height:100px; padding:0.5rem;"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="toggleJournalModal(false)"
                        style="background: #e2e8f0;">Batal</button>
                    <button type="submit" class="btn btn-primary" id="btnSaveJournal">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detail Judul Laporan -->
    <div id="titleModal" class="hidden"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 500px; padding: 2rem; border-radius: var(--radius); position: relative;">
            <button class="btn-close" onclick="toggleTitleModal(false)"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            <h3 id="titleModalTitle" style="margin-bottom: 1.5rem; color: var(--primary);">Detail Judul Laporan</h3>
            <div style="margin-bottom: 1rem; background: #f8fafc; padding: 1rem; border-radius: 0.5rem;">
                <div style="font-size: 0.8rem; color: var(--text-muted);">Siswa:</div>
                <div id="valTitleStudent" style="font-weight: 600;">-</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Judul Diajukan:</div>
                <div id="displayValTitle" style="font-weight: 500; font-style: italic;">-</div>
            </div>
            <div style="margin-bottom: 1rem;">
                <div style="font-size: 0.8rem; color: var(--text-muted);">Status Persetujuan:</div>
                <div id="displayValStatus" style="margin-top: 0.25rem;">-</div>
            </div>
            <div style="margin-bottom: 1.5rem;">
                <div style="font-size: 0.8rem; color: var(--text-muted);">Feedback / Catatan:</div>
                <div id="displayValFeedback"
                    style="margin-top: 0.25rem; padding: 0.75rem; background: #fff; border: 1px solid #e2e8f0; border-radius: 0.5rem; font-size: 0.9rem; min-height: 60px;">
                    -</div>
            </div>
            <div style="text-align: right; border-top: 1px solid #eee; padding-top: 1rem;">
                <button type="button" class="btn btn-primary" onclick="toggleTitleModal(false)"
                    style="width: auto; padding: 0.5rem 1.5rem;">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal Input Bimbingan/Monitoring -->
    <!-- Modal Bimbingan & Monitoring -->
    <div id="bimbinganModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 500px; padding: 2rem; border-radius: var(--radius); max-height: 90vh; overflow-y: auto;">
            <h3 id="bimbinganModalTitle" style="margin-bottom: 1.5rem;">Input Kegiatan Bimbingan</h3>
            <form id="bimbinganForm" style="display: flex; flex-direction: column; gap: 1.25rem;">
                <input type="hidden" id="bimId">
                <input type="hidden" id="bimPhotoUrl">

                <div class="form-group">
                    <label
                        style="font-weight: 700; color: var(--text-main); margin-bottom: 0.5rem; display: block;">Siswa
                        Bimbingan <span style="color: var(--danger);">*</span></label>
                    <div style="position: relative;">
                        <div id="studentDropdownTrigger" onclick="toggleStudentDropdown(event)"
                            style="width: 100%; padding: 0.75rem 1rem; background: rgba(255,255,255,0.05); border: 1.5px solid var(--glass-border); border-radius: 0.75rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;">
                            <span id="selectedCountDisplay" style="color: var(--text-muted); font-size: 0.9rem;">Pilih
                                minimal satu siswa</span>
                            <i class="fas fa-chevron-down" style="font-size: 0.8rem; color: var(--text-muted);"></i>
                        </div>

                        <div id="studentDropdownMenu" class="hidden"
                            style="position: absolute; top: 100%; left: 0; width: 100%; background: #1e293b; border: 1px solid var(--glass-border); border-radius: 0.75rem; margin-top: 0.5rem; z-index: 1100; box-shadow: 0 10px 25px rgba(0,0,0,0.3); overflow: hidden;">
                            <div
                                style="padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);">
                                <div style="position: relative;">
                                    <i class="fas fa-search"
                                        style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.85rem;"></i>
                                    <input type="text" id="studentSearchInput" placeholder="Cari nama atau NIS..."
                                        oninput="filterStudentList()"
                                        style="width: 100%; padding: 0.5rem 0.75rem 0.5rem 2.25rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; font-size: 0.85rem; color: var(--text-main);">
                                </div>
                            </div>
                            <div id="bimNisChecklist" style="max-height: 250px; overflow-y: auto; padding: 0.5rem;">
                                <!-- Students loaded dynamically -->
                                <div
                                    style="padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.85rem;">
                                    Memuat data...</div>
                            </div>
                        </div>
                    </div>
                    <div id="selectedStudentsList"
                        style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem;">
                        <!-- Selected tags here -->
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label
                            style="font-weight: 700; color: var(--text-main); margin-bottom: 0.5rem; display: block;">Tanggal
                            <span style="color: var(--danger);">*</span></label>
                        <input type="date" id="bimTanggal" required
                            style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1.5px solid var(--glass-border); border-radius: 0.75rem; color: var(--text-main);">
                    </div>
                    <div class="form-group">
                        <label
                            style="font-weight: 700; color: var(--text-main); margin-bottom: 0.5rem; display: block;">Jenis
                            Kegiatan <span style="color: var(--danger);">*</span></label>
                        <select id="bimJenis" required
                            style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1.5px solid var(--glass-border); border-radius: 0.75rem; color: var(--text-main);">
                            <option value="Bimbingan Laporan">Bimbingan Laporan</option>
                            <option value="Monitoring PKL" selected>Monitoring PKL</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label
                        style="font-weight: 700; color: var(--text-main); margin-bottom: 0.5rem; display: block;">Deskripsi
                        / Pembahasan <span style="color: var(--danger);">*</span></label>
                    <textarea id="bimDeskripsi" required placeholder="Tuliskan detail bimbingan atau monitoring..."
                        style="width: 100%; min-height: 120px; padding: 0.75rem 1rem; background: rgba(255,255,255,0.05); border: 1.5px solid var(--glass-border); border-radius: 0.75rem; font-family: inherit; color: var(--text-main); line-height: 1.5; resize: vertical;"></textarea>
                </div>

                <div class="form-group">
                    <label
                        style="font-weight: 700; color: var(--text-main); margin-bottom: 0.5rem; display: block;">Bukti
                        Foto (Opsional)</label>
                    <div
                        style="display: flex; gap: 1.25rem; align-items: start; background: rgba(255,255,255,0.02); padding: 1rem; border-radius: 0.75rem; border: 1px dashed var(--glass-border);">
                        <div id="bimPhotoPreview"
                            style="width: 100px; height: 100px; background: rgba(255,255,255,0.05); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1.5px solid var(--glass-border);">
                            <span style="color: var(--text-muted); font-size: 0.75rem; font-weight: 600;">PREVIEW</span>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 0.5rem;">
                            <input type="file" id="bimPhotoInput" accept="image/*"
                                style="font-size: 0.85rem; color: var(--text-muted); width: 100%;">
                            <p style="font-size: 0.7rem; color: var(--text-muted); font-style: italic;">Format: JPG, PNG
                                (Max 5MB). Foto dikompres otomatis.</p>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="btn glass" onclick="toggleBimbinganModal(false)"
                        style="flex: 1; padding: 0.85rem; border-radius: 0.75rem;">Batal</button>
                    <button type="submit" id="btnSaveBimbingan" class="btn btn-primary"
                        style="flex: 2; padding: 0.85rem; border-radius: 0.75rem; font-weight: 700; box-shadow: 0 4px 15px rgba(var(--primary-rgb), 0.3);">
                        <i class="fas fa-save" style="margin-right: 0.5rem;"></i> Simpan Kegiatan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detail Bimbingan -->
    <div id="viewBimbinganModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass" style="width: 90%; max-width: 500px; padding: 2rem; border-radius: var(--radius);">
            <h3 style="margin-bottom: 1.5rem; color: var(--primary);">Detail Bimbingan</h3>
            <div id="viewBimbinganContent">
                <!-- Data injected here -->
            </div>
            <div style="margin-top: 2rem; text-align: right;">
                <button class="btn btn-primary" onclick="toggleViewBimbinganModal(false)">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1100; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 400px; max-height: 90vh; padding: 2rem; border-radius: var(--radius); position: relative; overflow-y: auto; overflow-x: hidden;">
            <button class="btn-close" onclick="toggleProfileModal(false)"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            <h3 id="profModalTitle" style="margin-bottom: 1.5rem; text-align: center;">Profil Saya</h3>

            <!-- 1. View State -->
            <div id="profViewContent">
                <div class="profile-avatar-wrapper" style="cursor: default;">
                    <img id="profViewAvatar" src="" alt="Avatar" class="avatar-large" referrerpolicy="no-referrer"
                        onerror="this.src='https://ui-avatars.com/api/?name=Guru&background=random'">
                </div>
                <div style="display: grid; gap: 0.75rem; margin-bottom: 2rem;">
                    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem;">
                        <label style="font-size: 0.7rem; color: var(--text-muted); display: block;">NAMA</label>
                        <div id="pViewNama" style="font-weight: 500;">-</div>
                    </div>
                    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem;">
                        <label style="font-size: 0.7rem; color: var(--text-muted); display: block;">USERNAME</label>
                        <div id="pViewUser">-</div>
                    </div>
                    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem;">
                        <label style="font-size: 0.7rem; color: var(--text-muted); display: block;">NIP</label>
                        <div id="pViewNip">-</div>
                    </div>
                    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem;">
                        <label style="font-size: 0.7rem; color: var(--text-muted); display: block;">KONTAK</label>
                        <div id="pViewKontak">-</div>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <button class="btn btn-primary" onclick="switchProfileState('edit')" style="width: 100%;"><i
                            class="fas fa-edit"></i> Edit Profil</button>
                    <button class="btn" onclick="switchProfileState('password')"
                        style="width: 100%; background: #f1f5f9;"><i class="fas fa-key"></i> Ganti Password</button>
                </div>
            </div>

            <!-- 2. Edit Profile State -->
            <div id="profEditContent" class="hidden">
                <div class="profile-avatar-wrapper" onclick="document.getElementById('profilePhotoInput').click()"
                    title="Klik untuk ubah foto">
                    <img id="profModalAvatar" src="" alt="Avatar" class="avatar-large" referrerpolicy="no-referrer"
                        onerror="this.src='https://ui-avatars.com/api/?name=Guru&background=random'">
                    <div class="overlay"><i class="fas fa-camera"></i></div>
                    <input type="file" id="profilePhotoInput" hidden accept="image/*"
                        onchange="handleAvatarPreview(this)">
                </div>
                <form id="profileForm" onsubmit="saveProfile(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="profUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Kontak (WhatsApp)</label>
                        <input type="text" id="profEditKontak" placeholder="Contoh: 0812...">
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn" onclick="switchProfileState('view')"
                            style="background: #e2e8f0; flex: 1;">Batal</button>
                        <button type="submit" class="btn btn-primary" id="btnSaveProfile"
                            style="flex: 2;">Simpan</button>
                    </div>
                </form>
            </div>

            <!-- 3. Change Password State -->
            <div id="profPassContent" class="hidden">
                <form id="passForm" onsubmit="savePassword(event)">
                    <div class="form-group">
                        <label>Password Lama</label>
                        <div class="password-wrapper">
                            <input type="password" id="profOldPass" required placeholder="Masukkan password saat ini">
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordVisibility('profOldPass')">
                                <i id="toggleIcon-profOldPass" class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Password Baru</label>
                        <div class="password-wrapper">
                            <input type="password" id="profNewPass" required placeholder="Masukkan password baru">
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordVisibility('profNewPass')">
                                <i id="toggleIcon-profNewPass" class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn" onclick="switchProfileState('view')"
                            style="background: #e2e8f0; flex: 1;">Batal</button>
                        <button type="submit" class="btn btn-primary" id="btnSavePassword" style="flex: 2;">Update
                            Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        const user = AUTH.checkSession();
        if (!user || user.role !== 'guru') window.location.href = '../index.html';

        const showToast = (msg, type) => API.showNotification(msg, type === 'danger' ? 'error' : type);

        // --- Helpers ---
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;
            return d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function formatWhatsApp(number) {
            if (!number) return '-';
            let clean = number.toString().replace(/\D/g, '');
            if (clean.startsWith('0')) clean = '62' + clean.substring(1);
            if (!clean.startsWith('62')) clean = '62' + clean;
            return `<a href="https://wa.me/${clean}" target="_blank" style="color: #25D366; text-decoration: none;"><i class="fab fa-whatsapp"></i> ${number}</a>`;
        }

        function getDriveThumbnail(urlOrId) {
            if (!urlOrId) return '';
            let id = urlOrId;
            if (urlOrId.includes('id=')) {
                id = urlOrId.split('id=')[1].split('&')[0];
            } else if (urlOrId.includes('/d/')) {
                id = urlOrId.split('/d/')[1].split('/')[0];
            }
            return `https://drive.google.com/thumbnail?id=${id}&sz=w600`;
        }

        // --- Navigation ---

        // --- Data Loading & Shared Logic ---
        let cachedAssignedStudents = []; // List of student objects assigned to this guru

        async function getAssignedStudents() {
            const currentUser = AUTH.getUser();
            const gurusRes = await API.getData('LOGINGURU');
            const dbGuru = gurusRes.data.find(g => g.username === currentUser.username);
            const nip = dbGuru ? dbGuru.nip : null;

            if (!nip) {
                showToast('NIP Guru tidak ditemukan!', 'danger');
                return [];
            }

            const [paks, siswas, locations, guruMaster, evals, judulRes] = await Promise.all([
                API.getData('DATAPKL'),
                API.getData('DATASISWA'),
                API.getData('LOKASIPKL'),
                API.getData('DATAGURU'),
                API.getData('EVALUASI'),
                API.getData('JUDULLAPORAN')
            ]);

            const assignedPKL = paks.data.filter(p => p.ID_GURU === nip);

            cachedAssignedStudents = assignedPKL.map(st => {
                const s = siswas.data.find(siswa => siswa.nis === st.nis) || { nama: st.nis, kelas: '-' };
                const currentIdPkl = st.ID_PKL_3 || st.ID_PKL_2 || st.ID_PKL;
                const location = locations.data.find(l => l.ID_PKL === currentIdPkl);
                const gMaster = guruMaster.data.find(g => g.ID_GURU === st.ID_GURU);
                const evaluation = evals.data.find(e => e.NIS === st.nis);
                const judul = judulRes.data.find(j => j.NIS === st.nis);

                const pklHistory = [];
                if (st.ID_PKL) pklHistory.push(st.ID_PKL);
                if (st.ID_PKL_2) pklHistory.push(st.ID_PKL_2);
                if (st.ID_PKL_3) pklHistory.push(st.ID_PKL_3);

                return {
                    ...s,
                    pkl: st,
                    location: location,
                    currentIdPkl: currentIdPkl,
                    pklHistory: pklHistory,
                    evaluation: evaluation,
                    judul: judul,
                    guru: {
                        name: gMaster ? gMaster.NamaGuru : '-',
                        contact: dbGuru ? dbGuru.kontak : '-'
                    }
                };
            });

            return cachedAssignedStudents;
        }

        async function loadMonitoringData() {
            const tbody = document.getElementById('monitoringTableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Memuat data...</td></tr>';

            try {
                const students = await getAssignedStudents();
                if (students.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">Belum ada siswa yang dibimbing.</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                students.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #f1f5f9';
                    tr.innerHTML = `
                        <td data-label="Siswa" style="padding: 1rem;">
                            <div style="font-weight: 700; color: #fff; font-size: 0.95rem;">${s.nama}</div>
                            <div style="font-size: 0.75rem; color: var(--electric-blue); font-weight: 600; letter-spacing: 0.05em;">NIS: ${s.nis}</div>
                        </td>
                        <td data-label="Kelas" style="padding: 1rem;">
                            <div style="font-weight: 600; color: var(--text-main);">${s.kelas}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); opacity: 0.8;">${s.jurusan}</div>
                        </td>
                        <td data-label="Aksi" style="padding: 1rem; text-align: right;">
                            <button class="btn" style="width: auto; padding: 0.4rem 1rem; background: rgba(59, 130, 246, 0.1); color: var(--primary); border-radius: 0.5rem; font-size: 0.85rem;" onclick="openViewStudent('${s.nis}')" title="Lihat Detail">
                                <i class="fas fa-eye" style="margin-right:0.25rem;"></i> Detail
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--danger);">Gagal memuat data.</td></tr>';
            }
        }

        async function loadAttendanceData() {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Memuat data...</td></tr>';

            try {
                const [students, attRes] = await Promise.all([
                    getAssignedStudents(),
                    API.getData('KEHADIRAN')
                ]);

                const nisList = students.map(s => s.nis);
                const myAtt = attRes.data.filter(a => nisList.includes(a.NIS));

                if (myAtt.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);">Belum ada data absensi.</td></tr>';
                    return;
                }

                myAtt.sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal));

                tbody.innerHTML = '';
                myAtt.forEach(a => {
                    const s = students.find(stu => stu.nis === a.NIS);
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #f1f5f9';
                    tr.innerHTML = `
                        <td data-label="Tanggal" style="padding: 1rem;">${formatDate(a.Tanggal)}</td>
                        <td data-label="Siswa" style="padding: 1rem;"><strong>${s ? s.nama : a.NIS}</strong></td>
                        <td data-label="Waktu" style="padding: 1rem;">${a.time_in || '-'} / ${a.time_out || '-'}</td>
                        <td data-label="Status" style="padding: 1rem;">
                            <span class="badge" style="background:var(--success); color:white; padding: 0.2rem 0.6rem; border-radius:1rem; font-size:0.75rem;">${a.StatusAbsen}</span>
                        </td>
                        <td data-label="Lokasi" style="padding: 1rem;">
                            <a href="https://www.google.com/maps?q=${a.lat},${a.lng}" target="_blank" style="color:var(--primary); text-decoration:none;"><i class="fas fa-map-marker-alt"></i> Lihat Map</a>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--danger);">Gagal memuat data.</td></tr>';
            }
        }

        async function loadReportTitlesData() {
            const tbody = document.getElementById('titlesTableBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Memuat data...</td></tr>';

            try {
                const [students, titlesRes] = await Promise.all([
                    getAssignedStudents(),
                    API.getData('JUDULLAPORAN')
                ]);

                const nisList = students.map(s => s.nis);
                const myTitles = titlesRes.data.filter(t => nisList.includes(t.NIS));

                if (myTitles.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);">Belum ada ajuan judul laporan.</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                myTitles.forEach(t => {
                    const s = students.find(stu => stu.nis === t.NIS);
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #f1f5f9';

                    let statusColor = '#94a3b8';
                    if (t.status === 'Disetujui') statusColor = 'var(--success)';
                    else if (t.status === 'Revisi') statusColor = 'var(--warning)';
                    else if (t.status === 'Ditolak') statusColor = 'var(--danger)';

                    tr.innerHTML = `
                        <td data-label="Siswa" style="padding: 1rem;">
                            <div style="font-weight: 600;">${s ? s.nama : t.NIS}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">NIS: ${t.NIS}</div>
                        </td>
                        <td data-label="Judul" style="padding: 1rem; max-width: 300px;">${t.JudulAjuan}</td>
                        <td data-label="Status" style="padding: 1rem;">
                            <span class="badge" style="background:${statusColor}; color:white; padding: 0.2rem 0.6rem; border-radius:1rem; font-size:0.75rem;">${t.status || 'Pending'}</span>
                        </td>
                        <td data-label="Feedback" style="padding: 1rem; font-size:0.85rem;">${t.feedback || '-'}</td>
                        <td data-label="Aksi" style="padding: 1rem;">
                            <button class="btn btn-primary" style="width:auto; padding:0.4rem 0.6rem; background: #e0f2fe; color: #0ea5e9;" onclick="openTitleValidation('${t.ID_Judul}')"><i class="fas fa-eye"></i> Detail</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                window.currentTitles = myTitles;
            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--danger);">Gagal memuat data.</td></tr>';
            }
        }

        function toggleTitleModal(show) {
            const modal = document.getElementById('titleModal');
            modal.classList.toggle('hidden', !show);
            modal.style.display = show ? 'flex' : 'none';
        }

        function openTitleValidation(id) {
            const t = window.currentTitles.find(item => item.ID_Judul === id);
            if (!t) return;

            const student = cachedAssignedStudents.find(s => s.nis === t.NIS);
            document.getElementById('valTitleStudent').textContent = student ? student.nama : t.NIS;
            document.getElementById('displayValTitle').textContent = t.JudulAjuan;

            const statusBadge = document.getElementById('displayValStatus');
            let statusColor = '#94a3b8';
            if (t.status === 'Disetujui') statusColor = 'var(--success)';
            else if (t.status === 'Revisi') statusColor = 'var(--warning)';
            else if (t.status === 'Ditolak') statusColor = 'var(--danger)';

            statusBadge.innerHTML = `<span class="badge" style="background:${statusColor}; color:white; padding: 0.2rem 0.6rem; border-radius:1rem; font-size:0.75rem;">${t.status || 'Pending'}</span>`;
            document.getElementById('displayValFeedback').textContent = t.feedback || 'Tidak ada catatan.';

            toggleTitleModal(true);
        }

        // --- Modals & Initialization ---
        function toggleViewStudentModal(show) {
            const modal = document.getElementById('viewStudentModal');
            modal.classList.toggle('hidden', !show);
            modal.style.display = show ? 'flex' : 'none';
        }

        function openViewStudent(nis) {
            const s = cachedAssignedStudents.find(item => item.nis == nis);
            if (!s) return;

            const content = document.getElementById('viewStudentContent');
            const sectionStyle = "margin-bottom: 2rem; background: #f8fafc; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #e2e8f0;";
            const headerStyle = "font-weight: bold; font-size: 1.1rem; color: var(--primary); margin-bottom: 1rem; border-bottom: 2px solid #cbd5e1; padding-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;";
            const gridStyle = "display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.9rem;";

            content.innerHTML = `
                <div style="${sectionStyle}">
                    <div style="${headerStyle}"><i class="fas fa-id-card"></i> Data Siswa</div>
                    <div style="${gridStyle}">
                        <div><strong style="color:var(--text-muted)">NIS:</strong><br>${s.nis}</div>
                        <div><strong style="color:var(--text-muted)">Nama Lengkap:</strong><br>${s.nama}</div>
                        <div><strong style="color:var(--text-muted)">NIK:</strong><br>${s.NIK || '-'}</div>
                        <div><strong style="color:var(--text-muted)">Jurusan:</strong><br>${s.jurusan}</div>
                        <div><strong style="color:var(--text-muted)">Kelas:</strong><br>${s.kelas}</div>
                        <div><strong style="color:var(--text-muted)">Kontak:</strong><br>${formatWhatsApp(s.KontakSiswa)}</div>
                    </div>
                </div>
                <div style="${sectionStyle}">
                    <div style="${headerStyle}"><i class="fas fa-building"></i> Data Tempat PKL</div>
                    <div style="${gridStyle}">
                        <div style="grid-column: span 2;"><strong style="color:var(--text-muted)">Nama Tempat:</strong><br>${s.location ? s.location.NamaTempat : 'Belum Ditentukan'}</div>
                        <div style="grid-column: span 2;"><strong style="color:var(--text-muted)">Alamat:</strong><br>${s.location ? s.location.Alamat : '-'}</div>
                        <div><strong style="color:var(--text-muted)">Mentor:</strong><br>${s.location ? s.location.NamaMentor : '-'}</div>
                        <div><strong style="color:var(--text-muted)">Kontak Mentor:</strong><br>${formatWhatsApp(s.location ? s.location.KontakMentor : '-')}</div>
                    </div>
                </div>
                <div style="${sectionStyle}">
                    <div style="${headerStyle}"><i class="fas fa-calendar-alt"></i> Periode PKL</div>
                    <div style="${gridStyle}">
                        <div><strong style="color:var(--text-muted)">Tanggal Mulai:</strong><br>${formatDate(s.pkl.StartDate)}</div>
                        <div><strong style="color:var(--text-muted)">Tanggal Selesai:</strong><br>${formatDate(s.pkl.EndDate)}</div>
                    </div>
                </div>
                <div style="${sectionStyle}">
                    <div style="${headerStyle}"><i class="fas fa-user-tie"></i> Pembimbing</div>
                    <div style="${gridStyle}">
                        <div><strong style="color:var(--text-muted)">Guru Pembimbing:</strong><br>${s.guru.name}</div>
                        <div><strong style="color:var(--text-muted)">Kontak Guru:</strong><br>${formatWhatsApp(s.guru.contact)}</div>
                    </div>
                </div>
            `;
            toggleViewStudentModal(true);
        }


        async function loadBimbinganData() {
            const container = document.getElementById('bimbinganDataContainer');
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Memuat data...</div>';

            try {
                const [bimRes, stuRes] = await Promise.all([
                    API.getData('BIMBINGAN'),
                    API.getData('DATASISWA')
                ]);

                if (bimRes.status !== 'success' || stuRes.status !== 'success') throw new Error('Gagal mengambil data');

                // Filter bimbingan by assigned students
                const myBimbingan = bimRes.data.filter(b =>
                    cachedAssignedStudents.some(s => s.nis === b.NIS)
                ).sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal));

                window.currentBimbingan = myBimbingan;
                window.allStudentsData = stuRes.data;

                if (myBimbingan.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">Belum ada data bimbingan/monitoring.</div>';
                    return;
                }

                renderBimbingan(myBimbingan);
            } catch (err) {
                console.error(err);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--danger);">Gagal memuat data.</div>';
            }
        }

        function renderBimbingan(data) {
            const container = document.getElementById('bimbinganDataContainer');
            container.innerHTML = `<div class="card-grid">` + data.map(b => {
                const student = window.allStudentsData ? window.allStudentsData.find(s => s.nis === b.NIS) : null;
                const isMonitoring = b.Jenis_keg === 'Monitoring PKL';

                return `
                    <div class="glass-card fade-in" style="padding: 1rem; border: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="display: flex; gap: 0.75rem; align-items: center;">
                                <div class="logo-circle" style="width: 36px; height: 36px; background: rgba(${isMonitoring ? 'var(--primary-rgb)' : '99, 102, 241'}, 0.08); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas ${isMonitoring ? 'fa-video' : 'fa-clipboard-check'}" style="color: ${isMonitoring ? 'var(--primary)' : '#6366f1'}; font-size: 1rem;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; color: var(--text-main); font-size: 0.95rem; line-height: 1.2;">${student ? student.nama : b.NIS}</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 500;">${formatDate(b.Tanggal)}</div>
                                </div>
                            </div>
                            <span style="font-size: 0.65rem; padding: 2px 8px; border-radius: 6px; background: ${isMonitoring ? 'rgba(var(--primary-rgb), 0.1)' : 'rgba(99, 102, 241, 0.1)'}; color: ${isMonitoring ? 'var(--primary)' : '#6366f1'}; font-weight: 700; border: 1px solid currentColor; white-space: nowrap;">${b.Jenis_keg}</span>
                        </div>

                        <div style="font-size: 0.85rem; color: var(--text-main); line-height: 1.4; opacity: 0.85; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.4rem;">
                            ${b.Deskripsi}
                        </div>

                        <div style="display: flex; gap: 0.5rem; margin-top: 0.25rem;">
                            <button class="btn glass" style="flex: 1; padding: 0.5rem; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.4rem; border-radius: 0.6rem;" onclick="viewBimbinganDetail('${b.ID_BIMBINGAN}')">
                                <i class="fas fa-eye"></i> Detail
                            </button>
                            <button class="btn" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: rgba(239, 68, 68, 0.1); color: var(--danger); border-radius: 0.6rem; padding: 0;" onclick="deleteBimbingan('${b.ID_BIMBINGAN}')" title="Hapus">
                                <i class="fas fa-trash" style="font-size: 0.85rem;"></i>
                            </button>
                        </div>
                    </div>`;
            }).join('') + `</div>`;
        }

        function toggleBimbinganModal(show) {
            const modal = document.getElementById('bimbinganModal');
            modal.classList.toggle('hidden', !show);
            modal.style.display = show ? 'flex' : 'none';
            if (!show) {
                document.getElementById('bimbinganForm').reset();
                document.getElementById('bimPhotoPreview').innerHTML = '<span style="color: var(--text-muted); font-size: 0.75rem; font-weight: 600;">PREVIEW</span>';
                document.getElementById('bimPhotoUrl').value = '';
                document.getElementById('selectedCountDisplay').textContent = 'Pilih minimal satu siswa';
                document.getElementById('selectedStudentsList').innerHTML = '';
                document.getElementById('studentDropdownMenu').classList.add('hidden');
                document.getElementById('studentSearchInput').value = '';
            }
        }

        function toggleStudentDropdown(e) {
            if (e) e.stopPropagation();
            const menu = document.getElementById('studentDropdownMenu');
            menu.classList.toggle('hidden');
            if (!menu.classList.contains('hidden')) {
                document.getElementById('studentSearchInput').focus();
            }
        }

        function updateSelectedCount() {
            const checkedCheckboxes = Array.from(document.querySelectorAll('input[name="bimNis"]:checked'));
            const nises = checkedCheckboxes.map(cb => cb.value);

            const display = document.getElementById('selectedCountDisplay');
            const listDisplay = document.getElementById('selectedStudentsList');

            if (nises.length === 0) {
                display.textContent = 'Pilih minimal satu siswa';
                display.style.color = 'var(--text-muted)';
                listDisplay.innerHTML = '';
            } else {
                display.textContent = `${nises.length} Siswa Terpilih`;
                display.style.color = 'var(--text-main)';

                const selectedNames = checkedCheckboxes.map(cb => {
                    const label = cb.nextElementSibling;
                    return label ? label.textContent.split(' (')[0] : 'Siswa';
                });

                listDisplay.innerHTML = selectedNames.map(name => `
                    <div style="background: rgba(var(--primary-rgb), 0.15); color: var(--primary-light); padding: 0.3rem 0.75rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600; border: 1px solid rgba(var(--primary-rgb), 0.3); display: flex; align-items: center; gap: 0.4rem;">
                        <i class="fas fa-check-circle" style="font-size: 0.7rem;"></i> ${name}
                    </div>
                `).join('');
            }
        }

        function filterStudentList() {
            const query = document.getElementById('studentSearchInput').value.toLowerCase();
            const items = document.querySelectorAll('.student-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? 'flex' : 'none';
            });
        }

        function openBimbinganModal() {
            toggleBimbinganModal(true);
            document.getElementById('bimbinganModalTitle').textContent = 'Input Kegiatan Bimbingan';
            document.getElementById('bimId').value = '';
            document.getElementById('bimPhotoUrl').value = '';
            document.getElementById('bimTanggal').value = new Date().toISOString().split('T')[0];

            const checklist = document.getElementById('bimNisChecklist');
            checklist.innerHTML = '';
            if (window.cachedAssignedStudents && window.cachedAssignedStudents.length > 0) {
                checklist.innerHTML = window.cachedAssignedStudents.map(s => `
                    <div class="student-item" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; cursor: pointer; border-radius: 0.6rem; transition: background 0.2s;" onclick="this.querySelector('input').click()">
                        <input type="checkbox" name="bimNis" value="${s.nis}" id="chk_${s.nis}" 
                            style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); filter: drop-shadow(0 0 5px rgba(var(--primary-rgb), 0.3));" 
                            onclick="event.stopPropagation(); updateSelectedCount()" onchange="updateSelectedCount()">
                        <label for="chk_${s.nis}" style="font-size: 0.85rem; cursor: pointer; flex: 1; color: var(--text-main);">${s.nama} (${s.nis})</label>
                    </div>
                `).join('');
            } else {
                checklist.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.85rem;">Tidak ada siswa bimbingan yang terdaftar.</div>';
            }
        }

        document.getElementById('bimPhotoInput').onchange = async function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const preview = document.getElementById('bimPhotoPreview');
            preview.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const compressed = await API.compressImage(file);
                // Preview locally first
                const reader = new FileReader();
                reader.onload = (event) => {
                    preview.innerHTML = `<img src="${event.target.result}" style="max-width:100%; max-height:100%; object-fit:contain;">`;
                };
                reader.readAsDataURL(compressed);

                // Upload to Drive
                const res = await API.uploadFile(compressed);
                if (res.status === 'success') {
                    document.getElementById('bimPhotoUrl').value = res.url;
                } else {
                    showToast('Gagal upload foto', 'danger');
                    preview.innerHTML = '<span style="color: var(--danger);">Upload Gagal</span>';
                }
            } catch (err) {
                console.error(err);
                showToast('Gagal memproses foto', 'danger');
                preview.innerHTML = '<span style="color: var(--danger);">Error</span>';
            }
        };

        function toggleViewBimbinganModal(show) {
            const modal = document.getElementById('viewBimbinganModal');
            modal.classList.toggle('hidden', !show);
            modal.style.display = show ? 'flex' : 'none';
        }

        async function viewBimbinganDetail(id) {
            const b = window.currentBimbingan.find(item => item.ID_BIMBINGAN === id);
            if (!b) return;

            const content = document.getElementById('viewBimbinganContent');
            const student = cachedAssignedStudents.find(s => s.nis === b.NIS);

            content.innerHTML = `
                <div style="display: grid; gap: 1rem; font-size: 0.95rem;">
                    <div><strong style="color:var(--text-muted)">Siswa:</strong><br>${student ? student.nama : b.NIS} (${b.NIS})</div>
                    <div><strong style="color:var(--text-muted)">Tanggal:</strong><br>${formatDate(b.Tanggal)}</div>
                    <div><strong style="color:var(--text-muted)">Jenis Kegiatan:</strong><br><span class="badge" style="background:var(--primary); color:white;">${b.Jenis_keg}</span></div>
                    <div><strong style="color:var(--text-muted)">Deskripsi:</strong><br><div style="background:#f8fafc; padding:1rem; border-radius:0.5rem; border:1px solid #e2e8f0; white-space:pre-wrap;">${b.Deskripsi}</div></div>
                    <div><strong style="color:var(--text-muted)">Bukti Foto:</strong><br>
                        ${(b.Photo || b.photo) ? `<img src="${getDriveThumbnail(b.Photo || b.photo)}" style="width:100%; border-radius:0.5rem; margin-top:0.5rem; border:1px solid #e2e8f0;" onerror="this.src='https://placehold.co/400x300?text=Foto+Gagal+Dimuat'">` : '<div style="padding:1rem; background:#f1f5f9; border-radius:0.5rem; text-align:center; color:var(--text-muted);">Tidak ada foto</div>'}
                    </div>
                </div>
            `;
            toggleViewBimbinganModal(true);
        }

        async function deleteBimbingan(id) {
            if (!confirm('Hapus data bimbingan ini?')) return;
            try {
                const res = await API.deleteData('BIMBINGAN', id);
                if (res.status === 'success') {
                    showToast('Berhasil dihapus', 'success');
                    loadBimbinganData();
                } else {
                    showToast('Gagal: ' + res.error, 'danger');
                }
            } catch (err) {
                showToast('Kesalahan jaringan', 'danger');
            }
        }

        function editBimbingan(id) {
            const b = window.currentBimbingan.find(item => item.ID_BIMBINGAN === id);
            if (!b) return;

            openBimbinganModal();
            document.getElementById('bimbinganModalTitle').textContent = 'Edit Kegiatan Bimbingan';
            document.getElementById('bimId').value = b.ID_BIMBINGAN;

            // Check correct student checkbox
            document.querySelectorAll('input[name="bimNis"]').forEach(cb => {
                cb.checked = (cb.value === b.NIS);
            });

            document.getElementById('bimTanggal').value = b.Tanggal.split('T')[0];
            document.getElementById('bimJenis').value = b.Jenis_keg;
            document.getElementById('bimDeskripsi').value = b.Deskripsi;

            // Photo Edit State
            const photoUrl = b.Photo || b.photo;
            if (photoUrl) {
                document.getElementById('bimPhotoUrl').value = photoUrl;
                document.getElementById('bimPhotoPreview').innerHTML = `<img src="${getDriveThumbnail(photoUrl)}" style="max-width:100%; max-height:100%; object-fit:contain;">`;
            }
        }

        document.getElementById('bimbinganForm').onsubmit = async (e) => {
            e.preventDefault();
            const checkedSiswa = Array.from(document.querySelectorAll('input[name="bimNis"]:checked')).map(cb => cb.value);
            if (checkedSiswa.length === 0) {
                showToast('Pilih minimal satu siswa', 'warning');
                return;
            }

            const tanggal = document.getElementById('bimTanggal').value;
            const jenis = document.getElementById('bimJenis').value;
            const deskripsi = document.getElementById('bimDeskripsi').value;
            const photo = document.getElementById('bimPhotoUrl').value;
            const btn = document.getElementById('btnSaveBimbingan');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

            try {
                const currentUser = AUTH.getUser();

                // Save entries for each selected student
                const promises = checkedSiswa.map(nis => {
                    const data = {
                        ID_BIMBINGAN: 'BIM-' + Date.now() + '-' + Math.floor(Math.random() * 1000),
                        NIS: nis,
                        Tanggal: tanggal,
                        Jenis_keg: jenis,
                        Deskripsi: deskripsi,
                        Pelaksana: currentUser.nama,
                        Photo: photo
                    };
                    return API.postData('BIMBINGAN', data);
                });

                const results = await Promise.all(promises);
                const allSuccess = results.every(r => r.status === 'success');

                if (allSuccess) {
                    showToast(`${checkedSiswa.length} data bimbingan disimpan!`, 'success');
                    toggleBimbinganModal(false);
                    loadBimbinganData();
                } else {
                    showToast('Beberapa data gagal disimpan', 'warning');
                }
            } catch (err) {
                console.error(err);
                showToast('Kesalahan sistem', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Simpan';
            }
        };

        // --- Profile Logic ---
        function toggleProfileModal(show) {
            const modal = document.getElementById('profileModal');
            modal.classList.toggle('hidden', !show);
            modal.style.display = show ? 'flex' : 'none';
        }

        function switchProfileState(state) {
            const title = document.getElementById('profModalTitle');
            const view = document.getElementById('profViewContent');
            const edit = document.getElementById('profEditContent');
            const pass = document.getElementById('profPassContent');

            view.classList.add('hidden');
            edit.classList.add('hidden');
            pass.classList.add('hidden');

            if (state === 'view') {
                title.textContent = 'Profil Saya';
                view.classList.remove('hidden');
            } else if (state === 'edit') {
                title.textContent = 'Edit Profil';
                edit.classList.remove('hidden');
            } else if (state === 'password') {
                title.textContent = 'Ganti Password';
                pass.classList.remove('hidden');
            }
        }

        async function openProfileModal() {
            const currentUser = AUTH.getUser();
            document.getElementById('pViewNama').textContent = currentUser.nama;
            document.getElementById('pViewUser').textContent = currentUser.username;

            try {
                const res = await API.getData('LOGINGURU');
                const dbUser = res.data.find(u => u.username === currentUser.username);
                if (dbUser) {
                    document.getElementById('pViewNip').textContent = dbUser.nip || '-';
                    document.getElementById('pViewKontak').textContent = dbUser.kontak || '-';
                    document.getElementById('profUsername').value = dbUser.username || '';
                    document.getElementById('profEditKontak').value = dbUser.kontak || '';
                }
            } catch (e) { console.error(e); }

            const fallbackUrl = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(currentUser.nama) + '&background=random';
            const avatarSrc = currentUser.photo ? getDriveThumbnail(currentUser.photo) : fallbackUrl;
            const setAvatarWithFallback = (el) => { el.onerror = function () { this.onerror = null; this.src = fallbackUrl; }; el.src = avatarSrc; };
            setAvatarWithFallback(document.getElementById('profViewAvatar'));
            setAvatarWithFallback(document.getElementById('profModalAvatar'));

            switchProfileState('view');
            toggleProfileModal(true);
        }

        function handleAvatarPreview(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('profModalAvatar').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function saveProfile(event) {
            event.preventDefault();
            const btn = document.getElementById('btnSaveProfile');
            const newUsername = document.getElementById('profUsername').value;
            const newKontak = document.getElementById('profEditKontak').value;
            const photoFile = document.getElementById('profilePhotoInput').files[0];

            btn.disabled = true;
            btn.textContent = 'Menyimpan...';

            try {
                const currentUser = AUTH.getUser();
                const updateData = {};
                if (newUsername !== currentUser.username) updateData.username = newUsername;
                if (newKontak !== document.getElementById('pViewKontak').textContent) updateData.kontak = newKontak;

                if (photoFile) {
                    const compressed = await API.compressImage(photoFile);
                    const uploaded = await API.uploadFile(compressed);
                    if (uploaded.status === 'success') updateData.photo = uploaded.url;
                }

                if (Object.keys(updateData).length === 0) {
                    showToast('Tidak ada perubahan.', 'info');
                    switchProfileState('view');
                    return;
                }

                const res = await API.updateProfile('guru', currentUser.username, updateData);
                if (res.status === 'success') {
                    showToast('Profil diperbarui!', 'success');
                    const session = JSON.parse(localStorage.getItem('pkl_session'));
                    Object.assign(session, updateData);
                    localStorage.setItem('pkl_session', JSON.stringify(session));
                    updateUserUI();
                    openProfileModal();
                } else {
                    showToast('Gagal: ' + res.message, 'danger');
                }
            } catch (err) {
                showToast('Kesalahan: ' + err.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Simpan';
            }
        }

        async function savePassword(event) {
            event.preventDefault();
            const btn = document.getElementById('btnSavePassword');
            const oldPass = document.getElementById('profOldPass').value;
            const newPass = document.getElementById('profNewPass').value;

            btn.disabled = true;
            btn.textContent = 'Memproses...';

            try {
                const currentUser = AUTH.getUser();
                const res = await API.getData('LOGINGURU');
                const dbUser = res.data.find(u =>
                    (u.username || "").toString().trim().toLowerCase() ===
                    (currentUser.username || "").toString().trim().toLowerCase()
                );

                if (!dbUser || (oldPass || "").toString().trim() !== (dbUser.password || "").toString().trim()) {
                    showToast('Password lama salah!', 'danger');
                    return;
                }

                const updateRes = await API.updateProfile('guru', currentUser.username, { password: newPass });
                if (updateRes.status === 'success') {
                    showToast('Password diganti!', 'success');
                    switchProfileState('view');
                    document.getElementById('passForm').reset();
                } else {
                    showToast('Gagal: ' + updateRes.message, 'danger');
                }
            } catch (err) {
                showToast('Kesalahan: ' + err.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Update Password';
            }
        }

        updateUserUI();
        updateClock();
        setInterval(updateClock, 1000);
        showSection('home');
    </script>
</body>

</html>