<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Dashboard Siswa - SIMAK NESBU</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Leaflet for Map Picker -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @media print {

            .sidebar,
            .mobile-header,
            .bottom-nav,
            .no-print {
                display: none !important;
            }

            .main-content {
                margin: 0 !important;
                padding: 0 !important;
            }
        }
    </style>
    <script>
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('active');
                document.body.classList.toggle('sidebar-open', sidebar.classList.contains('active'));
            }
        }


        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById('toggleIcon-' + inputId);
            if (input.type === 'password') {
                input.type = 'text';
                if (icon) icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                if (icon) icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }
    </script>
</head>

<body class="dashboard light-theme">
    <header class="mobile-header">
        <div style="display: flex; align-items: center; gap: 0.85rem;">
            <div class="logo-circle">
                <img src="https://blogger.googleusercontent.com/img/a/AVvXsEj0gidDMAxs79SkpgBW6-nRy7SLq7ytNTzeXSLp8-sX5SKhlCY7JHDHr7BNvJ9nTF8YgHbB_kubuvfYzX4t4ONGFDfoL2-AMa8mgK29o6XGebiHkSMgiO2BoXpv0fATKQ9XMf-RPWGbqrr_KQ1iVX3JeWYh9JGXR43QSWxyIa2o-qeJR9S0_8dxANpck08"
                    alt="Logo"
                    style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 5px rgba(var(--primary-rgb), 0.3));">
            </div>
            <div style="display: flex; flex-direction: column;">
                <span class="text-gradient"
                    style="font-weight: 800; font-size: 1.1rem; line-height: 1; font-family: 'Outfit', sans-serif;">SIMAK</span>
                <span
                    style="font-size: 0.7rem; color: var(--text-muted); font-weight: 700; letter-spacing: 0.1em; opacity: 0.8;">NESBU</span>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="profile-dropdown-container">
                <div class="header-profile" onclick="toggleProfileDropdown(event)"
                    style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <img src="" alt="" id="headerAvatar"
                        style="width: 36px; height: 36px; border-radius: 12px; border: 1.5px solid var(--glass-border); object-fit: cover; display: none;">
                    <div id="headerAvatarPlaceholder"
                        style="width: 36px; height: 36px; border-radius: 12px; background: var(--glass-bg); display: flex; align-items: center; justify-content: center; border: 1.5px solid var(--glass-border);">
                        <i class="fas fa-user" style="color: var(--primary-light); font-size: 1.1rem;"></i>
                    </div>
                </div>

                <div id="profileDropdown" class="profile-dropdown">
                    <div class="dropdown-item" onclick="openProfileModal('edit')">
                        <i class="fas fa-user-edit"></i> Edit Profil
                    </div>
                    <div class="dropdown-item" onclick="openProfileModal('password')">
                        <i class="fas fa-key"></i> Ganti Password
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="showPage('my-data')">
                        <i class="fas fa-id-card"></i> Data Saya
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item danger" onclick="AUTH.logout()">
                        <i class="fas fa-sign-out-alt"></i> Keluar
                    </div>
                </div>
            </div>
        </div>
    </header>

    <aside class="sidebar glass" id="sidebar">
        <div class="user-profile" onclick="openProfileModal()">
            <img src="" alt="Avatar" class="avatar" id="userAvatar" referrerpolicy="no-referrer">
            <div>
                <h4 id="userName" class="text-gradient">Siswa Name</h4>
                <p id="userRole" style="font-size: 0.75rem; color: var(--text-muted); font-weight: 600;">SISWA</p>
            </div>
        </div>

        <div class="sidebar-content">
            <ul class="sidebar-menu">
                <li><a href="#" id="nav-overview" class="active" onclick="showPage('overview')"><i
                            class="fas fa-home"></i> Beranda</a></li>
                <li><a href="#" id="nav-attendance" onclick="showPage('attendance')"><i
                            class="fas fa-calendar-check"></i> Kehadiran</a></li>
                <li><a href="#" id="nav-journal" onclick="showPage('journal')"><i class="fas fa-book"></i> Jurnal
                        Harian</a></li>
                <li><a href="#" id="nav-submission" onclick="showPage('submission')"><i class="fas fa-paper-plane"></i>
                        Pengajuan PKL</a></li>
                <li><a href="#" id="nav-report-title" onclick="showPage('report-title')"><i class="fas fa-file-alt"></i>
                        Pengajuan Judul</a></li>
                <li><a href="#" id="nav-my-data" onclick="showPage('my-data')"><i class="fas fa-user-circle"></i> Data
                        Saya</a></li>
                <li><a href="#" id="nav-info-pkl" onclick="showPage('info-pkl')"><i class="fas fa-info-circle"></i> Info
                        PKL</a></li>
                <li><a href="#" id="nav-evaluation" onclick="showPage('evaluation')"><i class="fas fa-star"></i> Status
                        Penilaian</a></li>
                <li style="margin-top: 2rem;"><a href="#" onclick="AUTH.logout()" style="color: var(--danger);"><i
                            class="fas fa-sign-out-alt"></i> Keluar</a></li>
            </ul>
        </div>
        <div class="sidebar-footer">
            <div style="font-size: 0.65rem; margin-top: 0.25rem; opacity: 0.5;">&copy; 2026 SIMAK NESBU VERSION 2.0
            </div>
        </div>
    </aside>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()" aria-hidden="true"></div>

    <nav class="bottom-nav">
        <ul class="bottom-nav-list">
            <li><a href="#" class="bottom-nav-link active" id="bnav-overview" onclick="showPage('overview')"><i
                        class="fas fa-th-large"></i><span>Home</span></a></li>
            <li><a href="#" class="bottom-nav-link" id="bnav-attendance" onclick="showPage('attendance')"><i
                        class="fas fa-camera"></i><span>Absen</span></a></li>
            <li><a href="#" class="bottom-nav-link" id="bnav-journal" onclick="showPage('journal')"><i
                        class="fas fa-edit"></i><span>Jurnal</span></a></li>
            <li><a href="#" class="bottom-nav-link" id="bnav-info-pkl" onclick="showPage('info-pkl')"><i
                        class="fas fa-info-circle"></i><span>Info</span></a></li>
            <li><a href="#" class="bottom-nav-link" id="bnav-my-data" onclick="showPage('my-data')"><i
                        class="fas fa-user-circle"></i><span>Profil</span></a></li>
        </ul>
    </nav>

    <main class="main-content">
        <header>
            <div>
                <h2 id="pageTitle" class="text-gradient"
                    style="font-family: 'Outfit', sans-serif; font-size: 2rem; font-weight: 800;">Beranda</h2>
                <div id="currentTime"
                    style="font-weight: 600; color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem;"></div>
            </div>
        </header>

        <!-- Overview Page -->
        <div id="overviewPage" class="content-page">
            <!-- Interactive Banner Slider -->
            <div class="banner-container">
                <div class="banner-track" id="bannerSlider">
                    <!-- Slide 1: Status -->
                    <div class="banner-card">
                        <div
                            style="font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">
                            Status Siswa</div>
                        <h3 id="bannerWelcomeName"
                            style="font-family: 'Outfit', sans-serif; margin: 0.5rem 0; font-weight: 800;">-</h3>
                        <div class="glass"
                            style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 2rem; font-size: 0.7rem; font-weight: 700; color: var(--primary);">
                            SISWA AKTIF</div>
                    </div>
                    <!-- Slide 2: Tempat PKL -->
                    <div class="banner-card">
                        <div
                            style="font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">
                            Tempat PKL</div>
                        <h3 id="bannerLocationName"
                            style="font-family: 'Outfit', sans-serif; margin: 0.5rem 0; font-weight: 800; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            Memuat...</h3>
                        <p id="bannerLocationAddr"
                            style="font-size: 0.75rem; color: var(--text-muted); line-height: 1.2;">-</p>
                    </div>
                    <!-- Slide 3: Progres -->
                    <div class="banner-card">
                        <div
                            style="font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">
                            Progres PKL</div>
                        <div
                            style="display: flex; align-items: center; justify-content: space-between; margin: 0.5rem 0;">
                            <span id="bannerProgressPercent"
                                style="font-size: 1.5rem; font-weight: 800; font-family: 'Outfit', sans-serif;">0%</span>
                            <i class="fas fa-chart-line" style="color: var(--success); font-size: 1.25rem;"></i>
                        </div>
                        <div
                            style="width: 100%; height: 8px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden;">
                            <div id="bannerProgressBar"
                                style="width: 0%; height: 100%; background: var(--primary); transition: width 1s ease-out;">
                            </div>
                        </div>
                    </div>
                    <!-- Slide 4: Periode -->
                    <div class="banner-card">
                        <div
                            style="font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">
                            Periode PKL</div>
                        <div style="margin: 0.5rem 0;">
                            <div style="font-size: 0.85rem; font-weight: 700;" id="bannerPeriodText">-</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;"
                                id="bannerDaysLeft">- hari tersisa</div>
                        </div>
                    </div>
                </div>

                <div class="banner-dots" id="bannerDots">
                    <div class="banner-dot active" onclick="goToSlide(0)"></div>
                    <div class="banner-dot" onclick="goToSlide(1)"></div>
                    <div class="banner-dot" onclick="goToSlide(2)"></div>
                    <div class="banner-dot" onclick="goToSlide(3)"></div>
                </div>
            </div>

            <!-- Dual-View Section: Attendance & Journal (Moved Inside overviewPage) -->
            <div class="glass-card" style="margin-top: 2rem; padding: 1.5rem 0.5rem;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 0 1.25rem; margin-bottom: 1rem;">
                    <h3 style="font-family: 'Outfit', sans-serif; font-size: 1.1rem; margin: 0;"><i
                            class="fas fa-layer-group" style="color: var(--primary);"></i> Aktivitas PKL</h3>
                    <div
                        style="font-size: 0.7rem; color: var(--text-muted); font-weight: 700; display: flex; align-items: center; gap: 0.4rem;">
                        <span>GESER</span> <i class="fas fa-arrows-left-right"></i>
                    </div>
                </div>

                <div class="dual-view-container">
                    <!-- Panel 1: Kehadiran -->
                    <div class="view-panel">
                        <div style="padding: 0 1.25rem;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span style="font-size: 0.85rem; font-weight: 800; color: var(--text-main);">TABEL
                                    PRESENSI</span>
                            </div>
                            <div id="homeAttTable" class="glass"
                                style="border-radius: 1rem; overflow: hidden; background: rgba(0,0,0,0.02);">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                                    <thead>
                                        <tr style="background: rgba(var(--primary-rgb), 0.05); text-align: left;">
                                            <th style="padding: 0.75rem; color: var(--text-muted);">TANGGAL</th>
                                            <th style="padding: 0.75rem; color: var(--text-muted);">MASUK</th>
                                            <th style="padding: 0.75rem; color: var(--text-muted);">PULANG</th>
                                            <th style="padding: 0.75rem; color: var(--text-muted);">ST</th>
                                        </tr>
                                    </thead>
                                    <tbody id="homeAttBody">
                                        <!-- Data will be populated by loadDashboardData -->
                                        <tr>
                                            <td colspan="4"
                                                style="padding: 2rem; text-align: center; color: var(--text-muted);">
                                                Memuat presensi...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Panel 2: Jurnal -->
                    <div class="view-panel">
                        <div style="padding: 0 1.25rem;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span style="font-size: 0.85rem; font-weight: 800; color: var(--text-main);">JURNAL
                                    TERBARU</span>
                            </div>
                            <div id="homeJournalFeed" style="display: flex; flex-direction: column; gap: 0.75rem;">
                                <!-- Data will be populated by loadDashboardData -->
                                <div
                                    style="padding: 2rem; text-align: center; color: var(--text-muted); font-size: 0.75rem;">
                                    Memuat jurnal...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Aktivitas PKL Summary END -->

            <div class="launcher-grid fade-in">
                <div class="launcher-item" onclick="showPage('attendance')">
                    <i class="fas fa-camera"></i>
                    <span>Absensi</span>
                </div>
                <div class="launcher-item" onclick="showPage('journal')">
                    <i class="fas fa-edit"></i>
                    <span>Jurnal</span>
                </div>
                <div class="launcher-item" onclick="showPage('submission')">
                    <i class="fas fa-paper-plane"></i>
                    <span>Pengajuan</span>
                </div>
                <div class="launcher-item" onclick="showPage('report-title')">
                    <i class="fas fa-file-signature"></i>
                    <span>Judul Laporan</span>
                </div>
                <div class="launcher-item" onclick="showPage('my-data')">
                    <i class="fas fa-user-circle"></i>
                    <span>Data Saya</span>
                </div>
                <div class="launcher-item" onclick="showPage('info-pkl')">
                    <i class="fas fa-info-circle"></i>
                    <span>Info PKL</span>
                </div>
                <div class="launcher-item" onclick="showPage('evaluation')">
                    <i class="fas fa-chart-bar"></i>
                    <span>Penilaian</span>
                </div>
                <div class="launcher-item" onclick="openProfileModal()">
                    <i class="fas fa-cog"></i>
                    <span>Pengaturan</span>
                </div>
            </div>

            <!-- Secondary Info (Optional/Small) -->
            <div style="margin-top: 2.5rem;">
                <div class="glass-card" style="padding: 1.25rem; display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-map-marker-alt" style="color: var(--primary-light); font-size: 1.25rem;"></i>
                    <div style="flex-grow: 1;">
                        <p
                            style="font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">
                            Lokasi PKL</p>
                        <p id="currentPKLLocation" style="font-weight: 700; font-size: 0.95rem;">Memuat...</p>
                    </div>
                </div>
            </div>

            <div class="glass-card" style="margin-top: 1.5rem; margin-bottom: 2rem;">
                <h3 style="display: flex; align-items: center; gap: 0.75rem; font-size: 1.1rem; margin-bottom: 1.5rem;">
                    <i class="fas fa-calendar-alt" style="color: var(--secondary-light);"></i> Event Mendatang
                </h3>
                <div id="homeEventList" style="display: grid; gap: 1.25rem;">
                    <p style="color: var(--text-muted); text-align: center; padding: 1.5rem; font-size: 0.9rem;">
                        <i class="fas fa-spinner fa-spin"></i> Memuat event...
                    </p>
                </div>
            </div>
        </div>

        <!-- Attendance Page -->
        <div id="attendancePage" class="content-page hidden">
            <!-- Tampilan ketika belum ada data PKL / belum menentukan tempat PKL -->
            <div id="attendanceContentUnavailable" class="hidden glass-card fade-in"
                style="padding: 4rem 2rem; text-align: center;">
                <div style="max-width: 400px; margin: 0 auto;">
                    <div class="logo-circle" style="width: 80px; height: 80px; margin: 0 auto 2rem; font-size: 2.5rem;">
                        <i class="fas fa-calendar-times" style="color: white;"></i>
                    </div>
                    <h2 style="margin-bottom: 1rem; font-family: 'Outfit', sans-serif;">Akses Dibatasi</h2>
                    <p style="color: var(--text-muted); font-size: 1rem; line-height: 1.6;">
                        Menu kehadiran belum tersedia. Anda perlu menyelesaikan <strong>Pengajuan PKL</strong>
                        dan mendapatkan persetujuan tempat PKL terlebih dahulu.
                    </p>
                    <button type="button" class="btn btn-primary" onclick="showPage('submission')"
                        style="margin-top: 2.5rem; width: 100%;">
                        <i class="fas fa-paper-plane"></i> Ke Pengajuan PKL
                    </button>
                </div>
            </div>

            <!-- Tampilan normal absensi -->
            <div id="attendanceContentAvailable" class="fade-in">
                <div class="glass-card" style="text-align: center; padding: 2.5rem 1.5rem;">
                    <h2 style="font-family: 'Outfit', sans-serif; font-size: 1.5rem; margin-bottom: 0.5rem;">
                        Presensi Kehadiran</h2>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 2.5rem;">Laporkan
                        status kehadiran Anda hari ini.</p>

                    <div id="attSelectionArea"
                        style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem;">
                        <button class="btn glass" id="btnStatusH" onclick="selectAttStatus('Hadir', this)"
                            style="flex-direction: column; gap: 0.75rem; padding: 1.5rem 1rem; border-radius: 1.5rem;">
                            <i class="fas fa-calendar-check" style="font-size: 1.75rem; color: var(--success);"></i>
                            <span style="font-size: 0.85rem; font-weight: 800;">HADIR</span>
                        </button>
                        <button class="btn glass" id="btnStatusS" onclick="selectAttStatus('Sakit', this)"
                            style="flex-direction: column; gap: 0.75rem; padding: 1.5rem 1rem; border-radius: 1.5rem;">
                            <i class="fas fa-heart-pulse" style="font-size: 1.75rem; color: var(--danger);"></i>
                            <span style="font-size: 0.85rem; font-weight: 800;">SAKIT</span>
                        </button>
                        <button class="btn glass" id="btnStatusI" onclick="selectAttStatus('Izin', this)"
                            style="flex-direction: column; gap: 0.75rem; padding: 1.5rem 1rem; border-radius: 1.5rem;">
                            <i class="fas fa-envelope-open-text" style="font-size: 1.75rem; color: var(--accent);"></i>
                            <span style="font-size: 0.85rem; font-weight: 800;">IZIN</span>
                        </button>
                        <button class="btn glass" id="btnStatusL" onclick="selectAttStatus('Libur', this)"
                            style="flex-direction: column; gap: 0.75rem; padding: 1.5rem 1rem; border-radius: 1.5rem;">
                            <i class="fas fa-umbrella-beach" style="font-size: 1.75rem; color: var(--secondary);"></i>
                            <span style="font-size: 0.85rem; font-weight: 800;">LIBUR</span>
                        </button>
                    </div>

                    <div id="statusAlert" class="hidden glass-card"
                        style="background: rgba(var(--primary-rgb), 0.05); margin-bottom: 2rem; border-color: rgba(var(--primary-rgb), 0.2);">
                        <div
                            style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; color: var(--primary-light);">
                            <i class="fas fa-info-circle"></i> <span id="statusAlertText"
                                style="font-weight: 600;">Mohon lampirkan surat keterangan.</span>
                        </div>
                        <div id="fileUploadOptions" class="hidden">
                            <button class="btn glass" onclick="triggerFilePicker()"
                                style="width: 100%; font-size: 0.8rem; background: rgba(255,255,255,0.05);">
                                <i class="fas fa-image"></i> Pilih Foto / Dokumen
                            </button>
                        </div>
                        <div id="selectedFileLabel" class="hidden"
                            style="margin-top: 0.75rem; color: var(--success); font-weight: 700; font-size: 0.85rem;">
                            <i class="fas fa-check-circle"></i> <span id="fileNameDisplay"></span>
                        </div>
                    </div>

                    <input type="file" id="fileGallery" class="hidden" accept="image/*"
                        onchange="handleFileSelect(event)">

                    <div id="locationStatus"
                        style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 2rem; padding: 0.85rem; background: rgba(255,255,255,0.03); border-radius: 1rem; border: 1px solid var(--glass-border);">
                        <i class="fas fa-location-arrow" style="color: var(--primary-light);"></i>
                        <span id="locStatusText"
                            style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted);">Mencari
                            lokasi...</span>
                        <button class="btn" onclick="getLocation()"
                            style="width: 32px; height: 32px; padding: 0; background: transparent; color: var(--primary-light);">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>

                    <button class="btn btn-primary" id="btnAbsenTrigger" onclick="startAttendance()"
                        style="width: 100%; height: 65px; font-size: 1.1rem; border-radius: 1.5rem;">
                        <i class="fas fa-camera"></i> <span id="btnAbsenText">ABSEN SEKARANG</span>
                    </button>
                </div>

                <div class="glass-card" style="margin-top: 2rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                        <h3 style="margin: 0; font-family: 'Outfit', sans-serif;"><i class="fas fa-history"
                                style="color: var(--secondary-light); margin-right: 0.5rem;"></i> Riwayat Pekan
                            Ini</h3>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn glass" onclick="exportAttendancePDF()"
                                style="padding: 0.6rem 1rem; font-size: 0.75rem;">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                    <div id="attHistoryList" class="card-list">
                        <div class="glass"
                            style="border-radius: 1rem; overflow: hidden; background: rgba(0,0,0,0.02); margin-top: 1rem;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                <thead>
                                    <tr style="background: rgba(var(--primary-rgb), 0.05); text-align: left;">
                                        <th style="padding: 1rem; color: var(--text-muted);">TANGGAL</th>
                                        <th style="padding: 1rem; color: var(--text-muted);">MASUK</th>
                                        <th style="padding: 1rem; color: var(--text-muted);">PULANG</th>
                                        <th style="padding: 1rem; color: var(--text-muted);">STATUS</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceHistoryBody">
                                    <tr>
                                        <td colspan="4"
                                            style="padding: 3rem; text-align: center; color: var(--text-muted);">Memuat
                                            riwayat...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Journal Page -->
        <div id="journalPage" class="content-page hidden">
            <div class="glass-card fade-in" style="margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div>
                        <h2 style="font-family: 'Outfit', sans-serif; font-size: 1.5rem; margin-bottom: 0.25rem;">Jurnal
                            Harian</h2>
                        <p style="color: var(--text-muted); font-size: 0.85rem;">Catat aktivitas PKL Anda setiap hari.
                        </p>
                    </div>
                    <button class="btn btn-primary" onclick="toggleJournalModal(true)"
                        style="width: 54px; height: 54px; border-radius: 18px; padding: 0; font-size: 1.25rem;">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>

                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="flex-grow: 1; min-width: 200px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <input type="month" id="journalMonthFilter"
                                style="background: rgba(255,255,255,0.05); font-weight: 700;">
                        </div>
                    </div>
                    <button class="btn glass" onclick="exportJournalPDF()"
                        style="background: rgba(var(--primary-rgb), 0.1); border-color: rgba(var(--primary-rgb), 0.2);">
                        <i class="fas fa-file-pdf" style="color: var(--danger);"></i> Cetak Laporan
                    </button>
                </div>
            </div>

            <!-- Journal Cards Area -->
            <div id="journalTableBody" class="card-list fade-in">
                <div style="display: flex; flex-direction: column; gap: 1rem;" id="journalFullFeed">
                    <div class="glass-card" style="text-align: center; padding: 4rem 2rem;">
                        <i class="fas fa-spinner fa-spin"
                            style="font-size: 2.5rem; color: var(--primary-light); margin-bottom: 1.5rem;"></i>
                        <p style="color: var(--text-muted); font-weight: 600;">Memuat data jurnal...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info PKL Page -->
        <div id="info-pklPage" class="content-page hidden">
            <div class="fade-in">
                <div class="glass-card" style="margin-bottom: 2rem;">
                    <h3
                        style="margin-bottom: 2rem; display: flex; align-items: center; gap: 0.85rem; font-family: 'Outfit', sans-serif; font-size: 1.4rem;">
                        <i class="fas fa-calendar-star" style="color: var(--secondary-light);"></i> Event & Kegiatan
                    </h3>
                    <div id="eventContainer"
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                        <p style="color: var(--text-muted); text-align: center; padding: 3rem;">
                            <i class="fas fa-spinner fa-spin"></i> Memuat event...
                        </p>
                    </div>
                </div>

                <div class="glass-card">
                    <h3
                        style="margin-bottom: 2rem; display: flex; align-items: center; gap: 0.85rem; font-family: 'Outfit', sans-serif; font-size: 1.4rem;">
                        <i class="fas fa-bullhorn" style="color: var(--accent);"></i> Pengumuman Penting
                    </h3>
                    <div id="infoContainer" class="card-list">
                        <p style="color: var(--text-muted); text-align: center; padding: 3rem;">
                            <i class="fas fa-spinner fa-spin"></i> Memuat pengumuman...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Title Page -->
        <div id="report-titlePage" class="content-page hidden">
            <div class="glass-card fade-in" style="max-width: 800px; margin: 0 auto;">
                <h3
                    style="margin-bottom: 2rem; display: flex; align-items: center; gap: 0.85rem; font-family: 'Outfit', sans-serif; font-size: 1.4rem;">
                    <i class="fas fa-file-signature" style="color: var(--primary-light);"></i> Pengajuan Judul Laporan
                </h3>

                <div id="reportTitleContent">
                    <form id="reportTitleForm" onsubmit="submitReportTitle(event)">
                        <div class="form-group">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Judul Laporan yang
                                Diajukan</label>
                            <textarea id="judulInput" required
                                placeholder="Contoh: Implementasi Sistem Manajemen Inventaris di PT. Sejahtera"
                                style="width: 100%; min-height: 120px; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.75rem; font-family: inherit;"></textarea>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                Pastikan judul mencerminkan kegiatan PKL Anda dan sudah dikonsultasikan sebelumnya.
                            </p>
                        </div>
                        <div style="margin-top: 2rem;">
                            <button type="submit" class="btn btn-primary" id="btnSubmitTitle"
                                style="width: 100%; padding: 1rem;">
                                <i class="fas fa-paper-plane"></i> Ajukan Judul Laporan
                            </button>
                        </div>
                    </form>
                </div>

                <div id="reportStatusRow" class="hidden"
                    style="margin-top: 2rem; padding: 2rem; border-radius: 1.5rem; background: rgba(255,255,255,0.02); border: 1px dashed var(--glass-border); text-align: center;">
                    <div id="reportStatusIcon" style="font-size: 2.5rem; margin-bottom: 1rem;"></div>
                    <h4 id="reportStatusBadge" style="font-size: 1.25rem; font-weight: 800; margin-bottom: 0.5rem;">-
                    </h4>
                    <p id="reportStatusMessage"
                        style="color: var(--text-muted); font-style: italic; margin-bottom: 1.5rem;">"-"</p>
                    <div
                        style="padding: 1rem; background: rgba(var(--primary-rgb), 0.05); border-radius: 1rem; text-align: left;">
                        <label style="color: var(--primary-light); font-size: 0.7rem;" id="reportProcessedBy">CATATAN
                            PEMBIMBING:</label>
                        <p id="repFeedback" style="font-size: 0.9rem; margin-top: 0.25rem;"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submission Page -->
        <div id="submissionPage" class="content-page hidden">
            <div class="glass-card fade-in" style="margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="font-family: 'Outfit', sans-serif; font-size: 1.5rem; margin-bottom: 0.25rem;">
                            Pengajuan PKL</h2>
                        <p style="color: var(--text-muted); font-size: 0.85rem;">Kelola pengajuan tempat PKL Anda.</p>
                    </div>
                    <button id="btnNewSubmission" class="btn btn-primary" onclick="toggleSubmissionModal(true)"
                        style="height: 50px; padding: 0 1.5rem; border-radius: 1rem;">
                        <i class="fas fa-plus"></i> <span class="hidden-xs">Buat Pengajuan</span>
                    </button>
                </div>
            </div>

            <div id="submissionLimitAlert" class="hidden glass-card fade-in"
                style="margin-bottom: 2rem; background: rgba(var(--danger), 0.1); border-color: rgba(var(--danger), 0.2); color: var(--danger);">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="limitAlertText" style="font-weight: 700;">Batas pengajuan telah tercapai.</span>
            </div>

            <div id="submissionTableBody" class="card-list fade-in">
                <div class="glass-card" style="text-align: center; padding: 4rem 2rem;">
                    <i class="fas fa-spinner fa-spin"
                        style="font-size: 2.5rem; color: var(--primary-light); margin-bottom: 1.5rem;"></i>
                    <p style="color: var(--text-muted); font-weight: 600;">Memuat riwayat pengajuan...</p>
                </div>
            </div>
        </div>

        <!-- My Data Page -->
        <div id="my-dataPage" class="content-page hidden">
            <div class="glass-card fade-in" style="max-width: 600px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem;"
                    id="myDataActions">
                    <h3
                        style="display: flex; align-items: center; gap: 0.85rem; font-family: 'Outfit', sans-serif; font-size: 1.4rem;">
                        <i class="fas fa-user-circle" style="color: var(--primary-light);"></i> Profil Saya
                    </h3>
                    <button id="btnEditMyData" class="btn glass" onclick="switchMyDataState('edit')"
                        style="padding: 0.5rem 1.25rem; font-size: 0.8rem; font-weight: 700;">
                        <i class="fas fa-edit"></i> Edit Profil
                    </button>
                </div>

                <div id="myDataViewSection">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 2rem;">
                        <div style="position: relative;">
                            <img id="myDataPhotoView" src="" alt="Avatar"
                                style="width: 140px; height: 140px; border-radius: 2.5rem; object-fit: cover; border: 4px solid var(--glass-border); box-shadow: var(--shadow-lg);"
                                onerror="this.src='https://ui-avatars.com/api/?name=Siswa&background=random'">
                            <div
                                style="position: absolute; bottom: -5px; right: -5px; width: 40px; height: 40px; background: var(--success); border-radius: 50%; border: 4px solid var(--bg-main); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow);">
                                <i class="fas fa-check" style="color: white; font-size: 1rem;"></i>
                            </div>
                        </div>

                        <div style="text-align: center;">
                            <h2 id="vDataNama"
                                style="font-family: 'Outfit', sans-serif; font-size: 1.75rem; font-weight: 800; margin-bottom: 0.25rem;">
                                -</h2>
                            <p id="vDataJurusanKelas" class="text-gradient" style="font-weight: 700; font-size: 1rem;">-
                            </p>
                        </div>

                        <div style="width: 100%; display: grid; gap: 1rem;">
                            <div class="glass-card"
                                style="padding: 1.25rem; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02);">
                                <span
                                    style="font-size: 0.8rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">NIS</span>
                                <span id="vDataNis" style="font-weight: 800; color: var(--text-main);">00000000</span>
                            </div>
                            <div class="glass-card"
                                style="padding: 1.25rem; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02);">
                                <span
                                    style="font-size: 0.8rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">NIK</span>
                                <span id="vDataNik" style="font-weight: 800; color: var(--text-main);">-</span>
                            </div>
                            <div class="glass-card" style="padding: 1.25rem; background: rgba(255,255,255,0.02);">
                                <span
                                    style="font-size: 0.8rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 0.5rem;">Tempat,
                                    Tanggal Lahir</span>
                                <span id="vDataTTL" style="font-weight: 800; color: var(--text-main);">-</span>
                            </div>
                            <div class="glass-card"
                                style="padding: 1.25rem; background: rgba(255,255,255,0.02); display: flex; justify-content: space-between; align-items: center;">
                                <span
                                    style="font-size: 0.8rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Golongan
                                    Darah</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span id="vDataGolDarah"
                                        style="font-weight: 800; color: var(--danger); font-size: 1.2rem;">-</span>
                                    <i class="fas fa-droplet" style="color: var(--danger);"></i>
                                </div>
                            </div>
                            <div class="glass-card" style="padding: 1.25rem; background: rgba(255,255,255,0.02);">
                                <span
                                    style="font-size: 0.8rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 0.5rem;">Informasi
                                    Kontak</span>
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <i class="fab fa-whatsapp" style="color: #25D366; font-size: 1.25rem;"></i>
                                    <span id="vDataKontak" style="font-weight: 700;">-</span>
                                </div>
                            </div>
                            <div class="glass-card" style="padding: 1.25rem; background: rgba(255,255,255,0.02);">
                                <span
                                    style="font-size: 0.8rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 0.5rem;">Orang
                                    Tua / Wali</span>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span id="vDataOrangtua" style="font-weight: 700;">-</span>
                                    <div style="font-size: 0.75rem; color: var(--text-muted); font-weight: 600;"
                                        id="vDataKontakOrtu">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Edit State (Hidden) -->
                <div id="myDataEditSection" class="hidden">
                    <form id="myDataEditForm" onsubmit="saveMyData(event)">
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <!-- Profile Photo Section -->
                            <div style="grid-column: 1 / -1; text-align: center; margin-bottom: 1rem;">
                                <div class="profile-avatar-wrapper"
                                    onclick="document.getElementById('myDataPhotoInput').click()"
                                    title="Klik untuk ubah foto">
                                    <img id="myDataPhotoPreview" src="" alt="Avatar" class="avatar-large"
                                        style="width: 120px; height: 120px;"
                                        onerror="this.src='https://placehold.co/120x120?text=Foto'">
                                    <div class="overlay"><i class="fas fa-camera"></i></div>
                                </div>
                                <input type="file" id="myDataPhotoInput" class="hidden" accept="image/*"
                                    onchange="previewMyDataPhoto(this)">
                                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Klik
                                    foto
                                    untuk mengganti</p>
                            </div>

                            <!-- Read-only Info -->
                            <div class="form-group">
                                <label>NIS</label>
                                <input type="text" id="myDataNis" readonly
                                    style="background: rgba(0,0,0,0.05); color: var(--text-muted);">
                            </div>
                            <div class="form-group">
                                <label>Nama Lengkap</label>
                                <input type="text" id="myDataNama" readonly
                                    style="background: rgba(0,0,0,0.05); color: var(--text-muted);">
                            </div>
                            <div class="form-group">
                                <label>NIK (16 Digit)</label>
                                <input type="text" id="myDataNik" maxlength="16" minlength="16"
                                    placeholder="Masukkan 16 digit NIK"
                                    oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            </div>
                            <div class="form-group">
                                <label>Jurusan</label>
                                <input type="text" id="myDataJurusan" readonly
                                    style="background: rgba(0,0,0,0.05); color: var(--text-muted);">
                            </div>
                            <div class="form-group">
                                <label>Kelas</label>
                                <input type="text" id="myDataKelas" readonly
                                    style="background: rgba(0,0,0,0.05); color: var(--text-muted);">
                            </div>

                            <!-- Editable fields -->
                            <div class="form-group">
                                <label>Tempat Lahir</label>
                                <input type="text" id="myDataTempatLahir" placeholder="Contoh: Bandung">
                            </div>
                            <div class="form-group">
                                <label>Tanggal Lahir</label>
                                <input type="date" id="myDataTanggalLahir">
                            </div>
                            <div class="form-group">
                                <label>Golongan Darah</label>
                                <select id="myDataGolDarah">
                                    <option value="-">Pilih</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="AB">AB</option>
                                    <option value="O">O</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Kontak Siswa (WhatsApp)</label>
                                <input type="tel" id="myDataKontakSiswa" placeholder="08xxxxxxxxxx">
                            </div>
                            <div class="form-group">
                                <label>Nama Orang Tua / Wali</label>
                                <input type="text" id="myDataNamaOrangtua" placeholder="Nama lengkap orang tua">
                            </div>
                            <div class="form-group">
                                <label>Kontak Orang Tua / Wali</label>
                                <input type="tel" id="myDataKontakOrangtua" placeholder="08xxxxxxxxxx">
                            </div>
                        </div>

                        <div style="margin-top: 2.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn"
                                style="width: auto; padding: 0.75rem 2rem; background: #f1f5f9;"
                                onclick="switchMyDataState('view')">Batal</button>
                            <button type="submit" class="btn btn-primary" id="btnSaveMyData"
                                style="width: auto; padding: 0.75rem 2rem;">Simpan Perubahan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Evaluation Page -->
        <div id="evaluationPage" class="content-page hidden">
            <div class="glass-card fade-in"
                style="margin-bottom: 2.5rem; display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 1.5rem;">
                <div>
                    <h2
                        style="font-family: 'Outfit', sans-serif; font-size: 1.75rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-star" style="color: var(--accent);"></i> Penilaian PKL
                    </h2>
                    <p style="color: var(--text-muted); font-size: 0.9rem;">Evaluasi performa Anda dari pembimbing
                        industri.</p>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button id="btnDownloadCert" class="btn btn-primary hidden" onclick="downloadCertificate()"
                        style="height: 48px; border-radius: 14px;">
                        <i class="fas fa-certificate"></i> Unduh Sertifikat
                    </button>
                    <button id="btnDownloadTemplateCert" class="btn glass" onclick="downloadCertificateTemplate()"
                        style="height: 48px; border-radius: 14px; background: rgba(255,255,255,0.02); font-size: 0.8rem;">
                        <i class="fas fa-file-download"></i> Template
                    </button>
                </div>
            </div>

            <div id="evaluationEmptyState" class="hidden glass-card fade-in"
                style="text-align: center; padding: 5rem 2rem;">
                <div class="logo-circle"
                    style="width: 80px; height: 80px; margin: 0 auto 2rem; background: rgba(255,255,255,0.03); color: var(--text-muted);">
                    <i class="fas fa-clipboard-check" style="font-size: 2.5rem;"></i>
                </div>
                <h3 style="font-family: 'Outfit', sans-serif;">Belum Ada Penilaian</h3>
                <p style="color: var(--text-muted); max-width: 400px; margin: 1rem auto 0; line-height: 1.6;">
                    Hasil evaluasi akan muncul di sini setelah pembimbing industri menyelesaikan penilaian performa
                    Anda.
                </p>
            </div>

            <div id="evaluationContent" class="hidden fade-in">
                <!-- Score Cards -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card glass-card">
                        <div
                            style="font-size: 0.7rem; color: var(--text-muted); font-weight: 800; text-transform: uppercase; margin-bottom: 1rem; letter-spacing: 0.05em;">
                            Softskill</div>
                        <div id="evalSoftskill" class="stat-value" style="font-size: 2.25rem;">0</div>
                        <div
                            style="width: 100%; height: 4px; background: var(--primary); margin-top: 1rem; border-radius: 2px; opacity: 0.3;">
                        </div>
                    </div>
                    <div class="stat-card glass-card">
                        <div
                            style="font-size: 0.7rem; color: var(--text-muted); font-weight: 800; text-transform: uppercase; margin-bottom: 1rem; letter-spacing: 0.05em;">
                            Technical</div>
                        <div id="evalTechnical" class="stat-value" style="font-size: 2.25rem;">0</div>
                        <div
                            style="width: 100%; height: 4px; background: var(--secondary); margin-top: 1rem; border-radius: 2px; opacity: 0.3;">
                        </div>
                    </div>
                    <div class="stat-card glass-card">
                        <div
                            style="font-size: 0.7rem; color: var(--text-muted); font-weight: 800; text-transform: uppercase; margin-bottom: 1rem; letter-spacing: 0.05em;">
                            Nilai Akhir</div>
                        <div id="evalPOS" class="stat-value text-gradient" style="font-size: 2.5rem;">0</div>
                        <div
                            style="width: 100%; height: 4px; background: var(--accent); margin-top: 1rem; border-radius: 2px; opacity: 0.3;">
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;">
                    <!-- Traits -->
                    <div class="glass-card">
                        <h3
                            style="margin-bottom: 2rem; display: flex; align-items: center; gap: 0.85rem; font-family: 'Outfit', sans-serif; font-size: 1.25rem;">
                            <i class="fas fa-chart-line" style="color: var(--primary-light);"></i> Karakter & Perilaku
                        </h3>
                        <div id="traitList" style="display: grid; gap: 1.5rem;">
                            <!-- Kedisiplinan -->
                            <div class="trait-item">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <span
                                        style="font-weight: 700; color: var(--text-muted); font-size: 0.85rem;">Kedisiplinan</span>
                                    <span id="labelDisiplin"
                                        style="font-weight: 800; color: var(--primary-light);">0/100</span>
                                </div>
                                <div
                                    style="height: 10px; background: rgba(255,255,255,0.03); border-radius: 10px; overflow: hidden; border: 1px solid var(--glass-border);">
                                    <div id="barDisiplin"
                                        style="width: 0%; height: 100%; background: var(--primary); box-shadow: 0 0 15px rgba(var(--primary-rgb), 0.5); transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);">
                                    </div>
                                </div>
                            </div>
                            <!-- Kerjasama -->
                            <div class="trait-item">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <span
                                        style="font-weight: 700; color: var(--text-muted); font-size: 0.85rem;">Kerjasama</span>
                                    <span id="labelKerjasama"
                                        style="font-weight: 800; color: var(--secondary-light);">0/100</span>
                                </div>
                                <div
                                    style="height: 10px; background: rgba(255,255,255,0.03); border-radius: 10px; overflow: hidden; border: 1px solid var(--glass-border);">
                                    <div id="barKerjasama"
                                        style="width: 0%; height: 100%; background: var(--secondary); box-shadow: 0 0 15px rgba(14, 165, 233, 0.5); transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);">
                                    </div>
                                </div>
                            </div>
                            <div class="trait-item">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <span
                                        style="font-weight: 700; color: var(--text-muted); font-size: 0.85rem;">Inisiatif</span>
                                    <span id="labelInisiatif"
                                        style="font-weight: 800; color: var(--accent);">0/100</span>
                                </div>
                                <div
                                    style="height: 10px; background: rgba(255,255,255,0.03); border-radius: 10px; overflow: hidden; border: 1px solid var(--glass-border);">
                                    <div id="barInisiatif"
                                        style="width: 0%; height: 100%; background: var(--accent); box-shadow: 0 0 15px rgba(245, 158, 11, 0.5); transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);">
                                    </div>
                                </div>
                            </div>
                            <div class="trait-item">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <span
                                        style="font-weight: 700; color: var(--text-muted); font-size: 0.85rem;">Kerajinan</span>
                                    <span id="labelKerajinan"
                                        style="font-weight: 800; color: var(--success);">0/100</span>
                                </div>
                                <div
                                    style="height: 10px; background: rgba(255,255,255,0.03); border-radius: 10px; overflow: hidden; border: 1px solid var(--glass-border);">
                                    <div id="barKerajinan"
                                        style="width: 0%; height: 100%; background: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.5); transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);">
                                    </div>
                                </div>
                            </div>
                            <div class="trait-item">
                                <div
                                    style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 500;">Tanggung Jawab</span>
                                    <span id="labelTanggungJawab"
                                        style="font-weight: 700; color: var(--primary-light);">0/100</span>
                                </div>
                                <div
                                    style="height: 6px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden;">
                                    <div id="barTanggungJawab"
                                        style="width: 0%; height: 100%; background: var(--primary); opacity: 0.8; transition: width 0.8s ease;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <!-- Attendance Stats -->
                        <div class="glass-card">
                            <h3
                                style="margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.75rem; font-size: 1.1rem;">
                                <i class="fas fa-user-clock" style="color: var(--secondary-light);"></i> Rekap
                                Kehadiran
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                <div
                                    style="text-align: center; padding: 1rem; background: rgba(239, 68, 68, 0.05); border-radius: 1rem; border: 1px solid rgba(239, 68, 68, 0.1);">
                                    <div
                                        style="font-size: 0.65rem; color: #fca5a5; font-weight: 700; text-transform: uppercase;">
                                        Sakit</div>
                                    <div id="evalSakit" style="font-size: 1.5rem; font-weight: 800; color: #fecaca;">0
                                    </div>
                                </div>
                                <div
                                    style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.05); border-radius: 1rem; border: 1px solid rgba(245, 158, 11, 0.1);">
                                    <div
                                        style="font-size: 0.65rem; color: #fcd34d; font-weight: 700; text-transform: uppercase;">
                                        Izin</div>
                                    <div id="evalIzin" style="font-size: 1.5rem; font-weight: 800; color: #fef08a;">0
                                    </div>
                                </div>
                                <div
                                    style="text-align: center; padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 1rem; border: 1px solid var(--glass-border);">
                                    <div
                                        style="font-size: 0.65rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">
                                        Alpa</div>
                                    <div id="evalAlpa"
                                        style="font-size: 1.5rem; font-weight: 800; color: var(--text-main);">0
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mentor Notes -->
                        <div class="glass-card" style="flex-grow: 1;">
                            <h3
                                style="margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.75rem; font-size: 1.1rem;">
                                <i class="fas fa-comment-dots" style="color: var(--warning);"></i> Catatan
                                Mentor
                            </h3>
                            <div id="evalCatatan"
                                style="font-style: italic; color: var(--text-muted); line-height: 1.6; background: rgba(245, 158, 11, 0.03); padding: 1.25rem; border-radius: 1rem; border-left: 3px solid var(--warning);">
                                "Belum ada catatan tambahan."
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Submission Modal -->
    <div id="submissionModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter: blur(12px); display:flex; align-items:center; justify-content:center; z-index: 2000; padding: 1rem; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass-card fade-in"
            style="width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative;">
            <button class="btn glass" onclick="toggleSubmissionModal(false)"
                style="position: absolute; top: 1.25rem; right: 1.25rem; width: 44px; height: 44px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);">&times;</button>
            <h3
                style="margin-bottom: 2.5rem; display: flex; align-items: center; gap: 0.85rem; font-family: 'Outfit', sans-serif; font-size: 1.5rem;">
                <i class="fas fa-paper-plane" style="color: var(--primary-light);"></i> Form Pengajuan PKL
            </h3>

            <form id="formSubmission" onsubmit="submitPKLApplication(event)">
                <div style="margin-bottom: 2rem;">
                    <label
                        style="font-size: 0.75rem; font-weight: 800; display: block; margin-bottom: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Jenis
                        Tempat PKL</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <button type="button" class="btn glass active" id="typeExist"
                            onclick="toggleSubmissionType('exist')"
                            style="border-radius: 1.25rem; padding: 1rem; font-weight: 700;">Terdaftar</button>
                        <button type="button" class="btn glass" id="typeNew" onclick="toggleSubmissionType('new')"
                            style="border-radius: 1.25rem; padding: 1rem; font-weight: 700;">Usul Baru</button>
                    </div>
                </div>

                <div id="areaExist" style="margin-bottom: 2rem;">
                    <label
                        style="font-size: 0.75rem; font-weight: 800; display: block; margin-bottom: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Pilih
                        Instansi</label>
                    <div class="form-group" style="position: relative;">
                        <select id="subLocId"
                            style="width: 100%; height: 60px; padding: 0 1.25rem; border-radius: 1.25rem; background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--glass-border); appearance: none; font-weight: 600;">
                            <option value="" style="background: #0f1423;">-- Pilih Tempat PKL --</option>
                        </select>
                        <i class="fas fa-chevron-down"
                            style="position: absolute; right: 1.25rem; top: 50%; translate: 0 -50%; pointer-events: none; color: var(--primary-light);"></i>
                    </div>
                </div>

                <div id="areaNew" class="hidden"
                    style="margin-bottom: 2rem; padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 1.5rem; border: 1px dashed var(--glass-border);">
                    <p
                        style="font-size: 0.8rem; color: var(--primary-light); font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-info-circle"></i> Detail Instansi Usulan
                    </p>
                    <div style="display: grid; gap: 1.25rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <input type="text" id="subNewNama" placeholder="Nama Perusahaan / Tempat *" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <input type="text" id="subNewBidang" placeholder="Bidang Usaha (IT, Otomotif, dll) *"
                                required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <textarea id="subNewAlamat" placeholder="Alamat Lengkap Perusahaan *" rows="3" required
                                style="resize: none;"></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <input type="text" id="subNewPimpinan" placeholder="Nama Pimpinan">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <input type="text" id="subNewMentor" placeholder="Nama Mentor">
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <input type="tel" id="subNewKontak" placeholder="No. WA Mentor (0812...)">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <input type="email" id="subNewEmail" placeholder="Email Perusahaan">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <input type="text" id="subNewDesc" placeholder="Deskripsi Singkat">
                            </div>
                        </div>

                        <div
                            style="margin-top: 0.5rem; padding: 1.25rem; background: rgba(var(--primary-rgb), 0.05); border-radius: 1.25rem; border: 1px solid rgba(var(--primary-rgb), 0.1);">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <label
                                    style="font-size: 0.7rem; font-weight: 800; color: var(--primary-light); text-transform: uppercase;">Koordinat
                                    Lokasi</label>
                                <span id="subCoordsDisplay"
                                    style="font-size: 0.7rem; font-family: monospace; opacity: 0.7; font-weight: 600;">Belum
                                    Terpilih</span>
                            </div>
                            <div class="form-group" style="margin-bottom: 0.75rem; position: relative;">
                                <input type="text" id="subMapSearch" placeholder="Cari alamat / lokasi..."
                                    style="padding-right: 3.5rem; height: 45px; font-size: 0.85rem; border-radius: 1rem;">
                                <button type="button" onclick="searchSubAddress()"
                                    style="position: absolute; right: 5px; top: 5px; bottom: 5px; width: 40px; background: var(--primary); border: none; border-radius: 0.75rem; color: white;">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div style="display: flex; gap: 0.75rem;">
                                <button type="button" class="btn glass" onclick="getCurrentSubLocation()"
                                    style="flex: 1; height: 45px; font-size: 0.8rem; background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.2); color: #10b981; border-radius: 1rem;"><i
                                        class="fas fa-location-dot"></i> GPS</button>
                                <button type="button" class="btn glass" onclick="subMap.invalidateSize()"
                                    style="flex: 1; height: 45px; font-size: 0.8rem; border-radius: 1rem;"><i
                                        class="fas fa-sync"></i> Refresh</button>
                            </div>
                            <div id="locationMapSub"
                                style="height: 350px; width: 100%; border-radius: 1.25rem; border: 1px solid var(--glass-border); margin-top: 1rem; z-index: 1;">
                            </div>
                            <input type="hidden" id="subNewLat">
                            <input type="hidden" id="subNewLng">
                        </div>
                    </div>
                </div>

                <div class="form-grid-mobile"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label
                            style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Mulai
                            PKL</label>
                        <input type="date" id="subStartDate" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label
                            style="font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Selesai
                            PKL</label>
                        <input type="date" id="subEndDate" required>
                    </div>
                </div>

                <div style="margin-bottom: 2.5rem;">
                    <label
                        style="font-size: 0.75rem; font-weight: 800; display: block; margin-bottom: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Rekan
                        Kelompok (Opsional)</label>
                    <div style="position: relative;" class="form-group">
                        <i class="fas fa-search"
                            style="position: absolute; left: 1.25rem; top: 50%; translate: 0 -50%; color: var(--primary-light);"></i>
                        <input type="text" id="studentSearch" placeholder="Cari Nama / NIS Teman..."
                            onfocus="showStudentList(true)" oninput="filterStudentList()"
                            onblur="showStudentList(false)" style="padding-left: 3.25rem !important;">
                        <div id="studentListDropdown" class="glass-card hidden"
                            style="position: absolute; top: 100%; left:0; width:100%; max-height: 250px; overflow-y: auto; z-index: 100; margin-top: 0.5rem; border-color: var(--primary-light); background: #0f1423;">
                        </div>
                    </div>
                    <div id="selectedStudentList"
                        style="display:flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 1rem;"></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.25rem;">
                    <button type="button" class="btn glass" onclick="toggleSubmissionModal(false)"
                        style="height: 60px; border-radius: 1.5rem; font-weight: 700;">Batal</button>
                    <button type="submit" class="btn btn-primary" id="btnSubmitFinal"
                        style="height: 60px; border-radius: 1.5rem; font-weight: 800; box-shadow: 0 8px 25px rgba(var(--primary-rgb), 0.4);">
                        KIRIM PENGAJUAN <i class="fas fa-paper-plane" style="margin-left: 0.5rem;"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Submission Modal -->
    <div id="viewSubmissionModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter: blur(12px); display:flex; align-items:center; justify-content:center; z-index: 2000; padding: 1rem; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass-card fade-in"
            style="width: 100%; max-width: 500px; border-radius: 2rem; position: relative; max-height: 90vh; overflow-y: auto;">
            <button class="btn glass" onclick="toggleViewSubmissionModal(false)"
                style="position: absolute; top: 1.25rem; right: 1.25rem; width: 44px; height: 44px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); transition: all 0.3s ease;">&times;</button>
            <h3 style="margin-bottom: 2rem; text-align: center; font-family: 'Outfit', sans-serif; font-size: 1.5rem;">
                <i class="fas fa-info-circle" style="color: var(--primary-light);"></i> Detail Pengajuan
            </h3>
            <div id="viewSubmissionContent" class="card-list">
                <!-- Populated by JS -->
            </div>
            <div style="margin-top: 2.5rem;">
                <button class="btn btn-primary" onclick="toggleViewSubmissionModal(false)"
                    style="width: 100%; height: 55px; border-radius: 1.25rem; font-weight: 700;">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter: blur(12px); display:flex; align-items:center; justify-content:center; z-index: 2000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass-card fade-in"
            style="width: 90%; max-width: 450px; max-height: 90vh; border-radius: 2rem; position: relative; overflow-y: auto;">
            <button class="btn glass" onclick="toggleProfileModal(false)"
                style="position: absolute; top: 1.25rem; right: 1.25rem; width: 44px; height: 44px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); transition: all 0.3s ease;">&times;</button>
            <h3 id="profModalTitle"
                style="margin-bottom: 2rem; text-align: center; font-family: 'Outfit', sans-serif; font-size: 1.5rem;">
                Profil Saya</h3>

            <!-- 1. View State -->
            <div id="profViewContent" class="fade-in">
                <div class="profile-avatar-wrapper" style="cursor: default; margin-bottom: 2.5rem;">
                    <img id="profViewAvatar" src="" alt="Avatar"
                        style="width: 120px; height: 120px; border-radius: 2.5rem; object-fit: cover; border: 4px solid var(--glass-border); box-shadow: var(--shadow-lg);"
                        onerror="this.src='https://ui-avatars.com/api/?name=Siswa&background=random'">
                </div>
                <div style="display: grid; gap: 1rem; margin-bottom: 2.5rem;">
                    <div class="glass-card"
                        style="padding: 1.25rem; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02);">
                        <span
                            style="font-size: 0.7rem; color: var(--text-muted); font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;">Nama
                            Lengkap</span>
                        <span id="pViewNama" style="font-weight: 700; color: var(--text-main);">-</span>
                    </div>
                    <div class="glass-card"
                        style="padding: 1.25rem; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02);">
                        <span
                            style="font-size: 0.7rem; color: var(--text-muted); font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;">Username</span>
                        <span id="pViewUser" class="text-gradient" style="font-weight: 800;">-</span>
                    </div>
                    <div class="glass-card"
                        style="padding: 1.25rem; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02);">
                        <span
                            style="font-size: 0.7rem; color: var(--text-muted); font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;">NIS</span>
                        <span id="pViewNis" style="font-weight: 700; color: var(--text-main);">-</span>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button class="btn btn-primary" onclick="switchProfileState('edit')"
                        style="width: 100%; height: 55px; border-radius: 1.25rem; font-weight: 700;">
                        <i class="fas fa-edit"></i> Edit Profil
                    </button>
                    <button class="btn glass" onclick="switchProfileState('password')"
                        style="width: 100%; height: 55px; border-radius: 1.25rem; font-weight: 700; background: rgba(255,255,255,0.05);">
                        <i class="fas fa-key"></i> Ganti Password
                    </button>
                </div>
            </div>

            <!-- 2. Edit Profile State -->
            <div id="profEditContent" class="hidden fade-in">
                <div class="profile-avatar-wrapper" onclick="document.getElementById('profilePhotoInput').click()"
                    title="Klik untuk ubah foto" style="margin-bottom: 2.5rem;">
                    <img id="profModalAvatar" src="" alt="Avatar" class="avatar-large"
                        onerror="this.src='https://ui-avatars.com/api/?name=Siswa&background=random'">
                    <div class="overlay"><i class="fas fa-camera"></i></div>
                    <input type="file" id="profilePhotoInput" hidden accept="image/*"
                        onchange="handleAvatarPreview(this)">
                </div>
                <form id="profileForm" onsubmit="saveProfile(event)" class="card-list">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="profUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Kontak (WhatsApp)</label>
                        <input type="text" id="profEditKontak" placeholder="Contoh: 0812...">
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn glass" onclick="switchProfileState('view')"
                            style="flex: 1; height: 55px; border-radius: 1.25rem; font-weight: 700;">Batal</button>
                        <button type="submit" class="btn btn-primary" id="btnSaveProfile"
                            style="flex: 2; height: 55px; border-radius: 1.25rem; font-weight: 700;">Simpan</button>
                    </div>
                </form>
            </div>

            <!-- 3. Change Password State -->
            <div id="profPassContent" class="hidden fade-in">
                <form id="passForm" onsubmit="savePassword(event)" class="card-list">
                    <div class="form-group">
                        <label>Password Lama</label>
                        <div class="password-wrapper">
                            <input type="password" id="profOldPass" required placeholder="Masukkan password saat ini">
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordVisibility('profOldPass')">
                                <i id="toggleIcon-profOldPass" class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Password Baru</label>
                        <div class="password-wrapper">
                            <input type="password" id="profNewPass" required placeholder="Masukkan password baru">
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordVisibility('profNewPass')">
                                <i id="toggleIcon-profNewPass" class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 2.5rem;">
                        <button type="button" class="btn glass" onclick="switchProfileState('view')"
                            style="flex: 1; height: 55px; border-radius: 1.25rem; font-weight: 700;">Batal</button>
                        <button type="submit" class="btn btn-primary" id="btnSavePassword"
                            style="flex: 2; height: 55px; border-radius: 1.25rem; font-weight: 700;">Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); backdrop-filter: blur(20px); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index: 3000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div
            style="position: relative; width: 100%; max-width: 500px; aspect-ratio: 3/4; background: #000; border-radius: 2.5rem; overflow: hidden; box-shadow: 0 0 100px rgba(0,0,0,0.8); border: 2px solid rgba(255,255,255,0.1);">
            <div id="cameraLoading"
                style="position: absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#0f172a; color:white; z-index: 3001;">
                <div style="text-align: center;">
                    <div class="logo-circle pulse-glow" style="margin: 0 auto 1.5rem;">
                        <i class="fas fa-camera"></i>
                    </div>
                    <p style="font-weight: 700; letter-spacing: 0.1em; opacity: 0.8;">MENYIAPKAN KAMERA...</p>
                </div>
            </div>

            <video id="video" autoplay playsinline
                style="width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); display: block;"></video>
            <canvas id="canvas" class="hidden"
                style="width: 100%; height: 100%; object-fit: cover; display: block;"></canvas>

            <div id="faceGuide"
                style="position: absolute; top: 50%; left: 50%; translate: -50% -50%; width: 75%; height: 60%; border: 3px dashed rgba(255,255,255,0.4); border-radius: 3rem; pointer-events: none; box-shadow: 0 0 0 1000px rgba(0,0,0,0.4);">
            </div>

            <div
                style="position: absolute; bottom: 40px; left: 0; width: 100%; display: flex; justify-content: center; align-items: center; gap: 40px; z-index: 3002;">
                <button id="btnCapture" class="btn-capture" title="Ambil Foto" onclick="capturePhoto()"
                    style="background: none; border: none; padding: 0; cursor: pointer;">
                    <div
                        style="width: 80px; height: 80px; border-radius: 50%; border: 4px solid white; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); transition: all 0.3s ease;">
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: white;"></div>
                    </div>
                </button>

                <button id="btnRetake" class="hidden btn glass" onclick="retakePhoto()"
                    style="height: 55px; padding: 0 2rem; border-radius: 2rem; font-weight: 700; background: rgba(255,255,255,0.15);"><i
                        class="fas fa-redo"></i> Ulangi</button>
            </div>

            <button onclick="closeCameraModal()"
                style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); color: white; border: 1px solid rgba(255,255,255,0.2); width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 3002;">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div id="captureAction" class="hidden fade-in"
            style="margin-top: 3rem; width: 100%; max-width: 500px; padding: 0 1.5rem;">
            <button id="btnSubmitAbsen" class="btn btn-primary" onclick="submitAttendance()"
                style="width: 100%; height: 65px; font-size: 1.25rem; font-weight: 800; border-radius: 1.75rem; background: var(--success); box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);">
                <i class="fas fa-check-circle"></i> KIRIM ABSENSI
            </button>
            <p
                style="text-align: center; color: rgba(255,255,255,0.7); margin-top: 1.5rem; font-size: 0.9rem; font-weight: 600;">
                Pastikan wajah terlihat jelas di dalam bingkai</p>
        </div>
    </div>

    <!-- Journal Modal -->
    <div id="journalModal" class="hidden"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 1rem; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass-card fade-in" style="width: 100%; max-width: 500px; border-radius: 2rem; position: relative;">
            <button class="btn glass" onclick="toggleJournalModal(false)"
                style="position: absolute; top: 1.25rem; right: 1.25rem; width: 44px; height: 44px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); transition: all 0.3s ease;">&times;</button>
            <h3 style="margin-bottom: 2rem; text-align: center; font-family: 'Outfit', sans-serif; font-size: 1.5rem;">
                <i class="fas fa-edit" style="color: var(--primary-light);"></i> Jurnal Harian
            </h3>
            <form id="journalForm" onsubmit="submitJournal(event)" class="card-list">
                <div class="form-group">
                    <label>Aktivitas Hari Ini</label>
                    <textarea id="journalActivity" required
                        placeholder="Apa yang Anda kerjakan atau pelajari hari ini? Jelaskan secara detail..."
                        style="min-height: 200px; line-height: 1.6;"></textarea>
                </div>
                <div style="margin-top: 2.5rem; display: grid; grid-template-columns: 1fr 2fr; gap: 1.25rem;">
                    <button type="button" class="btn glass" onclick="toggleJournalModal(false)"
                        style="height: 55px; border-radius: 1.25rem; font-weight: 700;">Batal</button>
                    <button type="submit" class="btn btn-primary" id="btnSubmitJournal"
                        style="height: 55px; border-radius: 1.25rem; font-weight: 800;">
                        KIRIM JURNAL <i class="fas fa-paper-plane" style="margin-left: 0.5rem;"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Detail Journal Modal -->
    <div id="journalDetailModal" class="hidden"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 1rem; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass-card fade-in" style="width: 100%; max-width: 500px; border-radius: 2rem; position: relative;">
            <button class="btn glass" onclick="toggleJournalDetailModal(false)"
                style="position: absolute; top: 1.25rem; right: 1.25rem; width: 44px; height: 44px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); transition: all 0.3s ease;">&times;</button>
            <h3
                style="margin-bottom: 2.5rem; text-align: center; font-family: 'Outfit', sans-serif; font-size: 1.5rem;">
                <i class="fas fa-book-open" style="color: var(--primary-light);"></i> Detail Jurnal
            </h3>
            <div style="max-height: 60vh; overflow-y: auto; padding-right: 0.5rem;" class="card-list">
                <div class="glass-card" style="padding: 1.25rem; background: rgba(255,255,255,0.02);">
                    <label
                        style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 800; letter-spacing: 0.05em; display: block; margin-bottom: 0.5rem;">Tanggal</label>
                    <div id="jdDate" style="font-weight: 700; color: var(--primary-light);">-</div>
                </div>
                <div class="glass-card" style="padding: 1.5rem; background: rgba(255,255,255,0.02);">
                    <label
                        style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 800; letter-spacing: 0.05em; display: block; margin-bottom: 1rem;">Aktivitas</label>
                    <div id="jdActivity"
                        style="line-height: 1.8; white-space: pre-wrap; color: var(--text-main); font-weight: 500;">-
                    </div>
                </div>
                <div id="jdFeedbackArea" class="hidden glass-card"
                    style="margin-top: 1rem; padding: 1.5rem; background: rgba(var(--primary-rgb), 0.05); border: 1px solid rgba(var(--primary-rgb), 0.2);">
                    <label
                        style="font-size: 0.7rem; color: var(--primary-light); text-transform: uppercase; font-weight: 800; letter-spacing: 0.05em; display: block; margin-bottom: 0.5rem;">Catatan
                        Pembimbing</label>
                    <div id="jdFeedback" style="color: var(--text-main); font-weight: 600; font-style: italic;">-</div>
                </div>
            </div>
            <div style="margin-top: 2.5rem;">
                <button class="btn btn-primary" onclick="toggleJournalDetailModal(false)"
                    style="width: 100%; height: 55px; border-radius: 1.25rem; font-weight: 700;">Tutup</button>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        const user = AUTH.checkSession();
        if (!user || user.role !== 'siswa') {
            window.location.href = '../index.html';
        }

        /** Cache: apakah siswa punya data PKL dan sudah punya tempat PKL (prioritas: ID_PKL_3 > ID_PKL_2 > ID_PKL) */
        let studentPklAvailability = null;

        async function ensureStudentPklAvailability() {
            if (studentPklAvailability !== null) return studentPklAvailability;
            try {
                const res = await API.getData('DATAPKL');
                const row = (res.data || []).find(s =>
                    (s.nis || '').toString().trim() === (user.nis || '').toString().trim()
                );
                const hasData = !!row;
                const activeId = (row && (row.ID_PKL_3 || row.ID_PKL_2 || row.ID_PKL))
                    ? (row.ID_PKL_3 || row.ID_PKL_2 || row.ID_PKL).toString().trim()
                    : '';
                const hasPlace = !!activeId;
                studentPklAvailability = { hasData, hasPlace, activeId };
            } catch (e) {
                console.error('Error cek DATAPKL:', e);
                studentPklAvailability = { hasData: false, hasPlace: false, activeId: '' };
            }
            return studentPklAvailability;
        }

        function updateAttendanceNavStyle(hasPlace) {
            const nav = document.getElementById('nav-attendance');
            if (!nav) return;
            if (hasPlace) {
                nav.classList.remove('nav-item-disabled');
                nav.removeAttribute('aria-disabled');
                nav.title = '';
            } else {
                nav.classList.add('nav-item-disabled');
                nav.setAttribute('aria-disabled', 'true');
                nav.title = 'Kehadiran belum tersedia. Anda belum memiliki data PKL atau belum menentukan tempat PKL.';
            }
        }

        async function updateUserUI() {
            const currentUser = AUTH.getUser();
            document.getElementById('userName').textContent = currentUser.nama;

            // Welcome Message logic
            const getGreeting = () => {
                const hour = new Date().getHours();
                if (hour >= 5 && hour < 12) return "Selamat Pagi";
                if (hour >= 12 && hour < 15) return "Selamat Siang";
                if (hour >= 15 && hour < 18) return "Selamat Sore";
                return "Selamat Malam";
            };

            const greetingEl = document.getElementById('greetingText');
            const welcomeNameEl = document.getElementById('welcomeName');
            const bannerWelcomeName = document.getElementById('bannerWelcomeName');

            if (greetingEl) greetingEl.textContent = getGreeting() + ' ';
            if (welcomeNameEl) welcomeNameEl.textContent = `${currentUser.nama}! `;
            if (bannerWelcomeName) bannerWelcomeName.textContent = currentUser.nama;

            // Fetch extra details from DATASISWA
            try {
                const res = await API.getData('DATASISWA');
                if (res.status === 'success') {
                    const student = res.data.find(s => s.nis == currentUser.nis);
                    const fallbackUrl = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(currentUser.nama) + '&background=random';

                    // Update all possible avatars
                    const avatarIds = ['userAvatar', 'headerAvatar', 'profViewAvatar', 'profModalAvatar', 'myDataPhotoView'];
                    const photoUrl = student && student.Photo ? getDriveThumbnail(student.Photo) : fallbackUrl;

                    avatarIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.onerror = function () {
                                this.onerror = null;
                                this.src = fallbackUrl;
                                // If header avatar fails, ensure placeholder is shown
                                if (id === 'headerAvatar') {
                                    const ph = document.getElementById('headerAvatarPlaceholder');
                                    if (ph) ph.classList.remove('hidden');
                                    this.classList.add('hidden');
                                }
                            };
                            el.src = photoUrl;

                            // Special handling for headerAvatar visibility
                            if (id === 'headerAvatar') {
                                const ph = document.getElementById('headerAvatarPlaceholder');
                                if (student && student.Photo) {
                                    el.style.display = 'block';
                                    if (ph) ph.classList.add('hidden');
                                } else {
                                    el.style.display = 'none';
                                    if (ph) ph.classList.remove('hidden');
                                }
                            }
                        }
                    });

                    if (student && !user.jurusan) {
                        user.jurusan = student.jurusan || student.Jurusan;
                    }
                }
            } catch (err) {
                console.error('Error loading student details:', err);
            }
        }

        updateUserUI();
        ensureStudentPklAvailability().then(av => updateAttendanceNavStyle(av.hasPlace));

        function getDriveThumbnail(urlOrId) {
            if (!urlOrId) return '';
            let id = urlOrId;
            if (urlOrId.includes('id=')) {
                id = urlOrId.split('id=')[1].split('&')[0];
            } else if (urlOrId.includes('/d/')) {
                id = urlOrId.split('/d/')[1].split('/')[0];
            }
            return `https://drive.google.com/thumbnail?id=${id}&sz=w200`;
        }

        function toggleProfileModal(show) {
            const modal = document.getElementById('profileModal');
            modal.classList.toggle('hidden', !show);
            modal.style.display = show ? 'flex' : 'none';
        }

        function switchProfileState(state) {
            const title = document.getElementById('profModalTitle');
            const view = document.getElementById('profViewContent');
            const edit = document.getElementById('profEditContent');
            const pass = document.getElementById('profPassContent');

            view.classList.add('hidden');
            edit.classList.add('hidden');
            pass.classList.add('hidden');

            if (state === 'view') {
                title.textContent = 'Profil Saya';
                view.classList.remove('hidden');
            } else if (state === 'edit') {
                title.textContent = 'Edit Profil';
                edit.classList.remove('hidden');
            } else if (state === 'password') {
                title.textContent = 'Ganti Password';
                pass.classList.remove('hidden');
            }
        }

        function toggleProfileDropdown(event) {
            if (event) event.stopPropagation();
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }

        function closeProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown) dropdown.classList.remove('active');
        }

        // Close dropdown when clicking outside
        window.addEventListener('click', function (e) {
            if (!e.target.closest('.profile-dropdown-container')) {
                closeProfileDropdown();
            }
        });

        async function openProfileModal(initialState = 'view') {
            closeProfileDropdown();
            const currentUser = AUTH.getUser();

            // Populate View State
            document.getElementById('pViewNama').textContent = currentUser.nama;
            document.getElementById('pViewUser').textContent = currentUser.username;
            document.getElementById('pViewNis').textContent = currentUser.nis || '-';

            // Fetch extra details from DATASISWA
            try {
                const res = await API.getData('DATASISWA');
                const student = res.data.find(s => s.nis == currentUser.nis);
                if (student) {
                    document.getElementById('pViewKelas').textContent = student.kelas || student.Kelas || '-';
                    document.getElementById('pViewKontak').textContent = student.KontakSiswa || '-';
                    document.getElementById('profEditKontak').value = student.KontakSiswa || '';

                    const photo = student.Photo;
                    const fallbackUrl = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(currentUser.nama) + '&background=random';
                    const avatarSrc = photo ? getDriveThumbnail(photo) : fallbackUrl;
                    const setAvatarWithFallback = (el) => { el.onerror = function () { this.onerror = null; this.src = fallbackUrl; }; el.src = avatarSrc; };
                    setAvatarWithFallback(document.getElementById('profViewAvatar'));
                    setAvatarWithFallback(document.getElementById('profModalAvatar'));
                } else {
                    const fallbackUrl = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(currentUser.nama) + '&background=random';
                    document.getElementById('profViewAvatar').src = document.getElementById('profModalAvatar').src = fallbackUrl;
                }
            } catch (e) {
                console.error('Error fetching student details:', e);
            }

            document.getElementById('profUsername').value = currentUser.username;

            switchProfileState(initialState);
            toggleProfileModal(true);
        }

        function handleAvatarPreview(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('profModalAvatar').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function saveProfile(event) {
            event.preventDefault();
            const btn = document.getElementById('btnSaveProfile');
            const newUsername = document.getElementById('profUsername').value;
            const newKontak = document.getElementById('profEditKontak').value;
            const photoFile = document.getElementById('profilePhotoInput').files[0];

            btn.disabled = true;
            btn.textContent = 'Menyimpan...';

            try {
                const currentUser = AUTH.getUser();
                const updateLoginData = {};
                let newPhotoUrl = null;
                let newKontakVal = null;

                if (newUsername !== currentUser.username) updateLoginData.username = newUsername;
                if (newKontak !== document.getElementById('pViewKontak').textContent) newKontakVal = newKontak;

                if (photoFile) {
                    btn.textContent = 'Mengompres...';
                    const compressedFile = await API.compressImage(photoFile);
                    btn.textContent = 'Mengunggah...';
                    const uploadRes = await API.uploadFile(compressedFile);
                    if (uploadRes.status === 'success') newPhotoUrl = uploadRes.url;
                }

                if (!Object.keys(updateLoginData).length && !newPhotoUrl && !newKontakVal) {
                    showToast('Tidak ada perubahan.', 'info');
                    switchProfileState('view');
                    return;
                }

                // Apply Updates
                if (Object.keys(updateLoginData).length > 0) {
                    await API.updateProfile('siswa', currentUser.username, updateLoginData);
                }
                if (newPhotoUrl || newKontakVal) {
                    const dataToUpdate = {};
                    if (newPhotoUrl) dataToUpdate.Photo = newPhotoUrl;
                    if (newKontakVal) dataToUpdate.KontakSiswa = newKontakVal;
                    await API.request('update', 'DATASISWA', { id: currentUser.nis, data: dataToUpdate });
                }

                showToast('Profil diperbarui!', 'success');
                const session = JSON.parse(localStorage.getItem('pkl_session'));
                if (updateLoginData.username) session.username = updateLoginData.username;
                localStorage.setItem('pkl_session', JSON.stringify(session));

                updateUserUI();
                openProfileModal(); // Refresh view
            } catch (err) {
                showToast('Kesalahan: ' + err.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Simpan';
            }
        }

        async function savePassword(event) {
            event.preventDefault();
            const btn = document.getElementById('btnSavePassword');
            const oldPass = document.getElementById('profOldPass').value;
            const newPass = document.getElementById('profNewPass').value;

            btn.disabled = true;
            btn.textContent = 'Memproses...';

            try {
                const currentUser = AUTH.getUser();
                const res = await API.getData('LOGINSISWA');
                const dbUser = res.data.find(u =>
                    (u.username || "").toString().trim().toLowerCase() ===
                    (currentUser.username || "").toString().trim().toLowerCase()
                );

                if (!dbUser || (oldPass || "").toString().trim() !== (dbUser.password || "").toString().trim()) {
                    showToast('Password lama salah!', 'danger');
                    return;
                }

                const updateRes = await API.updateProfile('siswa', currentUser.username, { password: newPass });
                if (updateRes.status === 'success') {
                    showToast('Password berhasil diganti!', 'success');
                    switchProfileState('view');
                    document.getElementById('passForm').reset();
                } else {
                    showToast('Gagal: ' + updateRes.message, 'danger');
                }
            } catch (err) {
                showToast('Kesalahan: ' + err.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Update Password';
            }
        }

        // Banner Slider Logic
        let currentSlide = 0;
        let slideInterval;
        const SLIDE_DURATION = 3000;

        function initBannerSlider() {
            const track = document.getElementById('bannerSlider');
            if (!track) return;
            startSlideTimer();
        }

        function startSlideTimer() {
            stopSlideTimer();
            slideInterval = setInterval(nextSlide, SLIDE_DURATION);
        }

        function stopSlideTimer() {
            if (slideInterval) clearInterval(slideInterval);
        }

        function nextSlide() {
            const track = document.getElementById('bannerSlider');
            const slides = track.querySelectorAll('.banner-card');
            currentSlide = (currentSlide + 1) % slides.length;
            updateSliderView();
            startSlideTimer(); // Reset timer on manual interaction
        }

        function prevSlide() {
            const track = document.getElementById('bannerSlider');
            const slides = track.querySelectorAll('.banner-card');
            currentSlide = (currentSlide - 1 + slides.length) % slides.length;
            updateSliderView();
            startSlideTimer();
        }

        function goToSlide(index) {
            currentSlide = index;
            updateSliderView();
            startSlideTimer();
        }

        function updateSliderView() {
            const track = document.getElementById('bannerSlider');
            const dots = document.querySelectorAll('.banner-dot');
            if (!track) return;

            const slideWidth = track.querySelector('.banner-card').offsetWidth;
            const gap = 24; // 1.5rem gap
            const offset = currentSlide * (slideWidth + gap);

            track.style.transform = `translateX(-${offset}px)`;

            dots.forEach((dot, idx) => {
                dot.classList.toggle('active', idx === currentSlide);
            });
        }

        function showToast(message, type = 'success') {
            const tMap = { 'success': 'success', 'danger': 'error', 'info': 'info', 'warning': 'info' };
            API.showNotification(message, tMap[type] || 'success');
        }

        function formatDate(dateInput) {
            if (!dateInput) return '-';
            let date = new Date(dateInput);
            if (isNaN(date.getTime())) return dateInput;
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }


        async function loadDashboardData() {
            try {
                // Populate Banner Location
                await loadCurrentPKLLocation();

                // Populate Progress & Period
                await loadPKLProgress();

                // Populate Home Attendance Table
                const resAtt = await API.getData('KEHADIRAN');
                const myAtt = (resAtt.data || [])
                    .filter(a => a.NIS == user.nis)
                    .sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal))
                    .slice(0, 5);

                const attBody = document.getElementById('homeAttBody');
                if (attBody) {
                    if (myAtt.length === 0) {
                        attBody.innerHTML = '<tr><td colspan="4" style="padding: 1.5rem; text-align: center; color: var(--text-muted); font-size: 0.7rem;">Belum ada data pekan ini.</td></tr>';
                    } else {
                        attBody.innerHTML = myAtt.map(a => `
                            <tr style="border-bottom: 1px solid rgba(0,0,0,0.03);">
                                <td style="padding: 0.75rem; font-weight: 700;">${new Date(a.Tanggal).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' })}</td>
                                <td style="padding: 0.75rem; color: var(--success); font-weight: 600;">${a.time_in || '--:--'}</td>
                                <td style="padding: 0.75rem; color: var(--secondary); font-weight: 600;">${a.time_out || '--:--'}</td>
                                <td style="padding: 0.75rem;"><span class="badge ${getStatusBadgeClass(a.StatusAbsen)}" style="font-size: 0.55rem; padding: 0.2rem 0.4rem;">${a.StatusAbsen || 'H'}</span></td>
                            </tr>
                        `).join('');
                    }
                }

                // Populate Home Journal Feed
                const resJur = await API.getData('JURNAL');
                const myJur = (resJur.data || [])
                    .filter(j => j.NIS == user.nis)
                    .sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal))
                    .slice(0, 3);

                const jurFeed = document.getElementById('homeJournalFeed');
                if (jurFeed) {
                    if (myJur.length === 0) {
                        jurFeed.innerHTML = '<div style="padding: 1.5rem; text-align: center; color: var(--text-muted); font-size: 0.7rem;">Anda belum mengisi jurnal.</div>';
                    } else {
                        jurFeed.innerHTML = myJur.map(j => `
                            <div class="glass" style="padding: 0.75rem; border-radius: 0.85rem; background: rgba(var(--primary-rgb), 0.02);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem;">
                                    <span style="font-size: 0.7rem; font-weight: 800; color: var(--primary);">${new Date(j.Tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })}</span>
                                    <i class="fas fa-check-circle" style="color: var(--success); font-size: 0.7rem;"></i>
                                </div>
                                <p style="font-size: 0.7rem; color: var(--text-main); line-height: 1.3; font-weight: 600; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${j.Kegiatan || '-'}</p>
                            </div>
                        `).join('');
                    }
                }
            } catch (err) {
                console.error('Error loading dashboard data:', err);
            }
        }

        async function loadCurrentPKLLocation() {
            const locEl = document.getElementById('currentPKLLocation');
            const bLocName = document.getElementById('bannerLocationName');
            const bLocAddr = document.getElementById('bannerLocationAddr');
            console.log('[DEBUG-BANNER] ids:', { locEl: !!locEl, bLocName: !!bLocName, bLocAddr: !!bLocAddr });

            try {
                const av = await ensureStudentPklAvailability();
                console.log('[DEBUG] av:', av);
                if (av.hasPlace) {
                    const resLoc = await API.getData('LOKASIPKL');
                    console.log('[DEBUG] resLoc:', resLoc);
                    const loc = (resLoc.data || []).find(l =>
                        (l.ID_PKL || '').toString().trim() === (av.activeId || '').toString().trim()
                    );

                    if (loc) {
                        const name = loc.NamaTempat || loc.NamaPKL || loc.UnitKerja || 'Tempat PKL';
                        const addr = loc.Alamat || loc.AlamatLengkap || '-';
                        console.log('[DEBUG] found loc:', name);
                        if (locEl) locEl.textContent = name;
                        if (bLocName) bLocName.textContent = name;
                        if (bLocAddr) bLocAddr.textContent = addr;
                    } else {
                        // Fallback: try finding any record if direct ID match fails (debugging)
                        console.warn('Location data not found for ID:', av.activeId);
                        if (bLocName) bLocName.textContent = 'Data Lokasi Tidak Ditemukan';
                        if (locEl) locEl.textContent = 'Lokasi Tidak Ditemukan';
                    }
                } else {
                    if (locEl) locEl.textContent = 'Belum Ditentukan';
                    if (bLocName) bLocName.textContent = 'Belum Ditentukan';
                }
            } catch (e) {
                console.error('Error in loadCurrentPKLLocation:', e);
                if (bLocName) bLocName.textContent = 'Gagal Memuat Data';
                if (locEl) locEl.textContent = 'Gagal Memuat';
            }
        }

        async function loadPKLProgress() {
            const content = document.getElementById('progressContent');
            const noSchedule = document.getElementById('noScheduleMsg');
            const bar = document.getElementById('progressBar');
            const percentText = document.getElementById('progressPercent');

            // Banner elements
            const bBar = document.getElementById('bannerProgressBar');
            const bPercent = document.getElementById('bannerProgressPercent');
            const bPeriodText = document.getElementById('bannerPeriodText');
            const bDaysLeft = document.getElementById('bannerDaysLeft');

            try {
                const res = await API.getData('JADWALPKL');
                if (res.status === 'success' && res.data.length > 0) {
                    const schedule = res.data[0];
                    const start = new Date(schedule.StartDate);
                    const end = new Date(schedule.EndDate);
                    const now = new Date();

                    if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                        throw new Error('Invalid dates');
                    }

                    const total = end - start;
                    const elapsed = now - start;
                    const remaining = end - now;
                    const daysRemaining = Math.max(0, Math.ceil(remaining / (1000 * 60 * 60 * 24)));

                    let percent = 0;
                    if (now > end) {
                        percent = 100;
                    } else if (now > start) {
                        percent = Math.round((elapsed / total) * 100);
                    }

                    if (content) content.classList.remove('hidden');
                    if (noSchedule) noSchedule.classList.add('hidden');
                    if (bar) bar.style.width = percent + '%';
                    if (percentText) percentText.textContent = percent + '%';

                    // Update Banner
                    if (bBar) bBar.style.width = percent + '%';
                    if (bPercent) bPercent.textContent = percent + '%';
                    if (bPeriodText) bPeriodText.textContent = `${formatDate(schedule.StartDate)} - ${formatDate(schedule.EndDate)}`;
                    if (bDaysLeft) bDaysLeft.textContent = `${daysRemaining} hari tersisa`;
                } else {
                    if (content) content.classList.add('hidden');
                    if (noSchedule) noSchedule.classList.remove('hidden');
                }
            } catch (err) {
                console.error('Error loading PKL progress:', err);
                if (content) content.classList.add('hidden');
                if (noSchedule) noSchedule.classList.remove('hidden');
            }
        }

        async function loadOverviewAnnouncements() {
            const container = document.getElementById('announcementList');
            try {
                const major = user.jurusan || 'Semua';
                const res = await API.getData('PENGUMUMAN');
                if (res.status === 'success') {
                    const filtered = res.data.filter(i => i.Status === 'Aktif' && (i.Jurusan === 'Semua' || i.Jurusan === major)).slice(0, 3);
                    if (filtered.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-muted);">Tidak ada pengumuman baru.</p>';
                    } else {
                        container.innerHTML = filtered.map(item => `
                            <div style="padding: 1rem; border-bottom: 1px solid rgba(0,0,0,0.05);">
                                <div style="font-weight: 600; font-size: 0.9rem;">${item.Judul}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${new Date(item.Tanggal).toLocaleDateString('id-ID')}</div>
                            </div>
                        `).join('') + `
                            <div style="padding-top: 1rem; text-align: center;">
                                <a href="#" onclick="showPage('info-pkl')" style="font-size: 0.75rem; color: var(--primary); text-decoration: none; font-weight: 600;">Lihat Semua <i class="fas fa-arrow-right"></i></a>
                            </div>
                        `;
                    }
                }
            } catch (err) {
                console.error('Error loading overview info:', err);
            }
            loadHomeEvents();
            await loadDashboardData();
            initBannerSlider();
        }
        loadOverviewAnnouncements();

        async function showPage(pageId) {
            document.querySelectorAll('.content-page').forEach(p => p.classList.add('hidden'));
            const page = document.getElementById(pageId + 'Page');
            if (page) page.classList.remove('hidden');

            // Update Sidebar nav
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            const nav = document.getElementById('nav-' + pageId);
            if (nav) nav.classList.add('active');

            // Update Bottom nav
            document.querySelectorAll('.bottom-nav-link').forEach(a => a.classList.remove('active'));
            const bnav = document.getElementById('bnav-' + pageId);
            if (bnav) bnav.classList.add('active');

            const titles = { overview: 'Beranda', attendance: 'Kehadiran', journal: 'Jurnal Harian', submission: 'Pengajuan PKL', 'report-title': 'Pengajuan Judul', 'info-pkl': 'Informasi & Event PKL', evaluation: 'Status Penilaian PKL', 'my-data': 'Data Pribadi Saya' };
            document.getElementById('pageTitle').textContent = titles[pageId] || 'Beranda';

            if (pageId === 'overview') await loadDashboardData();
            if (pageId === 'evaluation') loadEvaluation();
            if (pageId === 'info-pkl') loadInfoPKL();
            if (pageId === 'report-title') loadReportTitle();
            if (pageId === 'journal') loadJournals();
            if (pageId === 'submission') loadSubmissionData();
            if (pageId === 'attendance') applyAttendancePageVisibility();
            if (pageId === 'my-data') loadMyData();

            // Close mobile sidebar if open
            if (window.innerWidth < 768) {
                const sidebar = document.querySelector('.sidebar');
                if (sidebar && sidebar.classList.contains('active')) {
                    toggleMobileSidebar();
                }
            }
        }

        async function applyAttendancePageVisibility() {
            const av = await ensureStudentPklAvailability();
            const unavEl = document.getElementById('attendanceContentUnavailable');
            const avEl = document.getElementById('attendanceContentAvailable');
            if (av.hasPlace) {
                if (unavEl) unavEl.classList.add('hidden');
                if (avEl) avEl.classList.remove('hidden');
                loadAttendanceStatusToday();
                loadWeeklyAttendance();
            } else {
                if (unavEl) unavEl.classList.remove('hidden');
                if (avEl) avEl.classList.add('hidden');
            }
        }

        async function loadEvaluation() {
            const empty = document.getElementById('evaluationEmptyState');
            const content = document.getElementById('evaluationContent');

            try {
                const res = await API.getData('EVALUASI');
                const evalData = res.data ? res.data.find(e => e.NIS == user.nis) : null;

                if (!evalData) {
                    empty.classList.remove('hidden');
                    content.classList.add('hidden');
                    return;
                }

                empty.classList.add('hidden');
                content.classList.remove('hidden');
                document.getElementById('btnDownloadCert').classList.remove('hidden');

                // Helper to animate numbers
                const animateValue = (id, target) => {
                    const el = document.getElementById(id);
                    const duration = 1500;
                    const start = 0;
                    const startTime = performance.now();

                    const update = (now) => {
                        const progress = Math.min((now - startTime) / duration, 1);
                        const easeOut = 1 - Math.pow(1 - progress, 3);
                        const current = Math.floor(easeOut * target);
                        el.textContent = current;
                        if (progress < 1) requestAnimationFrame(update);
                    };
                    requestAnimationFrame(update);
                };

                // Map Score Cards with animation
                animateValue('evalSoftskill', evalData.score_softskill || 0);
                animateValue('evalTechnical', evalData.score_technical || 0);
                animateValue('evalBisnis', evalData.score_bisnisdudi || 0);
                animateValue('evalPOS', evalData.score_pos || 0);

                // Map Behavioral Traits
                const traits = [
                    { id: 'Disiplin', val: evalData.kedisplinan },
                    { id: 'Kerjasama', val: evalData.kerjasama },
                    { id: 'Inisiatif', val: evalData.inisiatif },
                    { id: 'Kerajinan', val: evalData.kerajinan },
                    { id: 'TanggungJawab', val: evalData.TanggungJawab }
                ];

                traits.forEach(t => {
                    const value = t.val || 0;
                    document.getElementById(`label${t.id}`).textContent = `${value}/100`;
                    setTimeout(() => {
                        document.getElementById(`bar${t.id}`).style.width = `${value}%`;
                    }, 500);
                });

                // Map Attendance Summary
                document.getElementById('evalSakit').textContent = evalData.sakit || '0';
                document.getElementById('evalIzin').textContent = evalData.ijin || '0';
                document.getElementById('evalAlpa').textContent = evalData.alpa || '0';

                // Map Catatan
                document.getElementById('evalCatatan').innerHTML = evalData.catatan ?
                    `<i class="fas fa-quote-left" style="opacity: 0.2; font-size: 1.5rem; display: block; margin-bottom: 0.5rem;"></i>${evalData.catatan}` :
                    '<em>Belum ada catatan tambahan dari mentor.</em>';

            } catch (err) {
                console.error('Error loading evaluation:', err);
                showToast('Gagal memuat data penilaian.', 'danger');
            }
        }

        async function downloadCertificate() {
            const btn = document.getElementById('btnDownloadCert');
            const originalHTML = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

                showToast('Menyiapkan sertifikat, mohon tunggu...');

                const res = await API.request('generateCertificate', '', { nis: user.nis });

                if (res.status === 'success') {
                    showToast('Sertifikat berhasil dibuat!', 'success');

                    // Convert Drive URL to direct download URL if possible
                    let downloadUrl = res.url;
                    const driveIdMatch = res.url.match(/\/d\/([a-zA-Z0-9_-]+)/) || res.url.match(/id=([a-zA-Z0-9_-]+)/);

                    if (driveIdMatch && driveIdMatch[1]) {
                        downloadUrl = `https://drive.google.com/uc?export=download&id=${driveIdMatch[1]}`;
                    }

                    // Create temporary link to trigger auto-download
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.target = '_blank';
                    link.download = `Sertifikat_PKL_${user.nama}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                } else {
                    throw new Error(res.message || res.error);
                }
            } catch (err) {
                console.error('Cert error:', err);
                showToast('Gagal mengunduh sertifikat: ' + err.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        async function downloadCertificateTemplate() {
            const btn = document.getElementById('btnDownloadTemplateCert');
            const originalHTML = btn.innerHTML;
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat...';
                const res = await API.getData('DOKUMEN');
                if (res.status !== 'success' || !res.data) throw new Error('Gagal memuat data dokumen.');
                const templateRow = (res.data || []).find(d =>
                    d.NamaDok && String(d.NamaDok).toLowerCase().includes('sertkosong')
                );
                if (!templateRow || !templateRow.Dokumen) {
                    showToast('Template sertifikat tidak ditemukan. Pastikan sheet DOKUMEN punya baris dengan NamaDok SertKosong.', 'warning');
                    return;
                }
                const url = String(templateRow.Dokumen).trim();
                const idMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
                if (idMatch && idMatch[1]) {
                    const exportUrl = `https://docs.google.com/document/d/${idMatch[1]}/export?format=pdf`;
                    const link = document.createElement('a');
                    link.href = exportUrl;
                    link.target = '_blank';
                    link.download = 'Template_Sertifikat_PKL.pdf';
                    link.rel = 'noopener noreferrer';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('Template sertifikat diunduh. Cetak untuk isi manual.', 'success');
                } else {
                    window.open(url, '_blank', 'noopener,noreferrer');
                    showToast('Template dibuka di tab baru. Gunakan File > Download > PDF untuk cetak.', 'info');
                }
            } catch (err) {
                console.error('Template cert error:', err);
                showToast('Gagal membuka template: ' + (err.message || 'Error'), 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // ==========================================
        // ATTENDANCE FUNCTIONS
        // ==========================================
        let currentAttStatus = 'Hadir';
        let currentCoords = null;
        let cameraStream = null;
        let capturedBlob = null;
        let galleryFile = null;
        let locationTimer = null;

        function triggerFilePicker() {
            document.getElementById('fileGallery').click();
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            galleryFile = file;
            document.getElementById('selectedFileLabel').classList.remove('hidden');
            document.getElementById('fileNameDisplay').textContent = file.name;
            showToast('File selected: ' + file.name, 'success');
        }

        function selectAttStatus(status, btn) {
            currentAttStatus = status;
            document.querySelectorAll('.btn-attendance').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const alert = document.getElementById('statusAlert');
            const alertText = document.getElementById('statusAlertText');
            const triggerText = document.getElementById('btnAbsenText');
            const uploadOptions = document.getElementById('fileUploadOptions');
            const selectedLabel = document.getElementById('selectedFileLabel');

            // Reset file selection when switching
            galleryFile = null;
            selectedLabel.classList.add('hidden');

            if (status === 'Hadir') {
                alert.classList.add('hidden');
                uploadOptions.classList.add('hidden');
                triggerText.textContent = 'Absen Sekarang';
            } else if (status === 'Libur') {
                alert.classList.remove('hidden');
                alert.style.background = 'rgba(14, 165, 233, 0.1)';
                alert.style.color = '#0369a1';
                alertText.textContent = 'Menandai hari libur (perlu disetujui pembimbing).';
                uploadOptions.classList.add('hidden');
                triggerText.textContent = 'Konfirmasi Libur';
            } else {
                alert.classList.remove('hidden');
                alert.style.background = 'rgba(245, 158, 11, 0.1)';
                alert.style.color = '#92400e';
                alertText.textContent = `Pilih Foto atau Upload Surat Keterangan (${status}).`;
                uploadOptions.classList.remove('hidden');
                triggerText.textContent = 'Buka Kamera';
            }
        }

        async function startAttendance() {
            if (currentAttStatus === 'Libur' || (galleryFile && (currentAttStatus === 'Sakit' || currentAttStatus === 'Izin'))) {
                submitAttendance();
                return;
            }

            const btn = document.getElementById('btnAbsenTrigger');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyiapkan...';

            getLocation(); // Start fetching location in background

            try {
                const modal = document.getElementById('cameraModal');
                const loading = document.getElementById('cameraLoading');
                const video = document.getElementById('video');

                modal.classList.remove('hidden');
                loading.classList.remove('hidden');

                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
                });

                video.srcObject = cameraStream;
                loading.classList.add('hidden');

                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-camera"></i> ${currentAttStatus === 'Hadir' ? 'Absen Sekarang' : 'Ambil Foto'}`;

            } catch (err) {
                console.error('Camera error:', err);
                showToast('Gagal mengakses kamera: ' + err.message, 'danger');
                closeCameraModal();
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-camera"></i> Absen Sekarang';
            }
        }

        function closeCameraModal() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraModal').classList.add('hidden');
            retakePhoto();
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const btnCapture = document.getElementById('btnCapture');
            const btnRetake = document.getElementById('btnRetake');
            const captureAction = document.getElementById('captureAction');
            const faceGuide = document.getElementById('faceGuide');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext('2d');
            // Mirror image for consistency with preview
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);

            video.classList.add('hidden');
            canvas.classList.remove('hidden');
            btnCapture.classList.add('hidden');
            btnRetake.classList.remove('hidden');
            captureAction.classList.remove('hidden');
            faceGuide.classList.add('hidden');

            canvas.toBlob(blob => {
                capturedBlob = blob;
            }, 'image/jpeg', 0.8);
        }

        function retakePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const btnCapture = document.getElementById('btnCapture');
            const btnRetake = document.getElementById('btnRetake');
            const captureAction = document.getElementById('captureAction');
            const faceGuide = document.getElementById('faceGuide');

            video.classList.remove('hidden');
            canvas.classList.add('hidden');
            btnCapture.classList.remove('hidden');
            btnRetake.classList.add('hidden');
            captureAction.classList.add('hidden');
            faceGuide.classList.remove('hidden');
            capturedBlob = null;
        }

        async function submitAttendance() {
            if (!capturedBlob && !galleryFile && currentAttStatus !== 'Libur') {
                showToast('Foto belum diambil atau file belum dipilih!', 'danger');
                return;
            }

            if (!currentCoords && currentAttStatus === 'Hadir') {
                showToast('Sedang mencari lokasi, mohon tunggu sebentar...', 'info');
                return;
            }

            const btn = document.getElementById('btnSubmitAbsen');
            const triggerBtn = document.getElementById('btnAbsenTrigger');
            const activeBtn = (currentAttStatus === 'Libur' || galleryFile) ? triggerBtn : btn;

            activeBtn.disabled = true;
            activeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';

            try {
                // Check if already has attendance for today to prevent duplicates
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const checkRes = await API.getData('KEHADIRAN');
                const todayAtt = checkRes.data.find(a => a.NIS == user.nis && (a.Tanggal || "").split('T')[0] === dateStr);
                if (todayAtt) {
                    showToast('Anda sudah melakukan absensi hari ini!', 'warning');
                    closeCameraModal();
                    return;
                }

                let photoUrl = '';
                const uploadSource = galleryFile || (capturedBlob ? new File([capturedBlob], `att_${user.nis}_${Date.now()}.jpg`, { type: 'image/jpeg' }) : null);

                if (uploadSource) {
                    const uploadRes = await API.uploadFile(uploadSource);
                    if (uploadRes.status === 'success') photoUrl = uploadRes.url;
                }

                const timeStr = now.toLocaleTimeString('id-ID', { hour12: false, hour: '2-digit', minute: '2-digit' });

                const statusMap = { 'Hadir': 'H', 'Sakit': 'S', 'Izin': 'I', 'Libur': 'L' };
                const data = {
                    ID_Absen: 'ATT-' + Date.now(),
                    NIS: user.nis,
                    Tanggal: dateStr,
                    time_in: timeStr,
                    time_out: '',
                    lat: currentCoords ? currentCoords.latitude : '',
                    lng: currentCoords ? currentCoords.longitude : '',
                    StatusAbsen: statusMap[currentAttStatus] || '',
                    Status: 'Pending',
                    photo: photoUrl,
                    JarakAbsen: currentCoords ? await calculateDistanceFromPKL() : ''
                };

                const res = await API.postData('KEHADIRAN', data);
                if (res.status === 'success') {
                    showToast('Absensi berhasil dikirim!', 'success');
                    closeCameraModal();
                    loadAttendanceStatusToday();
                    loadWeeklyAttendance();
                } else {
                    showToast('Gagal: ' + res.message, 'danger');
                }
            } catch (err) {
                console.error('Submit error:', err);
                showToast('Terjadi kesalahan data.', 'danger');
            } finally {
                if (typeof activeBtn !== 'undefined') {
                    activeBtn.disabled = false;
                    activeBtn.innerHTML = (currentAttStatus === 'Libur') ? '<i class="fas fa-umbrella-beach"></i> Konfirmasi Libur' : (galleryFile ? '<i class="fas fa-check"></i> Kirim Absensi' : '<i class="fas fa-check"></i> Kirim Absensi');
                }
            }
        }

        async function submitCheckOut(id) {
            const triggerBtn = document.getElementById('btnAbsenTrigger');
            const originalHtml = triggerBtn.innerHTML;
            triggerBtn.disabled = true;
            triggerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

            try {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('id-ID', { hour12: false, hour: '2-digit', minute: '2-digit' });

                const res = await API.updateData('KEHADIRAN', id, { time_out: timeStr });
                if (res.status === 'success') {
                    showToast('Berhasil absen pulang!', 'success');
                    loadAttendanceStatusToday();
                    loadWeeklyAttendance();
                } else {
                    showToast('Gagal: ' + res.message, 'danger');
                }
            } catch (err) {
                console.error('Check-out error:', err);
                showToast('Terjadi kesalahan.', 'danger');
            } finally {
                triggerBtn.disabled = false;
                triggerBtn.innerHTML = originalHtml;
            }
        }

        async function calculateDistanceFromPKL() {
            if (!currentCoords) return '';
            try {
                // Get student's location from LOKASIPKL via DATAPKL mapping
                const resDataPKL = await API.getData('DATAPKL');
                const studentPKL = resDataPKL.data.find(s => s.nis == user.nis);
                if (!studentPKL || !studentPKL.ID_PKL) return '';

                const resLoc = await API.getData('LOKASIPKL');
                const loc = resLoc.data.find(l => l.ID_PKL === studentPKL.ID_PKL);
                if (!loc || !loc.LAT || !loc.LNG) return 'N/A';

                const dist = calculateDistance(currentCoords.latitude, currentCoords.longitude, loc.LAT, loc.LNG);
                return Math.round(dist) + ' m';
            } catch (e) { return ''; }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const 1 = lat1 * Math.PI / 180;
            const 2 = lat2 * Math.PI / 180;
            const  = (lat2 - lat1) * Math.PI / 180;
            const  = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin( / 2) * Math.sin( / 2) + Math.cos(1) * Math.cos(2) * Math.sin( / 2) * Math.sin( / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        async function getLocation() {
            const statusText = document.getElementById('locStatusText');
            if (!navigator.geolocation) {
                statusText.textContent = "Geolokasi tidak didukung.";
                return;
            }

            statusText.textContent = "Mendapatkan lokasi...";
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    currentCoords = pos.coords;
                    const distanceStr = await calculateDistanceFromPKL();
                    let distanceHtml = '';

                    if (distanceStr && distanceStr !== 'N/A') {
                        const distValue = parseInt(distanceStr);
                        const distColor = distValue <= 50 ? 'var(--success)' : 'var(--danger)';
                        distanceHtml = `<br><span style="color:${distColor}; font-weight:600;">Jarak: ${distanceStr}</span>`;
                    }

                    statusText.innerHTML = `<span style="color:var(--success)">Lokasi Terdeteksi</span>${distanceHtml}`;
                },
                (err) => {
                    console.error(err);
                    statusText.innerHTML = `<span style="color:var(--danger)">Gagal mendapatkan lokasi: ${err.message}</span>`;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        function isSameDay(date1, date2) {
            if (!date1 || !date2) return false;
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            return d1.getFullYear() === d2.getFullYear() &&
                d1.getMonth() === d2.getMonth() &&
                d1.getDate() === d2.getDate();
        }

        async function loadAttendanceStatusToday() {
            const statusEl = document.getElementById('todayStatus');
            const homeActionEl = document.getElementById('homeAttAction');
            const triggerBtn = document.getElementById('btnAbsenTrigger');
            const selectionArea = document.getElementById('attSelectionArea');

            if (!statusEl || !triggerBtn) return;

            await ensureStudentPklAvailability();
            if (!studentPklAvailability.hasPlace) {
                statusEl.textContent = 'Kehadiran belum tersedia';
                if (homeActionEl) {
                    homeActionEl.classList.remove('hidden');
                    homeActionEl.innerHTML = '<p style="font-size: 0.875rem; color: var(--text-muted); margin: 0;">Anda belum memiliki data PKL atau belum menentukan tempat PKL.</p>';
                }
                if (triggerBtn) {
                    triggerBtn.disabled = true;
                    triggerBtn.classList.remove('btn-primary');
                    triggerBtn.style.background = '#e2e8f0';
                    triggerBtn.style.color = '#94a2b8';
                    triggerBtn.innerHTML = '<i class="fas fa-lock"></i> Kehadiran belum tersedia';
                    triggerBtn.onclick = null;
                }
                if (selectionArea) selectionArea.classList.add('hidden');
                return;
            }

            try {
                const now = new Date();
                const res = await API.getData('KEHADIRAN');
                const todayAtt = res.data.find(a => a.NIS == user.nis && isSameDay(a.Tanggal, now));

                if (todayAtt) {
                    const statusLabelMap = { 'H': 'Hadir', 'S': 'Sakit', 'I': 'Izin', 'L': 'Libur', 'A': 'Alpa' };
                    // Handle both 'H' and 'Hadir' from various stages of implementation
                    const label = statusLabelMap[todayAtt.StatusAbsen] || todayAtt.StatusAbsen;
                    const isHadir = todayAtt.StatusAbsen === 'H' || todayAtt.StatusAbsen === 'Hadir';

                    if (isHadir && !todayAtt.time_out) {
                        // Can check out
                        statusEl.textContent = 'Hadir (Belum Pulang)';

                        // Update Home Page
                        if (homeActionEl) {
                            homeActionEl.classList.remove('hidden');
                            homeActionEl.innerHTML = `
                                <div class="glass-card fade-in" style="margin-top: 1.5rem; border-color: rgba(var(--primary-rgb), 0.2);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                        <div style="font-weight: 700; font-size: 0.9rem;">Status Hari Ini: Hadir</div>
                                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                                    </div>
                                    <button class="btn btn-primary" onclick="submitCheckOut('${todayAtt.ID_Absen}')" style="width: 100%; border-radius: 1.25rem;">
                                        <i class="fas fa-sign-out-alt"></i> Absen Pulang Sekarang
                                    </button>
                                </div>
                            `;
                        }

                        // Update Attendance Page
                        triggerBtn.disabled = false;
                        triggerBtn.classList.add('btn-primary');
                        triggerBtn.style.background = '';
                        triggerBtn.style.color = '';
                        triggerBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Absen Pulang';
                        triggerBtn.onclick = () => submitCheckOut(todayAtt.ID_Absen);
                        if (selectionArea) selectionArea.classList.add('hidden');
                    } else {
                        // Done for the day or other status
                        statusEl.textContent = label + (todayAtt.time_out ? ' (Sudah Pulang)' : '');
                        if (homeActionEl) homeActionEl.classList.add('hidden');

                        // Update Attendance Page
                        triggerBtn.disabled = true;
                        triggerBtn.classList.remove('btn-primary');
                        triggerBtn.style.background = '#e2e8f0';
                        triggerBtn.style.color = '#94a2b8';
                        triggerBtn.innerHTML = '<i class="fas fa-check-double"></i> Sudah Absen';
                        triggerBtn.onclick = null;
                        if (selectionArea) selectionArea.classList.add('hidden');
                    }
                } else {
                    statusEl.textContent = 'Belum Absen';

                    // Update Home Page Button
                    if (homeActionEl) {
                        homeActionEl.classList.remove('hidden');
                        homeActionEl.innerHTML = `
                             <div class="glass-card fade-in" style="margin-top: 1.5rem; background: rgba(var(--secondary-rgb), 0.05);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <div style="font-weight: 700; font-size: 0.9rem;">Anda Belum Absen</div>
                                    <i class="fas fa-exclamation-circle" style="color: var(--secondary);"></i>
                                </div>
                                <button class="btn btn-primary" onclick="showPage('attendance')" style="width: 100%; border-radius: 1.25rem; background: var(--secondary);">
                                    <i class="fas fa-camera"></i> Mulai Absen Sekarang
                                </button>
                            </div>
                        `;
                    }

                    // Update Attendance Page
                    triggerBtn.disabled = false;
                    triggerBtn.classList.add('btn-primary');
                    triggerBtn.style.background = '';
                    triggerBtn.style.color = '';
                    triggerBtn.innerHTML = '<i class="fas fa-camera"></i> Absen Sekarang';
                    triggerBtn.onclick = openCameraModal;
                    if (selectionArea) selectionArea.classList.remove('hidden');
                    selectAttStatus('Hadir', document.getElementById('btnStatusH'));
                }

                // Update Small Stat Widgets (Added for Launchpad)
                const attCount = res.data.filter(a => a.NIS == user.nis).length;
                document.getElementById('statAttendanceCountSmall').textContent = `${attCount} Presensi`;

                const resJurnal = await API.getData('JURNAL');
                if (resJurnal.status === 'success') {
                    const jurCount = resJurnal.data.filter(j => j.NIS == user.nis).length;
                    document.getElementById('statJournalCountSmall').textContent = `${jurCount} Jurnal`;
                }

                const resEval = await API.getData('EVALUASI');
                if (resEval.status === 'success') {
                    const myEval = resEval.data.find(e => e.NIS == user.nis);
                    const evalVal = myEval ? (myEval.score_final || myEval.ScoreFinal || '-') : '-';
                    document.getElementById('statEvaluationSmall').textContent = `Nilai: ${evalVal}`;
                }

            } catch (e) {
                console.error('Error loadAttendanceStatusToday:', e);
            }
        }

        // Run initial checks for Home page
        loadAttendanceStatusToday();

        async function loadWeeklyAttendance() {
            const container = document.getElementById('attendanceHistoryBody');
            if (!container) return;
            try {
                const res = await API.getData('KEHADIRAN');
                const myAtt = res.data.filter(a => a.NIS == user.nis)
                    .sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal))
                    .slice(0, 7);

                if (myAtt.length === 0) {
                    container.innerHTML = '<tr><td colspan="4" style="color: var(--text-muted); font-size: 0.875rem; text-align: center; padding: 2rem;">Belum ada riwayat absensi.</td></tr>';
                    return;
                }

                container.innerHTML = myAtt.map(a => `
                    <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                        <td style="padding: 1rem;">
                            <div style="font-weight: 700; font-size: 0.9rem;">${new Date(a.Tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">${new Date(a.Tanggal).toLocaleDateString('id-ID', { weekday: 'long' })}</div>
                        </td>
                        <td style="padding: 1rem; color: var(--success); font-weight: 700;">${a.time_in || '--:--'}</td>
                        <td style="padding: 1rem; color: var(--secondary); font-weight: 700;">${a.time_out || '--:--'}</td>
                        <td style="padding: 1rem;"><span class="badge ${getStatusBadgeClass(a.StatusAbsen)}">${a.StatusAbsen}</span></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Error loadWeeklyAttendance:', e);
                container.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--danger); padding: 2rem;">Gagal memuat riwayat.</td></tr>';
            }
        }

        function getStatusBadgeClass(s) {
            if (s === 'Hadir' || s === 'H') return 'badge-success';
            if (s === 'Sakit' || s === 'S') return 'badge-danger';
            if (s === 'Izin' || s === 'I') return 'badge-warning';
            if (s === 'Libur' || s === 'L') return 'badge-primary';
            if (s === 'A') return 'badge-danger';
            return 'badge-primary';
        }

        async function loadInfoPKL() {
            const eventContainer = document.getElementById('eventContainer');
            const infoContainer = document.getElementById('infoContainer');

            eventContainer.innerHTML = '<p style="color: var(--text-muted); grid-column: 1/-1; text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Memuat event...</p>';
            infoContainer.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Memuat pengumuman...</p>';

            try {
                // Determine major for filtering
                // For now, if student major is not in user object, we fetch it or default to 'Semua'
                const major = user.jurusan || 'Semua';

                const [resInfo, resEvent] = await Promise.all([
                    API.getData('PENGUMUMAN'),
                    API.getData('EVENT')
                ]);

                if (resInfo.status === 'success') {
                    const filteredInfo = resInfo.data.filter(i => i.Status === 'Aktif' && (i.Jurusan === 'Semua' || i.Jurusan === major));
                    renderAnnouncements(filteredInfo);
                }

                if (resEvent.status === 'success') {
                    const filteredEvents = resEvent.data.filter(e => e.Jurusan === 'Semua' || e.Jurusan === major);
                    renderEvents(filteredEvents);
                }
            } catch (err) {
                console.error('Error loading Info PKL:', err);
                eventContainer.innerHTML = '<p style="color: var(--danger);">Gagal memuat data event.</p>';
                infoContainer.innerHTML = '<p style="color: var(--danger);">Gagal memuat data pengumuman.</p>';
            }
        }

        function renderAnnouncements(data) {
            const container = document.getElementById('infoContainer');
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="glass-card" style="text-align: center; color: var(--text-muted);">Tidak ada pengumuman aktif saat ini.</div>';
                return;
            }

            container.innerHTML = data.map(item => `
                <div class="glass-card" style="border-left: 4px solid var(--accent); transition: transform 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='none'">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                        <h4 style="color: var(--text-main); font-weight: 700;">${item.Judul}</h4>
                        <span style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">${new Date(item.Tanggal).toLocaleDateString('id-ID')}</span>
                    </div>
                    <p style="font-size: 0.85rem; line-height: 1.6; margin-bottom: 1rem; color: var(--text-muted);">${item.Konten}</p>
                    <div style="display: flex; align-items: center; gap: 0.75rem; font-size: 0.7rem; color: var(--text-muted); border-top: 1px solid var(--glass-border); padding-top: 0.75rem;">
                        <span><i class="fas fa-user-circle"></i> ${item.Pembuat}</span>
                        <span><i class="fas fa-tag"></i> ${item.Jurusan}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderEvents(data) {
            const container = document.getElementById('eventContainer');
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="glass-card" style="text-align: center; color: var(--text-muted); grid-column: 1/-1;">Tidak ada event mendatang.</div>';
                return;
            }

            container.innerHTML = data.map(item => `
                <div class="glass-card" style="padding: 0; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="background: linear-gradient(135deg, var(--primary), var(--primary-light)); padding: 1.25rem; color: white;">
                        <div style="font-size: 0.7rem; font-weight: 700; opacity: 0.8; margin-bottom: 0.25rem; text-transform: uppercase;">
                            ${new Date(item.TanggalEven).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' })}
                        </div>
                        <h4 style="margin: 0; font-size: 1.1rem; font-weight: 800;">${item.NamaEven}</h4>
                    </div>
                    <div style="padding: 1.25rem; flex-grow: 1;">
                        <div style="display: grid; gap: 0.75rem; font-size: 0.8rem; margin-bottom: 1.25rem;">
                            <div style="display: flex; gap: 0.6rem; align-items: center;">
                                <i class="fas fa-clock" style="color: var(--primary-light); width: 14px;"></i> ${item.Durasi}
                            </div>
                            <div style="display: flex; gap: 0.6rem; align-items: center;">
                                <i class="fas fa-map-marker-alt" style="color: var(--accent); width: 14px;"></i> ${item.Lokasi}
                            </div>
                            <div style="display: flex; gap: 0.6rem; align-items: center;">
                                <i class="fas fa-user-tie" style="color: var(--secondary-light); width: 14px;"></i> ${item.Pengisi}
                            </div>
                        </div>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1.5rem; line-height: 1.5;">${item.Deskripsi}</p>
                        <a href="https://www.google.com/maps?q=${item.LAT},${item.LNG}" target="_blank" class="btn glass" style="width: 100%; font-size: 0.75rem; border-radius: 0.75rem; font-weight: 600;">
                            <i class="fas fa-location-arrow"></i> PETUNJUK ARAH
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // EVENT ATTENDANCE FUNCTIONS
        // ==========================================
        async function loadHomeEvents() {
            const container = document.getElementById('homeEventList');
            if (!container) return;

            try {
                const major = user.jurusan || 'Semua';
                const [resEvents, resAbsen] = await Promise.all([
                    API.getData('EVENT'),
                    API.getData('ABSENEVEN')
                ]);

                if (resEvents.status === 'success' && resAbsen.status === 'success') {
                    const filteredEvents = resEvents.data.filter(e => e.Jurusan === 'Semua' || e.Jurusan === major);
                    const myAttendance = resAbsen.data.filter(a => a.NIS == user.nis);
                    renderHomeEvents(filteredEvents, myAttendance);
                }
            } catch (err) {
                console.error('Error loading home events:', err);
                container.innerHTML = '<p style="color: var(--danger);">Gagal memuat event.</p>';
            }
        }

        function renderHomeEvents(events, attendance) {
            const container = document.getElementById('homeEventList');
            if (!events || events.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        <i class="fas fa-calendar-alt" style="font-size: 2rem; opacity: 0.1; margin-bottom: 1rem;"></i>
                        <p style="font-size: 0.85rem;">Tidak ada event mendatang.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = events.slice(0, 3).map(event => {
                const isPresent = attendance.some(a => a.ID_Even === event.ID_Even);
                const statusBadge = isPresent ? 'badge-success' : 'badge-primary';
                const statusText = isPresent ? 'Hadir' : 'Mendatang';

                return `
                    <div class="glass-card" style="padding: 1rem; cursor: pointer; border-left: 3px solid ${isPresent ? 'var(--success)' : 'var(--primary-light)'}; margin-bottom: 1rem;" 
                        onclick="showPage('info-pkl')">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <h4 style="font-size: 0.9rem; font-weight: 700; margin: 0; color: var(--text-main);">${event.NamaEven}</h4>
                            <span class="badge ${statusBadge}" style="font-size: 0.6rem;">${statusText}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.75rem; font-size: 0.75rem; color: var(--text-muted);">
                            <span><i class="fas fa-calendar-day" style="color: var(--primary-light);"></i> ${new Date(event.TanggalEven).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' })}</span>
                            <span><i class="fas fa-map-marker-alt" style="color: var(--accent);"></i> ${event.Lokasi}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function submitEventAttendance(eventId, eventLat, eventLng, btn) {
            if (!currentCoords) {
                await getLocation();
                if (!currentCoords) return showToast('Mohon izinkan akses lokasi untuk absen.', 'error');
            }

            const confirmBtn = btn;
            const originalContent = confirmBtn.innerHTML;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

            try {
                const dist = calculateDistance(currentCoords.latitude, currentCoords.longitude, eventLat, eventLng);
                const status = dist <= 30 ? 'Valid' : 'Diluar Area';
                const distLabel = Math.round(dist) + ' m';

                const now = new Date();
                const data = {
                    ID_Even: eventId,
                    NIS: user.nis,
                    tanggal: now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0'),
                    jam: now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0'),
                    LAT: currentCoords.latitude,
                    LNG: currentCoords.longitude,
                    status: status
                };

                const res = await API.postData('ABSENEVEN', data);
                if (res.status === 'success') {
                    showToast(`Absensi event berhasil! Jarak: ${distLabel} (${status})`);
                    loadHomeEvents();
                } else {
                    showToast('Gagal absen event: ' + res.message, 'danger');
                }
            } catch (err) {
                console.error('Attendance error:', err);
                showToast('Kesalahan sistem, coba lagi.', 'danger');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalContent;
            }
        }

        // ==========================================
        // JOURNAL FUNCTIONS
        // ==========================================
        let cachedJournals = [];

        function toggleJournalModal(show) {
            const modal = document.getElementById('journalModal');
            modal.classList.toggle('hidden', !show);
            if (!show) document.getElementById('journalForm').reset();
        }

        function toggleJournalDetailModal(show, index = null) {
            const modal = document.getElementById('journalDetailModal');
            modal.classList.toggle('hidden', !show);

            if (show && index !== null) {
                const j = cachedJournals[index];
                document.getElementById('jdDate').textContent = new Date(j.Tanggal).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById('jdActivity').textContent = j.Aktifitas;

                const feedbackArea = document.getElementById('jdFeedbackArea');
                if (j.feedback) {
                    feedbackArea.classList.remove('hidden');
                    document.getElementById('jdFeedback').textContent = j.feedback;
                } else {
                    feedbackArea.classList.add('hidden');
                }
            }
        }

        async function loadJournals() {
            const feed = document.getElementById('journalFullFeed');
            if (!feed) return;

            try {
                const res = await API.getData('JURNAL');
                cachedJournals = res.data ? res.data.filter(j => j.NIS == user.nis) : [];
                renderJournals(cachedJournals);
            } catch (err) {
                feed.innerHTML = '<div class="glass-card" style="text-align: center; color: var(--danger); padding: 2rem;">Gagal memuat riwayat jurnal.</div>';
            }
        }

        function renderJournals(data) {
            const container = document.getElementById('journalFullFeed');
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="glass-card" style="text-align: center; padding: 4rem 2rem;">
                        <i class="fas fa-book-open" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1.5rem; opacity: 0.2;"></i>
                        <h3 style="margin-bottom: 0.5rem;">Jurnal Masih Kosong</h3>
                        <p style="color: var(--text-muted);">Belum ada riwayat kegiatan yang Anda catat.</p>
                    </div>
                `;
                return;
            }

            // Sort by Date descending
            data.sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal));

            container.innerHTML = data.map((j, index) => {
                let statusBadge = 'badge-primary';
                let statusLabel = j.status || 'Pending';
                let cardBorder = 'var(--glass-border)';

                if (statusLabel === 'Disetujui') { statusBadge = 'badge-success'; cardBorder = 'rgba(16, 185, 129, 0.2)'; }
                else if (statusLabel === 'Revisi') { statusBadge = 'badge-warning'; cardBorder = 'rgba(245, 158, 11, 0.2)'; }
                else if (statusLabel === 'Ditolak') { statusBadge = 'badge-danger'; cardBorder = 'rgba(239, 68, 68, 0.2)'; }

                const dateObj = new Date(j.Tanggal);
                const day = dateObj.getDate();
                const month = dateObj.toLocaleDateString('id-ID', { month: 'short' });
                const activitySnippet = j.Aktifitas.length > 100 ? j.Aktifitas.substring(0, 100) + '...' : j.Aktifitas;

                return `
                    <div class="glass-card" onclick="toggleJournalDetailModal(true, ${index})" style="padding: 1.25rem; border-color: ${cardBorder}; cursor: pointer; transition: transform 0.2s, background 0.2s;">
                        <div style="display: flex; gap: 1.25rem; align-items: start;">
                            <div style="min-width: 50px; height: 50px; background: rgba(255,255,255,0.03); border-radius: 1rem; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid var(--glass-border);">
                                <span style="font-size: 1.1rem; font-weight: 800; line-height: 1;">${day}</span>
                                <span style="font-size: 0.6rem; font-weight: 700; text-transform: uppercase; color: var(--primary-light);">${month}</span>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span class="badge ${statusBadge}" style="font-size: 0.65rem;">${statusLabel}</span>
                                    <span style="font-size: 0.7rem; color: var(--text-muted); font-family: monospace;">${j.ID_Jurnal || '-'}</span>
                                </div>
                                <p style="font-size: 0.85rem; line-height: 1.5; color: var(--text-main); margin-bottom: 0;">${activitySnippet}</p>
                            </div>
                            <div style="color: var(--text-muted); padding-top: 0.25rem;">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function submitJournal(e) {
            e.preventDefault();
            const btn = document.getElementById('btnSubmitJournal');
            const activity = document.getElementById('journalActivity').value;

            if (!activity.trim()) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';

            const data = {
                ID_Jurnal: 'JUR-' + Date.now(),
                NIS: user.nis,
                Tanggal: new Date().toISOString(),
                Aktifitas: activity,
                status: 'Pending',
                feedback: ''
            };

            try {
                const res = await API.postData('JURNAL', data);
                if (res.status === 'success') {
                    showToast('Jurnal harian berhasil dikirim!');
                    toggleJournalModal(false);
                    loadJournals();
                } else {
                    alert('Gagal mengirim jurnal: ' + res.message);
                }
            } catch (err) {
                alert('Kesalahan jaringan: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Kirim Jurnal';
            }
        }

        function logout() {
            AUTH.logout();
        }

        // Live Clock
        setInterval(() => {
            const now = new Date();
            const timeEl = document.getElementById('currentTime');
            if (timeEl) {
                timeEl.textContent = now.toLocaleTimeString('id-ID', { hour12: false }) + ' - ' + now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            }
        }, 1000);

        // Initial Page
        showPage('overview');

        // ==========================================
        // REPORT TITLE FUNCTIONS
        // ==========================================
        async function loadReportTitle() {
            const content = document.getElementById('reportTitleContent');
            const statusRow = document.getElementById('reportStatusRow');

            try {
                const res = await API.getData('JUDULLAPORAN');
                const myTitle = res.data ? res.data.find(t => t.NIS == user.nis) : null;
                window.currentReportTitle = myTitle;

                if (!myTitle) {
                    statusRow.classList.add('hidden');
                    renderSubmissionForm();
                } else {
                    renderReportTitleStatus(myTitle);
                }
            } catch (err) {
                content.innerHTML = '<p style="color: var(--danger); text-align: center;">Gagal memuat data.</p>';
            }
        }

        function renderSubmissionForm(existingTitle = '') {
            const content = document.getElementById('reportTitleContent');
            content.innerHTML = `
                <form id="reportTitleForm" onsubmit="submitReportTitle(event)">
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Judul Laporan yang Diajukan</label>
                        <textarea id="judulInput" required placeholder="Contoh: Implementasi Sistem Manajemen Inventaris di PT. Sejahtera" 
                            style="width: 100%; min-height: 120px; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.75rem; font-family: inherit;">${existingTitle}</textarea>
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                            Pastikan judul mencerminkan kegiatan PKL Anda dan sudah dikonsultasikan sebelumnya.
                        </p>
                    </div>
                    <div style="margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary" id="btnSubmitTitle" style="width: 100%; padding: 1rem;">
                            <i class="fas fa-paper-plane"></i> Ajukan Judul Laporan
                        </button>
                    </div>
                </form>
            `;
        }

        function renderReportTitleStatus(data) {
            const content = document.getElementById('reportTitleContent');
            const statusRow = document.getElementById('reportStatusRow');
            const icon = document.getElementById('reportStatusIcon');
            const badge = document.getElementById('reportStatusBadge');
            const message = document.getElementById('reportStatusMessage');
            const author = document.getElementById('reportProcessedBy');

            statusRow.classList.remove('hidden');
            author.textContent = data.DiprosesOleh ? `Oleh: ${data.DiprosesOleh}` : '';

            if (data.status === 'Disetujui') {
                statusRow.style.background = 'rgba(16, 185, 129, 0.05)';
                statusRow.style.borderColor = 'rgba(16, 185, 129, 0.2)';
                icon.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success);"></i>';
                badge.className = 'badge badge-success';
                badge.textContent = 'DISETUJUI';
                message.textContent = 'Judul laporan Anda telah disetujui. Silakan lanjutkan bimbingan.';
                content.innerHTML = `
                    <div class="glass-card" style="margin-top: 1rem; background: rgba(255,255,255,0.02);">
                        <label style="color: var(--text-muted); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; display: block; margin-bottom: 0.5rem;">JUDUL LAPORAN RESMI</label>
                        <div style="font-size: 1.15rem; font-weight: 800; color: var(--primary-light); line-height: 1.5;">${data.JudulAjuan}</div>
                        ${data.feedback ? `<div style="margin-top: 1.25rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 0.75rem; border-left: 3px solid var(--success); font-size: 0.85rem; color: var(--text-muted); font-style: italic;">"${data.feedback}"</div>` : ''}
                    </div>
                `;
            } else if (data.status === 'Revisi') {
                statusRow.style.background = 'rgba(245, 158, 11, 0.05)';
                statusRow.style.borderColor = 'rgba(245, 158, 11, 0.2)';
                icon.innerHTML = '<i class="fas fa-edit" style="color: var(--warning);"></i>';
                badge.className = 'badge badge-warning';
                badge.textContent = 'REVISI';
                message.textContent = 'Perlu perbaikan pada judul yang diajukan.';
                content.innerHTML = `
                    <div style="margin-bottom: 2rem; padding: 1.25rem; background: rgba(245, 158, 11, 0.03); border-radius: 1rem; border: 1px dashed var(--warning);">
                        <strong style="color: var(--warning); display: block; margin-bottom: 0.5rem; font-size: 0.9rem;"><i class="fas fa-comment-dots"></i> Catatan Revisi:</strong>
                        <div style="font-size: 0.85rem; line-height: 1.6; color: var(--text-main);">${data.feedback || 'Silakan hubungi pembimbing untuk detail revisi.'}</div>
                    </div>
                `;
                renderSubmissionForm(data.JudulAjuan);
            } else if (data.status === 'Ditolak') {
                statusRow.style.background = 'rgba(239, 68, 68, 0.05)';
                statusRow.style.borderColor = 'rgba(239, 68, 68, 0.2)';
                icon.innerHTML = '<i class="fas fa-times-circle" style="color: var(--danger);"></i>';
                badge.className = 'badge badge-danger';
                badge.textContent = 'DITOLAK';
                message.textContent = 'Judul ditolak. Mohon ajukan judul baru.';
                content.innerHTML = `
                    <div style="margin-bottom: 2rem; padding: 1.25rem; background: rgba(239, 68, 68, 0.03); border-radius: 1rem; border: 1px dashed var(--danger);">
                        <strong style="color: var(--danger); display: block; margin-bottom: 0.5rem; font-size: 0.9rem;"><i class="fas fa-exclamation-circle"></i> Alasan Penolakan:</strong>
                        <div style="font-size: 0.85rem; line-height: 1.6; color: var(--text-main);">${data.feedback || 'Judul tidak sesuai dengan tema PKL.'}</div>
                    </div>
                `;
                renderSubmissionForm('');
            } else {
                statusRow.style.background = 'rgba(255, 255, 255, 0.03)';
                statusRow.style.borderColor = 'var(--glass-border)';
                icon.innerHTML = '<i class="fas fa-history" style="color: var(--text-muted);"></i>';
                badge.className = 'badge';
                badge.textContent = 'PENDING';
                message.textContent = 'Menunggu verifikasi dari pembimbing.';
                content.innerHTML = `
                    <div class="glass-card" style="margin-top: 1rem; background: rgba(255,255,255,0.02); opacity: 0.7;">
                        <label style="color: var(--text-muted); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; display: block; margin-bottom: 0.5rem;">JUDUL YANG DIAJUKAN</label>
                        <div style="font-size: 1.15rem; font-weight: 700; color: var(--text-main); line-height: 1.5;">${data.JudulAjuan}</div>
                    </div>
                `;
            }
        }

        async function submitReportTitle(e) {
            e.preventDefault();
            const btn = document.getElementById('btnSubmitTitle');
            const judul = document.getElementById('judulInput').value;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

            const data = {
                NIS: user.nis,
                JudulAjuan: judul,
                status: 'Pending',
                feedback: '',
                DiprosesOleh: ''
            };

            try {
                let res;
                if (window.currentReportTitle) {
                    res = await API.updateData('JUDULLAPORAN', window.currentReportTitle.ID_Judul, data);
                } else {
                    data.ID_Judul = 'JDL-' + Date.now();
                    res = await API.postData('JUDULLAPORAN', data);
                }

                if (res.status === 'success') {
                    showToast('Judul laporan berhasil diajukan!');
                    loadReportTitle();
                } else {
                    alert('Gagal: ' + res.message);
                }
            } catch (err) {
                alert('Kesalahan jaringan.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Ajukan Judul Laporan';
            }
        }

        // ==========================================
        // PDF EXPORT FUNCTIONS
        // ==========================================
        async function getExportMetadata() {
            try {
                const [resSiswa, resDataPKL, resLoc] = await Promise.all([
                    API.getData('DATASISWA'),
                    API.getData('DATAPKL'),
                    API.getData('LOKASIPKL')
                ]);

                const studentInfo = resSiswa.data.find(s => s.nis == user.nis) || {};
                const studentPKL = resDataPKL.data.find(s => s.nis == user.nis);
                let mentorInfo = { NamaMentor: 'Mentor Lapangan' };

                if (studentPKL && studentPKL.ID_PKL) {
                    const loc = resLoc.data.find(l => l.ID_PKL === studentPKL.ID_PKL);
                    if (loc) mentorInfo = loc;
                }

                return { studentInfo, mentorInfo };
            } catch (e) {
                console.error('Metadata error:', e);
                return { studentInfo: {}, mentorInfo: { NamaMentor: 'Mentor Lapangan' } };
            }
        }

        async function exportAttendancePDF() {
            const monthVal = document.getElementById('attMonthFilter').value;
            if (!monthVal) return showToast('Pilih bulan terlebih dahulu!', 'danger');

            const [year, month] = monthVal.split('-');
            const date = new Date(year, month - 1);
            const monthName = date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });

            showToast('Menyiapkan laporan kehadiran...');

            try {
                const res = await API.getData('KEHADIRAN');
                const myAttendance = res.data ? res.data.filter(a => {
                    const d = new Date(a.Tanggal || a.tanggal);
                    return a.NIS == user.nis && d.getMonth() == (month - 1) && d.getFullYear() == year;
                }) : [];

                const { studentInfo, mentorInfo } = await getExportMetadata();
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFontSize(14);
                doc.text('LAPORAN KEHADIRAN SISWA PKL', 105, 15, { align: 'center' });

                doc.setFontSize(9);
                doc.text(`Nama: ${studentInfo.nama || user.nama}`, 20, 25);
                doc.text(`NIS: ${studentInfo.nis || user.nis}`, 20, 30);
                doc.text(`Kelas: ${studentInfo.kelas || '-'}`, 20, 35);
                doc.text(`Jurusan: ${studentInfo.jurusan || '-'}`, 120, 25);
                doc.text(`Bulan: ${monthName}`, 120, 30);

                // Table Data
                const daysInMonth = new Date(year, month, 0).getDate();
                const rows = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const currentDay = new Date(year, month - 1, i);
                    const dayStr = i.toString().padStart(2, '0');
                    const monthStr = month.toString().padStart(2, '0');
                    const datePrefix = `${year}-${monthStr}-${dayStr}`;

                    const record = myAttendance.find(a => (a.Tanggal || a.tanggal).startsWith(datePrefix));

                    rows.push([
                        i,
                        currentDay.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short' }),
                        record ? record.time_in || '-' : '-',
                        record ? record.time_out || '-' : '-',
                        record ? record.StatusAbsen || '-' : '-',
                        record ? (record.JarakAbsen || record.jarak || '-') : '-'
                    ]);
                }

                doc.autoTable({
                    startY: 45,
                    head: [['No', 'Tanggal', 'Jam Masuk', 'Jam Pulang', 'Status', 'Jarak']],
                    body: rows,
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 1.5 },
                    headStyles: { fillColor: [79, 70, 229] },
                    margin: { top: 45, bottom: 40 }
                });

                // Signature Section (only on the last page, but should be one page anyway)
                const finalY = doc.lastAutoTable.finalY + 15;
                if (finalY < 250) {
                    doc.setFontSize(9);
                    doc.text('Pembimbing Industri,', 150, finalY);
                    doc.text('( ____________________ )', 150, finalY + 20);
                    doc.text(mentorInfo.NamaMentor || 'Mentor Lapangan', 150, finalY + 25);
                }

                doc.save(`Kehadiran_${user.nama}_${monthVal}.pdf`);
            } catch (err) {
                console.error(err);
                showToast('Gagal mengekspor PDF', 'danger');
            }
        }

        async function exportJournalPDF() {
            const monthVal = document.getElementById('journalMonthFilter').value;
            if (!monthVal) return showToast('Pilih bulan terlebih dahulu!', 'danger');

            const [year, month] = monthVal.split('-');
            const date = new Date(year, month - 1);
            const monthName = date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });

            showToast('Menyiapkan laporan jurnal...');

            try {
                const res = await API.getData('JURNAL');
                const myJournals = res.data ? res.data.filter(j => {
                    const d = new Date(j.Tanggal);
                    return j.NIS == user.nis && d.getMonth() == (month - 1) && d.getFullYear() == year;
                }) : [];

                const { studentInfo, mentorInfo } = await getExportMetadata();
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFontSize(14);
                doc.text('LAPORAN JURNAL HARIAN SISWA PKL', 105, 15, { align: 'center' });

                doc.setFontSize(9);
                doc.text(`Nama: ${studentInfo.nama || user.nama}`, 20, 25);
                doc.text(`NIS: ${studentInfo.nis || user.nis}`, 20, 30);
                doc.text(`Kelas: ${studentInfo.kelas || '-'}`, 20, 35);
                doc.text(`Jurusan: ${studentInfo.jurusan || '-'}`, 120, 25);
                doc.text(`Bulan: ${monthName}`, 120, 30);

                // Table Data
                const daysInMonth = new Date(year, month, 0).getDate();
                const rows = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const currentDay = new Date(year, month - 1, i);

                    // Robust Date Matching: Compare YYYY, MM, DD
                    const record = myJournals.find(j => {
                        const jd = new Date(j.Tanggal);
                        return jd.getFullYear() == year &&
                            (jd.getMonth() + 1) == month &&
                            jd.getDate() == i;
                    });

                    let statusText = '-';
                    if (record && record.status === 'Disetujui') {
                        statusText = 'Disetujui';
                    }

                    rows.push([
                        i,
                        currentDay.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short' }),
                        record ? (record.Aktifitas || record.aktifitas || '-') : '-',
                        statusText
                    ]);
                }

                doc.autoTable({
                    startY: 45,
                    head: [['No', 'Tanggal', 'Aktivitas / Kegiatan', 'Status']],
                    body: rows,
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 1.5 },
                    headStyles: { fillColor: [79, 70, 229] },
                    columnStyles: {
                        2: { cellWidth: 'auto' },
                        3: { cellWidth: 25, halign: 'center' }
                    },
                    margin: { top: 45, bottom: 40 }
                });

                // Signature Section
                const finalY = doc.lastAutoTable.finalY + 15;
                if (finalY < 250) {
                    doc.setFontSize(9);
                    doc.text('Pembimbing Industri,', 150, finalY);
                    doc.text('( ____________________ )', 150, finalY + 20);
                    doc.text(mentorInfo.NamaMentor || 'Mentor Lapangan', 150, finalY + 25);
                }

                doc.save(`Jurnal_${user.nama}_${monthVal}.pdf`);
            } catch (err) {
                console.error(err);
                showToast('Gagal mengekspor PDF', 'danger');
            }
        }

        // ==========================================
        // SUBMISSION FUNCTIONS
        // ==========================================
        let submissionType = 'exist';
        let selectedSubStudents = [];
        let allStudents = [];
        let allLocations = [];
        let subMap, subMarker;

        function toggleSubmissionModal(show) {
            const modal = document.getElementById('submissionModal');
            if (show) {
                // Check limit first
                const currentCount = document.querySelectorAll('#submissionTableBody tr:not(.empty-row)').length;
                if (currentCount >= 3) {
                    showToast('Batas pengajuan maksimal 3 kali (termasuk relokasi).', 'warning');
                    return;
                }
                modal.classList.remove('hidden');
                loadSelectionPools();
            } else {
                modal.classList.add('hidden');
                document.getElementById('formSubmission').reset();
                selectedSubStudents = [];
                renderSelectedStudents();
                toggleSubmissionType('exist');
                if (subMarker) {
                    subMap.removeLayer(subMarker);
                    subMarker = null;
                }
                const coordsDisp = document.getElementById('subCoordsDisplay');
                if (coordsDisp) coordsDisp.textContent = 'Koordinat Belum Terpilih';
            }
        }

        function toggleSubmissionType(type) {
            submissionType = type;
            document.getElementById('typeExist').classList.remove('active');
            document.getElementById('typeNew').classList.remove('active');
            if (type === 'exist') {
                document.getElementById('typeExist').classList.add('active');
                document.getElementById('areaExist').classList.remove('hidden');
                document.getElementById('areaNew').classList.add('hidden');
            } else {
                document.getElementById('typeNew').classList.add('active');
                document.getElementById('areaExist').classList.add('hidden');
                document.getElementById('areaNew').classList.remove('hidden');
                setTimeout(() => initSubmissionMap(), 100);
            }
        }

        // --- Map Functions for Submission ---
        function initSubmissionMap() {
            if (!subMap) {
                subMap = L.map('locationMapSub').setView([-7.9666, 112.6326], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: ' OpenStreetMap'
                }).addTo(subMap);
                L.control.scale().addTo(subMap);

                subMap.on('click', function (e) {
                    const lat = e.latlng.lat.toFixed(7);
                    const lng = e.latlng.lng.toFixed(7);
                    setSubMarker(lat, lng);
                });
            } else {
                subMap.invalidateSize();
            }
        }

        function setSubMarker(lat, lng) {
            if (subMarker) subMap.removeLayer(subMarker);
            subMarker = L.marker([lat, lng]).addTo(subMap);
            document.getElementById('subNewLat').value = lat;
            document.getElementById('subNewLng').value = lng;
            document.getElementById('subCoordsDisplay').textContent = `Terpilih: ${lat}, ${lng}`;
            subMap.panTo([lat, lng]);
        }

        async function searchSubAddress() {
            const query = document.getElementById('subMapSearch').value;
            if (!query) return;
            const btn = event.currentTarget || event.target;
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await res.json();
                if (data && data.length > 0) {
                    const { lat, lon } = data[0];
                    subMap.setView([lat, lon], 15);
                    setSubMarker(lat, lon);
                } else {
                    showToast('Lokasi tidak ditemukan.', 'warning');
                }
            } catch (e) {
                showToast('Gagal mencari lokasi.', 'danger');
            } finally {
                btn.innerHTML = original;
            }
        }

        function getCurrentSubLocation() {
            if (!navigator.geolocation) return showToast('Geolokasi tidak didukung.', 'warning');
            const btn = event.currentTarget || event.target;
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude.toFixed(7);
                    const lng = pos.coords.longitude.toFixed(7);
                    subMap.setView([lat, lng], 17);
                    setSubMarker(lat, lng);
                    btn.innerHTML = original;
                },
                (err) => {
                    showToast('Gagal mendapatkan lokasi.', 'danger');
                    btn.innerHTML = original;
                },
                { enableHighAccuracy: true }
            );
        }

        async function loadSelectionPools() {
            try {
                const [resLoc, resSiswa] = await Promise.all([
                    API.getData('LOKASIPKL'),
                    API.getData('DATASISWA')
                ]);

                if (resLoc.status === 'success') {
                    // Try to get jurusan if missing
                    if (!user.jurusan) {
                        const me = resSiswa.data ? resSiswa.data.find(s => s.nis == user.nis) : null;
                        if (me) user.jurusan = me.jurusan || me.Jurusan;
                    }

                    const userJurusan = (user.jurusan || "").toString().toLowerCase().trim();
                    allLocations = resLoc.data.filter(l => {
                        const locJurusan = (l.Jurusan || "").toString().toLowerCase().trim();
                        return locJurusan === userJurusan || locJurusan === 'semua' || locJurusan === 'all';
                    });

                    const select = document.getElementById('subLocId');
                    if (allLocations.length === 0) {
                        select.innerHTML = '<option value="">-- Tidak ada tempat tersedia untuk jurusan ' + (user.jurusan || 'Anda') + ' --</option>';
                    } else {
                        select.innerHTML = '<option value="">-- Pilih Tempat PKL --</option>' +
                            allLocations.map(l => `<option value="${l.ID_PKL}">${l.NamaTempat || 'Tanpa Nama'} (${l.BidangUsaha || '-'})</option>`).join('');
                    }
                }

                if (resSiswa.status === 'success') {
                    const userJurusan = (user.jurusan || "").toString().toLowerCase();
                    allStudents = resSiswa.data.filter(s =>
                        (s.jurusan || "").toString().toLowerCase() === userJurusan &&
                        s.nis != user.nis
                    );
                }
            } catch (err) {
                console.error(err);
                showToast('Gagal memuat data pendukung', 'danger');
            }
        }

        function showStudentList(show) {
            const dropdown = document.getElementById('studentListDropdown');
            if (show) {
                dropdown.classList.remove('hidden');
                filterStudentList();
            } else {
                setTimeout(() => dropdown.classList.add('hidden'), 200);
            }
        }

        function filterStudentList() {
            const query = document.getElementById('studentSearch').value.toLowerCase();
            const dropdown = document.getElementById('studentListDropdown');
            const filtered = allStudents.filter(s =>
                (s.nama.toLowerCase().includes(query) || s.nis.toString().includes(query)) &&
                !selectedSubStudents.some(sel => sel.nis === s.nis)
            );

            dropdown.innerHTML = filtered.length === 0
                ? '<div style="padding: 1rem; color: var(--text-muted); font-size: 0.8rem;">Tidak ada siswa ditemukan</div>'
                : filtered.map(s => `
                    <div class="dropdown-item" onclick="selectStudent('${s.nis}', '${s.nama}')" 
                        style="padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.85rem;">
                        <div style="font-weight: 600;">${s.nama}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); display: flex; justify-content: space-between;">
                            <span>NIS: ${s.nis}</span>
                            <span style="font-weight: 600; color: var(--primary);">${s.kelas || '-'}</span>
                        </div>
                    </div>
                `).join('');
        }

        function selectStudent(nis, nama) {
            if (selectedSubStudents.length >= 5) {
                showToast('Maksimal 5 orang anggota lainnya.', 'warning');
                return;
            }
            if (!selectedSubStudents.some(s => s.nis === nis)) {
                selectedSubStudents.push({ nis, nama });
                renderSelectedStudents();
                document.getElementById('studentSearch').value = '';
                document.getElementById('studentListDropdown').classList.add('hidden');
            }
        }

        function removeStudent(nis) {
            selectedSubStudents = selectedSubStudents.filter(s => s.nis !== nis);
            renderSelectedStudents();
        }

        function renderSelectedStudents() {
            const container = document.getElementById('selectedStudentList');
            container.innerHTML = selectedSubStudents.map(s => `
                <div class="badge" style="background: var(--primary); color: white; padding: 0.4rem 0.75rem; border-radius: 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem;">
                    ${s.nama}
                    <i class="fas fa-times-circle" style="cursor: pointer;" onclick="removeStudent('${s.nis}')"></i>
                </div>
            `).join('');
        }

        async function loadSubmissionData() {
            const container = document.getElementById('submissionTableBody');
            const alert = document.getElementById('submissionLimitAlert');
            const btn = document.getElementById('btnNewSubmission');

            try {
                const res = await API.getData('PENGAJUANPKL');
                if (res.status === 'success') {
                    const mySubmissions = res.data.filter(s => {
                        if (!s.NIS) return false;
                        return s.NIS.toString().split(',').map(n => n.trim()).includes(user.nis.toString());
                    });

                    window.allMySubmissions = mySubmissions;
                    const approvedCount = mySubmissions.filter(s => s.Status === 'Disetujui').length;

                    if (approvedCount >= 3) {
                        alert.innerHTML = '<i class="fas fa-info-circle"></i> Anda telah mencapai batas maksimal 3 pengajuan.';
                        alert.classList.remove('hidden');
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                    } else {
                        alert.classList.add('hidden');
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    }

                    if (mySubmissions.length === 0) {
                        container.innerHTML = `
                            <div class="glass-card" style="text-align: center; padding: 4rem 2rem;">
                                <i class="fas fa-paper-plane" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1.5rem; opacity: 0.2;"></i>
                                <h3 style="margin-bottom: 0.5rem;">Belum Ada Pengajuan</h3>
                                <p style="color: var(--text-muted);">Silakan buat pengajuan pertama Anda dengan klik tombol di atas.</p>
                            </div>
                        `;
                    } else {
                        const resLoc = await API.getData('LOKASIPKL');
                        const locations = resLoc.status === 'success' ? resLoc.data : [];

                        container.innerHTML = mySubmissions.sort((a, b) => (b.ID_PENGAJUAN || '').localeCompare(a.ID_PENGAJUAN || '')).map((s, idx) => {
                            const loc = locations.find(l => l.ID_PKL === s.ID_PKL);
                            const locName = loc ? loc.NamaTempat : (s.ID_PKL && s.ID_PKL.startsWith('PKL-NEW-') ? 'Tempat Baru (Menunggu)' : s.ID_PKL || '-');

                            let statusBadge = 'badge-primary';
                            let cardBorder = 'var(--glass-border)';
                            if (s.Status === 'Disetujui') { statusBadge = 'badge-success'; cardBorder = 'rgba(16, 185, 129, 0.2)'; }
                            if (s.Status === 'Ditolak') { statusBadge = 'badge-danger'; cardBorder = 'rgba(239, 68, 68, 0.2)'; }

                            return `
                                <div class="glass-card" style="padding: 1.5rem; border-color: ${cardBorder};">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 0.25rem;">${s.TipeAjuan || 'PENGAJUAN'}</div>
                                            <h4 style="margin: 0; font-size: 1.1rem; font-weight: 800; color: var(--primary-light);">${locName}</h4>
                                        </div>
                                        <span class="badge ${statusBadge}">${s.Status}</span>
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem 1.5rem; margin-bottom: 1.5rem; font-size: 0.85rem; color: var(--text-muted);">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; white-space: nowrap;"><i class="fas fa-calendar-alt" style="color: var(--primary-light);"></i> <span>${formatDate(s.StartDate)}</span></div>
                                        <div style="display: flex; align-items: center; gap: 0.5rem; white-space: nowrap;"><i class="fas fa-calendar-check" style="color: var(--secondary-light);"></i> <span>${formatDate(s.EndDate)}</span></div>
                                    </div>
                                    <div style="display: flex; gap: 0.75rem;">
                                        <button class="btn glass" onclick="openViewSubmission('${s.ID_PENGAJUAN}')" style="flex: 1; padding: 0.6rem; border-radius: 0.75rem; font-size: 0.8rem; font-weight: 700;">
                                            <i class="fas fa-eye"></i> DETAIL
                                        </button>
                                        ${s.Status === 'Disetujui' ? `
                                            <button class="btn btn-primary" onclick="printApplicationPDF('${s.ID_PENGAJUAN}')" style="flex: 1; padding: 0.6rem; border-radius: 0.75rem; font-size: 0.8rem; font-weight: 700;">
                                                <i class="fas fa-file-pdf"></i> CETAK PDF
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = '<div class="glass-card" style="text-align: center; padding: 3rem; color: var(--danger);">Gagal memuat data pengajuan.</div>';
            }
        }

        function toggleViewSubmissionModal(show) {
            const modal = document.getElementById('viewSubmissionModal');
            modal.classList.toggle('hidden', !show);
            modal.style.display = show ? 'flex' : 'none';
        }

        async function openViewSubmission(id) {
            const s = window.allMySubmissions.find(item => item.ID_PENGAJUAN === id);
            if (!s) return;

            const content = document.getElementById('viewSubmissionContent');
            const resLoc = await API.getData('LOKASIPKL');
            const loc = resLoc.status === 'success' ? resLoc.data.find(l => l.ID_PKL === s.ID_PKL) : null;
            const resSiswa = await API.getData('DATASISWA');
            const allStudents = resSiswa.status === 'success' ? resSiswa.data : [];

            const nisList = (s.NIS || '').toString().split(',').filter(n => n.trim()).map(n => n.trim());
            const groupMembers = nisList.map(nis => {
                const stu = allStudents.find(item => item.nis == nis);
                return stu ? `${stu.nama} (${stu.nis})` : nis;
            });

            const sectionStyle = "margin-bottom: 1rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 1rem;";
            const labelStyle = "font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 0.25rem;";
            const valueStyle = "font-weight: 600; color: var(--text-dark);";

            content.innerHTML = `
                <div style="${sectionStyle}">
                    <span style="${labelStyle}">ID Pengajuan / Tipe</span>
                    <div style="${valueStyle}">${s.ID_PENGAJUAN || '-'} / <span class="badge" style="background: var(--primary); color: white; scale: 0.8; transform-origin: left;">${s.TipeAjuan || '-'}</span></div>
                </div>
                <div style="${sectionStyle}">
                    <span style="${labelStyle}">Tempat PKL</span>
                    <div style="${valueStyle}">${loc ? loc.NamaTempat : s.ID_PKL || '-'}</div>
                    ${loc ? `<div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">${loc.Alamat}</div>` : ''}
                </div>
                <div style="${sectionStyle}">
                    <span style="${labelStyle}">Periode PKL</span>
                    <div style="${valueStyle}">${s.StartDate ? formatDate(s.StartDate) : '-'} s/d ${s.EndDate ? formatDate(s.EndDate) : '-'}</div>
                </div>
                <div style="${sectionStyle}">
                    <span style="${labelStyle}">Rekan Kelompok</span>
                    <div style="font-size: 0.9rem; line-height: 1.5;">
                        <ul style="margin: 0; padding-left: 1.25rem;">
                            ${groupMembers.length > 0 ? groupMembers.map(m => `<li>${m}</li>`).join('') : '<li>-</li>'}
                        </ul>
                    </div>
                </div>
                <div>
                    <span style="${labelStyle}">Status / Catatan</span>
                    <div style="${valueStyle} margin-bottom: 0.5rem;">${s.Status || '-'} ${s.TanggalPersetujuan && s.TanggalPersetujuan !== '-' ? `<small style="font-weight: 400; color: var(--text-muted);">pada ${s.TanggalPersetujuan}</small>` : ''}</div>
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px dashed #cbd5e1; font-size: 0.85rem; min-height: 60px;">
                        <strong>Feedback:</strong><br>
                        ${s.Catatan || 'Menunggu peninjauan.'}
                    </div>
                </div>
            `;

            toggleViewSubmissionModal(true);
        }

        async function printApplicationPDF(id) {
            showToast('Sedang membuat dokumen PDF...', 'info');
            try {
                const res = await API.postData('', { action: 'generatePermohonan', id: id });
                if (res.status === 'success' && res.url) {
                    window.open(res.url, '_blank');
                    showToast('Dokumen PDF berhasil dibuat!', 'success');
                } else {
                    showToast('Gagal membuat PDF: ' + (res.message || 'Unknown error'), 'danger');
                }
            } catch (err) {
                console.error(err);
                showToast('Kesalahan jaringan: ' + err.message, 'danger');
            }
        }

        function switchMyDataState(state) {
            const view = document.getElementById('myDataViewSection');
            const edit = document.getElementById('myDataEditSection');
            const actions = document.getElementById('myDataActions');

            if (state === 'edit') {
                view.classList.add('hidden');
                edit.classList.remove('hidden');
                actions.classList.add('hidden');
            } else {
                view.classList.remove('hidden');
                edit.classList.add('hidden');
                actions.classList.remove('hidden');
            }
        }

        async function loadCurrentPKLLocation() {
            const el = document.getElementById('currentPKLLocation');
            if (!el) return;
            try {
                const resDataPKL = await API.getData('DATAPKL');
                const studentPKL = resDataPKL.data.find(s => s.nis == user.nis);
                if (!studentPKL) {
                    el.textContent = 'Belum Ada';
                    return;
                }

                const targetId = studentPKL.ID_PKL_3 || studentPKL.ID_PKL_2 || studentPKL.ID_PKL;
                if (!targetId) {
                    el.textContent = 'Belum Ada';
                    return;
                }

                const resLoc = await API.getData('LOKASIPKL');
                const loc = resLoc.data.find(l => l.ID_PKL === targetId);
                el.textContent = loc ? loc.NamaTempat : 'Tidak Ditemukan';
            } catch (e) {
                console.error(e);
                el.textContent = 'Gagal Memuat';
            }
        }

        async function loadMyData() {
            const btn = document.getElementById('btnSaveMyData');
            const originalHTML = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat...';
            }

            try {
                const res = await API.getData('DATASISWA');
                const student = (res.data || []).find(s => s.nis == user.nis);
                if (student) {
                    // Helper to safely set text content
                    const setT = (id, val) => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = val || '-';
                    };
                    // Helper to safely set value
                    const setV = (id, val) => {
                        const el = document.getElementById(id);
                        if (el) el.value = val || '';
                    };

                    // Update View State
                    setT('vDataNama', student.nama);
                    setT('vDataNis', student.nis);
                    setT('vDataNik', student.NIK);
                    setT('vDataJurusanKelas', `${student.jurusan || '-'} / ${student.kelas || student.Kelas || '-'}`);

                    let ttl = '-';
                    if (student.TempatLahir || student.TanggalLahir) {
                        const tg = student.TanggalLahir ? new Date(student.TanggalLahir).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : '';
                        ttl = `${student.TempatLahir || ''}${student.TempatLahir && tg ? ', ' : ''}${tg}`;
                    }
                    setT('vDataTTL', ttl);
                    setT('vDataGolDarah', student.GolDarah);
                    setT('vDataKontak', student.KontakSiswa);

                    const ortuText = student.NamaOrangtua || '-';
                    const ortuKontak = student.KontakOrangtua || '-';
                    setT('vDataOrangtua', ortuText);
                    setT('vDataKontakOrtu', ortuKontak);

                    const photoView = document.getElementById('myDataPhotoView');
                    if (photoView) photoView.src = student.Photo || '';

                    // Update Edit State (Pre-fill form)
                    setV('myDataNis', student.nis);
                    setV('myDataNama', student.nama);
                    setV('myDataNik', student.NIK);
                    setV('myDataJurusan', student.jurusan);
                    setV('myDataKelas', student.kelas || student.Kelas);
                    setV('myDataTempatLahir', student.TempatLahir);

                    if (student.TanggalLahir) {
                        const date = new Date(student.TanggalLahir);
                        const y = date.getFullYear();
                        const m = String(date.getMonth() + 1).padStart(2, '0');
                        const d = String(date.getDate()).padStart(2, '0');
                        setV('myDataTanggalLahir', `${y}-${m}-${d}`);
                    }

                    const golDarahEl = document.getElementById('myDataGolDarah');
                    if (golDarahEl) golDarahEl.value = student.GolDarah || '-';

                    setV('myDataKontakSiswa', student.KontakSiswa);
                    setV('myDataNamaOrangtua', student.NamaOrangtua);
                    setV('myDataKontakOrangtua', student.KontakOrangtua);

                    const photoPreview = document.getElementById('myDataPhotoPreview');
                    if (photoPreview && student.Photo) {
                        photoPreview.src = student.Photo;
                    }
                }
            } catch (err) {
                console.error(err);
                showToast('Gagal memuat data pribadi.', 'danger');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Simpan Perubahan';
                }
            }
        }

        function previewMyDataPhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('myDataPhotoPreview').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function saveMyData(event) {
            event.preventDefault();
            const btn = document.getElementById('btnSaveMyData');
            const originalHTML = btn.innerHTML;

            const data = {
                NIK: document.getElementById('myDataNik').value,
                TempatLahir: document.getElementById('myDataTempatLahir').value,
                TanggalLahir: document.getElementById('myDataTanggalLahir').value,
                GolDarah: document.getElementById('myDataGolDarah').value,
                KontakSiswa: document.getElementById('myDataKontakSiswa').value,
                NamaOrangtua: document.getElementById('myDataNamaOrangtua').value,
                KontakOrangtua: document.getElementById('myDataKontakOrangtua').value
            };

            if (data.NIK && data.NIK.length !== 16) {
                showToast('NIK harus terdiri dari 16 digit angka.', 'warning');
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                return;
            }

            const photoFile = document.getElementById('myDataPhotoInput').files[0];

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

            try {
                if (photoFile) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengompres Foto...';
                    const compressed = await API.compressImage(photoFile);
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengunggah Foto...';
                    const uploadRes = await API.uploadFile(compressed);
                    if (uploadRes.status === 'success') {
                        data.Photo = uploadRes.url;
                    } else {
                        throw new Error('Gagal unggah foto: ' + uploadRes.message);
                    }
                }

                const res = await API.updateData('DATASISWA', user.nis, data);
                if (res.status === 'success') {
                    showToast('Data pribadi berhasil diperbarui!', 'success');
                    await loadMyData();
                    switchMyDataState('view');
                    if (data.Photo) user.photo = data.Photo;
                    updateUserUI();
                } else {
                    throw new Error(res.message);
                }
            } catch (err) {
                console.error(err);
                showToast('Gagal menyimpan: ' + err.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        async function submitPKLApplication(e) {
            e.preventDefault();
            const btn = document.getElementById('btnSubmitFinal');
            const originalHTML = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

                const idPengajuan = 'AJU-' + Date.now();
                let idPkl = document.getElementById('subLocId').value;
                const tanggal = new Date().toISOString();

                if (submissionType === 'new') {
                    idPkl = 'PKL-NEW-' + Date.now();
                    const newLocData = {
                        ID_PKL: idPkl,
                        NamaTempat: document.getElementById('subNewNama').value,
                        BidangUsaha: document.getElementById('subNewBidang').value,
                        Alamat: document.getElementById('subNewAlamat').value,
                        NamaPimpinan: document.getElementById('subNewPimpinan').value,
                        NamaMentor: document.getElementById('subNewMentor').value,
                        KontakMentor: document.getElementById('subNewKontak').value,
                        Jurusan: user.jurusan,
                        LAT: document.getElementById('subNewLat').value || 0,
                        LNG: document.getElementById('subNewLng').value || 0,
                        Email: document.getElementById('subNewEmail').value || '-',
                        description: document.getElementById('subNewDesc').value || '-'
                    };

                    if (!newLocData.NamaTempat || !newLocData.Alamat) {
                        throw new Error('Nama Tempat dan Alamat wajib diisi.');
                    }
                    if (newLocData.LAT == 0) {
                        throw new Error('Silakan pilih lokasi tempat PKL pada peta.');
                    }

                    const resNewLoc = await API.postData('LOKASIPKL', newLocData);
                    if (resNewLoc.status !== 'success') throw new Error('Gagal menyimpan usulan tempat baru.');
                }

                if (!idPkl) throw new Error('Silakan pilih tempat PKL.');

                // 1. Calculate sequence number based on approved submissions
                const resCheck = await API.getData('PENGAJUANPKL');
                let approvedCount = 0;
                if (resCheck.status === 'success') {
                    approvedCount = resCheck.data.filter(s => {
                        if (s.Status !== 'Disetujui' || !s.NIS) return false;
                        return s.NIS.toString().split(',').map(n => n.trim()).includes(user.nis.toString());
                    }).length;
                }

                if (approvedCount >= 3) throw new Error('Anda sudah mencapai batas maksimal 3 pengajuan yang disetujui.');

                const sequenceLabel = `Ajuan Ke-${approvedCount + 1}`;

                // 2. Combine all applicants into one string
                const allNis = [user.nis.toString(), ...selectedSubStudents.map(s => s.nis.toString())].join(', ');

                // 3. Post a single grouped record
                await API.postData('PENGAJUANPKL', {
                    ID_PENGAJUAN: idPengajuan,
                    NIS: allNis,
                    Jurusan: user.jurusan,
                    ID_PKL: idPkl,
                    TanggalAjuan: tanggal,
                    StartDate: document.getElementById('subStartDate').value,
                    EndDate: document.getElementById('subEndDate').value,
                    TipeAjuan: sequenceLabel,
                    Status: 'Pending',
                    DisetujuiOleh: '-',
                    TanggalPersetujuan: '-',
                    Catatan: '-'
                });

                showToast('Pengajuan PKL berhasil dikirim!', 'success');
                toggleSubmissionModal(false);
                loadSubmissionData();
            } catch (err) {
                console.error(err);
                showToast('Gagal: ' + err.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }
    </script>
</body>

</html>