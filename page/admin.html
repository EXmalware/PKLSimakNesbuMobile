<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Admin - SIMAK NESBU</title>
    <!-- External Libraries for Export/Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet for Map Picker -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @media print {

            .sidebar,
            .mobile-header,
            .no-print,
            header,
            .btn-close,
            .toast-container,
            .section {
                display: none !important;
            }

            @page {
                margin-top: 0;
            }

            .main-content {
                margin: 0 !important;
                padding: 0 !important;
            }
        }

        .compact-user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .compact-user-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .compact-user-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--electric-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .compact-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 1.5px solid rgba(255, 255, 255, 0.1);
        }

        .compact-user-name {
            font-size: 0.85rem;
            font-weight: 500;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }
    </style>
    <script>
        /* Mobile Helper functions */
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('active');
                document.body.classList.toggle('sidebar-open', sidebar.classList.contains('active'));
            }
        }

        /* Override showSection for Animations */
        function toggleProfileDropdown(e) {
            if (e) e.stopPropagation();
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }

        window.onclick = function (event) {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown && dropdown.classList.contains('active')) {
                if (!event.target.closest('.profile-dropdown-container')) {
                    dropdown.classList.remove('active');
                }
            }
        }

        function updateUserUI() {
            const user = AUTH.getUser();
            if (!user) return;

            const welcomeName = document.getElementById('userName');
            if (welcomeName) welcomeName.textContent = user.nama || 'Admin';

            const fallbackUrl = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.nama || 'Admin') + '&background=random';
            const avatarSrc = user.photo ? API.getDriveThumbnail(user.photo) : fallbackUrl;

            const avatars = ['sideAvatar', 'headerAvatar'];
            avatars.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.onerror = function () { this.onerror = null; this.src = fallbackUrl; };
                    el.src = avatarSrc;
                    el.style.display = 'block';
                }
            });
        }

        /* Override showSection for Animations */
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            const navLinks = document.querySelectorAll('.sidebar-menu a');
            const bottomLinks = document.querySelectorAll('.bottom-nav-link');

            sections.forEach(s => {
                s.classList.add('hidden');
                s.classList.remove('fade-in');
            });

            navLinks.forEach(l => l.classList.remove('active'));
            bottomLinks.forEach(l => l.classList.remove('active'));

            const targetSection = document.getElementById('section-' + sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('fade-in');

                // Update navigation active state
                const activeNav = document.getElementById('nav-' + sectionId);
                if (activeNav) activeNav.classList.add('active');

                const activeBNav = document.getElementById('bnav-' + sectionId);
                if (activeBNav) activeBNav.classList.add('active');

                // Update title
                const titleMap = {
                    'dashboard': 'Dashboard',
                    'users': 'Kelola User',
                    'locations': 'Lokasi PKL',
                    'students': 'Data Siswa',
                    'teachers': 'Master Data Guru',
                    'schedule': 'Jadwal PKL',
                    'applications': 'Pengajuan PKL',
                    'attendance': 'Monitoring Kehadiran',
                    'report-title': 'Pengajuan Judul',
                    'bimbingan': 'Bimbingan & Monitoring',
                    'announcements': 'Kelola Pengumuman',
                    'events': 'Kelola Event',
                    'docs': 'Kelola Dokumen'
                };
                document.getElementById('sectionTitle').textContent = titleMap[sectionId] || sectionId;
            }

            // Close sidebar on mobile after navigation
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth <= 1024 && sidebar) {
                sidebar.classList.remove('active');
                document.body.classList.remove('sidebar-open');
            }

            // Trigger data loading if needed
            if (sectionId === 'users') loadUsers();
            if (sectionId === 'locations') loadLocations();
            if (sectionId === 'students') loadStudents();
            if (sectionId === 'applications') loadApplications();
        }
    </script>
</head>

<body class="dashboard">
    <header class="mobile-header">
        <div style="display: flex; align-items: center; gap: 0.85rem;">
            <div class="logo-circle">
                <img src="https://blogger.googleusercontent.com/img/a/AVvXsEj0gidDMAxs79SkpgBW6-nRy7SLq7ytNTzeXSLp8-sX5SKhlCY7JHDHr7BNvJ9nTF8YgHbB_kubuvfYzX4t4ONGFDfoL2-AMa8mgK29o6XGebiHkSMgiO2BoXpv0fATKQ9XMf-RPWGbqrr_KQ1iVX3JeWYh9JGXR43QSWxyIa2o-qeJR9S0_8dxANpck08"
                    alt="Logo"
                    style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 5px rgba(var(--primary-rgb), 0.3));">
            </div>
            <div style="display: flex; flex-direction: column;">
                <span class="text-gradient"
                    style="font-weight: 800; font-size: 1.1rem; line-height: 1; font-family: 'Outfit', sans-serif;">SIMAK</span>
                <span
                    style="font-size: 0.7rem; color: var(--text-muted); font-weight: 700; letter-spacing: 0.1em; opacity: 0.8;">NESBU</span>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="profile-dropdown-container">
                <div class="header-profile" onclick="toggleProfileDropdown(event)"
                    style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <img src="" alt="" id="headerAvatar"
                        style="width: 36px; height: 36px; border-radius: 12px; border: 1.5px solid var(--glass-border); object-fit: cover; display: none;">
                    <div id="headerAvatarPlaceholder"
                        style="width: 36px; height: 36px; border-radius: 12px; border: 1.5px solid var(--glass-border); background: var(--glass-bg); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user-shield" style="color: var(--text-muted); font-size: 1.1rem;"></i>
                    </div>
                </div>
                <div id="profileDropdown" class="profile-dropdown">
                    <div class="dropdown-item" onclick="openProfileModal()">
                        <i class="fas fa-user-edit"></i> Edit Profil
                    </div>
                    <div class="dropdown-item" onclick="openProfileModal()">
                        <i class="fas fa-key"></i> Ganti Password
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item danger" onclick="AUTH.logout()">
                        <i class="fas fa-sign-out-alt"></i> Keluar
                    </div>
                </div>
            </div>
            <button class="menu-toggle" onclick="toggleMobileSidebar()"
                style="background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--text-main);">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <aside class="sidebar glass" id="sidebar">
        <div class="user-profile" onclick="openProfileModal()">
            <img class="avatar" id="sideAvatar" src="" alt="" referrerpolicy="no-referrer">
            <div>
                <h4 id="userName">Admin Name</h4>
                <p style="font-size: 0.75rem; color: var(--text-muted);">Administrator</p>
            </div>
        </div>
        <div class="sidebar-content">
            <ul class="sidebar-menu">
                <li><a href="#" id="nav-dashboard" class="active" onclick="showSection('dashboard')"><i
                            class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="#" id="nav-users" onclick="showSection('users')"><i class="fas fa-users-cog"></i> Kelola
                        User</a></li>
                <li><a href="#" id="nav-locations" onclick="showSection('locations')"><i
                            class="fas fa-map-marker-alt"></i>
                        Lokasi PKL</a></li>
                <li><a href="#" id="nav-students" onclick="showSection('students')"><i
                            class="fas fa-graduation-cap"></i>
                        Data Siswa</a></li>
                <li><a href="#" id="nav-teachers" onclick="showSection('teachers')"><i
                            class="fas fa-chalkboard-teacher"></i>
                        Guru Master</a></li>
                <li><a href="#" id="nav-schedule" onclick="showSection('schedule')"><i class="fas fa-calendar-alt"></i>
                        Jadwal PKL</a></li>
                <li><a href="#" id="nav-applications" onclick="showSection('applications')"><i
                            class="fas fa-file-signature"></i>
                        PKL Apps</a></li>
                <li><a href="#" id="nav-attendance" onclick="showSection('attendance')"><i
                            class="fas fa-calendar-check"></i>
                        Monitoring Kehadiran</a></li>
                <li><a href="#" id="nav-report-title" onclick="showSection('report-title')"><i
                            class="fas fa-file-alt"></i>
                        Pengajuan Judul</a></li>
                <li><a href="#" id="nav-bimbingan" onclick="showSection('bimbingan')"><i
                            class="fas fa-clipboard-check"></i>
                        Bimbingan & Monitoring</a></li>
                <li><a href="#" id="nav-announcements" onclick="showSection('announcements')"><i
                            class="fas fa-bullhorn"></i>
                        Kelola Pengumuman</a></li>
                <li><a href="#" id="nav-events" onclick="showSection('events')"><i class="fas fa-calendar-star"></i>
                        Kelola Event</a></li>
                <li><a href="#" id="nav-docs" onclick="showSection('docs')"><i class="fas fa-file-contract"></i>
                        Dokumen</a></li>
                <li><a href="#" onclick="AUTH.logout()" style="color: var(--danger);"><i
                            class="fas fa-sign-out-alt"></i>
                        Keluar</a></li>
            </ul>
        </div>
        <div class="sidebar-footer">
            <div style="display: flex; align-items: center; gap: 0.5rem; opacity: 0.6;">
                <i class="fas fa-shield-virus"></i>
                <span>Malware Developed</span>
            </div>
            <div style="font-size: 0.65rem; margin-top: 0.25rem;">&copy; 2026 SIMAK NESBU</div>
        </div>
    </aside>
    <nav class="bottom-nav">
        <ul class="bottom-nav-list">
            <li><a href="#" class="bottom-nav-link active" id="bnav-dashboard" onclick="showSection('dashboard')"><i
                        class="fas fa-th-large"></i><span>Home</span></a></li>
            <li><a href="#" class="bottom-nav-link" id="bnav-users" onclick="showSection('users')"><i
                        class="fas fa-users-cog"></i><span>Users</span></a></li>
            <li><a href="#" class="bottom-nav-link" id="bnav-students" onclick="showSection('students')"><i
                        class="fas fa-graduation-cap"></i><span>Siswa</span></a></li>
            <li><a href="#" class="bottom-nav-link" id="bnav-applications" onclick="showSection('applications')"><i
                        class="fas fa-file-signature"></i><span>PKL</span></a></li>
            <li><a href="#" class="bottom-nav-link" onclick="toggleMobileSidebar()"><i
                        class="fas fa-bars"></i><span>More</span></a></li>
        </ul>
    </nav>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()" aria-hidden="true"></div>

    <main class="main-content">
        <header>
            <h2 id="sectionTitle">Admin Panel</h2>
        </header>

        <!-- Dashboard Section -->
        <div id="section-dashboard" class="section">
            <div class="admin-hero fade-in">
                <div class="hero-content">
                    <p
                        style="text-transform: uppercase; letter-spacing: 0.15em; font-size: 0.75rem; font-weight: 700; opacity: 0.7; margin-bottom: 0.5rem; color: var(--electric-blue);">
                        System Command Center</p>
                    <h1>Selamat Datang, Admin</h1>
                    <p style="font-size: 1rem; opacity: 0.6; max-width: 500px; line-height: 1.6;">Kelola data
                        operasional
                        dan pantau perkembangan PKL siswa secara real-time melalui dashboard terpadu.</p>
                </div>
            </div>

            <!-- High-End Redesigned Metrics Grid -->
            <div class="metrics-row fade-in">
                <div class="metric-box">
                    <div class="icon-wrapper" style="background: rgba(99, 102, 241, 0.15); color: #818cf8;">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <div class="label">Total Pengguna</div>
                        <div class="value" id="count-users">0</div>
                    </div>
                    <div class="detail">
                        <span id="count-admin">0</span> Adm • <span id="count-siswa">0</span> Ssw • <span
                            id="count-guru">0</span> Gru
                    </div>
                </div>

                <div class="metric-box">
                    <div class="icon-wrapper" style="background: rgba(34, 197, 94, 0.15); color: #4ade80;">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div>
                        <div class="label">Siswa PKL</div>
                        <div class="value" id="count-students">0</div>
                    </div>
                    <div class="detail">Kapasitas <span>Terisi</span></div>
                </div>

                <div class="metric-box">
                    <div class="icon-wrapper" style="background: rgba(168, 85, 247, 0.15); color: #c084fc;">
                        <i class="fas fa-building"></i>
                    </div>
                    <div>
                        <div class="label">Lokasi PKL</div>
                        <div class="value" id="count-locations">0</div>
                    </div>
                    <div class="detail">Mitra <span>Aktif</span></div>
                </div>

                <div class="metric-box">
                    <div class="icon-wrapper" style="background: rgba(245, 158, 11, 0.15); color: #fbbf24;">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div>
                        <div class="label">Pending</div>
                        <div class="value" id="count-app-pending">0</div>
                    </div>
                    <div class="detail">Butuh <span>Persetujuan</span></div>
                </div>

                <div class="metric-box">
                    <div class="icon-wrapper" style="background: rgba(56, 189, 248, 0.15); color: #7dd3fc;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div>
                        <div class="label">Disetujui</div>
                        <div class="value" id="count-app-approved">0</div>
                    </div>
                    <div class="detail">Verifikasi <span>Selesai</span></div>
                </div>
            </div>

            <div style="margin-top: 3rem;">
                <h3
                    style="font-family: 'Outfit', sans-serif; font-size: 1.1rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem; color: #ffffff;">
                    <span
                        style="width: 4px; height: 18px; background: var(--electric-indigo); border-radius: 2px;"></span>
                    Akses Cepat
                </h3>
                <div class="launcher-grid">
                    <div class="launcher-item" onclick="showSection('users')">
                        <i class="fas fa-id-card"></i>
                        <span>Manajemen User</span>
                    </div>
                    <div class="launcher-item" onclick="showSection('students')">
                        <i class="fas fa-user-graduate"></i>
                        <span>Data Siswa</span>
                    </div>
                    <div class="launcher-item" onclick="showSection('teachers')">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>Data Guru</span>
                    </div>
                    <div class="launcher-item" onclick="showSection('locations')">
                        <i class="fas fa-map-marked-alt"></i>
                        <span>Lokasi PKL</span>
                    </div>
                    <div class="launcher-item" onclick="showSection('applications')">
                        <i class="fas fa-file-contract"></i>
                        <span>Pengajuan</span>
                    </div>
                    <div class="launcher-item" onclick="showSection('attendance')">
                        <i class="fas fa-calendar-check"></i>
                        <span>Absensi</span>
                    </div>
                    <div class="launcher-item" onclick="showSection('announcements')">
                        <i class="fas fa-bullhorn"></i>
                        <span>Info</span>
                    </div>
                    <div class="launcher-item" onclick="showSection('events')">
                        <i class="fas fa-calendar-star"></i>
                        <span>Event</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management Section -->
        <div id="section-users" class="section hidden">
            <div class="glass" style="padding: 2.5rem; border-radius: 1.5rem; margin-bottom: 2.5rem;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
                        <h3 style="font-family: 'Outfit', sans-serif; font-size: 1.25rem;">Manajemen Pengguna</h3>
                        <div class="form-premium" style="width: 220px; margin: 0;">
                            <select id="roleFilter" onchange="loadUsers()"
                                style="padding: 0.5rem 1rem; border-radius: 0.75rem;">
                                <option value="admin">Administrator</option>
                                <option value="siswa">Siswa</option>
                                <option value="guru">Guru Pembimbing</option>
                                <option value="kakomli">Ka. Komli</option>
                                <option value="mentor">Mentor DUDI</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <div class="search-premium" style="width: 280px; position: relative;">
                            <i class="fas fa-search"
                                style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); opacity: 0.4;"></i>
                            <input type="text" id="userSearch" onkeyup="filterUsers()"
                                placeholder="Cari nama pengguna..."
                                style="width: 100%; padding: 0.65rem 1rem 0.65rem 2.8rem; border-radius: 2rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 0.85rem; outline: none; transition: all 0.2s;">
                        </div>
                        <button class="btn btn-primary"
                            style="width: 42px; height: 42px; padding: 0; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; min-width: 42px; box-shadow: var(--neon-glow);"
                            onclick="toggleAddUserModal(true)" title="Tambah Akun Baru">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div id="userListGrid" class="compact-user-grid">
                    <!-- Data dynamically injected -->
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; opacity: 0.5;">
                        <i class="fas fa-spinner fa-spin"
                            style="font-size: 1.5rem; margin-bottom: 1rem; display: block;"></i>
                        Memuat data...
                    </div>
                </div>
            </div>
        </div>

        <!-- Location Management Section -->
        <div id="section-locations" class="section hidden">
            <div class="glass" style="padding: 2.5rem; border-radius: 1.5rem; margin-bottom: 2.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h3 style="font-family: 'Outfit', sans-serif; font-size: 1.25rem;">Manajemen Lokasi PKL</h3>
                    <button class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem; border-radius: 1rem;"
                        onclick="toggleAddLocationModal(true)">
                        <i class="fas fa-plus" style="margin-right: 0.5rem;"></i> Tambah Lokasi
                    </button>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Tempat & Alamat Lengkap</th>
                                <th>Mentor & Kontak Utama</th>
                                <th>Program Keahlian</th>
                                <th>Opsi Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="locationTableBody">
                            <!-- Data dynamically injected -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Student Data Management Section -->
        <div id="section-students" class="section hidden">
            <div class="glass" style="padding: 2rem; border-radius: var(--radius); margin-bottom: 2rem;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 300px;">
                        <h3 style="font-family: 'Outfit', sans-serif; font-size: 1.25rem; white-space: nowrap;">Daftar
                            Siswa</h3>
                        <div class="search-premium" style="flex: 1; max-width: 350px; position: relative;">
                            <i class="fas fa-search"
                                style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); opacity: 0.4;"></i>
                            <input type="text" id="studentSearchInput" oninput="filterStudents(this.value)"
                                placeholder="Cari NIS atau Nama..."
                                style="width: 100%; padding: 0.6rem 1rem 0.6rem 2.8rem; border-radius: 2rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 0.85rem; outline: none;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                        <button class="btn btn-primary" onclick="toggleAddStudentModal(true)"
                            style="padding: 0.65rem 1.25rem; border-radius: 0.75rem; font-weight: 600;">
                            <i class="fas fa-plus"></i> Tambah Siswa
                        </button>

                        <div
                            style="display: flex; gap: 0.5rem; background: rgba(255,255,255,0.03); padding: 0.35rem; border-radius: 0.75rem; border: 1px solid rgba(255,255,255,0.05);">
                            <button class="action-btn" onclick="exportToExcel()" title="Export Excel"
                                style="width: 38px; height: 38px;">
                                <i class="fas fa-file-excel" style="color: #22c55e;"></i>
                            </button>
                            <button class="action-btn" onclick="exportToPDF()" title="Export PDF"
                                style="width: 38px; height: 38px;">
                                <i class="fas fa-file-pdf" style="color: #ef4444;"></i>
                            </button>
                            <button class="action-btn" onclick="triggerImport()" title="Import Excel"
                                style="width: 38px; height: 38px;">
                                <i class="fas fa-file-import" style="color: #3b82f6;"></i>
                            </button>
                            <button class="action-btn" onclick="downloadTemplate()" title="Format Import"
                                style="width: 38px; height: 38px;">
                                <i class="fas fa-download" style="color: var(--text-muted);"></i>
                            </button>
                        </div>
                        <input type="file" id="importFile" hidden accept=".xlsx, .xls" onchange="handleImport(this)">
                    </div>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Siswa (Nama & NIS)</th>
                                <th>Kelas</th>
                                <th style="text-align: right; padding-right: 2rem;">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- PKL Applications Section -->
        <div id="section-applications" class="section hidden">
            <div class="glass" style="padding: 2rem; border-radius: var(--radius); margin-bottom: 2rem;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h3 style="margin: 0; color: var(--primary);">Daftar Pengajuan PKL</h3>
                        <p style="margin: 0.25rem 0 0; font-size: 0.8rem; color: var(--text-muted);">Kelola pengajuan
                            tempat PKL dari siswa.</p>
                    </div>
                    <div class="search-box" style="width: 100%; max-width: 320px;">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Cari NIS, Nama, atau Lokasi..."
                            oninput="filterApplications(this.value)">
                    </div>
                </div>

                <div id="applicationCardContainer" class="application-card-grid">
                    <!-- Cards will be loaded here -->
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; opacity: 0.5;">
                        <i class="fas fa-spinner fa-spin"
                            style="font-size: 2rem; margin-bottom: 1rem; color: var(--primary);"></i>
                        <p>Memuat data pengajuan...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher Master Data Section -->
        <div id="section-teachers" class="section hidden">
            <div class="glass" style="padding: 2rem; border-radius: var(--radius); margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3>Master Data Guru</h3>
                    <button class="btn btn-primary" style="width: auto; padding: 0.5rem 1rem;"
                        onclick="toggleAddMasterTeacherModal(true)">
                        <i class="fas fa-plus"></i> Tambah Guru
                    </button>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Guru</th>
                                <th style="text-align: right; padding-right: 1.5rem;">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="teacherMasterTableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Attendance Monitoring Section -->
        <div id="section-attendance" class="section hidden">
            <div class="glass" style="padding: 2rem; border-radius: var(--radius); margin-bottom: 2rem;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <h3>Data Kehadiran Siswa</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                        <div class="search-box" style="width: 250px; margin: 0;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="attendanceSearch" placeholder="Cari NIS, Nama, atau Status..."
                                oninput="filterAttendance(this.value)">
                        </div>
                        <button class="btn btn-outline" onclick="loadAttendance()"
                            style="width: auto; padding: 0.5rem 1rem;">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Siswa</th>
                                <th>Tanggal</th>
                                <th>Masuk</th>
                                <th>Pulang</th>
                                <th>Status</th>
                                <th>Jurnal</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <tr>
                                <td colspan="7"
                                    style="text-align:center; padding: 3rem; color: var(--text-muted); opacity: 0.5;">
                                    Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Report Title Monitoring Section -->
        <div id="section-report-title" class="section hidden">
            <div class="glass" style="padding: 2rem; border-radius: var(--radius); margin-bottom: 2rem;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <h3>Pengajuan Judul Laporan Siswa</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <input type="text" id="reportTitleSearch" placeholder="Cari NIS, Nama, atau Judul..."
                            oninput="filterReportTitles(this.value)"
                            style="padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; width: 250px;">
                        <button class="btn btn-primary" onclick="loadReportTitles()"
                            style="width: auto; padding: 0.5rem 1rem;">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Siswa</th>
                                <th>Judul Laporan</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="reportTitleTableBody">
                            <tr>
                                <td colspan="4"
                                    style="text-align:center; padding: 3rem; color: var(--text-muted); opacity: 0.5;">
                                    Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Admin Announcements Section -->
        <div id="section-announcements" class="section hidden">
            <div class="glass" style="padding: 2rem; border-radius: var(--radius); margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3>Kelola Pengumuman</h3>
                    <button class="btn btn-primary" onclick="openAnnouncementModal()"
                        style="width: auto; padding: 0.5rem 1rem;">
                        <i class="fas fa-plus"></i> Tambah Pengumuman
                    </button>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Judul</th>
                                <th>Jurusan</th>
                                <th>Tanggal</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="announcementTableBody">
                            <tr>
                                <td colspan="5"
                                    style="text-align:center; padding: 3rem; color: var(--text-muted); opacity: 0.5;">
                                    Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Admin Events Section -->
        <div id="section-events" class="section hidden">
            <div class="glass" style="padding: 2rem; border-radius: var(--radius); margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3>Kelola Event & Kegiatan</h3>
                    <button class="btn btn-primary" onclick="openEventModal()"
                        style="width: auto; padding: 0.5rem 1rem;">
                        <i class="fas fa-plus"></i> Tambah Event
                    </button>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nama Event</th>
                                <th>Tanggal</th>
                                <th>Lokasi</th>
                                <th>Jurusan</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="eventTableBody">
                            <tr>
                                <td colspan="5"
                                    style="text-align:center; padding: 3rem; color: var(--text-muted); opacity: 0.5;">
                                    Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Documents Section -->
        <div id="section-docs" class="section hidden">
            <div class="glass" style="padding: 2rem; border-radius: var(--radius); margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3>Kelola Template Dokumen</h3>
                    <button class="btn btn-primary" onclick="toggleDocModal(true)"
                        style="width: auto; padding: 0.5rem 1rem;">
                        <i class="fas fa-plus"></i> Tambah Template
                    </button>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nama Dokumen</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="docTableBody">
                            <tr>
                                <td colspan="3"
                                    style="text-align:center; padding: 3rem; color: var(--text-muted); opacity: 0.5;">
                                    Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PKL Schedule Section -->
        <div id="section-schedule" class="section hidden">
            <div class="glass" style="padding: 2rem; border-radius: var(--radius); margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3><i class="fas fa-calendar-alt" style="margin-right: 0.5rem; color: var(--primary);"></i>
                        Pengaturan Jadwal PKL</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" style="width: auto; padding: 0.5rem 1rem;"
                            onclick="openScheduleModal()">
                            <i class="fas fa-edit"></i> Atur Jadwal
                        </button>
                        <button id="btnDeleteSchedule" class="btn"
                            style="width: auto; padding: 0.5rem 1rem; background: var(--danger); color: white;"
                            onclick="deleteSchedule()">
                            <i class="fas fa-trash"></i> Hapus Jadwal
                        </button>
                    </div>
                </div>

                <div class="glass"
                    style="background: rgba(var(--primary-rgb), 0.05); padding: 2rem; border-radius: 1rem; border: 1px dashed var(--primary); text-align: center;">
                    <div
                        style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 2rem; align-items: center; max-width: 600px; margin: 0 auto;">
                        <div>
                            <div
                                style="font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">
                                Tanggal Mulai</div>
                            <div id="displayStartDate"
                                style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">-- -- ----</div>
                        </div>
                        <div style="font-size: 2rem; color: var(--text-muted); opacity: 0.5;">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div>
                            <div
                                style="font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">
                                Tanggal Selesai</div>
                            <div id="displayEndDate"
                                style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">-- -- ----</div>
                        </div>
                    </div>
                </div>

                <div
                    style="margin-top: 2rem; display: flex; gap: 1rem; color: var(--text-muted); font-size: 0.85rem; justify-content: center;">
                    <span><i class="fas fa-info-circle"></i> Jadwal ini berlaku untuk semua pengajuan PKL baru secara
                        otomatis.</span>
                </div>
            </div>
        </div>

        <!-- Bimbingan & Monitoring Section -->
        <div id="section-bimbingan" class="section hidden">
            <div class="glass" style="padding: 2rem; border-radius: var(--radius);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3>Bimbingan & Monitoring PKL</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" style="width: auto; padding: 0.5rem 1rem;"
                            onclick="openBimbinganModal()">
                            <i class="fas fa-plus"></i> Input Kegiatan
                        </button>
                        <button class="btn btn-outline" style="width: auto; padding: 0.5rem 1rem;"
                            onclick="loadBimbinganData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div id="bimbinganDataContainer">
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        Memuat data...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Bimbingan (Add/Edit) -->
    <div id="bimbinganModal" class="hidden modal-overlay"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1; backdrop-filter: blur(10px);">
        <div class="glass form-premium"
            style="width: 95%; max-width: 600px; padding: 2.5rem; border-radius: 1.5rem; position: relative; max-height: 90vh; overflow-y: auto;">
            <button class="btn-close" onclick="toggleBimbinganModal(false)"
                style="position: absolute; top: 1.25rem; right: 1.25rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            <h3 id="bimbinganModalTitle" style="margin-bottom: 2rem; font-family: 'Outfit', sans-serif;">Jurnal Kegiatan
                Bimbingan</h3>
            <form id="bimbinganForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <input type="hidden" id="bimId">
                <input type="hidden" id="bimPhotoUrl">

                <div class="form-group">
                    <label>Pilih Siswa Bimbingan <span style="color: var(--danger);">*</span></label>
                    <div style="position: relative;">
                        <div id="studentDropdownTrigger" onclick="toggleStudentDropdown(event)"
                            style="width: 100%; padding: 0.85rem 1.25rem; background: rgba(255,255,255,0.03); border: 1.5px solid rgba(255,255,255,0.1); border-radius: 0.75rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;">
                            <span id="selectedCountDisplay" style="color: var(--text-muted); font-size: 0.9rem;">Pilih
                                satu atau lebih siswa</span>
                            <i class="fas fa-chevron-down" style="font-size: 0.8rem; color: var(--text-muted);"></i>
                        </div>

                        <div id="studentDropdownMenu" class="hidden"
                            style="position: absolute; top: 105%; left: 0; width: 100%; background: #0f172a; border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; z-index: 1100; box-shadow: 0 20px 40px rgba(0,0,0,0.4); overflow: hidden;">
                            <div
                                style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(255,255,255,0.02);">
                                <div style="position: relative;">
                                    <i class="fas fa-search"
                                        style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.85rem;"></i>
                                    <input type="text" id="studentSearchInput" placeholder="Cari nama atau NIS..."
                                        oninput="filterStudentList()"
                                        style="width: 100%; padding: 0.65rem 1rem 0.65rem 2.5rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem; font-size: 0.85rem; color: #fff;">
                                </div>
                            </div>
                            <div id="bimNisChecklist" style="max-height: 250px; overflow-y: auto; padding: 0.75rem;">
                                <!-- Students dynamically loaded -->
                                <div
                                    style="padding: 1.5rem; text-align: center; color: var(--text-muted); font-size: 0.85rem;">
                                    Memuat data siswa...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;">
                    <div class="form-group">
                        <label>Tanggal Pelaksanaan <span style="color: var(--danger);">*</span></label>
                        <input type="date" id="bimTanggal" required>
                    </div>
                    <div class="form-group">
                        <label>Kategori Kegiatan <span style="color: var(--danger);">*</span></label>
                        <select id="bimJenis" required>
                            <option value="Bimbingan Laporan">Bimbingan Laporan</option>
                            <option value="Monitoring PKL" selected>Monitoring PKL</option>
                            <option value="Penjemputan PKL">Penjemputan PKL</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Deskripsi & Hasil Bimbingan <span style="color: var(--danger);">*</span></label>
                    <textarea id="bimDeskripsi" required
                        placeholder="Tuliskan detail pembahasan atau temuan monitoring..."
                        style="min-height: 120px;"></textarea>
                </div>

                <div class="form-group">
                    <label>Dokumentasi Foto (Opsional)</label>
                    <div
                        style="display: flex; gap: 1.5rem; align-items: center; background: rgba(255,255,255,0.02); padding: 1.25rem; border-radius: 1rem; border: 1px dashed rgba(255,255,255,0.1);">
                        <div id="bimPhotoPreview"
                            style="width: 80px; height: 80px; background: rgba(255,255,255,0.03); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
                            <i class="fas fa-camera" style="color: var(--text-muted); font-size: 1.25rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <input type="file" id="bimPhotoInput" accept="image/*"
                                style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                            <p style="font-size: 0.7rem; color: var(--text-muted); opacity: 0.7;">Format: JPG, PNG (Max
                                5MB). Foto akan dikompres otomatis.</p>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn" onclick="toggleBimbinganModal(false)"
                        style="flex: 1; padding: 0.85rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem;">Batal</button>
                    <button type="submit" id="btnSaveBimbingan" class="btn btn-primary"
                        style="flex: 2; padding: 0.85rem; border-radius: 0.75rem; font-weight: 700; box-shadow: 0 4px 15px rgba(var(--primary-rgb), 0.3);">
                        <i class="fas fa-save" style="margin-right: 0.5rem;"></i> Simpan Jurnal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detail Bimbingan -->
    <div id="viewBimbinganModal" class="hidden modal-overlay"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index: 1001; grid-column: 1 / -1; grid-row: 1 / -1; backdrop-filter: blur(10px);">
        <div class="glass"
            style="width: 90%; max-width: 500px; padding: 2.5rem; border-radius: 1.5rem; position: relative; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
            <button class="btn-close" onclick="toggleViewBimbinganModal(false)"
                style="position: absolute; top: 1.25rem; right: 1.25rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            <h3
                style="margin-bottom: 2rem; color: #fff; font-family: 'Outfit', sans-serif; display: flex; align-items: center; gap: 0.75rem;">
                <i class="fas fa-file-alt" style="color: var(--electric-blue);"></i> Detail Bimbingan
            </h3>
            <div id="viewBimbinganContent" style="color: var(--text-main); line-height: 1.6;">
                <!-- Content will be injected -->
            </div>
            <div style="margin-top: 2.5rem; text-align: right;">
                <button class="btn btn-primary" onclick="toggleViewBimbinganModal(false)"
                    style="padding: 0.75rem 2rem; border-radius: 0.75rem; font-weight: 600;">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal Tambah User -->
    <div id="addUserModal" class="hidden modal-overlay"
        style="position: fixed; top:0; left:0; width:100%; height:100%; z-index: 1000; backdrop-filter: blur(10px);">
        <div class="glass form-premium"
            style="width: 90%; max-width: 500px; padding: 2.5rem; border-radius: 1.5rem; position: relative; max-height: 90vh; overflow-y: auto;">
            <h3 id="userModalTitle" style="margin-bottom: 2rem; font-family: 'Outfit', sans-serif;">Tambah Akun Baru
            </h3>
            <form id="addUserForm">
                <input type="hidden" id="userOriginalUsername">
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label>Peran Pengguna</label>
                    <select id="newRole" required onchange="adjustFormFields()">
                        <option value="admin">Administrator</option>
                        <option value="siswa">Siswa</option>
                        <option value="guru">Guru Pembimbing</option>
                        <option value="kakomli">Ka. Komli</option>
                        <option value="mentor">Mentor DUDI</option>
                    </select>
                </div>

                <div id="dynamicFields" style="display: flex; flex-direction: column; gap: 1.25rem;">
                    <!-- Fields dynamically injected -->
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2.5rem;">
                    <button type="button" class="btn" onclick="toggleAddUserModal(false)"
                        style="flex: 1; padding: 0.85rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem;">Batal</button>
                    <button type="submit" class="btn btn-primary" id="btnSaveUser"
                        style="flex: 2; padding: 0.85rem; border-radius: 0.75rem; font-weight: 700;">Simpan
                        Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Edit Lokasi -->
    <div id="addLocationModal" class="hidden modal-overlay"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1; backdrop-filter: blur(10px);">
        <div class="glass form-premium"
            style="width: 95%; max-width: 700px; padding: 2.5rem; border-radius: 1.5rem; position: relative; max-height: 95vh; overflow-y: auto;">
            <h3 id="locationModalTitle" style="margin-bottom: 2rem; font-family: 'Outfit', sans-serif;">Manajemen Lokasi
                PKL</h3>
            <form id="addLocationForm">
                <input type="hidden" id="locOriginalId">
                <input type="hidden" id="locIdPkl">
                <input type="hidden" id="locLat">
                <input type="hidden" id="locLng">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;">
                    <div class="form-group">
                        <label>Nama Tempat / Instansi</label>
                        <input type="text" id="locNamaTempat" required placeholder="Contoh: PT. Teknologi Maju">
                    </div>
                    <div class="form-group">
                        <label>Nama Pimpinan / HRD</label>
                        <input type="text" id="locNamaPimpinan" required placeholder="Nama pimpinan lokasi">
                    </div>
                </div>

                <div class="form-group">
                    <label>Alamat</label>
                    <textarea id="locAlamat" required
                        style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem;"
                        placeholder="Ketik alamat lengkap..."></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Nama Mentor (DUDI)</label>
                        <input type="text" id="locNamaMentor" required>
                    </div>
                    <div class="form-group">
                        <label>Kontak Mentor</label>
                        <div style="display:flex; align-items:center;">
                            <span
                                style="background:#eee; padding:0.75rem; border:1px solid #e2e8f0; border-right:none; border-radius:0.5rem 0 0 0.5rem;">+62</span>
                            <input type="text" id="locKontakMentor" style="border-radius:0 0.5rem 0.5rem 0;"
                                placeholder="8123456789" oninput="this.value = this.value.replace(/^0/, '')">
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Jurusan</label>
                        <select id="locJurusan" required>
                            <option value="">Pilih Jurusan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bidang Usaha</label>
                        <input type="text" id="locBidangUsaha"
                            placeholder="Contoh: Teknologi Informasi, Konstruksi, dll.">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Email Industri (Optional)</label>
                        <input type="email" id="locEmail" placeholder="contoh@perusahaan.com">
                    </div>
                    <div class="form-group">
                        <label>Deskripsi (LT/Gedung)</label>
                        <input type="text" id="locDescription" placeholder="Contoh: LT.2, Nama Gedung, dsb.">
                    </div>
                </div>

                <!-- Map Section -->
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <span style="font-weight: 600; color: var(--text-muted);">Penanda Lokasi Peta (Koordinat)</span>
                        <span id="coordsDisplay"
                            style="font-size: 0.7rem; color: var(--electric-blue); font-weight: 500;">
                            Klik peta untuk mengambil koordinat
                        </span>
                    </label>
                    <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                        <input type="text" id="mapSearchInput" placeholder="Cari area (Contoh: Malang)..."
                            style="flex: 1; padding: 0.75rem 1rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem; color: #fff;">
                        <button type="button" class="btn btn-primary" onclick="searchAddress()"
                            style="width: 48px; border-radius: 0.75rem;" title="Cari Alamat"><i
                                class="fas fa-search"></i></button>
                        <button type="button" class="btn" onclick="getCurrentLocation()"
                            style="width: 48px; background: rgba(16, 185, 129, 0.15); color: #4ade80; border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 0.75rem;"
                            title="Lokasi Saya"><i class="fas fa-location-crosshairs"></i></button>
                    </div>
                    <div id="locationMap"
                        style="height: 250px; width: 100%; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.1); z-index: 1;">
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2.5rem;">
                    <button type="button" class="btn" onclick="toggleAddLocationModal(false)"
                        style="flex: 1; padding: 0.85rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem;">Batal</button>
                    <button type="submit" class="btn btn-primary" id="btnSaveLocation"
                        style="flex: 2; padding: 0.85rem; border-radius: 0.75rem; font-weight: 700;">Simpan
                        Lokasi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Lihat Data Lokasi -->
    <div id="viewLocationModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 500px; padding: 2rem; border-radius: var(--radius); position: relative;">
            <h3 style="margin-bottom: 1.5rem;">Detail Lokasi PKL</h3>
            <div id="viewLocationContent" style="display: grid; gap: 1rem;">
                <!-- Content will be injected -->
            </div>
            <div style="margin-top: 2rem; text-align: right;">
                <button class="btn btn-primary"
                    onclick="document.getElementById('viewLocationModal').classList.add('hidden'); document.getElementById('viewLocationModal').style.display = 'none';">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal Kelola Dokumen -->
    <div id="docModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 500px; padding: 2rem; border-radius: var(--radius); position: relative;">
            <button class="btn-close" onclick="toggleDocModal(false)"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            <h3 id="docModalTitle" style="margin-bottom: 1.5rem;">Tambah Template Dokumen</h3>
            <form id="docForm" onsubmit="saveDocument(event)">
                <input type="hidden" id="editDocId">
                <div class="form-group">
                    <label>Nama Dokumen</label>
                    <input type="text" id="docName" required placeholder="Contoh: Surat Pengantar PKL">
                </div>
                <div class="form-group">
                    <label>Link Dokumen / Template ID</label>
                    <input type="text" id="docContent" placeholder="https://docs.google.com/document/d/...">
                </div>
                <div class="form-group">
                    <label>Atau Upload File (Drive)</label>
                    <input type="file" id="docFile" style="padding: 0.5rem 0;">
                    <p style="font-size: 0.7rem; color: var(--text-muted);">Format: PDF, Docx, xlsx, dll.</p>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="toggleDocModal(false)"
                        style="background: #e2e8f0; flex: 1;">Batal</button>
                    <button type="submit" class="btn btn-primary" id="btnSaveDoc" style="flex: 2;">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Edit Siswa -->
    <div id="addStudentModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 600px; padding: 2rem; border-radius: var(--radius); position: relative; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h3 id="studentModalTitle" style="margin: 0; color: var(--primary);">Data Siswa</h3>
                    <p style="margin: 0.25rem 0 0; font-size: 0.8rem; color: var(--text-muted);">Lengkapi formulir di
                        bawah untuk menambah/ubah data.</p>
                </div>
                <button type="button" onclick="toggleAddStudentModal(false)"
                    style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.25rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="addStudentForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <input type="hidden" id="stuOriginalId">

                <div
                    style="background: rgba(255,255,255,0.02); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <div
                        style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--primary); font-weight: 700; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-user-circle"></i> Informasi Biodata
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1.25rem;">
                        <div class="form-group custom-field">
                            <label>NIS & NIK</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <input type="text" id="stuNis" placeholder="NIS" required style="flex: 1;">
                                <input type="text" id="stuNik" placeholder="NIK" style="flex: 2;">
                            </div>
                        </div>
                        <div class="form-group custom-field">
                            <label>Nama Lengkap</label>
                            <input type="text" id="stuNama" required>
                        </div>
                        <div class="form-group custom-field">
                            <label>Jurusan & Kelas</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <select id="stuJurusan" required style="flex: 1;">
                                    <option value="">Jurusan</option>
                                </select>
                                <input type="text" id="stuKelas" placeholder="Kelas" required style="flex: 1;">
                            </div>
                        </div>
                        <div class="form-group custom-field">
                            <label>Tempat & Tgl Lahir</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <input type="text" id="stuTempatLahir" placeholder="Tempat" style="flex: 1;">
                                <input type="date" id="stuTanggalLahir" style="flex: 1;">
                            </div>
                        </div>
                        <div class="form-group custom-field">
                            <label>Kontak & Gol Darah</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <input type="text" id="stuKontak" placeholder="WhatsApp" style="flex: 2;">
                                <select id="stuGolDarah" style="flex: 1;">
                                    <option value="">Gol</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="AB">AB</option>
                                    <option value="O">O</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group custom-field">
                            <label>Data Orang Tua</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <input type="text" id="stuNamaOrangtua" placeholder="Nama Ortu" style="flex: 1;">
                                <input type="text" id="stuKontakOrangtua" placeholder="Kontak Ortu" style="flex: 1;">
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    style="background: rgba(255,255,255,0.02); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <div
                        style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent); font-weight: 700; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-map-marker-alt"></i> Penempatan PKL
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1.25rem;">
                        <div class="form-group custom-field">
                            <label>ID Lokasi PKL</label>
                            <select id="stuIdPkl">
                                <option value="">Belum Memilih PKL</option>
                            </select>
                        </div>
                        <div class="form-group custom-field">
                            <label>Guru Pembimbing</label>
                            <select id="stuIdGuru">
                                <option value="">Belum Ada Pembimbing</option>
                            </select>
                        </div>
                        <div class="form-group custom-field">
                            <label>Periode PKL (Mulai - Selesai)</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <input type="date" id="stuStartDate" style="flex: 1;">
                                <input type="date" id="stuEndDate" style="flex: 1;">
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="btn glass" onclick="toggleAddStudentModal(false)"
                        style="padding: 0.75rem 2rem; background: rgba(255,255,255,0.05);">Batal</button>
                    <button type="submit" class="btn btn-primary" id="btnSaveStudent"
                        style="padding: 0.75rem 2.5rem; border-radius: 10px; font-weight: 700;">Simpan Data</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Lihat Data Siswa -->
    <div id="viewStudentModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 95%; max-width: 800px; padding: 2rem; border-radius: var(--radius); position: relative; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-user-circle"></i> Detail Profil Siswa
            </h3>
            <div id="viewStudentContent">
                <!-- Content will be injected -->
            </div>
            <div style="margin-top: 2rem; text-align: right; border-top: 1px solid #eee; padding-top: 1rem;">
                <button class="btn btn-primary"
                    onclick="document.getElementById('viewStudentModal').classList.add('hidden'); document.getElementById('viewStudentModal').style.display = 'none';">Tutup
                    Detail</button>
            </div>
        </div>
    </div>

    <!-- Modal Lihat Detail User -->
    <div id="viewUserDetailModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 500px; padding: 2rem; border-radius: var(--radius); position: relative;">
            <h3 style="margin-bottom: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-info-circle"></i> Detail User
            </h3>
            <div id="viewUserDetailContent" style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- Details injected here -->
            </div>
            <div style="margin-top: 2rem; text-align: right;">
                <button class="btn btn-primary"
                    onclick="document.getElementById('viewUserDetailModal').classList.add('hidden'); document.getElementById('viewUserDetailModal').style.display='none';">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal Penolakan Pengajuan -->
    <div id="applicationRejectModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1001; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 500px; padding: 2rem; border-radius: var(--radius); position: relative;">
            <h3 style="margin-bottom: 1.5rem; color: var(--danger);">Alasan Penolakan</h3>
            <form id="rejectApplicationForm">
                <input type="hidden" id="rejectApplicationId">
                <div class="form-group">
                    <label>Berikan alasan kenapa pengajuan ini ditolak (Wajib)</label>
                    <textarea id="rejectReason" required placeholder="Contoh: Tempat PKL sudah penuh untuk jurusan ini"
                        style="width: 100%; min-height: 120px; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; font-family: inherit; margin-top: 0.5rem;"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="toggleRejectModal(false)"
                        style="background: #e2e8f0;">Batal</button>
                    <button type="submit" class="btn btn-primary" style="background: var(--danger);">Kirim
                        Penolakan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detail Pengajuan -->
    <div id="viewApplicationModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 600px; padding: 2rem; border-radius: var(--radius); position: relative; max-height: 90vh; overflow-y: auto;">
            <button class="btn-close" onclick="toggleViewApplicationModal(false)"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            <h3 style="margin-bottom: 2rem; color: var(--primary);">Detail Pengajuan PKL</h3>
            <div id="viewApplicationContent"></div>
            <div id="reviewActions" class="hidden"
                style="margin-top: 2rem; display: flex; gap: 1rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                <button class="btn btn-primary" id="btnApproveInside"
                    style="flex: 1; background: var(--success);">Setujui</button>
                <button class="btn" id="btnRejectInside" style="flex: 1; background: var(--danger);">Tolak</button>
            </div>
        </div>
    </div>

    <!-- Modal Edit Pengajuan -->
    <div id="editApplicationModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 500px; padding: 2rem; border-radius: var(--radius); position: relative;">
            <button class="btn-close" onclick="toggleEditApplicationModal(false)"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            <h3 style="margin-bottom: 1.5rem; color: var(--primary);">Edit Pengajuan PKL</h3>
            <form id="editApplicationForm">
                <input type="hidden" id="editAppId">
                <div class="form-group">
                    <label>Tipe Ajuan</label>
                    <select id="editAppTipe" class="form-control" required
                        style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                        <option value="Mandiri (Oleh Siswa)">Mandiri (Oleh Siswa)</option>
                        <option value="Penempatan (Oleh Sekolah)">Penempatan (Oleh Sekolah)</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div class="form-group">
                        <label>Tanggal Mulai</label>
                        <input type="date" id="editAppStart" required
                            style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                    </div>
                    <div class="form-group">
                        <label>Tanggal Selesai</label>
                        <input type="date" id="editAppEnd" required
                            style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 1rem;">
                    <label>Status</label>
                    <select id="editAppStatus" class="form-control"
                        style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                        <option value="Pending">Pending</option>
                        <option value="Disetujui">Disetujui</option>
                        <option value="Ditolak">Ditolak</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="toggleEditApplicationModal(false)"
                        style="background: #e2e8f0; flex: 1;">Batal</button>
                    <button type="submit" class="btn btn-primary" style="flex: 2;">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detail Kehadiran -->
    <div id="viewAttendanceModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 95%; max-width: 800px; padding: 2rem; border-radius: var(--radius); position: relative; max-height: 90vh; overflow-y: auto;">
            <button class="btn-close" onclick="toggleAttendanceModal(false)"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            <h3 style="margin-bottom: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-calendar-check"></i> Detail Kehadiran
            </h3>
            <div id="viewAttendanceContent">
                <!-- Content will be injected -->
            </div>
            <div style="margin-top: 2rem; text-align: right; border-top: 1px solid #eee; padding-top: 1rem;">
                <button class="btn btn-primary" onclick="toggleAttendanceModal(false)">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal Detail Jurnal dihapus karena digabung ke kehadiran -->
    <!-- Modal Aksi Judul Laporan -->
    <div id="actionReportTitleModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 500px; padding: 2rem; border-radius: var(--radius); position: relative;">
            <button class="btn-close" onclick="toggleReportTitleModal(false)"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            <h3 style="margin-bottom: 1.5rem;">Konfirmasi Judul Laporan</h3>
            <form id="actionReportTitleForm">
                <input type="hidden" id="actionReportTitleId">
                <div style="margin-bottom: 1rem; background: rgba(0,0,0,0.05); padding: 1rem; border-radius: 0.5rem;">
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem;">Judul yang
                        Diajukan:</div>
                    <div id="displayReportTitle" style="font-weight: 600; line-height: 1.4;"></div>
                </div>
                <div class="form-group">
                    <label>Status Persetujuan</label>
                    <select id="reportTitleStatus" class="form-control" required
                        style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                        <option value="Disetujui">Setujui</option>
                        <option value="Revisi">Minta Revisi</option>
                        <option value="Ditolak">Tolak</option>
                    </select>
                </div>
                <div class="form-group" style="margin-top: 1rem;">
                    <label>Feedback / Catatan</label>
                    <textarea id="reportTitleFeedback" placeholder="Berikan alasan atau arahan revisi..."
                        style="width: 100%; min-height: 100px; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; font-family: inherit; margin-top: 0.5rem;"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="toggleReportTitleModal(false)"
                        style="background: #e2e8f0; flex: 1;">Batal</button>
                    <button type="submit" class="btn btn-primary" style="flex: 2;">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detail Kehadiran -->
    <div id="addMasterTeacherModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 500px; padding: 2rem; border-radius: var(--radius); position: relative;">
            <h3 id="masterTeacherModalTitle" style="margin-bottom: 1.5rem;">Tambah Guru Baru</h3>
            <form id="addMasterTeacherForm">
                <input type="hidden" id="teacherMasterOriginalId">
                <div class="form-group">
                    <label>ID Guru (NIP)</label>
                    <input type="text" id="masterTeacherId" required placeholder="Contoh: 198...">
                </div>
                <div class="form-group">
                    <label>Nama Guru</label>
                    <input type="text" id="masterTeacherNama" required placeholder="Nama Lengkap dengan Gelar">
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="toggleAddMasterTeacherModal(false)"
                        style="background: #e2e8f0;">Batal</button>
                    <button type="submit" class="btn btn-primary" id="btnSaveMasterTeacher">Simpan Data</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Edit Pengumuman -->
    <div id="announcementModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 500px; padding: 2rem; border-radius: var(--radius); position: relative;">
            <button class="btn-close" onclick="toggleAnnouncementModal(false)"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            <h3 id="announcementModalTitle" style="margin-bottom: 1.5rem;">Tambah Pengumuman</h3>
            <form id="announcementForm">
                <input type="hidden" id="annId">
                <div class="form-group">
                    <label>Judul Pengumuman</label>
                    <input type="text" id="annJudul" required>
                </div>
                <div class="form-group">
                    <label>Isi Konten</label>
                    <textarea id="annKonten" required
                        style="width: 100%; min-height: 120px; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; font-family: inherit;"></textarea>
                </div>
                <div class="form-group">
                    <label>Jurusan (Filter)</label>
                    <select id="annJurusan" required>
                        <option value="Semua">Memuat data...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="annStatus" required>
                        <option value="Aktif">Aktif</option>
                        <option value="Nonaktif">Nonaktif</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="toggleAnnouncementModal(false)"
                        style="background: #e2e8f0; flex: 1;">Batal</button>
                    <button type="submit" class="btn btn-primary" id="btnSaveAnnouncement"
                        style="flex: 2;">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah/Edit Event -->
    <div id="eventModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 95%; max-width: 700px; padding: 2rem; border-radius: var(--radius); position: relative; max-height: 90vh; overflow-y: auto;">
            <button class="btn-close" onclick="toggleEventModal(false)"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            <h3 id="eventModalTitle" style="margin-bottom: 1.5rem;">Tambah Event Kegiatan</h3>
            <form id="eventForm">
                <input type="hidden" id="evtId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Nama Event</label>
                        <input type="text" id="evtNama" required>
                    </div>
                    <div class="form-group">
                        <label>Jurusan</label>
                        <select id="evtJurusan" required>
                            <option value="Semua">Memuat data...</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Tanggal</label>
                        <input type="date" id="evtTanggal" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div class="form-group">
                            <label>Jam Mulai</label>
                            <input type="time" id="evtJamMulai" required onchange="calculateEventDuration()">
                        </div>
                        <div class="form-group">
                            <label>Jam Selesai</label>
                            <input type="time" id="evtJamSelesai" required onchange="calculateEventDuration()">
                        </div>
                    </div>
                </div>
                <input type="hidden" id="evtDurasi">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Lokas Tempat</label>
                        <input type="text" id="evtLokasi" required>
                    </div>
                    <div class="form-group">
                        <label>Pengisi Acara / Nara Sumber</label>
                        <input type="text" id="evtPengisi">
                    </div>
                </div>
                <div class="form-group">
                    <label>Deskripsi Singkat</label>
                    <textarea id="evtDeskripsi"
                        style="width: 100%; min-height: 80px; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; font-family: inherit;"></textarea>
                </div>
                <div class="form-group">
                    <label>Koordinat Lokasi (Klik Peta untuk Set)</label>
                    <div style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem;">
                        <input type="text" id="evtMapSearchInput" placeholder="Cari lokasi di peta..."
                            onkeydown="if(event.key==='Enter'){ event.preventDefault(); searchLocationOnMap(); }"
                            style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.4rem;">
                        <button type="button" class="btn btn-sm" id="btnSearchMap" onclick="searchLocationOnMap()"
                            style="padding: 0 1rem; width: auto; background: var(--primary); color: white;"><i
                                class="fas fa-search"></i> Cari</button>
                    </div>
                    <div id="eventPickerMap"
                        style="height: 200px; border-radius: 0.5rem; border: 1px solid #e2e8f0; margin: 0.5rem 0; z-index: 1;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <input type="text" id="evtLat" placeholder="Latitude" readonly style="background: #f1f5f9;">
                        <input type="text" id="evtLng" placeholder="Longitude" readonly style="background: #f1f5f9;">
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn" onclick="toggleEventModal(false)"
                        style="background: #e2e8f0; flex: 1;">Batal</button>
                    <button type="submit" class="btn btn-primary" id="btnSaveEvent" style="flex: 2;">Simpan
                        Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Detail Event Modal -->
    <div id="eventDetailModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1001; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 95%; max-width: 800px; padding: 2rem; border-radius: var(--radius); position: relative; max-height: 90vh; overflow-y: auto;">
            <div style="position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem; align-items: center;"
                class="no-print">
                <button class="btn btn-sm" style="background: var(--primary); color: white;"
                    onclick="printEventDetail()"><i class="fas fa-print"></i> Cetak PDF</button>
                <button class="btn-close" onclick="toggleEventDetailModal(false)"
                    style="position: static; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            </div>
            <h3 style="margin-bottom: 1.5rem; border-bottom: 2px solid var(--primary); padding-bottom: 0.5rem;"><i
                    class="fas fa-calendar-alt"></i> Daftar Hadir Peserta</h3>

            <div
                style="display: flex; flex-direction: column; gap: 1.25rem; margin-bottom: 2rem; background: rgba(255,255,255,0.5); padding: 1.5rem; border-radius: 0.5rem;">
                <div>
                    <label
                        style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">Nama
                        Event</label>
                    <div id="detEvtNama" style="font-weight: 600;">-</div>
                </div>
                <div>
                    <label
                        style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">Tanggal</label>
                    <div id="detEvtTanggal">-</div>
                </div>
                <div>
                    <label
                        style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">Waktu
                        / Durasi</label>
                    <div id="detEvtWaktu">-</div>
                </div>
                <div>
                    <label
                        style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">Lokasi</label>
                    <div id="detEvtLokasi">-</div>
                </div>
                <div>
                    <label
                        style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">Pengisi
                        / Narasumber</label>
                    <div id="detEvtPengisi">-</div>
                </div>
            </div>

            <div style="margin-bottom: 2rem;">
                <label
                    style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">Deskripsi</label>
                <div id="detEvtDeskripsi" style="line-height: 1.6; font-size: 0.9rem;">-</div>
            </div>

            <h4 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-users"
                    style="color: var(--primary);"></i> Peserta Hadir (Presensi)</h4>
            <div class="data-table-container" style="border: 1px solid rgba(255,255,255,0.05);">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nama Siswa</th>
                            <th>Kelas</th>
                            <th>Jam</th>
                            <th>Keterangan</th>
                        </tr>
                    </thead>
                    <tbody id="eventParticipantList">
                        <tr>
                            <td colspan="4"
                                style="text-align:center; padding: 2rem; color: var(--text-muted); opacity: 0.5;">Memuat
                                data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Atur Jadwal PKL -->
    <div id="scheduleModal" class="hidden modal-overlay"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1000; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 400px; padding: 2rem; border-radius: var(--radius); position: relative; border: 1px solid var(--glass-border);">
            <button class="btn-close" onclick="toggleScheduleModal(false)">&times;</button>
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;"><i
                    class="fas fa-calendar-check" style="color: var(--electric-blue);"></i> Atur Jadwal PKL</h3>
            <form id="scheduleForm" class="form-premium">
                <div class="form-group">
                    <label>Tanggal Mulai</label>
                    <input type="date" id="schedStartDate" required style="width: 100%;">
                </div>
                <div class="form-group">
                    <label>Tanggal Selesai</label>
                    <input type="date" id="schedEndDate" required style="width: 100%;">
                </div>
                <div class="btn-group" style="margin-top: 2rem; grid-auto-columns: 1fr;">
                    <button type="submit" class="btn btn-primary" id="btnSaveSchedule" style="width: 100%;">
                        <i class="fas fa-save" style="margin-right: 0.5rem;"></i> Simpan Jadwal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="hidden"
        style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index: 1100; grid-column: 1 / -1; grid-row: 1 / -1;">
        <div class="glass"
            style="width: 90%; max-width: 400px; max-height: 90vh; padding: 2rem; border-radius: var(--radius); position: relative; overflow-y: auto; overflow-x: hidden;">
            <button class="btn-close" onclick="toggleProfileModal(false)"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            <h3 id="profModalTitle" style="margin-bottom: 1.5rem; text-align: center;">Profil Saya</h3>

            <!-- 1. View State -->
            <div id="profViewContent">
                <div class="profile-avatar-wrapper" style="cursor: default;">
                    <img id="profViewAvatar" src="" alt="Avatar" class="avatar-large" referrerpolicy="no-referrer"
                        onerror="this.src='https://ui-avatars.com/api/?name=Admin&background=random'">
                </div>
                <div style="display: grid; gap: 0.75rem; margin-bottom: 2rem;">
                    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem;">
                        <label style="font-size: 0.7rem; color: var(--text-muted); display: block;">NAMA</label>
                        <div id="pViewNama" style="font-weight: 500;">-</div>
                    </div>
                    <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem;">
                        <label style="font-size: 0.7rem; color: var(--text-muted); display: block;">USERNAME</label>
                        <div id="pViewUser">-</div>
                    </div>
                    <div
                        style="border-bottom: 1px solid #f1f5f9; padding-bottom: 0.5rem; display: flex; justify-content: space-between;">
                        <div>
                            <label style="font-size: 0.7rem; color: var(--text-muted); display: block;">NIP</label>
                            <div id="pViewNip">-</div>
                        </div>
                        <div style="text-align: right;">
                            <label style="font-size: 0.7rem; color: var(--text-muted); display: block;">KONTAK</label>
                            <div id="pViewKontak">-</div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <button class="btn btn-primary" onclick="switchProfileState('edit')" style="width: 100%;"><i
                            class="fas fa-edit"></i> Edit Profil</button>
                    <button class="btn" onclick="switchProfileState('password')"
                        style="width: 100%; background: #f1f5f9;"><i class="fas fa-key"></i> Ganti Password</button>
                </div>
            </div>

            <!-- 2. Edit Profile State -->
            <div id="profEditContent" class="hidden">
                <div class="profile-avatar-wrapper" onclick="document.getElementById('profilePhotoInput').click()"
                    title="Klik untuk ubah foto">
                    <img id="profModalAvatar" src="" alt="Avatar" class="avatar-large" referrerpolicy="no-referrer"
                        onerror="this.src='https://ui-avatars.com/api/?name=Admin&background=random'">
                    <div class="overlay"><i class="fas fa-camera"></i></div>
                    <input type="file" id="profilePhotoInput" hidden accept="image/*"
                        onchange="handleAvatarPreview(this)">
                </div>
                <form id="profileForm" onsubmit="saveProfile(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="profUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Kontak (WhatsApp)</label>
                        <input type="text" id="profEditKontak" placeholder="Contoh: 0812...">
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn" onclick="switchProfileState('view')"
                            style="background: #e2e8f0; flex: 1;">Batal</button>
                        <button type="submit" class="btn btn-primary" id="btnSaveProfile"
                            style="flex: 2;">Simpan</button>
                    </div>
                </form>
            </div>

            <!-- 3. Change Password State -->
            <div id="profPassContent" class="hidden">
                <form id="passForm" onsubmit="savePassword(event)">
                    <div class="form-group">
                        <label>Password Lama</label>
                        <div class="password-wrapper">
                            <input type="password" id="profOldPass" required placeholder="Masukkan password saat ini">
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordVisibility('profOldPass')">
                                <i id="toggleIcon-profOldPass" class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Password Baru</label>
                        <div class="password-wrapper">
                            <input type="password" id="profNewPass" required placeholder="Masukkan password baru">
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordVisibility('profNewPass')">
                                <i id="toggleIcon-profNewPass" class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn" onclick="switchProfileState('view')"
                            style="background: #e2e8f0; flex: 1;">Batal</button>
                        <button type="submit" class="btn btn-primary" id="btnSavePassword" style="flex: 2;">Update
                            Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // --- BIMBINGAN & MONITORING LOGIC ---
        async function loadBimbinganData() {
            const container = document.getElementById('bimbinganDataContainer');
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Memuat data...</div>';

            try {
                const [bimRes, stuRes] = await Promise.all([
                    API.getData('BIMBINGAN'),
                    API.getData('DATASISWA')
                ]);

                if (bimRes.status !== 'success' || stuRes.status !== 'success') throw new Error('Gagal mengambil data');

                const data = bimRes.data.sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal));
                window.currentBimbingan = data;
                window.allStudentsData = stuRes.data;

                if (data.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">Belum ada data bimbingan.</div>';
                    return;
                }

                renderBimbingan(data);
            } catch (err) {
                console.error(err);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--danger);">Gagal memuat data.</div>';
            }
        }

        function renderBimbingan(data) {
            const container = document.getElementById('bimbinganDataContainer');
            container.innerHTML = `<div class="card-grid">` + data.map(b => {
                const student = window.allStudentsData ? window.allStudentsData.find(s => s.nis === b.NIS) : null;
                const isMonitoring = b.Jenis_keg === 'Monitoring PKL';

                return `
                    <div class="glass fade-in" style="padding: 1.5rem; border-radius: 1.25rem; display: flex; flex-direction: column; gap: 1rem; border: 1px solid rgba(255,255,255,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <div style="width: 42px; height: 42px; background: rgba(${isMonitoring ? 'var(--primary-rgb)' : '99, 102, 241'}, 0.1); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(${isMonitoring ? 'var(--primary-rgb)' : '99, 102, 241'}, 0.2);">
                                    <i class="fas ${isMonitoring ? 'fa-video' : 'fa-clipboard-check'}" style="color: ${isMonitoring ? 'var(--primary)' : '#818cf8'}; font-size: 1.1rem;"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; color: #fff; font-size: 0.95rem; line-height: 1.2;">${student ? student.nama : b.NIS}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;">${formatDate(b.Tanggal)}</div>
                                </div>
                            </div>
                            <span style="font-size: 0.65rem; padding: 4px 10px; border-radius: 2rem; background: rgba(${isMonitoring ? 'var(--primary-rgb)' : '99, 102, 241'}, 0.1); color: ${isMonitoring ? 'var(--primary)' : '#a5b4fc'}; font-weight: 700; border: 1px solid rgba(${isMonitoring ? 'var(--primary-rgb)' : '99, 102, 241'}, 0.3); text-transform: uppercase; letter-spacing: 0.5px;">${b.Jenis_keg}</span>
                        </div>

                        <div style="font-size: 0.85rem; color: var(--text-main); line-height: 1.6; opacity: 0.7; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; min-height: 3.8rem; margin: 0.25rem 0;">
                            ${b.Deskripsi}
                        </div>

                        <div style="display: flex; gap: 0.75rem; margin-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1rem;">
                            <button class="btn btn-primary" style="flex: 1; padding: 0.6rem; font-size: 0.8rem; border-radius: 0.75rem; font-weight: 600;" onclick="viewBimbinganDetail('${b.ID_BIMBINGAN}')">
                                <i class="fas fa-eye" style="margin-right: 0.4rem;"></i> Detail
                            </button>
                            <button class="action-btn delete" style="width: 38px; height: 38px; border-radius: 0.75rem;" onclick="deleteBimbingan('${b.ID_BIMBINGAN}')" title="Hapus Jurnal">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`;
            }).join('') + `</div>`;
        }

        function toggleBimbinganModal(show) {
            const modal = document.getElementById('bimbinganModal');
            modal.classList.toggle('hidden', !show);
            modal.style.display = show ? 'flex' : 'none';
            if (!show) {
                document.getElementById('bimbinganForm').reset();
                document.getElementById('bimPhotoPreview').innerHTML = '<span style="color: var(--text-muted); font-size: 0.75rem; font-weight: 600;">PREVIEW</span>';
                document.getElementById('bimPhotoUrl').value = '';
                document.getElementById('selectedCountDisplay').textContent = 'Pilih minimal satu siswa';
                document.getElementById('selectedStudentsList').innerHTML = '';
                document.getElementById('studentDropdownMenu').classList.add('hidden');
                document.getElementById('studentSearchInput').value = '';
            }
        }

        function toggleStudentDropdown(e) {
            if (e) e.stopPropagation();
            const menu = document.getElementById('studentDropdownMenu');
            menu.classList.toggle('hidden');
            if (!menu.classList.contains('hidden')) {
                document.getElementById('studentSearchInput').focus();
            }
        }

        function updateSelectedCount() {
            const checkedCheckboxes = Array.from(document.querySelectorAll('input[name="bimNis"]:checked'));
            const nises = checkedCheckboxes.map(cb => cb.value);

            const display = document.getElementById('selectedCountDisplay');
            const listDisplay = document.getElementById('selectedStudentsList');

            if (nises.length === 0) {
                display.textContent = 'Pilih minimal satu siswa';
                display.style.color = 'var(--text-muted)';
                listDisplay.innerHTML = '';
            } else {
                display.textContent = `${nises.length} Siswa Terpilih`;
                display.style.color = 'var(--text-main)';

                const selectedNames = checkedCheckboxes.map(cb => {
                    const label = cb.nextElementSibling;
                    return label ? label.textContent.split(' (')[0] : 'Siswa';
                });

                listDisplay.innerHTML = selectedNames.map(name => `
                    <div style="background: rgba(var(--primary-rgb), 0.15); color: var(--primary-light); padding: 0.3rem 0.75rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600; border: 1px solid rgba(var(--primary-rgb), 0.3); display: flex; align-items: center; gap: 0.4rem;">
                        <i class="fas fa-check-circle" style="font-size: 0.7rem;"></i> ${name}
                    </div>
                `).join('');
            }
        }

        function filterStudentList() {
            const query = document.getElementById('studentSearchInput').value.toLowerCase();
            const items = document.querySelectorAll('.student-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? 'flex' : 'none';
            });
        }

        async function openBimbinganModal() {
            toggleBimbinganModal(true);
            document.getElementById('bimbinganModalTitle').textContent = 'Input Kegiatan Bimbingan';
            document.getElementById('bimId').value = '';

            const checklist = document.getElementById('bimNisChecklist');
            checklist.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-muted);"><i class="fas fa-spinner fa-spin"></i></div>';

            try {
                if (!window.allStudentsData) {
                    const res = await API.getData('DATASISWA');
                    window.allStudentsData = res.data;
                }
                checklist.innerHTML = window.allStudentsData.map(s => `
                    <div class="student-item" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; cursor: pointer; border-radius: 0.6rem; transition: background 0.2s;" onclick="this.querySelector('input').click()">
                        <input type="checkbox" name="bimNis" value="${s.nis}" id="chk_${s.nis}" 
                            style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); filter: drop-shadow(0 0 5px rgba(var(--primary-rgb), 0.3));" 
                            onclick="event.stopPropagation(); updateSelectedCount()" onchange="updateSelectedCount()">
                        <label for="chk_${s.nis}" style="font-size: 0.85rem; cursor: pointer; flex: 1; color: var(--text-main);">${s.nama} (${s.nis})</label>
                    </div>
                `).join('');
            } catch (err) {
                checklist.innerHTML = '<div style="color: var(--danger); font-size: 0.8rem; padding: 1rem;">Gagal memuat daftar siswa.</div>';
            }
        }

        document.getElementById('bimPhotoInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const preview = document.getElementById('bimPhotoPreview');
            preview.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                const compressed = await API.compressImage(file);
                const reader = new FileReader();
                reader.onload = (event) => {
                    preview.innerHTML = `<img src="${event.target.result}" style="width:100%; height:100%; object-fit:cover;">`;
                };
                reader.readAsDataURL(compressed);
                const res = await API.uploadFile(compressed);
                if (res.status === 'success') document.getElementById('bimPhotoUrl').value = res.url;
                else throw new Error('Upload gagal');
            } catch (err) {
                showToast('Gagal proses foto', 'danger');
                preview.innerHTML = '<span style="color: var(--danger);">Error</span>';
            }
        };

        document.getElementById('bimbinganForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSaveBimbingan');
            const nises = Array.from(document.querySelectorAll('input[name="bimNis"]:checked')).map(cb => cb.value);

            if (nises.length === 0) return showToast('Pilih minimal satu siswa', 'warning');

            btn.disabled = true;
            btn.textContent = 'Menyimpan...';

            try {
                const results = await Promise.all(nises.map(nis => {
                    const payload = {
                        NIS: nis,
                        Tanggal: document.getElementById('bimTanggal').value,
                        Jenis_keg: document.getElementById('bimJenis').value,
                        Deskripsi: document.getElementById('bimDeskripsi').value,
                        Photo: document.getElementById('bimPhotoUrl').value
                    };
                    return API.postData('BIMBINGAN', payload);
                }));

                if (results.every(r => r.status === 'success')) {
                    showToast('Kegiatan berhasil disimpan!', 'success');
                    toggleBimbinganModal(false);
                    loadBimbinganData();
                } else {
                    showToast('Beberapa data gagal disimpan', 'warning');
                }
            } catch (err) {
                showToast('Kesalahan sistem', 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Simpan';
            }
        };

        function viewBimbinganDetail(id) {
            const b = window.currentBimbingan.find(item => item.ID_BIMBINGAN === id);
            if (!b) return;

            const student = window.allStudentsData ? window.allStudentsData.find(s => s.nis === b.NIS) : null;
            const content = document.getElementById('viewBimbinganContent');
            content.innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--primary);">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Siswa</div>
                        <div style="font-weight: 600; font-size: 1.1rem;">${student ? student.nama : b.NIS}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">NIS: ${b.NIS}</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <strong style="color:var(--text-muted); font-size:0.75rem; display:block;">TANGGAL</strong>
                            <div>${formatDate(b.Tanggal)}</div>
                        </div>
                        <div>
                            <strong style="color:var(--text-muted); font-size:0.75rem; display:block;">JENIS KEGIATAN</strong>
                            <span class="badge" style="background:var(--primary); color:white; padding:0.2rem 0.5rem; border-radius:1rem; font-size:0.7rem;">${b.Jenis_keg}</span>
                        </div>
                    </div>
                    <div>
                        <strong style="color:var(--text-muted); font-size:0.75rem; display:block;">DESKRIPSI / PEMBAHASAN</strong>
                        <div style="background:rgba(0,0,0,0.2); padding:0.75rem; border-radius:0.5rem; font-size:0.9rem; line-height:1.5; border: 1px solid rgba(255,255,255,0.05);">${b.Deskripsi}</div>
                    </div>
                    <div>
                        <strong style="color:var(--text-muted); font-size:0.75rem; display:block;">BUKTI FOTO</strong>
                        ${(b.Photo || b.photo) ? `<img src="${getDriveThumbnail(b.Photo || b.photo)}" style="width:100%; border-radius:0.5rem; margin-top:0.5rem; border:1px solid rgba(255,255,255,0.05);" onerror="this.src='https://placehold.co/400x300?text=Foto+Gagal+Dimuat'">` : '<div style="padding:1rem; background:rgba(0,0,0,0.2); border-radius:0.5rem; text-align:center; color:var(--text-muted); font-size:0.8rem; border: 1px solid rgba(255,255,255,0.05);">Tidak ada foto</div>'}
                    </div>
                </div>
            `;
            toggleViewBimbinganModal(true);
        }

        function toggleViewBimbinganModal(show) {
            const modal = document.getElementById('viewBimbinganModal');
            modal.classList.toggle('hidden', !show);
            modal.style.display = show ? 'flex' : 'none';
        }

        async function deleteBimbingan(id) {
            if (!confirm('Yakin ingin menghapus data bimbingan ini?')) return;
            try {
                const res = await API.deleteData('BIMBINGAN', id);
                if (res.status === 'success') {
                    showToast('Data dihapus', 'success');
                    loadBimbinganData();
                } else throw new Error(res.error);
            } catch (err) {
                showToast('Gagal menghapus: ' + err.message, 'danger');
            }
        }
        const user = AUTH.checkSession();
        if (!user || user.role !== 'admin') window.location.href = '../index.html';

        function updateUserUI() {
            const user = AUTH.getUser();
            if (!user) return;

            const welcomeName = document.getElementById('userName');
            if (welcomeName) welcomeName.textContent = user.nama || 'Admin';

            const fallbackUrl = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.nama || 'Admin') + '&background=random';
            const avatarSrc = user.photo ? getDriveThumbnail(user.photo) : fallbackUrl;

            const avatars = ['sideAvatar', 'headerAvatar', 'profViewAvatar', 'profModalAvatar'];
            avatars.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.onerror = function () {
                        this.onerror = null;
                        this.src = fallbackUrl;
                        if (id === 'headerAvatar') {
                            const ph = document.getElementById('headerAvatarPlaceholder');
                            if (ph) ph.style.display = 'flex';
                            this.style.display = 'none';
                        }
                    };
                    el.src = avatarSrc;

                    // Special handling for headerAvatar
                    if (id === 'headerAvatar') {
                        const ph = document.getElementById('headerAvatarPlaceholder');
                        if (user.photo) {
                            el.style.display = 'block';
                            if (ph) ph.style.display = 'none';
                        } else {
                            el.style.display = 'none';
                            if (ph) ph.style.display = 'flex';
                        }
                    }
                }
            });
        }

        updateUserUI();
        loadDashboardStats();

        function getDriveThumbnail(urlOrId) {
            if (!urlOrId) return '';
            let id = urlOrId;
            if (urlOrId.includes('id=')) {
                id = urlOrId.split('id=')[1].split('&')[0];
            } else if (urlOrId.includes('/d/')) {
                id = urlOrId.split('/d/')[1].split('/')[0];
            }
            return `https://drive.google.com/thumbnail?id=${id}&sz=w600`;
        }

        function toggleProfileModal(show) {
            const modal = document.getElementById('profileModal');
            modal.classList.toggle('hidden', !show);
            modal.style.display = show ? 'flex' : 'none';
        }

        function switchProfileState(state) {
            const title = document.getElementById('profModalTitle');
            const view = document.getElementById('profViewContent');
            const edit = document.getElementById('profEditContent');
            const pass = document.getElementById('profPassContent');

            view.classList.add('hidden');
            edit.classList.add('hidden');
            pass.classList.add('hidden');

            if (state === 'view') {
                title.textContent = 'Profil Saya';
                view.classList.remove('hidden');
            } else if (state === 'edit') {
                title.textContent = 'Edit Profil';
                edit.classList.remove('hidden');
            } else if (state === 'password') {
                title.textContent = 'Ganti Password';
                pass.classList.remove('hidden');
            }
        }

        async function openProfileModal() {
            const currentUser = AUTH.getUser();

            // Populate View State basics
            document.getElementById('pViewNama').textContent = currentUser.nama;
            document.getElementById('pViewUser').textContent = currentUser.username;

            // Fetch more details for View state (nip, kontak) from DB
            try {
                const res = await API.getData('LOGINADMIN');
                const dbUser = res.data.find(u => u.username === currentUser.username);
                if (dbUser) {
                    document.getElementById('pViewNip').textContent = dbUser.nip || '-';
                    document.getElementById('pViewKontak').textContent = dbUser.kontak || '-';
                    // Populate Profile Edit Fields
                    document.getElementById('profUsername').value = dbUser.username || '';
                    document.getElementById('profEditKontak').value = dbUser.kontak || '';
                }
            } catch (e) { console.error('Error fetching profile details:', e); }

            const fallbackUrl = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(currentUser.nama) + '&background=random';
            const avatarSrc = currentUser.photo ? getDriveThumbnail(currentUser.photo) : fallbackUrl;
            const setAvatarWithFallback = (el) => {
                el.onerror = function () { this.onerror = null; this.src = fallbackUrl; };
                el.src = avatarSrc;
            };
            setAvatarWithFallback(document.getElementById('profViewAvatar'));
            setAvatarWithFallback(document.getElementById('profModalAvatar'));

            switchProfileState('view');
            toggleProfileModal(true);
        }

        function handleAvatarPreview(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('profModalAvatar').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function saveProfile(event) {
            event.preventDefault();
            const btn = document.getElementById('btnSaveProfile');
            const newUsername = document.getElementById('profUsername').value;
            const photoFile = document.getElementById('profilePhotoInput').files[0];

            btn.disabled = true;
            btn.textContent = 'Menyimpan...';

            try {
                const currentUser = AUTH.getUser();
                const updateData = {};

                const newUsername = document.getElementById('profUsername').value;
                const newKontak = document.getElementById('profEditKontak').value;

                if (newUsername !== currentUser.username) updateData.username = newUsername;
                if (newKontak !== document.getElementById('pViewKontak').textContent) updateData.kontak = newKontak;

                if (photoFile) {
                    btn.textContent = 'Mengompres...';
                    const compressedFile = await API.compressImage(photoFile);
                    btn.textContent = 'Mengunggah...';
                    const uploadRes = await API.uploadFile(compressedFile);
                    if (uploadRes.status === 'success') updateData.photo = uploadRes.url;
                }

                if (Object.keys(updateData).length === 0) {
                    showToast('Tidak ada perubahan.', 'info');
                    switchProfileState('view');
                    return;
                }

                const updateRes = await API.updateProfile('admin', currentUser.username, updateData);
                if (updateRes.status === 'success') {
                    showToast('Profil diperbarui!', 'success');
                    const session = JSON.parse(localStorage.getItem('pkl_session'));
                    Object.assign(session, updateData);
                    localStorage.setItem('pkl_session', JSON.stringify(session));
                    updateUserUI();
                    openProfileModal(); // Refresh view
                } else {
                    showToast('Gagal: ' + updateRes.message, 'danger');
                }
            } catch (err) {
                showToast('Kesalahan: ' + err.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Simpan';
            }
        }

        async function savePassword(event) {
            event.preventDefault();
            const btn = document.getElementById('btnSavePassword');
            const oldPass = document.getElementById('profOldPass').value;
            const newPass = document.getElementById('profNewPass').value;

            btn.disabled = true;
            btn.textContent = 'Memproses...';

            try {
                const currentUser = AUTH.getUser();
                const res = await API.getData('LOGINADMIN');
                const dbUser = res.data.find(u =>
                    (u.username || "").toString().trim().toLowerCase() ===
                    (currentUser.username || "").toString().trim().toLowerCase()
                );

                if (!dbUser || (oldPass || "").toString().trim() !== (dbUser.password || "").toString().trim()) {
                    showToast('Password lama salah!', 'danger');
                    return;
                }

                const updateRes = await API.updateProfile('admin', currentUser.username, { password: newPass });
                if (updateRes.status === 'success') {
                    showToast('Password berhasil diganti!', 'success');
                    switchProfileState('view');
                    document.getElementById('passForm').reset();
                } else {
                    showToast('Gagal: ' + updateRes.message, 'danger');
                }
            } catch (err) {
                showToast('Kesalahan: ' + err.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Update Password';
            }
        }

        let locMap, locMarker;

        const showToast = (msg, type) => API.showNotification(msg, type === 'danger' ? 'error' : type);

        // Date Formatter Helper
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
            } catch (e) {
                return dateStr;
            }
        }

        // WhatsApp Link Helper
        function formatWhatsApp(phone) {
            if (!phone) return '-';
            const clean = phone.toString().replace(/[^0-9]/g, '');
            const display = phone.toString().startsWith('0') ? '62' + clean.slice(1) : (clean.startsWith('62') ? clean : '62' + clean);
            return `<a href="https://wa.me/${display}" target="_blank" class="wa-link"><i class="fab fa-whatsapp"></i> ${phone}</a>`;
        }

        async function loadJurusanOptions(selectId, defaultValue = '') {
            const select = document.getElementById(selectId);
            if (!select) return;
            try {
                const res = await API.getData('JURUSAN');
                if (res.status === 'success' || res.data) {
                    let html = (defaultValue === 'Semua') ? '<option value="Semua">Semua Jurusan</option>' : '<option value="">Pilih Jurusan</option>';
                    res.data.forEach(j => {
                        html += `<option value="${j.Jurusan}">${j.Jurusan}</option>`;
                    });
                    select.innerHTML = html;
                    if (defaultValue && defaultValue !== 'Semua') select.value = defaultValue;
                    else if (defaultValue === 'Semua') select.value = 'Semua';
                }
            } catch (err) {
                console.error('Error loading jurusan:', err);
            }
        }

        async function loadPklOptions(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            try {
                const res = await API.getData('LOKASIPKL');
                if (res.status === 'success' || res.data) {
                    select.innerHTML = '<option value="">Belum Memilih PKL</option>' + (res.data || []).map(l => `<option value="${l.ID_PKL}">${l.NamaTempat}</option>`).join('');
                }
            } catch (err) {
                console.error('Error loading PKL options:', err);
            }
        }

        async function loadGuruOptions(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            try {
                const res = await API.getData('DATAGURU');
                if (res.status === 'success' || res.data) {
                    select.innerHTML = '<option value="">Belum Ada Pembimbing</option>' + (res.data || []).map(g => `<option value="${g.ID_GURU}">${g.NamaGuru}</option>`).join('');
                }
            } catch (err) {
                console.error('Error loading Guru options:', err);
            }
        }

        async function loadDashboardStats() {
            try {
                // Fetch all necessary data in parallel
                const [admins, gurus, kakomlis, mentors, siswas, allStudents, locations, applications] = await Promise.all([
                    API.getData('LOGINADMIN'),
                    API.getData('LOGINGURU'),
                    API.getData('LOGINKAKOMLI'),
                    API.getData('LOGINMENTOR'),
                    API.getData('LOGINSISWA'),
                    API.getData('DATASISWA'),
                    API.getData('LOKASIPKL'),
                    API.getData('PENGAJUANPKL')
                ]);

                // User counts
                const countAdmin = (admins.data || []).length;
                const countGuru = (gurus.data || []).length;
                const countKakomli = (kakomlis.data || []).length;
                const countMentor = (mentors.data || []).length;
                const countUserSiswa = (siswas.data || []).length;
                const totalUsers = countAdmin + countGuru + countKakomli + countMentor + countUserSiswa;

                // Data counts
                const totalStudents = (allStudents.data || []).length;
                const totalLocations = (locations.data || []).length;

                // Application status
                const apps = applications.data || [];
                const countApproved = apps.filter(a => a.Status === 'Disetujui').length;
                const countPending = apps.filter(a => a.Status === 'Pending' || !a.Status).length;

                // Update UI
                document.getElementById('count-users').textContent = totalUsers;
                document.getElementById('count-students').textContent = totalStudents;
                document.getElementById('count-locations').textContent = totalLocations;
                document.getElementById('count-app-approved').textContent = countApproved;
                document.getElementById('count-app-pending').textContent = countPending;

                document.getElementById('count-admin').textContent = countAdmin;
                document.getElementById('count-guru').textContent = countGuru;
                document.getElementById('count-kakomli').textContent = countKakomli;
                document.getElementById('count-mentor').textContent = countMentor;
                document.getElementById('count-siswa').textContent = countUserSiswa;

            } catch (err) {
                console.error('Error loading dashboard stats:', err);
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            const section = document.getElementById('section-' + sectionId);
            if (section) section.classList.remove('hidden');

            // Navigation Active states
            document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
            document.querySelectorAll('.bottom-nav-link').forEach(a => a.classList.remove('active'));

            const navId = 'nav-' + sectionId;
            if (document.getElementById(navId)) document.getElementById(navId).classList.add('active');

            const bnavId = 'bnav-' + sectionId;
            if (document.getElementById(bnavId)) document.getElementById(bnavId).classList.add('active');

            // Mobile Sidebar Auto-close
            const sidebar = document.getElementById('sidebar');
            if (sidebar && sidebar.classList.contains('active') && window.innerWidth <= 1024) {
                toggleMobileSidebar();
            }

            const titles = {
                dashboard: 'Admin Panel',
                users: 'Kelola Pengguna',
                locations: 'Kelola Lokasi PKL',
                students: 'Kelola Data Siswa',
                teachers: 'Master Data Guru',
                applications: 'Pengajuan PKL Siswa',
                attendance: 'Monitoring Kehadiran Siswa',
                'report-title': 'Pengajuan Judul Laporan',
                announcements: 'Kelola Pengumuman',
                events: 'Kelola Event & Kegiatan',
                docs: 'Kelola Template Dokumen',
                bimbingan: 'Bimbingan & Monitoring PKL'
            };
            document.getElementById('sectionTitle').textContent = titles[sectionId] || 'Admin Panel';

            if (sectionId === 'dashboard') loadDashboardStats();
            if (sectionId === 'users') loadUsers();
            if (sectionId === 'locations') loadLocations();
            if (sectionId === 'students') loadStudents();
            if (sectionId === 'teachers') loadMasterTeachers();
            if (sectionId === 'applications') loadApplications();
            if (sectionId === 'attendance') loadAttendance();
            if (sectionId === 'report-title') loadReportTitles();
            if (sectionId === 'announcements') loadAnnouncementsAdmin();
            if (sectionId === 'events') loadEventsAdmin();
            if (sectionId === 'docs') loadDocuments();
            if (sectionId === 'schedule') loadSchedule();
            if (sectionId === 'bimbingan') loadBimbinganData();
        }

        // PKL SCHEDULE MANAGEMENT
        // ==========================================
        async function loadSchedule() {
            try {
                const res = await API.getData('JADWALPKL');
                if (res.status === 'success' && res.data && res.data.length > 0) {
                    const sched = res.data[0];
                    window.currentSchedule = sched;
                    document.getElementById('displayStartDate').textContent = formatDate(sched.StartDate);
                    document.getElementById('displayEndDate').textContent = formatDate(sched.EndDate);
                } else {
                    document.getElementById('displayStartDate').textContent = '-- -- ----';
                    document.getElementById('displayEndDate').textContent = '-- -- ----';
                }
            } catch (err) {
                console.error('Error loading schedule:', err);
                showToast('Gagal memuat jadwal PKL', 'danger');
            }
        }

        function toggleScheduleModal(show) {
            const modal = document.getElementById('scheduleModal');
            modal.classList.toggle('hidden', !show);
            modal.style.display = show ? 'flex' : 'none';
        }

        function openScheduleModal() {
            if (window.currentSchedule) {
                // Ensure date format is YYYY-MM-DD for input[type="date"]
                const formatForInput = (dateStr) => {
                    if (!dateStr) return '';
                    const d = new Date(dateStr);
                    if (isNaN(d.getTime())) return '';
                    return d.toISOString().split('T')[0];
                };
                document.getElementById('schedStartDate').value = formatForInput(window.currentSchedule.StartDate);
                document.getElementById('schedEndDate').value = formatForInput(window.currentSchedule.EndDate);
            }
            toggleScheduleModal(true);
        }

        document.getElementById('scheduleForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSaveSchedule');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

            const payload = {
                ID: 'MAIN_SCHEDULE',
                StartDate: document.getElementById('schedStartDate').value,
                EndDate: document.getElementById('schedEndDate').value
            };

            try {
                let res;
                if (window.currentSchedule) {
                    res = await API.updateData('JADWALPKL', 'MAIN_SCHEDULE', payload);
                } else {
                    res = await API.postData('JADWALPKL', payload);
                }

                if (res.status === 'success') {
                    showToast('Jadwal PKL berhasil disimpan!', 'success');
                    toggleScheduleModal(false);
                    loadSchedule();
                } else {
                    showToast('Gagal menyimpan: ' + res.error, 'danger');
                }
            } catch (err) {
                console.error('Save Schedule Error:', err);
                showToast('Kesalahan saat menyimpan', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Simpan';
            }
        };

        async function deleteSchedule() {
            if (!confirm('Apakah Anda yakin ingin menghapus jadwal PKL ini? Data jadwal akan dikosongkan.')) return;

            const btn = document.getElementById('btnDeleteSchedule');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menghapus...';

            try {
                const res = await API.deleteData('JADWALPKL', 'MAIN_SCHEDULE');
                if (res.status === 'success') {
                    showToast('Jadwal PKL berhasil dihapus!', 'success');
                    window.currentSchedule = null;
                    await loadSchedule();
                } else {
                    showToast('Gagal menghapus: ' + res.error, 'danger');
                }
            } catch (err) {
                console.error('Delete Schedule Error:', err);
                showToast('Kesalahan saat menghapus', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        async function loadUsers() {
            const role = document.getElementById('roleFilter').value;
            const tabMap = { admin: 'LOGINADMIN', guru: 'LOGINGURU', kakomli: 'LOGINKAKOMLI', mentor: 'LOGINMENTOR', siswa: 'LOGINSISWA' };
            const grid = document.getElementById('userListGrid');
            const searchInput = document.getElementById('userSearch');
            if (searchInput) searchInput.value = '';

            grid.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 4rem; opacity: 0.5;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin-bottom: 1rem; display: block;"></i>
                    Memuat data...
                </div>`;

            try {
                const [response, pklResponse] = await Promise.all([
                    API.getData(tabMap[role]),
                    role === 'mentor' ? API.getData('LOKASIPKL') : Promise.resolve({ data: [] })
                ]);

                window.userListData = response.data || [];
                renderUsers(window.userListData);
            } catch (err) {
                console.error('Load Users Error:', err);
                grid.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; padding: 4rem; color: var(--danger);">Gagal memuat data.</div>`;
            }
        }

        function renderUsers(users) {
            const grid = document.getElementById('userListGrid');
            const role = document.getElementById('roleFilter').value;
            grid.innerHTML = '';

            if (users && users.length > 0) {
                users.forEach(u => {
                    const avatarSrc = u.photo ? getDriveThumbnail(u.photo) : `https://ui-avatars.com/api/?name=${encodeURIComponent(u.nama)}&background=random`;

                    const item = document.createElement('div');
                    item.className = 'compact-user-item';
                    item.onclick = () => openViewUserDetail(u.username);
                    item.innerHTML = `
                        <img src="${avatarSrc}" class="compact-user-avatar">
                        <div class="compact-user-name" title="${u.nama}">${u.nama}</div>
                        <i class="fas fa-chevron-right" style="margin-left: auto; font-size: 0.7rem; opacity: 0.2;"></i>
                    `;
                    grid.appendChild(item);
                });
            } else {
                const query = document.getElementById('userSearch')?.value || '';
                const emptyMsg = query ? 'Tidak ada data yang cocok.' : `Belum ada data ${role} yang tersedia.`;
                grid.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; padding: 4rem; opacity: 0.5;">${emptyMsg}</div>`;
            }
        }

        function filterUsers() {
            const query = document.getElementById('userSearch').value.toLowerCase();
            const filtered = window.userListData.filter(u =>
                (u.nama && u.nama.toLowerCase().includes(query)) ||
                (u.username && u.username.toLowerCase().includes(query))
            );
            renderUsers(filtered);
        }

        async function openViewUserDetail(username) {
            const u = window.userListData.find(item => item.username == username);
            if (!u) return;

            const role = document.getElementById('roleFilter').value;
            const content = document.getElementById('viewUserDetailContent');

            let extraInfo = '';
            if (role === 'mentor' && u.ID_PKL) {
                try {
                    const res = await API.getData('LOKASIPKL');
                    const pkl = res.data.find(l => l.ID_PKL == u.ID_PKL);
                    if (pkl) {
                        extraInfo = `
                                <div><strong style="color:var(--text-muted)">Tempat PKL:</strong><br>${pkl.NamaTempat}</div>
                                <div><strong style="color:var(--text-muted)">Alamat:</strong><br>${pkl.Alamat || '-'}</div>
                                <div><strong style="color:var(--text-muted)">Kontak Mentor (DUDI):</strong><br>${formatWhatsApp(pkl.KontakMentor)}</div>
                            `;
                    }
                } catch (e) { console.error(e); }
            }

            const avatarSrc = u.photo ? getDriveThumbnail(u.photo) : `https://ui-avatars.com/api/?name=${encodeURIComponent(u.nama)}&background=random`;
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <img src="${avatarSrc}" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #e0f2fe; box-shadow: var(--shadow);">
                </div>
                <div><strong style="color:var(--text-muted)">Username:</strong><br>${u.username}</div>
                <div><strong style="color:var(--text-muted)">Nama Lengkap:</strong><br>${u.nama}</div>
                ${u.nip ? `<div><strong style="color:var(--text-muted)">NIP:</strong><br>${u.nip}</div>` : ''}
                ${u.nis ? `<div><strong style="color:var(--text-muted)">NIS:</strong><br>${u.nis}</div>` : ''}
                <div><strong style="color:var(--text-muted)">Kontak Akun:</strong><br>${formatWhatsApp(u.kontak)}</div>
                ${u.jurusan ? `<div><strong style="color:var(--text-muted)">Jurusan:</strong><br>${u.jurusan}</div>` : ''}
                ${extraInfo}
                <div><strong style="color:var(--text-muted)">Peran:</strong><br>${role.charAt(0).toUpperCase() + role.slice(1)}</div>
            `;

            const modal = document.getElementById('viewUserDetailModal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        async function openEditUser(username) {
            const u = window.userListData.find(item => item.username == username);
            if (!u) return;

            const role = document.getElementById('roleFilter').value;
            document.getElementById('newRole').value = role;

            // Adjust fields first
            await adjustFormFields();

            document.getElementById('userModalTitle').textContent = 'Edit Akun Pengguna';
            document.getElementById('userOriginalUsername').value = u.username;

            // Populate fields
            if (document.getElementById('newNama')) document.getElementById('newNama').value = u.nama;
            if (document.getElementById('newUsername')) {
                document.getElementById('newUsername').value = u.username;
                if (role === 'siswa' || role === 'guru' || role === 'kakomli') {
                    document.getElementById('newUsername').readOnly = true;
                }
            }
            if (document.getElementById('newPassword')) document.getElementById('newPassword').value = u.password;
            if (document.getElementById('newNip') && u.nip) document.getElementById('newNip').value = u.nip;
            if (document.getElementById('newNis') && u.nis) {
                document.getElementById('newNis').value = u.nis;
            }
            if (document.getElementById('newKontak') && u.kontak) {
                let val = u.kontak;
                if (val.startsWith('+62')) val = val.substring(3);
                document.getElementById('newKontak').value = val;
            }
            if (document.getElementById('newID_PKL') && u.ID_PKL) document.getElementById('newID_PKL').value = u.ID_PKL;
            if (document.getElementById('newJurusan') && u.jurusan) document.getElementById('newJurusan').value = u.jurusan;

            toggleAddUserModal(true);
        }

        async function deleteUser(role, username) {
            if (!confirm('Hapus akun ini?')) return;
            const tabMap = { admin: 'LOGINADMIN', guru: 'LOGINGURU', kakomli: 'LOGINKAKOMLI', mentor: 'LOGINMENTOR', siswa: 'LOGINSISWA' };
            try {
                const res = await API.deleteData(tabMap[role], username);
                if (res.status === 'success') {
                    showToast('Berhasil dihapus');
                    loadUsers();
                } else {
                    showToast('Gagal: ' + (res.message || res.error), 'danger');
                }
            } catch (e) {
                showToast('Kesalahan jaringan', 'danger');
            }
        }

        async function loadLocations() {
            const tbody = document.getElementById('locationTableBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 2rem;">Memuat data...</td></tr>';

            try {
                const response = await API.getData('LOKASIPKL');
                tbody.innerHTML = '';

                if (response.data && response.data.length > 0) {
                    window.locationData = response.data; // Cache for edit/view
                    response.data.forEach(l => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td data-label="Lokasi">
                                <strong style="color: #fff;">${l.NamaTempat}</strong><br>
                                <span style="font-size: 0.75rem; color: var(--text-muted); line-height: 1.4; display: block; max-width: 300px;">${l.Alamat}</span>
                            </td>
                            <td data-label="Mentor">
                                <div style="font-weight: 600; color: #fff; font-size: 0.9rem;">${l.NamaMentor}</div>
                                <span style="font-size: 0.75rem; color: var(--electric-blue); font-weight: 600;">${l.KontakMentor || '-'}</span>
                            </td>
                            <td data-label="Jurusan" style="font-weight: 700; font-size: 0.8rem; color: var(--accent); opacity: 0.9;">${l.Jurusan || '-'}</td>
                            <td data-label="Aksi" style="text-align: right; padding-right: 1rem;">
                                <div class="table-actions" style="justify-content: flex-end;">
                                    <button class="action-btn view" onclick="openViewLocation('${l.ID_PKL}')" title="Lihat Detail"><i class="fas fa-eye"></i></button>
                                    <button class="action-btn edit" onclick="openEditLocation('${l.ID_PKL}')" title="Edit Data"><i class="fas fa-edit"></i></button>
                                    <button class="action-btn delete" onclick="deleteLocation('${l.ID_PKL}')" title="Hapus Lokasi"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 3rem; color: var(--text-muted); opacity: 0.5;">Belum ada data lokasi PKL yang terdaftar.</td></tr>';
                }
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--danger); padding: 2rem;">Gagal memuat data.</td></tr>';
            }
        }

        async function loadStudents() {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem;">Memuat data...</td></tr>';

            try {
                const [stuRes, pklRes, locRes, guruRes, loginGuruRes, evalRes, judulRes] = await Promise.all([
                    API.getData('DATASISWA'),
                    API.getData('DATAPKL'),
                    API.getData('LOKASIPKL'),
                    API.getData('DATAGURU'),
                    API.getData('LOGINGURU'),
                    API.getData('EVALUASI'),
                    API.getData('JUDULLAPORAN')
                ]);

                if (stuRes.data && stuRes.data.length > 0) {
                    // Sorting by NIS (Natural Sort)
                    stuRes.data.sort((a, b) => a.nis.toString().localeCompare(b.nis.toString(), undefined, { numeric: true, sensitivity: 'base' }));

                    window.studentData = stuRes.data;
                    window.locationData = locRes.data; // Cache for history lookups
                    window.combinedStudentData = stuRes.data.map(s => {
                        const pklInfo = pklRes.data ? pklRes.data.find(p => p.nis == s.nis) : null;

                        // Multi-location logic: use the latest assigned ID_PKL
                        let currentIdPkl = null;
                        if (pklInfo) {
                            currentIdPkl = pklInfo.ID_PKL_3 || pklInfo.ID_PKL_2 || pklInfo.ID_PKL;
                        }

                        const location = currentIdPkl && locRes.data ? locRes.data.find(l => l.ID_PKL == currentIdPkl) : null;
                        const guruMaster = pklInfo && guruRes.data ? guruRes.data.find(g => g.ID_GURU == pklInfo.ID_GURU) : null;
                        const guruLogin = guruMaster && loginGuruRes.data ? loginGuruRes.data.find(gl => gl.nama === guruMaster.NamaGuru || gl.nip === guruMaster.ID_GURU) : null;
                        const evaluation = evalRes.data ? evalRes.data.find(e => e.NIS == s.nis) : null;
                        const judul = judulRes.data ? judulRes.data.find(j => j.NIS == s.nis) : null;

                        // Identify history for detail view
                        const pklHistory = [];
                        if (pklInfo) {
                            if (pklInfo.ID_PKL) pklHistory.push(pklInfo.ID_PKL);
                            if (pklInfo.ID_PKL_2) pklHistory.push(pklInfo.ID_PKL_2);
                            if (pklInfo.ID_PKL_3) pklHistory.push(pklInfo.ID_PKL_3);
                        }

                        return {
                            ...s,
                            pkl: pklInfo,
                            location: location,
                            currentIdPkl: currentIdPkl,
                            pklHistory: pklHistory,
                            evaluation: evaluation,
                            judul: judul,
                            guru: {
                                name: guruMaster ? guruMaster.NamaGuru : (pklInfo ? 'Guru Tidak Ditemukan' : '-'),
                                contact: guruLogin ? guruLogin.kontak : '-'
                            },
                            startDate: pklInfo ? pklInfo.StartDate : '-',
                            endDate: pklInfo ? pklInfo.EndDate : '-'
                        };
                    });

                    renderStudents(window.combinedStudentData);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem;">Tidak ada data.</td></tr>';
                }
            } catch (err) {
                console.error('Error loading students:', err);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: var(--danger); padding: 2rem;">Gagal memuat data.</td></tr>';
            }
        }

        function renderStudents(data) {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 3rem; color: var(--text-muted); opacity: 0.5;">Belum ada data siswa yang tersedia.</td></tr>';
                return;
            }
            data.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Siswa">
                        <div style="font-weight: 700; color: #fff; font-size: 0.95rem;">${s.nama}</div>
                        <div style="font-size: 0.75rem; color: var(--electric-blue); font-weight: 600; letter-spacing: 0.05em;">NIS: ${s.nis}</div>
                    </td>
                    <td data-label="Kelas">
                        <div style="font-weight: 600; color: var(--text-main);">${s.kelas}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); opacity: 0.8;">${s.jurusan}</div>
                    </td>
                    <td data-label="Aksi" style="text-align: right; padding-right: 1rem;">
                        <div class="table-actions" style="justify-content: flex-end;">
                            <button class="action-btn view" onclick="openViewStudent('${s.nis}')" title="Lihat Detail"><i class="fas fa-eye"></i></button>
                            <button class="action-btn edit" onclick="openEditStudent('${s.nis}')" title="Edit Data"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" onclick="deleteStudent('${s.nis}')" title="Hapus Data"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterStudents(query) {
            if (!window.combinedStudentData) return;
            const q = query.toLowerCase();
            const filtered = window.combinedStudentData.filter(s =>
                s.nis.toString().includes(q) ||
                s.nama.toLowerCase().includes(q)
            );
            renderStudents(filtered);
        }

        async function openViewStudent(nis) {
            try {
                console.log('Attempting to view student NIS:', nis);
                if (!window.combinedStudentData) {
                    console.error('window.combinedStudentData is not initialized');
                    return;
                }
                const s = window.combinedStudentData.find(item => item.nis == nis);
                if (!s) {
                    console.error('Student not found for NIS:', nis);
                    return;
                }

                const content = document.getElementById('viewStudentContent');
                if (!content) {
                    console.error('viewStudentContent element not found');
                    return;
                }

                const sectionStyle = "margin-bottom: 2rem; background: #f8fafc; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #e2e8f0;";
                const headerStyle = "font-weight: bold; font-size: 1.1rem; color: var(--primary); margin-bottom: 1rem; border-bottom: 2px solid #cbd5e1; padding-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;";
                const gridStyle = "display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.9rem;";

                const formatDateSafe = (d) => {
                    try { return formatDate(d); } catch (e) { return '-'; }
                };
                const formatWASafe = (p) => {
                    try { return formatWhatsApp(p); } catch (e) { return '-'; }
                };

                content.innerHTML = `
                    <div style="${sectionStyle}">
                        <div style="${headerStyle}"><i class="fas fa-id-card"></i> Data Siswa</div>
                        <div style="${gridStyle}">
                            <div><strong style="color:var(--text-muted)">NIS:</strong><br>${s.nis || '-'}</div>
                            <div><strong style="color:var(--text-muted)">Nama Lengkap:</strong><br>${s.nama || '-'}</div>
                            <div><strong style="color:var(--text-muted)">NIK:</strong><br>${s.NIK || '-'}</div>
                            <div><strong style="color:var(--text-muted)">Jurusan:</strong><br>${s.jurusan || '-'}</div>
                            <div><strong style="color:var(--text-muted)">Kelas:</strong><br>${s.kelas || '-'}</div>
                            <div><strong style="color:var(--text-muted)">Tempat, Tgl Lahir:</strong><br>${s.TempatLahir || '-'}, ${formatDateSafe(s.TanggalLahir)}</div>
                            <div><strong style="color:var(--text-muted)">Gol. Darah:</strong><br>${s.GolDarah || '-'}</div>
                            <div><strong style="color:var(--text-muted)">Kontak Siswa:</strong><br>${formatWASafe(s.KontakSiswa)}</div>
                            <div><strong style="color:var(--text-muted)">Nama Orang Tua:</strong><br>${s.NamaOrangtua || '-'}</div>
                            <div><strong style="color:var(--text-muted)">Kontak Orang Tua:</strong><br>${formatWASafe(s.KontakOrangtua)}</div>
                        </div>
                    </div>

                    <div style="${sectionStyle}">
                        <div style="${headerStyle}"><i class="fas fa-building"></i> Data Tempat PKL Saat Ini</div>
                        <div style="${gridStyle}">
                            <div style="grid-column: span 2;"><strong style="color:var(--text-muted)">Nama Tempat:</strong><br>${s.location ? s.location.NamaTempat : 'Belum Ditentukan'}</div>
                            <div style="grid-column: span 2;"><strong style="color:var(--text-muted)">Alamat:</strong><br>${s.location ? s.location.Alamat : '-'}</div>
                            <div><strong style="color:var(--text-muted)">Nama Pimpinan:</strong><br>${s.location ? s.location.NamaPimpinan : '-'}</div>
                            <div><strong style="color:var(--text-muted)">Mulai PKL:</strong><br>${formatDateSafe(s.startDate)}</div>
                            <div><strong style="color:var(--text-muted)">Selesai PKL:</strong><br>${formatDateSafe(s.endDate)}</div>
                        </div>
                        
                        ${s.pklHistory && s.pklHistory.length > 1 ? `
                        <div style="margin-top: 1.5rem; border-top: 1px dashed #cbd5e1; padding-top: 1rem;">
                            <strong style="color:var(--primary); font-size: 0.85rem; display: block; margin-bottom: 0.5rem;">Riwayat Penempatan:</strong>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.85rem;">
                                ${s.pklHistory.map((id, idx) => {
                    const loc = window.locationData ? window.locationData.find(l => l.ID_PKL == id) : null;
                    return `<div style="display: flex; gap: 0.5rem; align-items: baseline;">
                                        <span style="color: var(--text-muted)">${idx + 1}.</span>
                                        <span>${loc ? loc.NamaTempat : id} ${idx === s.pklHistory.length - 1 ? '<span class="badge badge-success" style="font-size: 0.65rem; padding: 0.1rem 0.4rem;">Aktif</span>' : ''}</span>
                                    </div>`;
                }).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>

                    <div style="${sectionStyle}">
                        <div style="${headerStyle}"><i class="fas fa-user-tie"></i> Data Pembimbing</div>
                        <div style="${gridStyle}">
                            <div><strong style="color:var(--text-muted)">Nama Mentor DUDI:</strong><br>${s.location ? s.location.NamaMentor : '-'}</div>
                            <div><strong style="color:var(--text-muted)">Kontak Mentor:</strong><br>${formatWASafe(s.location ? s.location.KontakMentor : '-')}</div>
                            <div><strong style="color:var(--text-muted)">Guru Pembimbing:</strong><br>${s.guru ? s.guru.name : '-'}</div>
                            <div><strong style="color:var(--text-muted)">Kontak Guru:</strong><br>${formatWASafe(s.guru ? s.guru.contact : '-')}</div>
                        </div>
                    </div>

                    <div style="${sectionStyle}">
                        <div style="${headerStyle}"><i class="fas fa-file-alt"></i> Judul Ajuan Laporan</div>
                        <div style="${gridStyle}">
                            <div style="grid-column: span 2;"><strong style="color:var(--text-muted)">Judul Laporan:</strong><br>${s.judul ? s.judul.JudulAjuan : '<span style="color:#ef4444; font-style:italic;">Belum mengajukan judul</span>'}</div>
                            <div><strong style="color:var(--text-muted)">Status:</strong><br><span class="badge ${s.judul && s.judul.status === 'Disetujui' ? 'badge-success' : 'badge-warning'}">${s.judul ? s.judul.status : '-'}</span></div>
                            <div><strong style="color:var(--text-muted)">Feedback:</strong><br>${s.judul ? s.judul.feedback : '-'}</div>
                        </div>
                    </div>

                    <div style="${sectionStyle}">
                        <div style="${headerStyle}"><i class="fas fa-star"></i> Nilai dari DUDI</div>
                        <div style="margin-bottom: 1rem;">
                            <span style="font-weight: 600; font-size: 0.85rem; color: var(--primary); text-transform: uppercase;">1. Penilaian Kompetensi</span>
                            <div style="${gridStyle}; margin-top: 0.5rem;">
                                <div><strong style="color:var(--text-muted)">Softskill:</strong><br>${s.evaluation ? s.evaluation.score_softskill : '-'}</div>
                                <div><strong style="color:var(--text-muted)">POS & K3LH:</strong><br>${s.evaluation ? s.evaluation.score_pos : '-'}</div>
                                <div><strong style="color:var(--text-muted)">Teknis:</strong><br>${s.evaluation ? s.evaluation.score_technical : '-'}</div>
                                <div><strong style="color:var(--text-muted)">Alur Bisnis:</strong><br>${s.evaluation ? s.evaluation.score_bisnisdudi : '-'}</div>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <span style="font-weight: 600; font-size: 0.85rem; color: var(--primary); text-transform: uppercase;">2. Penilaian Sikap</span>
                            <div style="${gridStyle}; margin-top: 0.5rem;">
                                <div><strong style="color:var(--text-muted)">Kedisiplinan:</strong><br>${s.evaluation ? s.evaluation.kedisplinan : '-'}</div>
                                <div><strong style="color:var(--text-muted)">Kerjasama:</strong><br>${s.evaluation ? s.evaluation.kerjasama : '-'}</div>
                                <div><strong style="color:var(--text-muted)">Inisiatif:</strong><br>${s.evaluation ? s.evaluation.inisiatif : '-'}</div>
                                <div><strong style="color:var(--text-muted)">Kerajinan:</strong><br>${s.evaluation ? s.evaluation.kerajinan : '-'}</div>
                                <div><strong style="color:var(--text-muted)">Tanggung Jawab:</strong><br>${s.evaluation ? s.evaluation.TanggungJawab : '-'}</div>
                            </div>
                        </div>
                        <div style="border-top: 1px dashed #cbd5e1; padding-top: 1rem; margin-top: 1rem;">
                            <div style="${gridStyle}">
                                <div style="grid-column: span 2;"><strong style="color:var(--text-muted)">Catatan Mentor:</strong><br>${s.evaluation ? s.evaluation.catatan : '-'}</div>
                                <div><strong style="color:var(--text-muted)">Absensi (S/I/A):</strong><br>${s.evaluation ? s.evaluation.sakit : 0} / ${s.evaluation ? s.evaluation.ijin : 0} / ${s.evaluation ? s.evaluation.alpa : 0}</div>
                            </div>
                        </div>
                    </div>
                `;
                toggleViewStudentModal(true);
            } catch (err) {
                console.error('Fatal error in openViewStudent:', err);
                alert('Gagal menampilkan detail siswa: ' + err.message);
            }
        }

        function toggleViewStudentModal(show) {
            const modal = document.getElementById('viewStudentModal');
            if (show) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            } else {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }

        async function openEditStudent(nis) {
            const s = window.combinedStudentData.find(item => item.nis == nis);
            if (!s) return;

            await Promise.all([
                loadJurusanOptions('stuJurusan'),
                loadPklOptions('stuIdPkl'),
                loadGuruOptions('stuIdGuru')
            ]);

            document.getElementById('studentModalTitle').textContent = 'Edit Data Siswa & PKL';
            document.getElementById('stuOriginalId').value = s.nis;
            document.getElementById('stuNis').value = s.nis;
            document.getElementById('stuNama').value = s.nama;
            document.getElementById('stuNik').value = s.NIK || '';
            document.getElementById('stuJurusan').value = s.jurusan;
            document.getElementById('stuKelas').value = s.kelas;
            document.getElementById('stuTempatLahir').value = s.TempatLahir || '';
            try {
                document.getElementById('stuTanggalLahir').value = s.TanggalLahir ? new Date(s.TanggalLahir).toISOString().split('T')[0] : '';
            } catch (e) {
                document.getElementById('stuTanggalLahir').value = '';
            }
            document.getElementById('stuGolDarah').value = s.GolDarah || '';
            document.getElementById('stuKontak').value = s.KontakSiswa || '';
            document.getElementById('stuNamaOrangtua').value = s.NamaOrangtua || '';
            document.getElementById('stuKontakOrangtua').value = s.KontakOrangtua || '';

            // PKL Info
            document.getElementById('stuIdPkl').value = s.currentIdPkl || '';
            document.getElementById('stuIdGuru').value = s.pkl ? s.pkl.ID_GURU : '';
            document.getElementById('stuStartDate').value = s.startDate || '';
            document.getElementById('stuEndDate').value = s.endDate || '';

            toggleAddStudentModal(true);
        }

        async function deleteStudent(nis) {
            if (!confirm('Apakah Anda yakin ingin menghapus data siswa ini?')) return;
            try {
                // Delete from both sheets
                await API.deleteData('DATAPKL', nis);
                const res = await API.deleteData('DATASISWA', nis);

                if (res.status === 'success') {
                    showToast('Data siswa berhasil dihapus!');
                    loadStudents();
                } else {
                    showToast('Gagal menghapus: ' + (res.message || res.error), 'danger');
                }
            } catch (err) {
                showToast('Kesalahan jaringan.', 'danger');
            }
        }

        async function openViewLocation(idParam) {
            const l = window.locationData.find(item => {
                const idStr = (item.ID_PKL || item.id_pkl || "").toString();
                return idStr === idParam.toString();
            });
            if (!l) return alert('Data lokasi tidak ditemukan.');

            const content = document.getElementById('viewLocationContent');
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="detail-item">
                        <label style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">Status</label>
                        <span class="badge ${l.Status === 'Aktif' ? 'badge-success' : 'badge-warning'}">${l.Status || 'Aktif'}</span>
                    </div>
                    <div></div> <!-- Empty for spacing -->
                    <div class="detail-item" style="grid-column: span 2;">
                        <label style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">Nama Tempat / Perusahaan</label>
                        <div style="font-weight: 600; font-size: 1.1rem;">${l.NamaTempat}</div>
                    </div>
                    <div class="detail-item">
                        <label style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">Pimpinan</label>
                        <div><i class="fas fa-user-tie" style="margin-right: 0.5rem; color: var(--primary);"></i>${l.NamaPimpinan || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <label style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">Bidang Usaha</label>
                        <div><i class="fas fa-briefcase" style="margin-right: 0.5rem; color: var(--primary);"></i>${l.BidangUsaha || '-'}</div>
                    </div>
                    <div class="detail-item" style="grid-column: span 2;">
                        <label style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">Alamat</label>
                        <div><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem; color: var(--primary);"></i>${l.Alamat}</div>
                    </div>
                    <div class="detail-item">
                        <label style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">Jurusan</label>
                        <div><i class="fas fa-graduation-cap" style="margin-right: 0.5rem; color: var(--primary);"></i>${l.Jurusan || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <label style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">Mentor (DUDI)</label>
                        <div><i class="fas fa-user" style="margin-right: 0.5rem; color: var(--primary);"></i>${l.NamaMentor}</div>
                    </div>
                    <div class="detail-item">
                        <label style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">Kontak Mentor</label>
                        <div><i class="fab fa-whatsapp" style="margin-right: 0.5rem; color: #25D366;"></i>${formatWhatsApp(l.KontakMentor)}</div>
                    </div>
                    <div class="detail-item">
                        <label style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">Email Industri</label>
                        <div style="font-size: 0.85rem;"><i class="fas fa-envelope" style="margin-right: 0.5rem; color: #ef4444;"></i>${l.Email || '-'}</div>
                    </div>
                    <div class="detail-item" style="grid-column: span 2;">
                        <label style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">Deskripsi Lokasi</label>
                        <div><i class="fas fa-info-circle" style="margin-right: 0.5rem; color: var(--primary);"></i>${l.description || '-'}</div>
                    </div>
                </div>
                ${(l.LAT && l.LNG) ? `
                    <div style="grid-column: span 2; margin-top: 1rem;">
                        <label style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-bottom: 0.5rem;">Lokasi Presisi</label>
                        <div id="viewMap" style="height: 250px; width: 100%; border-radius: 0.75rem; border: 1px solid #e2e8f0; box-shadow: var(--shadow);"></div>
                    </div>
                ` : ''}
            `;

            const modal = document.getElementById('viewLocationModal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';

            if (l.LAT && l.LNG) {
                setTimeout(() => {
                    const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap'
                    });
                    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EBP, and the GIS User Community'
                    });

                    const vMap = L.map('viewMap', {
                        center: [l.LAT, l.LNG],
                        zoom: 15,
                        layers: [streetLayer]
                    });

                    const baseMaps = {
                        "Jalan": streetLayer,
                        "Satelit": satelliteLayer
                    };

                    L.control.layers(baseMaps).addTo(vMap);
                    L.marker([l.LAT, l.LNG]).addTo(vMap);
                }, 100);
            }
        }

        async function openEditLocation(idParam) {
            const l = window.locationData.find(item => {
                const idStr = (item.ID_PKL || item.id_pkl || "").toString();
                return idStr === idParam.toString();
            });
            if (!l) return alert('Data lokasi tidak ditemukan.');

            // Load jurusan list first
            await loadJurusanOptions('locJurusan');

            document.getElementById('locationModalTitle').textContent = 'Edit Lokasi PKL';
            document.getElementById('locOriginalId').value = l.ID_PKL;
            document.getElementById('locIdPkl').value = l.ID_PKL;
            document.getElementById('locNamaTempat').value = l.NamaTempat;
            document.getElementById('locNamaPimpinan').value = l.NamaPimpinan || '';
            document.getElementById('locAlamat').value = l.Alamat;
            document.getElementById('locJurusan').value = l.Jurusan || '';
            document.getElementById('locNamaMentor').value = l.NamaMentor;
            document.getElementById('locBidangUsaha').value = l.BidangUsaha || '';
            document.getElementById('locEmail').value = l.Email || '';
            document.getElementById('locDescription').value = l.description || '';

            if (l.KontakMentor) {
                let val = l.KontakMentor.toString();
                if (val.startsWith('+62')) val = val.substring(3);
                document.getElementById('locKontakMentor').value = val;
            } else {
                document.getElementById('locKontakMentor').value = '';
            }

            // Set coordinates
            if (l.LAT && l.LNG) {
                document.getElementById('locLat').value = l.LAT;
                document.getElementById('locLng').value = l.LNG;
                document.getElementById('coordsDisplay').textContent = `Terpilih: ${l.LAT}, ${l.LNG}`;
                // Set marker will happen after modal is shown and map is init
                setTimeout(() => {
                    initLocationMap();
                    setMarker(l.LAT, l.LNG);
                }, 200);
            } else {
                document.getElementById('locLat').value = '';
                document.getElementById('locLng').value = '';
                document.getElementById('coordsDisplay').textContent = 'Belum ada koordinat';
            }

            toggleAddLocationModal(true);
        }

        async function deleteLocation(idPkl) {
            if (!confirm('Apakah Anda yakin ingin menghapus lokasi PKL ini?')) return;

            try {
                const res = await API.deleteData('LOKASIPKL', idPkl);
                if (res.status === 'success') {
                    showToast('Lokasi berhasil dihapus!');
                    loadLocations();
                } else {
                    showToast('Gagal menghapus: ' + (res.message || res.error), 'danger');
                }
            } catch (err) {
                showToast('Kesalahan jaringan: ' + err.message, 'danger');
            }
        }

        function toggleAddUserModal(show) {
            const modal = document.getElementById('addUserModal');
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('active'), 10);

                // Reset title and fields if not in Edit mode
                const title = document.getElementById('userModalTitle');
                if (title && title.textContent.trim() !== 'Edit Akun Pengguna') {
                    title.textContent = 'Tambah Akun Baru';
                    adjustFormFields();
                }
            } else {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.getElementById('addUserForm').reset();
                    document.getElementById('userModalTitle').textContent = 'Tambah Akun Baru';
                    document.getElementById('userOriginalUsername').value = '';
                }, 300);
            }
        }

        function toggleAddLocationModal(show) {
            const modal = document.getElementById('addLocationModal');
            if (show) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';

                const title = document.getElementById('locationModalTitle').textContent;
                if (title === 'Tambah Lokasi PKL Baru') {
                    loadJurusanOptions('locJurusan');
                    // Auto-generate ID_PKL
                    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                    let mid = 'LOK-';
                    for (let i = 0; i < 5; i++) mid += chars.charAt(Math.floor(Math.random() * chars.length));
                    document.getElementById('locIdPkl').value = mid;

                    // Reset coordinates
                    document.getElementById('locLat').value = '';
                    document.getElementById('locLng').value = '';
                    document.getElementById('coordsDisplay').textContent = 'Klik pada peta untuk mengambil koordinat';
                }

                // Initialize/Refresh Map
                setTimeout(() => initLocationMap(), 100);
            } else {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                document.getElementById('addLocationForm').reset();
                document.getElementById('locationModalTitle').textContent = 'Tambah Lokasi PKL Baru';
                document.getElementById('locOriginalId').value = '';
                if (locMarker) {
                    locMap.removeLayer(locMarker);
                    locMarker = null;
                }
            }
        }

        function initLocationMap() {
            if (!locMap) {
                const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                });

                const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19,
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EBP, and the GIS User Community'
                });

                locMap = L.map('locationMap', {
                    center: [-7.9666, 112.6326],
                    zoom: 13,
                    layers: [streetLayer]
                });

                const baseMaps = {
                    "Jalan": streetLayer,
                    "Satelit": satelliteLayer
                };

                L.control.layers(baseMaps).addTo(locMap);

                locMap.on('click', function (e) {
                    const lat = e.latlng.lat.toFixed(7);
                    const lng = e.latlng.lng.toFixed(7);
                    setMarker(lat, lng);
                });
            } else {
                locMap.invalidateSize();
            }
        }

        function setMarker(lat, lng) {
            if (locMarker) locMap.removeLayer(locMarker);
            locMarker = L.marker([lat, lng]).addTo(locMap);
            document.getElementById('locLat').value = lat;
            document.getElementById('locLng').value = lng;
            document.getElementById('coordsDisplay').textContent = `Terpilih: ${lat}, ${lng}`;
            locMap.panTo([lat, lng]);
        }

        async function searchAddress(silent = false) {
            const query = document.getElementById('mapSearchInput').value;
            if (!query) return;

            const btn = document.querySelector('button[onclick="searchAddress()"]');
            const originalIcon = btn ? btn.innerHTML : '';
            if (btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await res.json();
                if (data && data.length > 0) {
                    const { lat, lon } = data[0];
                    locMap.setView([lat, lon], 15);
                    setMarker(lat, lon);
                } else {
                    if (!silent) alert('Lokasi tidak ditemukan.');
                }
            } catch (e) {
                console.error('Search error:', e);
                if (!silent) alert('Gagal mencari lokasi. Periksa koneksi internet Anda.');
            } finally {
                if (btn) btn.innerHTML = originalIcon;
            }
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                return alert('Geolokasi tidak didukung oleh browser Anda.');
            }

            const btn = event.currentTarget;
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude.toFixed(7);
                    const lng = position.coords.longitude.toFixed(7);
                    locMap.setView([lat, lng], 17);
                    setMarker(lat, lng);
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    alert('Gagal mendapatkan lokasi. Pastikan izin lokasi aktif.');
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                },
                { enableHighAccuracy: true }
            );
        }

        function toggleAddStudentModal(show) {
            const modal = document.getElementById('addStudentModal');
            if (show) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                if (document.getElementById('studentModalTitle').textContent === 'Tambah Data Siswa Baru') {
                    loadJurusanOptions('stuJurusan');
                    loadPklOptions('stuIdPkl');
                    loadGuruOptions('stuIdGuru');
                }
            } else {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                document.getElementById('addStudentForm').reset();
                document.getElementById('studentModalTitle').textContent = 'Tambah Data Siswa Baru';
                document.getElementById('stuOriginalId').value = '';
                document.getElementById('stuStartDate').value = '';
                document.getElementById('stuEndDate').value = '';
            }
        }

        async function adjustFormFields() {
            const role = document.getElementById('newRole').value;
            const dynamicFields = document.getElementById('dynamicFields');
            dynamicFields.innerHTML = ''; // Start fresh

            const createField = (label, id, type = 'text', readOnly = false, placeholder = '', value = '') => {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `<label>${label}</label>`;
                if (type === 'select') {
                    const sel = document.createElement('select');
                    sel.id = id;
                    sel.required = true;
                    div.appendChild(sel);
                } else {
                    const input = document.createElement('input');
                    input.type = type;
                    input.id = id;
                    input.required = true;
                    input.readOnly = readOnly;
                    input.placeholder = placeholder;
                    input.value = value;
                    div.appendChild(input);
                }
                return div;
            };

            const createKontakField = (label, id) => {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label>${label}</label>
                    <div style="display:flex; align-items:center;">
                        <span style="background:#eee; padding:0.75rem; border:1px solid #e2e8f0; border-right:none; border-radius:0.5rem 0 0 0.5rem;">+62</span>
                        <input type="text" id="${id}" style="border-radius:0 0.5rem 0.5rem 0;" placeholder="8123456789" oninput="this.value = this.value.replace(/^0/, '')">
                    </div>
                `;
                return div;
            };

            if (role === 'siswa') {
                dynamicFields.appendChild(createField('NIS (dari Data Siswa)', 'newNis', 'select'));
                dynamicFields.appendChild(createField('Username (NIS)', 'newUsername', 'text', false));
                dynamicFields.appendChild(createField('Password', 'newPassword', 'password'));
                dynamicFields.appendChild(createField('Nama Lengkap', 'newNama', 'text', true, 'Akan terisi otomatis'));

                // Fetch DATASISWA
                try {
                    const res = await API.getData('DATASISWA');
                    const nisSelect = document.getElementById('newNis');
                    nisSelect.innerHTML = '<option value="">Pilih NIS</option>';
                    if (res.data) {
                        res.data.forEach(s => {
                            const opt = document.createElement('option');
                            opt.value = s.nis;
                            opt.textContent = `${s.nis} - ${s.nama}`;
                            opt.dataset.nama = s.nama;
                            nisSelect.appendChild(opt);
                        });
                        nisSelect.addEventListener('change', (e) => {
                            const opt = e.target.options[e.target.selectedIndex];
                            if (e.target.value) {
                                document.getElementById('newUsername').value = e.target.value;
                                document.getElementById('newPassword').value = e.target.value;
                                document.getElementById('newNama').value = opt.dataset.nama || '';
                            }
                        });
                    }
                } catch (e) { console.error(e); }

            } else if (role === 'mentor') {
                dynamicFields.appendChild(createField('Tempat PKL', 'newID_PKL', 'select'));
                dynamicFields.appendChild(createField('Username', 'newUsername', 'text', false, 'Otomatis'));
                dynamicFields.appendChild(createField('Password', 'newPassword', 'password'));
                dynamicFields.appendChild(createField('Nama Lengkap (Mentor)', 'newNama', 'text', true, 'Dari Lokasi PKL'));
                dynamicFields.appendChild(createKontakField('Kontak (Auto-fill)', 'newKontak'));

                try {
                    const res = await API.getData('LOKASIPKL');
                    const pklSelect = document.getElementById('newID_PKL');
                    pklSelect.innerHTML = '<option value="">Pilih Tempat PKL</option>';
                    if (res.data) {
                        res.data.forEach(l => {
                            const opt = document.createElement('option');
                            opt.value = l.ID_PKL;
                            opt.textContent = l.NamaTempat;
                            opt.dataset.namaMentor = l.NamaMentor || '';
                            opt.dataset.kontakMentor = l.KontakMentor || '';
                            pklSelect.appendChild(opt);
                        });
                        pklSelect.addEventListener('change', (e) => {
                            const opt = e.target.options[e.target.selectedIndex];
                            if (e.target.value) {
                                if (!document.getElementById('newUsername').value) {
                                    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                                    let sid = '';
                                    for (let i = 0; i < 5; i++) sid += chars.charAt(Math.floor(Math.random() * chars.length));
                                    document.getElementById('newUsername').value = sid;
                                }
                                document.getElementById('newPassword').value = 'Mentor123';
                                document.getElementById('newNama').value = opt.dataset.namaMentor || '-';
                                // Kontak auto-fill
                                let raw = opt.dataset.kontakMentor || '';
                                if (raw) {
                                    let clean = raw.replace(/\D/g, '');
                                    if (clean.startsWith('62')) clean = clean.substring(2);
                                    if (clean.startsWith('0')) clean = clean.substring(1);
                                    document.getElementById('newKontak').value = clean;
                                }
                            }
                        });
                    }
                } catch (e) { console.error(e); }

            } else {
                // Admin, Guru, KaKomli
                if (role === 'guru' || role === 'kakomli') {
                    dynamicFields.appendChild(createField('Nama Lengkap', 'newNama', 'select'));
                } else {
                    dynamicFields.appendChild(createField('Nama Lengkap', 'newNama', 'text'));
                }
                dynamicFields.appendChild(createField('Username', 'newUsername', 'text'));
                dynamicFields.appendChild(createField('Password', 'newPassword', 'password'));
                dynamicFields.appendChild(createField('NIP', 'newNip', 'text'));
                dynamicFields.appendChild(createKontakField('Kontak', 'newKontak'));

                if (role === 'kakomli') {
                    dynamicFields.appendChild(createField('Jurusan', 'newJurusan', 'select'));
                    loadJurusanOptions('newJurusan');
                }

                if (role === 'guru' || role === 'kakomli') {
                    const defaultPass = role === 'guru' ? 'Pembimbing123' : 'Kakomli123';
                    try {
                        const res = await API.getData('DATAGURU');
                        const nameSelect = document.getElementById('newNama');
                        nameSelect.innerHTML = '<option value="">Pilih Nama</option>';
                        if (res.data) {
                            res.data.forEach(g => {
                                const opt = document.createElement('option');
                                opt.value = g.NamaGuru;
                                opt.textContent = g.NamaGuru;
                                opt.dataset.idGuru = g.ID_GURU;
                                nameSelect.appendChild(opt);
                            });
                            nameSelect.addEventListener('change', (e) => {
                                const opt = e.target.options[e.target.selectedIndex];
                                if (e.target.value) {
                                    document.getElementById('newUsername').value = opt.dataset.idGuru;
                                    document.getElementById('newNip').value = opt.dataset.idGuru;
                                    document.getElementById('newPassword').value = defaultPass;
                                }
                            });
                        }
                    } catch (e) { console.error(e); }
                }
            }
        }

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSaveUser');
            const originalUsername = document.getElementById('userOriginalUsername').value;
            const isEdit = !!originalUsername;

            btn.disabled = true;
            btn.textContent = 'Menyimpan...';

            const role = document.getElementById('newRole').value;
            const tabMap = { admin: 'LOGINADMIN', guru: 'LOGINGURU', kakomli: 'LOGINKAKOMLI', mentor: 'LOGINMENTOR', siswa: 'LOGINSISWA' };

            let rawKontak = document.getElementById('newKontak') ? document.getElementById('newKontak').value : '';
            let finalKontak = rawKontak ? '+62' + rawKontak.replace(/^0/, '') : '';

            const data = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                nama: document.getElementById('newNama').value,
                kontak: finalKontak
            };

            if (document.getElementById('newNip')) data.nip = document.getElementById('newNip').value;
            if (document.getElementById('newJurusan')) data.jurusan = document.getElementById('newJurusan').value;
            if (document.getElementById('newID_PKL')) data.ID_PKL = document.getElementById('newID_PKL').value;
            if (document.getElementById('newNis')) data.nis = document.getElementById('newNis').value;

            try {
                let res;
                if (isEdit) {
                    res = await API.updateData(tabMap[role], originalUsername, data);
                } else {
                    res = await API.postData(tabMap[role], data);
                }

                if (res.status === 'success') {
                    showToast(isEdit ? 'Akun berhasil diperbarui!' : 'Akun berhasil ditambahkan!');
                    toggleAddUserModal(false);
                    loadUsers();
                } else {
                    showToast('Gagal: ' + (res.message || res.error), 'danger');
                }
            } catch (err) {
                alert('Terjadi kesalahan storage.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Simpan Akun';
            }
        });

        document.getElementById('addLocationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSaveLocation');
            const originalId = document.getElementById('locOriginalId').value;
            const isEdit = !!originalId;

            btn.disabled = true;
            btn.textContent = 'Menyimpan...';

            const data = {
                ID_PKL: document.getElementById('locIdPkl').value,
                NamaTempat: document.getElementById('locNamaTempat').value,
                NamaPimpinan: document.getElementById('locNamaPimpinan').value,
                Alamat: document.getElementById('locAlamat').value,
                Jurusan: document.getElementById('locJurusan').value,
                BidangUsaha: document.getElementById('locBidangUsaha').value,
                NamaMentor: document.getElementById('locNamaMentor').value,
                KontakMentor: document.getElementById('locKontakMentor').value ? '+62' + document.getElementById('locKontakMentor').value.replace(/^0/, '') : '',
                Email: document.getElementById('locEmail').value,
                description: document.getElementById('locDescription').value,
                LAT: document.getElementById('locLat').value,
                LNG: document.getElementById('locLng').value
            };

            try {
                let res;
                if (isEdit) {
                    res = await API.updateData('LOKASIPKL', originalId, data);
                } else {
                    res = await API.postData('LOKASIPKL', data);
                }

                if (res.status === 'success') {
                    showToast(isEdit ? 'Lokasi berhasil diperbarui!' : 'Lokasi PKL berhasil ditambahkan!');
                    toggleAddLocationModal(false);
                    loadLocations();
                } else {
                    showToast('Gagal: ' + (res.message || res.error), 'danger');
                }
            } catch (err) {
                alert('Terjadi kesalahan storage: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Simpan Lokasi';
            }
        });

        document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSaveStudent');
            const originalId = document.getElementById('stuOriginalId').value;
            const isEdit = !!originalId;

            btn.disabled = true;
            btn.textContent = 'Menyimpan...';

            const stuData = {
                nis: document.getElementById('stuNis').value,
                nama: document.getElementById('stuNama').value,
                NIK: document.getElementById('stuNik').value,
                jurusan: document.getElementById('stuJurusan').value,
                kelas: document.getElementById('stuKelas').value,
                TempatLahir: document.getElementById('stuTempatLahir').value,
                TanggalLahir: document.getElementById('stuTanggalLahir').value,
                GolDarah: document.getElementById('stuGolDarah').value,
                KontakSiswa: document.getElementById('stuKontak').value,
                NamaOrangtua: document.getElementById('stuNamaOrangtua').value,
                KontakOrangtua: document.getElementById('stuKontakOrangtua').value
            };

            // NIK Validation
            if (stuData.NIK && (stuData.NIK.length !== 16 || isNaN(stuData.NIK))) {
                showToast('NIK harus terdiri dari 16 digit angka.', 'warning');
                btn.disabled = false;
                btn.textContent = 'Simpan Data';
                return;
            }

            const pklData = {
                nis: stuData.nis,
                ID_PKL: document.getElementById('stuIdPkl').value,
                ID_GURU: document.getElementById('stuIdGuru').value,
                ID_Jurusan: stuData.jurusan,
                StartDate: document.getElementById('stuStartDate').value,
                EndDate: document.getElementById('stuEndDate').value
            };

            try {
                let res;
                if (isEdit) {
                    res = await API.updateData('DATASISWA', originalId, stuData);
                    const pklCheck = await API.getData('DATAPKL');
                    const existingPkl = pklCheck.data ? pklCheck.data.find(p => p.nis == originalId) : null;
                    if (existingPkl) {
                        await API.updateData('DATAPKL', originalId, pklData);
                    } else {
                        await API.postData('DATAPKL', pklData);
                    }
                } else {
                    res = await API.postData('DATASISWA', stuData);
                    if (pklData.ID_PKL || pklData.ID_GURU) {
                        await API.postData('DATAPKL', pklData);
                    }
                }

                if (res.status === 'success') {
                    alert(isEdit ? 'Data siswa & PKL berhasil diperbarui!' : 'Data siswa & PKL berhasil ditambahkan!');
                    toggleAddStudentModal(false);
                    loadStudents();
                } else {
                    showToast('Gagal: ' + (res.message || res.error), 'danger');
                }
            } catch (err) {
                console.error('Save Student Error:', err);
                alert('Terjadi kesalahan storage.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Simpan Data';
            }
        });

        // --- Data Operations (Export/Import) ---
        function exportToExcel() {
            if (!window.combinedStudentData) return alert('Data belum dimuat.');
            const data = window.combinedStudentData.map(s => ({
                // Data Siswa
                'NIS': s.nis,
                'Nama Lengkap': s.nama,
                'Jurusan': s.jurusan,
                'Kelas': s.kelas,
                'Tempat Lahir': s.TempatLahir || '-',
                'Tanggal Lahir': formatDate(s.TanggalLahir),
                'Gol. Darah': s.GolDarah || '-',
                'Kontak Siswa': s.KontakSiswa || '-',
                'Nama Orang Tua': s.NamaOrangtua || '-',
                'Kontak Orang Tua': s.KontakOrangtua || '-',

                // Data PKL
                'Tempat PKL': s.location ? s.location.NamaTempat : '-',
                'Alamat PKL': s.location ? s.location.Alamat : '-',
                'Mulai PKL': formatDate(s.startDate),
                'Selesai PKL': formatDate(s.endDate),
                'Pimpinan': s.location ? s.location.NamaPimpinan : '-',
                'Bidang Usaha': s.location ? s.location.BidangUsaha : '-',

                // Data Pembimbing
                'Mentor DUDI': s.location ? s.location.NamaMentor : '-',
                'Kontak Mentor': s.location ? s.location.KontakMentor : '-',
                'Guru Pembimbing': s.guru ? s.guru.name : '-',
                'Kontak Guru': s.guru ? s.guru.contact : '-',

                // Judul Laporan
                'Judul Laporan': s.judul ? s.judul.JudulAjuan : '-',
                'Status Laporan': s.judul ? s.judul.status : '-',
                'Feedback Laporan': s.judul ? s.judul.feedback : '-',

                // Penilaian Kompetensi
                'Softskill (Kompetensi)': s.evaluation ? s.evaluation.score_softskill : '-',
                'POS & K3LH (Kompetensi)': s.evaluation ? s.evaluation.score_pos : '-',
                'Teknis (Kompetensi)': s.evaluation ? s.evaluation.score_technical : '-',
                'Alur Bisnis (Kompetensi)': s.evaluation ? s.evaluation.score_bisnisdudi : '-',

                // Penilaian Sikap
                'Kedisiplinan (Sikap)': s.evaluation ? s.evaluation.kedisplinan : '-',
                'Kerjasama (Sikap)': s.evaluation ? s.evaluation.kerjasama : '-',
                'Inisiatif (Sikap)': s.evaluation ? s.evaluation.inisiatif : '-',
                'Kerajinan (Sikap)': s.evaluation ? s.evaluation.kerajinan : '-',
                'Tanggung Jawab (Sikap)': s.evaluation ? s.evaluation.TanggungJawab : '-',

                // Lainnya
                'Catatan Mentor': s.evaluation ? s.evaluation.catatan : '-',
                'Sakit': s.evaluation ? (s.evaluation.sakit || 0) : 0,
                'Izin': s.evaluation ? (s.evaluation.ijin || 0) : 0,
                'Alpa': s.evaluation ? (s.evaluation.alpa || 0) : 0
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Siswa");
            XLSX.writeFile(wb, `Data_Siswa_Lengkap_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportToPDF() {
            if (!window.combinedStudentData) return alert('Data belum dimuat.');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');

            doc.setFontSize(16);
            doc.text("Laporan Data Lengkap Siswa PKL SIMAK NESBU", 14, 15);
            doc.setFontSize(10);
            doc.text(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}`, 14, 22);

            const tableData = window.combinedStudentData.map(s => [
                s.nis,
                s.nama,
                `${s.jurusan}\n${s.kelas}`,
                `${s.location ? s.location.NamaTempat : '-'}\n(${formatDate(s.startDate)} - ${formatDate(s.endDate)})`,
                s.evaluation ? `Softskill: ${s.evaluation.score_softskill || '-'}\nPOS: ${s.evaluation.score_pos || '-'}\nTeknis: ${s.evaluation.score_technical || '-'}\nBisnis: ${s.evaluation.score_bisnisdudi || '-'}` : '-',
                s.evaluation ? `Disiplin: ${s.evaluation.kedisplinan || '-'}\nKerja Sama: ${s.evaluation.kerjasama || '-'}\nInisiatif: ${s.evaluation.inisiatif || '-'}\nKerajinan: ${s.evaluation.kerajinan || '-'}\nTj. Jawab: ${s.evaluation.TanggungJawab || '-'}` : '-',
                s.evaluation ? `${s.evaluation.sakit || 0}/${s.evaluation.ijin || 0}/${s.evaluation.alpa || 0}` : '0/0/0'
            ]);

            doc.autoTable({
                head: [['NIS', 'Nama', 'Jurusan/Kelas', 'Tempat PKL & Periode', 'Penilaian Kompetensi', 'Penilaian Sikap', 'S/I/A']],
                body: tableData,
                startY: 28,
                theme: 'grid',
                styles: { fontSize: 7, cellPadding: 2, halign: 'center', valign: 'middle' },
                headStyles: { fillStyle: 'F', fillColor: [59, 130, 246], textColor: 255 },
                columnStyles: {
                    1: { halign: 'left', cellWidth: 35 },
                    3: { halign: 'left', cellWidth: 50 },
                    4: { halign: 'left', cellWidth: 50 },
                    5: { halign: 'left', cellWidth: 55 }
                }
            });

            doc.save(`Laporan_Siswa_PKL_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function downloadTemplate() {
            const template = [
                ['nis', 'nama', 'jurusan', 'kelas', 'TempatLahir', 'TanggalLahir', 'GolDarah', 'KontakSiswa', 'NamaOrangtua', 'KontakOrangtua'],
                ['12345', 'Nama Siswa Contoh', 'RPL', 'XII RPL 1', 'Bandung', '2006-01-01', 'O', '08123', 'Bapak Contoh', '08124']
            ];
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "FormatImport");
            XLSX.writeFile(wb, "Format_Import_Siswa.xlsx");
        }

        function triggerImport() {
            document.getElementById('importFile').click();
        }

        function handleImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.SheetNames[0];
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet]);

                if (confirm(`Impor ${jsonData.length} data siswa?`)) {
                    let successCount = 0;
                    for (const row of jsonData) {
                        try {
                            // Basic validation
                            if (!row.nis || !row.nama) continue;
                            await API.postData('DATASISWA', row);
                            successCount++;
                        } catch (err) {
                            console.error('Import failed for:', row.nis, err);
                        }
                    }
                    alert(`Berhasil mengimpor ${successCount} data.`);
                    loadStudents();
                }
                input.value = ''; // Reset
            };
            reader.readAsArrayBuffer(file);
        }
        async function loadMasterTeachers() {
            const tbody = document.getElementById('teacherMasterTableBody');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding: 2rem;">Memuat data...</td></tr>';
            try {
                const res = await API.getData('DATAGURU');
                tbody.innerHTML = '';
                if (res.data && res.data.length > 0) {
                    window.teacherMasterData = res.data;
                    res.data.forEach(t => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td data-label="Guru">
                                <div style="font-weight: 700; color: #fff; font-size: 0.95rem;">${t.NamaGuru}</div>
                                <div style="font-size: 0.75rem; color: var(--electric-blue); font-weight: 600; letter-spacing: 0.05em;">ID: ${t.ID_GURU}</div>
                            </td>
                            <td data-label="Aksi" style="text-align: right; padding-right: 1rem;">
                                <div class="table-actions" style="justify-content: flex-end;">
                                    <button class="action-btn edit" onclick="openEditMasterTeacher('${t.ID_GURU}')" title="Edit Data Guru"><i class="fas fa-edit"></i></button>
                                    <button class="action-btn delete" onclick="deleteMasterTeacher('${t.ID_GURU}')" title="Hapus Data Guru"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding: 2rem;">Tidak ada data.</td></tr>';
                }
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; color: var(--danger); padding: 2rem;">Gagal memuat data guru.</td></tr>';
            }
        }

        function toggleAddMasterTeacherModal(show) {
            const modal = document.getElementById('addMasterTeacherModal');
            if (show) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            } else {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                document.getElementById('addMasterTeacherForm').reset();
                document.getElementById('masterTeacherModalTitle').textContent = 'Tambah Guru Baru';
                document.getElementById('teacherMasterOriginalId').value = '';
                document.getElementById('masterTeacherId').readOnly = false;
            }
        }

        function openEditMasterTeacher(idGuru) {
            const t = window.teacherMasterData.find(item => item.ID_GURU == idGuru);
            if (!t) return;

            document.getElementById('masterTeacherModalTitle').textContent = 'Edit Data Guru';
            document.getElementById('teacherMasterOriginalId').value = t.ID_GURU;
            document.getElementById('masterTeacherId').value = t.ID_GURU;
            document.getElementById('masterTeacherId').readOnly = true;
            document.getElementById('masterTeacherNama').value = t.NamaGuru;

            toggleAddMasterTeacherModal(true);
        }

        async function deleteMasterTeacher(idGuru) {
            if (!confirm(`Hapus data guru ${idGuru}? Ini akan menghapus data permanen dari sheet.`)) return;
            try {
                const res = await API.deleteData('DATAGURU', idGuru);
                if (res.status === 'success') {
                    showToast('Data guru berhasil dihapus!');
                    loadMasterTeachers();
                } else {
                    showToast('Gagal: ' + (res.message || res.error), 'danger');
                }
            } catch (e) {
                showToast('Kesalahan jaringan.', 'danger');
            }
        }

        document.getElementById('addMasterTeacherForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSaveMasterTeacher');
            const originalId = document.getElementById('teacherMasterOriginalId').value;
            const isEdit = !!originalId;

            btn.disabled = true;
            btn.textContent = 'Menyimpan...';

            const data = {
                ID_GURU: document.getElementById('masterTeacherId').value,
                NamaGuru: document.getElementById('masterTeacherNama').value
            };

            try {
                let res;
                if (isEdit) {
                    res = await API.updateData('DATAGURU', originalId, data);
                } else {
                    res = await API.postData('DATAGURU', data);
                }

                if (res.status === 'success') {
                    showToast(isEdit ? 'Data guru berhasil diperbarui!' : 'Data guru berhasil ditambahkan!');
                    toggleAddMasterTeacherModal(false);
                    loadMasterTeachers();
                } else {
                    showToast('Gagal: ' + (res.message || res.error), 'danger');
                }
            } catch (e) {
                alert('Kesalahan jaringan / storage.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Simpan Data';
            }
        });

        async function loadApplications() {
            const container = document.getElementById('applicationCardContainer');
            if (!container) return;
            container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 3rem; opacity: 0.5;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem; color: var(--primary);"></i><p>Memuat data pengajuan...</p></div>';

            try {
                const [resApp, resStudent, resLocation] = await Promise.all([
                    API.getData('PENGAJUANPKL'),
                    API.getData('DATASISWA'),
                    API.getData('LOKASIPKL')
                ]);

                if (resApp.data) {
                    window.allApplications = resApp.data.map(app => {
                        const nisList = app.NIS ? app.NIS.toString().split(',').map(n => n.trim()) : [];
                        const students = nisList.map(nis => resStudent.data ? resStudent.data.find(s => s.nis == nis) : null).filter(s => s);
                        const studentNames = students.map(s => s.nama).join(', ') || 'Tidak Ditemukan';

                        const location = resLocation.data ? resLocation.data.find(l => l.ID_PKL == app.ID_PKL) : null;
                        return {
                            ...app,
                            studentName: studentNames,
                            locationName: location ? location.NamaTempat : 'Tidak Ditemukan',
                            studentObj: students[0] || null,
                            students: students,
                            locationObj: location
                        };
                    });
                    renderApplications(window.allApplications);
                } else {
                    container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 3rem; opacity: 0.5;"><p>Tidak ada data pengajuan.</p></div>';
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--danger);"><p>Gagal memuat data pengajuan.</p></div>';
            }
        }

        function renderApplications(data) {
            const container = document.getElementById('applicationCardContainer');
            if (!container) return;
            container.innerHTML = '';
            if (!data || data.length === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 3rem; opacity: 0.5;"><p>Data tidak ditemukan.</p></div>';
                return;
            }

            // Sort by date (latest first)
            const sorted = [...data].sort((a, b) => new Date(b.TanggalAjuan) - new Date(a.TanggalAjuan));

            sorted.forEach(app => {
                const card = document.createElement('div');
                card.className = 'application-card glass';

                let statusBadgeClass = app.Status === 'Disetujui' ? 'badge-success' : (app.Status === 'Ditolak' ? 'badge-danger' : 'badge-warning');

                card.innerHTML = `
                    <div class="card-badge ${statusBadgeClass}">${app.Status}</div>
                    <div class="card-header">
                        <div class="card-student-info">
                            <div class="card-student-name">${app.studentNames || app.studentName}</div>
                            <div class="card-student-nis">NIS: ${app.NIS} • ${app.Jurusan}</div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <i class="fas fa-building"></i>
                            <span>${app.locationName}</span>
                        </div>
                        <div class="info-row">
                            <i class="fas fa-calendar-alt"></i>
                            <span>${app.StartDate ? formatDate(app.StartDate) : '-'} s/d ${app.EndDate ? formatDate(app.EndDate) : '-'}</span>
                        </div>
                        <div class="info-row">
                            <i class="fas fa-tags"></i>
                            <span>${app.TipeAjuan}</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn-card-action view" onclick="openViewApplication('${app.ID_PENGAJUAN}')" title="Detail">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                        ${app.Status === 'Pending' ? `
                            <button class="btn-card-action review" onclick="openReviewApplication('${app.ID_PENGAJUAN}')" title="Pertinjauan">
                                <i class="fas fa-check-double"></i> Tinjau
                            </button>
                        ` : ''}
                        <button class="btn-card-action edit" onclick="openEditApplication('${app.ID_PENGAJUAN}')" title="Edit">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-card-action delete" onclick="deleteApplication('${app.ID_PENGAJUAN}')" title="Hapus">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function filterApplications(query) {
            if (!window.allApplications) return;
            const q = query.toLowerCase();
            const filtered = window.allApplications.filter(app =>
                app.NIS.toString().includes(q) ||
                app.studentName.toLowerCase().includes(q) ||
                app.locationName.toLowerCase().includes(q)
            );
            renderApplications(filtered);
        }

        async function approveApplication(id) {
            const adminData = AUTH.getUser();
            if (!adminData) {
                alert('Sesi Anda telah berakhir. Silakan login kembali.');
                AUTH.logout();
                return;
            }

            if (!confirm('Apakah Anda yakin ingin menyetujui pengajuan PKL ini?')) return;

            const app = window.allApplications.find(a => a.ID_PENGAJUAN == id);
            if (!app) return alert('Data pengajuan tidak ditemukan.');

            const updateData = {
                Status: 'Disetujui',
                DisetujuiOleh: adminData.nama || adminData.username,
                TanggalPersetujuan: new Date().toISOString()
            };

            try {
                const res = await API.updateData('PENGAJUANPKL', id, updateData);
                if (res.status === 'success') {
                    // Also update DATAPKL to assign student to place individually
                    try {
                        const resPKL = await API.getData('DATAPKL');
                        const nisList = app.NIS ? app.NIS.toString().split(',').map(n => n.trim()) : [];
                        const fullGroupedNis = app.NIS ? app.NIS.toString() : "";

                        for (let i = 0; i < nisList.length; i++) {
                            const nis = nisList[i];
                            let existing = resPKL.data ? resPKL.data.find(d => d.nis == nis) : null;
                            let targetNisForUpdate = nis;

                            if (!existing && i === 0 && fullGroupedNis.includes(',')) {
                                existing = resPKL.data ? resPKL.data.find(d => d.nis == fullGroupedNis) : null;
                                if (existing) targetNisForUpdate = fullGroupedNis;
                            }

                            const pklAssignment = {
                                nis: nis,
                                ID_Jurusan: app.Jurusan,
                                StartDate: app.StartDate || '',
                                EndDate: app.EndDate || ''
                            };

                            if (existing) {
                                if (!existing.ID_PKL_2) {
                                    pklAssignment.ID_PKL_2 = app.ID_PKL;
                                } else {
                                    pklAssignment.ID_PKL_3 = app.ID_PKL;
                                }
                                await API.updateData('DATAPKL', targetNisForUpdate, pklAssignment);
                            } else {
                                pklAssignment.ID_PKL = app.ID_PKL;
                                await API.postData('DATAPKL', pklAssignment);
                            }
                        }
                    } catch (pklErr) {
                        console.error('Failed to sync DATAPKL:', pklErr);
                        alert('Pengajuan disetujui, namun gagal sinkronisasi ke Data PKL Siswa.');
                    }

                    showToast('Pengajuan berhasil disetujui dan data PKL siswa telah diperbarui!');
                    loadApplications();
                } else {
                    showToast('Gagal: ' + (res.message || res.error), 'danger');
                }
            } catch (err) {
                alert('Kesalahan jaringan: ' + err.message);
            }
        }

        function openRejectModal(id) {
            document.getElementById('rejectApplicationId').value = id;
            document.getElementById('rejectReason').value = '';
            toggleRejectModal(true);
        }

        function toggleRejectModal(show) {
            const modal = document.getElementById('applicationRejectModal');
            if (show) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            } else {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }

        document.getElementById('rejectApplicationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('rejectApplicationId').value;
            const reason = document.getElementById('rejectReason').value;
            const adminData = AUTH.getUser();

            if (!adminData) {
                alert('Sesi Anda telah berakhir.');
                AUTH.logout();
                return;
            }

            const updateData = {
                Status: 'Ditolak',
                Catatan: reason,
                DisetujuiOleh: adminData.nama || adminData.username,
                TanggalPersetujuan: new Date().toISOString()
            };

            try {
                const res = await API.updateData('PENGAJUANPKL', id, updateData);
                if (res.status === 'success') {
                    showToast('Pengajuan telah ditolak.');
                    toggleRejectModal(false);
                    loadApplications();
                } else {
                    showToast('Gagal: ' + (res.message || res.error), 'danger');
                }
            } catch (err) {
                alert('Kesalahan jaringan: ' + err.message);
            }
        });

        async function deleteApplication(id) {
            const app = window.allApplications.find(a => a.ID_PENGAJUAN == id);
            if (!app) return;

            const confirmMsg = app.Status === 'Disetujui'
                ? 'Hapus pengajuan yang telah disetujui? Data penempatan di DATAPKL juga akan dihapus.'
                : 'Hapus data pengajuan ini?';

            if (!confirm(confirmMsg)) return;

            try {
                const res = await API.deleteData('PENGAJUANPKL', id);
                if (res.status === 'success') {
                    if (app.Status === 'Disetujui') {
                        const nisList = app.NIS ? app.NIS.toString().split(',').map(n => n.trim()) : [];
                        for (const nis of nisList) {
                            await API.deleteData('DATAPKL', nis);
                        }
                    }
                    showToast('Pengajuan berhasil dihapus.', 'success');
                    loadApplications();
                } else {
                    showToast('Gagal: ' + (res.message || res.error), 'danger');
                }
            } catch (err) {
                showToast('Kesalahan: ' + err.message, 'danger');
            }
        }

        function openReviewApplication(id) {
            openViewApplication(id, true);
        }

        function openViewApplication(id, isReview = false) {
            const app = window.allApplications.find(a => a.ID_PENGAJUAN == id);
            if (!app) return;

            const s = app.studentObj || {};
            const loc = app.locationObj || {};
            const content = document.getElementById('viewApplicationContent');

            const sectionStyle = "margin-bottom: 2rem; background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.08);";
            const headerStyle = "font-size: 1.1rem; font-weight: 700; color: var(--primary-light); margin-bottom: 1.2rem; display: flex; align-items: center; gap: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.08); padding-bottom: 0.5rem;";

            const studentsToRender = app.students && app.students.length > 0 ? app.students : [s];
            const itemStyle = "padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; gap: 0.25rem;";
            const labelStyle = "font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;";
            const valueStyle = "font-weight: 600; color: var(--text-main); font-size: 0.95rem;";

            let studentHtml = '';
            studentsToRender.forEach((std, index) => {
                studentHtml += `
                    <div style="${sectionStyle} ${index > 0 ? 'margin-top: 1rem;' : ''}">
                        <div style="${headerStyle}"><i class="fas fa-user-graduate"></i> DATA SISWA ${studentsToRender.length > 1 ? (index + 1) : ''}</div>
                        <div style="display: flex; flex-direction: column;">
                            <div style="${itemStyle}"><span style="${labelStyle}">NIS</span><span style="${valueStyle}">${std.nis || '-'}</span></div>
                            <div style="${itemStyle}"><span style="${labelStyle}">Nama Lengkap</span><span style="${valueStyle}">${std.nama || '-'}</span></div>
                            <div style="${itemStyle}"><span style="${labelStyle}">Jurusan / Kelas</span><span style="${valueStyle}">${std.jurusan || app.Jurusan} / ${std.kelas || '-'}</span></div>
                            <div style="${itemStyle}"><span style="${labelStyle}">Tempat, Tgl Lahir</span><span style="${valueStyle}">${std.TempatLahir || '-'}, ${formatDate(std.TanggalLahir)}</span></div>
                            <div style="${itemStyle}"><span style="${labelStyle}">Kontak Siswa</span><span style="${valueStyle}">${std.KontakSiswa || '-'}</span></div>
                            <div style="${itemStyle}; border-bottom: none;"><span style="${labelStyle}">Orang Tua (Nama / Kontak)</span><span style="${valueStyle}">${std.NamaOrangtua || '-'} (${std.KontakOrangtua || '-'})</span></div>
                        </div>
                    </div>
                `;
            });

            content.innerHTML = `
                <div style="max-height: 70vh; overflow-y: auto; padding-right: 0.5rem;">
                    <!-- Group 1: Data Siswa -->
                    ${studentHtml}

                    <!-- Group 2: Data Tempat PKL -->
                    <div style="${sectionStyle}">
                        <div style="${headerStyle}"><i class="fas fa-building"></i> INFO TEMPAT PKL</div>
                        <div style="display: flex; flex-direction: column;">
                            <div style="${itemStyle}"><span style="${labelStyle}">Nama Instansi</span><span style="${valueStyle}">${loc.NamaTempat || app.locationName}</span></div>
                            <div style="${itemStyle}"><span style="${labelStyle}">Alamat</span><span style="${valueStyle}">${loc.Alamat || '-'}</span></div>
                            <div style="${itemStyle}"><span style="${labelStyle}">Pimpinan / Mentor</span><span style="${valueStyle}">${loc.NamaPimpinan || '-'} / ${loc.NamaMentor || '-'}</span></div>
                            <div style="${itemStyle}; border-bottom: none;"><span style="${labelStyle}">Kontak Mentor</span><span style="${valueStyle}">${loc.KontakMentor || '-'}</span></div>
                        </div>
                    </div>

                    <!-- Group 3: Detail Pengajuan -->
                    <div style="${sectionStyle}">
                        <div style="${headerStyle}"><i class="fas fa-info-circle"></i> DETAIL PENGAJUAN</div>
                        <div style="display: flex; flex-direction: column;">
                            <div style="${itemStyle}"><span style="${labelStyle}">Tipe Ajuan</span><span style="${valueStyle}">${app.TipeAjuan}</span></div>
                            <div style="${itemStyle}"><span style="${labelStyle}">Periode PKL</span><span style="${valueStyle}">${formatDate(app.StartDate)} s/d ${formatDate(app.EndDate)}</span></div>
                            <div style="${itemStyle}"><span style="${labelStyle}">Status</span>
                                <div><span class="badge ${app.Status === 'Disetujui' ? 'badge-success' : (app.Status === 'Ditolak' ? 'badge-danger' : 'badge-warning')}" style="font-size: 0.7rem;">${app.Status}</span></div>
                            </div>
                            <div style="${itemStyle}; border-bottom: none;">
                                <span style="${labelStyle}">Catatan / Feedback</span>
                                <div style="margin-top: 0.5rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 0.75rem; border: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem; line-height: 1.5;">
                                    ${app.Catatan || '<span style="color:var(--text-muted); font-style:italic;">Tidak ada catatan</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            toggleViewApplicationModal(true);

            // Handle Review Mode
            const reviewActions = document.getElementById('reviewActions');
            if (isReview && app.Status === 'Pending') {
                reviewActions.classList.remove('hidden');
                document.getElementById('btnApproveInside').onclick = () => {
                    toggleViewApplicationModal(false);
                    approveApplication(id);
                };
                document.getElementById('btnRejectInside').onclick = () => {
                    toggleViewApplicationModal(false);
                    openRejectModal(id);
                };
            } else {
                reviewActions.classList.add('hidden');
            }
        }

        function toggleViewApplicationModal(show) {
            const modal = document.getElementById('viewApplicationModal');
            if (show) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            } else {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }

        function openEditApplication(id) {
            const app = window.allApplications.find(a => a.ID_PENGAJUAN == id);
            if (!app) return;

            document.getElementById('editAppId').value = app.ID_PENGAJUAN;
            document.getElementById('editAppTipe').value = app.TipeAjuan;
            document.getElementById('editAppStart').value = app.StartDate ? app.StartDate.split('T')[0] : '';
            document.getElementById('editAppEnd').value = app.EndDate ? app.EndDate.split('T')[0] : '';
            document.getElementById('editAppStatus').value = app.Status;

            toggleEditApplicationModal(true);
        }

        function toggleEditApplicationModal(show) {
            const modal = document.getElementById('editApplicationModal');
            if (show) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            } else {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }

        document.getElementById('editApplicationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editAppId').value;
            const data = {
                TipeAjuan: document.getElementById('editAppTipe').value,
                StartDate: document.getElementById('editAppStart').value,
                EndDate: document.getElementById('editAppEnd').value,
                Status: document.getElementById('editAppStatus').value
            };

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = 'Menyimpan...';

            try {
                const res = await API.updateData('PENGAJUANPKL', id, data);
                if (res.status === 'success') {
                    showToast('Perubahan berhasil disimpan!', 'success');
                    toggleEditApplicationModal(false);
                    loadApplications();
                } else {
                    showToast('Gagal: ' + (res.message || res.error), 'danger');
                }
            } catch (err) {
                showToast('Kesalahan: ' + err.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Simpan Perubahan';
            }
        });

        async function loadAttendance() {
            const tableBody = document.getElementById('attendanceTableBody');
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 2rem;">Memuat data...</td></tr>';

            try {
                console.log('Fetching Attendance, Jurnal, and Student data...');
                const [resAtt, resJurnal, resStudent] = await Promise.all([
                    API.getData('KEHADIRAN'),
                    API.getData('JURNAL'),
                    API.getData('DATASISWA')
                ]);

                if (resAtt.status === 'success' && resAtt.data) {
                    window.allAttendance = resAtt.data.map(att => {
                        const student = resStudent.data ? resStudent.data.find(s => s.nis == att.NIS) : null;

                        // Find matching journal (NIS and same Date)
                        // att.Tanggal usually "YYYY-MM-DD" or "YYYY-MM-DDTHH:mm:ss.sssZ"
                        const attDate = new Date(att.Tanggal).toDateString();
                        const journal = resJurnal.data ? resJurnal.data.find(j =>
                            j.NIS == att.NIS && new Date(j.Tanggal).toDateString() === attDate
                        ) : null;

                        return {
                            ...att,
                            studentName: student ? student.nama : 'Tidak Ditemukan',
                            studentObj: student,
                            journal: journal
                        };
                    });

                    // Sort by date descending
                    window.allAttendance.sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal));
                    renderAttendance(window.allAttendance);
                } else {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 2rem; color: var(--danger);">Gagal memuat data kehadiran.</td></tr>';
                }
            } catch (err) {
                console.error('Error loading attendance:', err);
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 2rem; color: var(--danger);">Kesalahan jaringan.</td></tr>';
            }
        }

        function renderAttendance(data) {
            const tableBody = document.getElementById('attendanceTableBody');
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 3rem; color: var(--text-muted); opacity: 0.5;">Tidak ada data kehadiran ditemukan.</td></tr>';
                return;
            }

            tableBody.innerHTML = data.map(att => `
                <tr>
                    <td data-label="Siswa">
                        <div style="font-weight: 700; color: #fff; font-size: 0.95rem;">${att.studentName}</div>
                        <div style="font-size: 0.75rem; color: var(--electric-blue); font-weight: 600;">NIS: ${att.NIS}</div>
                    </td>
                    <td data-label="Tanggal" style="font-weight: 600;">${formatDate(att.Tanggal)}</td>
                    <td data-label="Masuk" style="color: var(--success); font-weight: 700;">${att.time_in || att.JamMasuk || '-'}</td>
                    <td data-label="Pulang" style="color: var(--warning); font-weight: 700;">${att.time_out || att.JamPulang || '-'}</td>
                    <td data-label="Status">
                        <span class="badge ${att.StatusAbsen === 'Hadir' || att.Status === 'Hadir' ? 'badge-success' : 'badge-danger'}">${att.StatusAbsen || att.Status || 'Hadir'}</span>
                    </td>
                    <td data-label="Jurnal" style="text-align: center;">
                        ${att.journal ?
                    '<span style="color: var(--success); font-size: 1.2rem;" title="Terisi"><i class="fas fa-check-circle"></i></span>' :
                    '<span style="color: var(--danger); font-size: 1.2rem;" title="Belum"><i class="fas fa-times-circle"></i></span>'}
                    </td>
                    <td data-label="Aksi" style="text-align: right; padding-right: 1rem;">
                        <div class="table-actions" style="justify-content: flex-end;">
                            <button class="action-btn view" onclick="openViewAttendanceDetail('${att.ID_Absen || att.ID}')" title="Lihat Detail"><i class="fas fa-eye"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterAttendance(query) {
            if (!window.allAttendance) return;
            const q = query.toLowerCase();
            const filtered = window.allAttendance.filter(att =>
                att.NIS.toString().includes(q) ||
                att.studentName.toLowerCase().includes(q) ||
                att.StatusAbsen.toLowerCase().includes(q) ||
                formatDate(att.Tanggal).toLowerCase().includes(q)
            );
            renderAttendance(filtered);
        }

        function openViewAttendanceDetail(id) {
            const att = window.allAttendance.find(a => a.ID_Absen == id);
            if (!att) return;

            const content = document.getElementById('viewAttendanceContent');
            const sectionStyle = "margin-bottom: 1.5rem; background: rgba(255,255,255,0.05); padding: 1.25rem; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.1);";
            const headerStyle = "font-size: 1rem; font-weight: 700; color: var(--primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; border-bottom: 1px solid rgba(59, 130, 246, 0.2); padding-bottom: 0.5rem;";

            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Photo Column -->
                    <div>
                        <div style="${headerStyle}"><i class="fas fa-camera"></i> Foto Bukti</div>
                        <div style="width: 100%; border-radius: 1rem; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); background: #000;">
                            ${att.photo ? `<img src="${getDriveThumbnail(att.photo)}" style="width: 100%; height: auto; display: block;" onerror="this.src='https://placehold.co/400x300?text=Foto+Tidak+Ditemukan'">` : `<div style="padding: 3rem; text-align: center; color: var(--text-muted);"><i class="fas fa-image" style="font-size: 3rem; display: block; margin-bottom: 1rem;"></i>Tidak ada foto</div>`}
                        </div>
                    </div>

                    <!-- Details Column -->
                    <div>
                        <div style="${sectionStyle}">
                            <div style="${headerStyle}"><i class="fas fa-info-circle"></i> Informasi Absen</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem;">
                                <div><strong style="color:var(--text-muted)">Waktu Masuk:</strong><br>${att.time_in || '-'}</div>
                                <div><strong style="color:var(--text-muted)">Waktu Pulang:</strong><br>${att.time_out || '-'}</div>
                                <div><strong style="color:var(--text-muted)">Status:</strong><br><span class="badge ${att.StatusAbsen === 'Hadir' ? 'badge-success' : 'badge-danger'}">${att.StatusAbsen}</span></div>
                                <div><strong style="color:var(--text-muted)">Jarak:</strong><br>${att.JarakAbsen || '0'} m</div>
                            </div>
                        </div>

                        <div style="${sectionStyle}">
                            <div style="${headerStyle}"><i class="fas fa-map-marker-alt"></i> Lokasi Absen</div>
                            <div style="font-size: 0.9rem; margin-bottom: 1rem;">
                                <strong style="color:var(--text-muted)">Koordinat:</strong><br>
                                ${att.lat}, ${att.lng}
                            </div>
                            <a href="https://www.google.com/maps?q=${att.lat},${att.lng}" target="_blank" class="btn btn-sm" style="background: #ea4335; color: #fff; width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-external-link-alt"></i> Buka di Google Maps
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Journal Section (Full Width Bottom) -->
                <div style="margin-top: 1.5rem; ${sectionStyle}">
                    <div style="${headerStyle}"><i class="fas fa-book"></i> Jurnal Harian</div>
                    ${att.journal ? `
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <strong style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">Aktivitas/Kegiatan:</strong>
                                <div style="background: rgba(0,0,0,0.1); padding: 1rem; border-radius: 0.5rem; font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; border: 1px solid rgba(255,255,255,0.05);">
                                    ${att.journal.Aktifitas || '-'}
                                </div>
                            </div>
                            <div>
                                <strong style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">Feedback Pembimbing:</strong>
                                <div style="background: rgba(59, 130, 246, 0.05); padding: 1rem; border-radius: 0.5rem; font-size: 0.95rem; line-height: 1.5; border: 1px solid rgba(59, 130, 246, 0.1);">
                                    ${att.journal.feedback || '<span style="color: var(--text-muted); font-style: italic;">Belum ada feedback</span>'}
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; font-size: 0.85rem; margin-top: 0.5rem;">
                                <div><strong style="color: var(--text-muted);">Status Jurnal:</strong> <span class="badge ${att.journal.status === 'Disetujui' ? 'badge-success' : (att.journal.status === 'Revisi' ? 'badge-warning' : 'badge-primary')}">${att.journal.status || 'Pending'}</span></div>
                            </div>
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 2rem; color: var(--danger); background: rgba(239, 68, 68, 0.05); border-radius: 0.5rem; border: 1px dashed rgba(239, 68, 68, 0.3);">
                            <i class="fas fa-times-circle" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                            Siswa belum mengisi jurnal harian untuk tanggal ini.
                        </div>
                    `}
                </div>
            `;
            toggleAttendanceModal(true);
        }

        function toggleAttendanceModal(show) {
            const modal = document.getElementById('viewAttendanceModal');
            if (show) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            } else {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }

        // Jurnal Monitoring functions removed as they are integrated into Attendance

        async function loadReportTitles() {
            const tableBody = document.getElementById('reportTitleTableBody');
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 2rem;">Memuat data...</td></tr>';

            try {
                const [resTitles, resStudent] = await Promise.all([
                    API.getData('JUDULLAPORAN'),
                    API.getData('DATASISWA')
                ]);

                if (resTitles.status === 'success' && resTitles.data) {
                    window.allReportTitles = resTitles.data.map(item => {
                        const student = resStudent.data ? resStudent.data.find(s => s.nis == item.NIS) : null;
                        return {
                            ...item,
                            studentName: student ? student.nama : 'Tidak Ditemukan',
                            studentObj: student
                        };
                    });

                    renderReportTitles(window.allReportTitles);
                } else {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 2rem; color: var(--danger);">Gagal memuat data judul laporan.</td></tr>';
                }
            } catch (err) {
                console.error('Error loading report titles:', err);
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 2rem; color: var(--danger);">Kesalahan jaringan.</td></tr>';
            }
        }

        function renderReportTitles(data) {
            const tableBody = document.getElementById('reportTitleTableBody');
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 2rem;">Tidak ada pengajuan judul ditemukan.</td></tr>';
                return;
            }

            tableBody.innerHTML = data.map(item => {
                const statusIcon = item.status === 'Disetujui' ? '<i class="fas fa-check-circle" style="color: var(--success); margin-right: 0.5rem;"></i>' :
                    item.status === 'Revisi' ? '<i class="fas fa-exclamation-triangle" style="color: var(--warning); margin-right: 0.5rem;"></i>' :
                        item.status === 'Ditolak' ? '<i class="fas fa-times-circle" style="color: var(--danger); margin-right: 0.5rem;"></i>' : '';

                let statusLabel = item.status || 'Pending';
                if (item.status && item.status !== 'Pending' && item.DiprosesOleh) {
                    statusLabel = `${item.status === 'Revisi' ? 'Diminta Revisi' : item.status} oleh ${item.DiprosesOleh}`;
                }

                return `
                <tr>
                    <td data-label="Siswa">
                        <div style="font-weight: 600; color: #fff;">${item.studentName}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">NIS: ${item.NIS}</div>
                    </td>
                    <td data-label="Judul Laporan">
                        <div style="max-width: 400px; font-weight: 500; line-height: 1.4;">${item.JudulAjuan || '-'}</div>
                    </td>
                    <td data-label="Status">
                        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                            <span class="badge ${item.status === 'Disetujui' ? 'badge-success' : (item.status === 'Revisi' ? 'badge-warning' : (item.status === 'Ditolak' ? 'badge-danger' : 'badge-primary'))}" style="padding: 4px 12px; border-radius: 2rem; font-weight: 700; font-size: 0.7rem;">
                                ${statusLabel}
                            </span>
                        </div>
                    </td>
                    <td data-label="Aksi">
                        <div class="table-actions">
                            <button class="action-btn edit" onclick="openReportTitleAction('${item.ID_Judul}')" title="${item.status && item.status !== 'Pending' ? 'Edit Respon' : 'Konfirmasi Judul'}">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function filterReportTitles(query) {
            if (!window.allReportTitles) return;
            const q = query.toLowerCase();
            const filtered = window.allReportTitles.filter(item =>
                item.NIS.toString().includes(q) ||
                item.studentName.toLowerCase().includes(q) ||
                (item.JudulAjuan && item.JudulAjuan.toLowerCase().includes(q))
            );
            renderReportTitles(filtered);
        }

        function openReportTitleAction(id) {
            const item = window.allReportTitles.find(t => t.ID_Judul == id);
            if (!item) return;

            document.getElementById('actionReportTitleId').value = item.ID_Judul;
            document.getElementById('displayReportTitle').textContent = item.JudulAjuan;
            document.getElementById('reportTitleStatus').value = item.status || 'Disetujui';
            document.getElementById('reportTitleFeedback').value = item.feedback || '';

            toggleReportTitleModal(true);
        }

        function toggleReportTitleModal(show) {
            const modal = document.getElementById('actionReportTitleModal');
            if (show) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            } else {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }

        document.getElementById('actionReportTitleForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('actionReportTitleId').value;
            const status = document.getElementById('reportTitleStatus').value;
            const feedback = document.getElementById('reportTitleFeedback').value;

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            btn.disabled = true;

            try {
                const res = await API.updateData('JUDULLAPORAN', id, { status, feedback, DiprosesOleh: user.nama });
                if (res.status === 'success') {
                    showToast('Status judul laporan berhasil diperbarui!', 'success');
                    toggleReportTitleModal(false);
                    loadReportTitles();
                } else {
                    showToast('Gagal memperbarui status.', 'danger');
                }
            } catch (err) {
                console.error('Update report title error:', err);
                showToast('Kesalahan jaringan.', 'danger');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // Initialize dashboard
        // Info PKL Admin Functions
        async function loadAnnouncementsAdmin() {
            const tableBody = document.getElementById('announcementTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 2rem;">Memuat data...</td></tr>';
            try {
                const res = await API.getData('PENGUMUMAN');
                if (res.status === 'success') {
                    window.allAnnouncements = res.data;
                    renderAnnouncementsAdmin(res.data);
                }
            } catch (err) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--danger);">Gagal memuat data.</td></tr>';
            }
        }

        function renderAnnouncementsAdmin(data) {
            const tableBody = document.getElementById('announcementTableBody');
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 3rem; color: var(--text-muted); opacity: 0.5;">Tidak ada pengumuman.</td></tr>';
                return;
            }
            tableBody.innerHTML = data.map(item => `
                <tr>
                    <td data-label="Judul & Konten">
                        <div style="font-weight: 600; color: #fff;">${item.Judul}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.Konten}</div>
                    </td>
                    <td data-label="Jurusan">${item.Jurusan}</td>
                    <td data-label="Tanggal">${new Date(item.Tanggal).toLocaleDateString('id-ID')}</td>
                    <td data-label="Status">
                        <span class="badge ${item.Status === 'Aktif' ? 'badge-success' : 'badge-danger'}" style="padding: 4px 12px; border-radius: 2rem; font-weight: 700; font-size: 0.7rem;">${item.Status}</span>
                    </td>
                    <td data-label="Aksi">
                        <div class="table-actions">
                            <button class="action-btn edit" onclick="openAnnouncementModal('${item.ID_Info}')" title="Edit Pengumuman"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" onclick="deleteAnnouncement('${item.ID_Info}')" title="Hapus Pengumuman"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function toggleAnnouncementModal(show) {
            const modal = document.getElementById('announcementModal');
            modal.classList.toggle('hidden', !show);
            modal.style.display = show ? 'flex' : 'none';
        }


        function openAnnouncementModal(id = null) {
            const form = document.getElementById('announcementForm');
            form.reset();
            document.getElementById('annId').value = id || '';
            document.getElementById('announcementModalTitle').textContent = id ? 'Edit Pengumuman' : 'Tambah Pengumuman';

            let currentJurusan = 'Semua';
            if (id && window.allAnnouncements) {
                const item = window.allAnnouncements.find(a => a.ID_Info == id);
                if (item) {
                    document.getElementById('annJudul').value = item.Judul;
                    document.getElementById('annKonten').value = item.Konten;
                    currentJurusan = item.Jurusan;
                    document.getElementById('annStatus').value = item.Status;
                }
            }
            loadJurusanOptions('annJurusan', currentJurusan);
            toggleAnnouncementModal(true);
        }

        document.getElementById('announcementForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('annId').value;
            const data = {
                Judul: document.getElementById('annJudul').value,
                Konten: document.getElementById('annKonten').value,
                Jurusan: document.getElementById('annJurusan').value,
                Status: document.getElementById('annStatus').value,
                Pembuat: user.nama,
                Tanggal: new Intl.DateTimeFormat('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }).format(new Date())
            };

            if (!id) {
                // Generate ID for new entry
                data.ID_Info = 'INF-' + Date.now();
            }

            const btn = document.getElementById('btnSaveAnnouncement');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            try {
                const res = id ? await API.updateData('PENGUMUMAN', id, data) : await API.postData('PENGUMUMAN', data);
                if (res.status === 'success') {
                    showToast(id ? 'Pengumuman diperbarui!' : 'Pengumuman ditambahkan!', 'success');
                    toggleAnnouncementModal(false);
                    loadAnnouncementsAdmin();
                }
            } catch (err) {
                showToast('Gagal menyimpan pengumuman.', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Simpan';
            }
        };

        async function deleteAnnouncement(id) {
            if (!confirm('Hapus pengumuman ini?')) return;
            try {
                const res = await API.deleteData('PENGUMUMAN', id);
                if (res.status === 'success') {
                    showToast('Pengumuman dihapus!', 'success');
                    loadAnnouncementsAdmin();
                }
            } catch (err) {
                showToast('Gagal menghapus.', 'danger');
            }
        }

        let eventPickerMap, eventPickerMarker;
        async function loadEventsAdmin() {
            const tableBody = document.getElementById('eventTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 2rem;">Memuat data...</td></tr>';
            try {
                const res = await API.getData('EVENT');
                if (res.status === 'success') {
                    window.allEvents = res.data;
                    renderEventsAdmin(res.data);
                }
            } catch (err) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--danger);">Gagal memuat data.</td></tr>';
            }
        }

        function renderEventsAdmin(data) {
            const tableBody = document.getElementById('eventTableBody');
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 3rem; color: var(--text-muted); opacity: 0.5;">Tidak ada event.</td></tr>';
                return;
            }
            tableBody.innerHTML = data.map(item => `
                <tr>
                    <td data-label="Nama Event"><strong style="color: #fff;">${item.NamaEven}</strong></td>
                    <td data-label="Tanggal">${formatDate(item.TanggalEven)}</td>
                    <td data-label="Lokasi">${item.Lokasi}</td>
                    <td data-label="Jurusan">${item.Jurusan}</td>
                    <td data-label="Aksi">
                        <div class="table-actions">
                            <button class="action-btn view" onclick="viewEventDetails('${item.ID_Even}')" title="Lihat Detail Event"><i class="fas fa-eye"></i></button>
                            <button class="action-btn edit" onclick="openEventModal('${item.ID_Even}')" title="Edit Event"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" onclick="deleteEvent('${item.ID_Even}')" title="Hapus Event"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function toggleEventModal(show) {
            const modal = document.getElementById('eventModal');
            modal.classList.toggle('hidden', !show);
            modal.style.display = show ? 'flex' : 'none';
            if (show) setTimeout(initEventMap, 300);
        }

        function toggleEventDetailModal(show) {
            const modal = document.getElementById('eventDetailModal');
            if (modal) {
                modal.classList.toggle('hidden', !show);
                modal.style.display = show ? 'flex' : 'none';
            }
        }

        function viewEventDetails(id) {
            const event = window.allEvents.find(e => e.ID_Even == id);
            if (!event) return;

            const modal = document.getElementById('eventDetailModal');
            if (!modal) return showToast('Modal detail tidak ditemukan.', 'danger');

            document.getElementById('detEvtNama').textContent = event.NamaEven;
            document.getElementById('detEvtTanggal').textContent = formatDate(event.TanggalEven);
            document.getElementById('detEvtWaktu').textContent = event.Durasi || '-';
            document.getElementById('detEvtLokasi').textContent = event.Lokasi;
            document.getElementById('detEvtPengisi').textContent = event.Pengisi;
            document.getElementById('detEvtDeskripsi').textContent = event.Deskripsi;

            loadEventParticipants(id, event.LAT, event.LNG);
            toggleEventDetailModal(true);
        }

        function printEventDetail() {
            window.print();
        }

        async function loadEventParticipants(eventId, eventLat, eventLng) {
            const list = document.getElementById('eventParticipantList');
            if (!list) return;
            list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 1rem;"><i class="fas fa-spinner fa-spin"></i> Memuat peserta...</td></tr>';

            try {
                const [resAbsen, resSiswa] = await Promise.all([
                    API.getData('ABSENEVEN'),
                    API.getData('DATASISWA')
                ]);

                if (resAbsen.status === 'success' && resSiswa.status === 'success') {
                    const eventAbsen = resAbsen.data.filter(a => a.ID_Even == eventId);
                    if (eventAbsen.length === 0) {
                        list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 1rem;">Belum ada peserta hadir.</td></tr>';
                        return;
                    }

                    // Sort by NIS (natural sort)
                    eventAbsen.sort((a, b) => a.NIS.toString().localeCompare(b.NIS.toString(), undefined, { numeric: true, sensitivity: 'base' }));

                    list.innerHTML = eventAbsen.map(absen => {
                        const student = resSiswa.data.find(s => s.nis == absen.NIS);
                        const nama = student ? student.nama : absen.NIS;
                        const kelas = student ? (student.kelas || '-') : '-';

                        let keterangan = '<span style="color: #cbd5e1;">Lokasi tidak diketahui</span>';
                        if (absen.LAT && absen.LNG && eventLat && eventLng) {
                            const dist = haversineDistance(parseFloat(absen.LAT), parseFloat(absen.LNG), parseFloat(eventLat), parseFloat(eventLng));
                            if (dist <= 30) {
                                keterangan = '<span style="color: var(--success);">Hadir di lokasi</span>';
                            } else {
                                keterangan = '<span style="color: var(--danger);">Lokasi terlalu jauh</span>';
                            }
                        }

                        return `
                            <tr>
                                <td style="padding: 0.75rem;">${nama}</td>
                                <td style="padding: 0.75rem;">${kelas}</td>
                                <td style="padding: 0.75rem;">${absen.jam}</td>
                                <td style="padding: 0.75rem;">${keterangan}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error('Error loading participants:', err);
                list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 1rem; color: var(--danger);">Gagal memuat peserta.</td></tr>';
            }
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }


        function initEventMap() {
            try {
                if (!eventPickerMap) {
                    eventPickerMap = L.map('eventPickerMap').setView([-7.9839, 112.6214], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(eventPickerMap);

                    eventPickerMap.on('click', (e) => {
                        const { lat, lng } = e.latlng;
                        if (eventPickerMarker) {
                            eventPickerMarker.setLatLng(e.latlng);
                        } else {
                            eventPickerMarker = L.marker(e.latlng).addTo(eventPickerMap);
                        }
                        document.getElementById('evtLat').value = lat.toFixed(6);
                        document.getElementById('evtLng').value = lng.toFixed(6);
                    });
                } else {
                    setTimeout(() => eventPickerMap.invalidateSize(), 100);
                }
            } catch (err) {
                console.error('Init Map Error:', err);
            }
        }

        function calculateEventDuration() {
            const start = document.getElementById('evtJamMulai').value;
            const end = document.getElementById('evtJamSelesai').value;
            if (start && end) {
                document.getElementById('evtDurasi').value = `${start} - ${end}`;
            }
        }
        async function searchLocationOnMap() {
            const query = document.getElementById('evtMapSearchInput').value;
            if (!query) return showToast('Masukkan lokasi yang ingin dicari', 'warning');

            // Ensure Leaflet is loaded
            if (typeof L === 'undefined') return showToast('Library peta belum dimuat', 'danger');

            // Force modal to be visible before map operations
            document.getElementById('eventModal').style.display = 'flex';

            if (!eventPickerMap) {
                initEventMap();
                await new Promise(r => setTimeout(r, 200));
            }

            const btn = document.getElementById('btnSearchMap');
            const originalBtnHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
                const response = await fetch(url);

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();

                if (data && data.length > 0) {
                    const first = data[0];
                    const lat = parseFloat(first.lat);
                    const lon = parseFloat(first.lon);
                    const latlng = [lat, lon];

                    if (eventPickerMap) {
                        eventPickerMap.setView(latlng, 15);

                        if (eventPickerMarker) {
                            eventPickerMarker.setLatLng(latlng);
                        } else {
                            eventPickerMarker = L.marker(latlng).addTo(eventPickerMap);
                        }

                        document.getElementById('evtLat').value = lat.toFixed(6);
                        document.getElementById('evtLng').value = lon.toFixed(6);

                        showToast(`Lokasi ditemukan: ${first.display_name.split(',')[0]}`, 'success');
                    }
                } else {
                    showToast('Lokasi tidak ditemukan. Coba kata kunci lain.', 'danger');
                }
            } catch (err) {
                console.error('Search Map Error:', err);
                showToast('Gagal mencari lokasi. Pastikan koneksi internet aktif.', 'danger');
            } finally {
                btn.innerHTML = originalBtnHtml;
                btn.disabled = false;
            }
        }

        function openEventModal(id = null) {
            const form = document.getElementById('eventForm');
            form.reset();
            document.getElementById('evtId').value = id || '';
            document.getElementById('eventModalTitle').textContent = id ? 'Edit Event' : 'Tambah Event';
            document.getElementById('evtLat').value = '';
            document.getElementById('evtLng').value = '';
            document.getElementById('evtMapSearchInput').value = '';
            if (eventPickerMarker) {
                eventPickerMap.removeLayer(eventPickerMarker);
                eventPickerMarker = null;
            }

            let currentJurusan = 'Semua';
            if (id && window.allEvents) {
                const item = window.allEvents.find(e => e.ID_Even == id);
                if (item) {
                    document.getElementById('evtNama').value = item.NamaEven;
                    currentJurusan = item.Jurusan;

                    // Handle date format for <input type="date">
                    if (item.TanggalEven) {
                        try {
                            const d = new Date(item.TanggalEven);
                            if (!isNaN(d.getTime())) {
                                document.getElementById('evtTanggal').value = d.toISOString().split('T')[0];
                            } else {
                                document.getElementById('evtTanggal').value = item.TanggalEven;
                            }
                        } catch (e) {
                            document.getElementById('evtTanggal').value = item.TanggalEven;
                        }
                    }
                    document.getElementById('evtLokasi').value = item.Lokasi;
                    document.getElementById('evtPengisi').value = item.Pengisi;
                    document.getElementById('evtDeskripsi').value = item.Deskripsi;

                    if (item.Durasi && item.Durasi.includes(' - ')) {
                        const parts = item.Durasi.split(' - ');
                        document.getElementById('evtJamMulai').value = parts[0];
                        document.getElementById('evtJamSelesai').value = parts[1];
                        document.getElementById('evtDurasi').value = item.Durasi;
                    }

                    if (item.LAT && item.LNG) {
                        document.getElementById('evtLat').value = item.LAT;
                        document.getElementById('evtLng').value = item.LNG;
                        const latlng = [parseFloat(item.LAT), parseFloat(item.LNG)];
                        setTimeout(() => {
                            if (eventPickerMap) {
                                eventPickerMap.setView(latlng, 15);
                                if (eventPickerMarker) {
                                    eventPickerMarker.setLatLng(latlng);
                                } else {
                                    eventPickerMarker = L.marker(latlng).addTo(eventPickerMap);
                                }
                            }
                        }, 500);
                    }
                }
            }
            loadJurusanOptions('evtJurusan', currentJurusan);
            toggleEventModal(true);
        }

        document.getElementById('eventForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('evtId').value;
            const data = {
                NamaEven: document.getElementById('evtNama').value,
                Jurusan: document.getElementById('evtJurusan').value,
                TanggalEven: document.getElementById('evtTanggal').value,
                Durasi: document.getElementById('evtDurasi').value,
                Lokasi: document.getElementById('evtLokasi').value,
                Pengisi: document.getElementById('evtPengisi').value,
                Deskripsi: document.getElementById('evtDeskripsi').value,
                LAT: document.getElementById('evtLat').value,
                LNG: document.getElementById('evtLng').value
            };

            if (!id) {
                // Generate ID for new entry
                data.ID_Even = 'EVT-' + Date.now();
            }
            const btn = document.getElementById('btnSaveEvent');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            try {
                const res = id ? await API.updateData('EVENT', id, data) : await API.postData('EVENT', data);
                if (res.status === 'success') {
                    showToast(id ? 'Event diperbarui!' : 'Event ditambahkan!', 'success');
                    toggleEventModal(false);
                    loadEventsAdmin();
                }
            } catch (err) {
                showToast('Gagal menyimpan event.', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Simpan Event';
            }
        };

        async function deleteEvent(id) {
            if (!confirm('Hapus event ini?')) return;
            try {
                const res = await API.deleteData('EVENT', id);
                if (res.status === 'success') {
                    showToast('Event dihapus!', 'success');
                    loadEventsAdmin();
                }
            } catch (err) {
                showToast('Gagal menghapus.', 'danger');
            }
        }

        async function loadDocuments() {
            const tbody = document.getElementById('docTableBody');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Memuat data...</td></tr>';
            try {
                const res = await API.getData('DOKUMEN');
                if (res.status === 'success') {
                    window.allDocs = res.data;
                    tbody.innerHTML = res.data.map(doc => `
                        <tr>
                            <td data-label="ID">${doc.ID_DOK}</td>
                            <td data-label="Nama Dokumen"><strong style="color: #fff;">${doc.NamaDok}</strong></td>
                            <td data-label="Aksi">
                                <div class="table-actions">
                                    <button class="action-btn view" onclick="window.open('${doc.Dokumen}', '_blank')" title="Buka Link Dokumen"><i class="fas fa-external-link-alt"></i></button>
                                    <button class="action-btn edit" onclick="editDocument('${doc.ID_DOK}')" title="Edit Template"><i class="fas fa-edit"></i></button>
                                    <button class="action-btn delete" onclick="deleteDocument('${doc.ID_DOK}')" title="Hapus Template"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color: var(--danger); padding: 2rem;">Gagal memuat data.</td></tr>';
            }
        }

        function toggleDocModal(show) {
            document.getElementById('docModal').classList.toggle('hidden', !show);
            document.getElementById('docModal').style.display = show ? 'flex' : 'none';
            if (!show) {
                document.getElementById('docForm').reset();
                document.getElementById('docFile').value = '';
            }
        }

        function editDocument(id) {
            const doc = window.allDocs.find(d => d.ID_DOK == id);
            if (doc) {
                document.getElementById('editDocId').value = doc.ID_DOK;
                document.getElementById('docName').value = doc.NamaDok;
                document.getElementById('docContent').value = doc.Dokumen;
                document.getElementById('docModalTitle').textContent = 'Edit Template Dokumen';
                toggleDocModal(true);
            }
        }

        async function saveDocument(event) {
            event.preventDefault();
            const id = document.getElementById('editDocId').value;
            const docName = document.getElementById('docName').value;
            let docUrl = document.getElementById('docContent').value;
            const fileInput = document.getElementById('docFile');
            const file = fileInput.files[0];

            const btn = document.getElementById('btnSaveDoc');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

            try {
                // 1. Handle File Upload if present
                if (file) {
                    let fileToUpload = file;
                    if (file.type.startsWith('image/')) {
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengompres Gambar...';
                        fileToUpload = await API.compressImage(file);
                    }
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading ke Drive...';
                    const uploadRes = await API.uploadFile(fileToUpload);
                    if (uploadRes.status === 'success') {
                        docUrl = uploadRes.url;
                    } else {
                        throw new Error(uploadRes.error || 'Gagal upload file');
                    }
                }

                if (!docUrl) {
                    showToast('Link atau File harus diisi!', 'warning');
                    return;
                }

                const data = {
                    NamaDok: docName,
                    Dokumen: docUrl
                };

                let res;
                if (id) {
                    res = await API.updateData('DOKUMEN', id, data);
                } else {
                    data.ID_DOK = 'DOC-' + Date.now();
                    res = await API.postData('DOKUMEN', data);
                }

                if (res.status === 'success') {
                    showToast(id ? 'Dokumen diperbarui!' : 'Dokumen ditambahkan!', 'success');
                    toggleDocModal(false);
                    loadDocuments();
                } else {
                    showToast('Gagal: ' + (res.message || res.error), 'danger');
                }
            } catch (err) {
                console.error(err);
                showToast('Kesalahan: ' + err.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Simpan';
            }
        }

        async function deleteDocument(id) {
            if (!confirm('Hapus template dokumen ini?')) return;
            try {
                const res = await API.deleteData('DOKUMEN', id);
                if (res.status === 'success') {
                    showToast('Dokumen dihapus!', 'success');
                    loadDocuments();
                }
            } catch (err) {
                showToast('Gagal menghapus.', 'danger');
            }
        }

        window.onload = function () {
            const user = AUTH.checkSession();
            if (!user || user.role !== 'admin') {
                window.location.href = '../index.html';
                return;
            }
            updateUserUI();
            showSection('dashboard');
        };
    </script>
</body>

</html>